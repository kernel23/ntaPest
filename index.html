<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agri-Guard</title>
    
    <!-- PWA Manifest commit-->
    <link rel="manifest" href="manifest.json">
    
    <!-- Theme Color for PWA -->
    <meta name="theme-color" content="#22c55e">
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Leaflet CSS for mapping -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />

    <style>
        /* Simple transition for showing/hiding screens */
        .screen { display: none; }
        .screen.active { display: flex; }
        body { font-family: 'Inter', sans-serif; } /* Using a common sans-serif font */

        /* Fixed Sidebar */
        #sidebar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            z-index: 10;
        }

        #screen-container.with-sidebar {
            margin-left: 4rem; /* ml-16 */
        }
        #map { height: 400px; }
        #report-map { height: 200px; margin-bottom: 1.5rem; }
        #pest-cards-container {
            perspective: 1000px;
        }
        .pest-card {
            width: 180px;
            height: 220px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.5s, z-index 0.5s;
            cursor: pointer;
            animation: float 6s ease-in-out infinite;

            /* Glassmorphism styles */
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px); /* For Safari */
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
        }
        .pest-card:hover {
            transform: translateY(-10px) scale(1.1);
            z-index: 10;
            animation-play-state: paused;
        }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .pest-name {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.5); /* White with 50% transparency */
            color: black;
            font-size: 0.875rem; /* 14px, text-sm */
            line-height: 1.25rem; /* 20px */
            overflow: hidden;
            white-space: nowrap;
            text-align: center;
        }

        .pest-name p {
            margin: 0;
            padding: 0.25rem;
            display: inline-block;
        }

        .pest-name.is-long p {
            padding-left: 100%;
            animation: marquee 10s linear infinite;
        }

        @keyframes marquee {
            0% { transform: translate(0, 0); }
            100% { transform: translate(-100%, 0); }
        }
    </style>
</head>
<body class="bg-[#fff2c9]">

    <!-- Saving Overlay -->
    <div id="saving-overlay" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center" style="z-index: 10000;">
        <div class="text-center text-white">
            <svg class="animate-spin h-10 w-10 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="saving-message" class="mt-4 text-lg">Saving...</p>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-green-600 text-white py-2 px-4 rounded-lg shadow-md opacity-0 transition-opacity duration-300" style="z-index: 10001;">
        <p id="toast-message"></p>
    </div>

    <div id="app-container" class="h-screen w-screen relative">
        <!-- Fixed Icon-Only Sidebar -->
        <aside id="sidebar" class="w-16 bg-gradient-to-br from-[#384532] via-[#455b3c] to-[#cc9244] text-white p-4 hidden flex-col items-center">
            <!-- Logo -->
            <div class="mb-10">
                 <i data-lucide="leaf" class="w-8 h-8 text-[#f1c232]"></i>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 flex flex-col items-center space-y-4">
                <a href="#" id="nav-farm-list" class="nav-item p-2 rounded-lg hover:bg-[#455b3c]" title="My Farms">
                    <i data-lucide="layout-dashboard" class="w-6 h-6"></i>
                </a>
                <a href="#" id="nav-profile" class="nav-item p-2 rounded-lg hover:bg-[#455b3c]" title="Profile">
                    <i data-lucide="user" class="w-6 h-6"></i>
                </a>
                <a href="#" id="nav-reports" class="nav-item p-2 rounded-lg hover:bg-[#455b3c]" title="Reports">
                    <i data-lucide="file-text" class="w-6 h-6"></i>
                </a>
                <a href="#" id="nav-diagnosis" class="nav-item p-2 rounded-lg hover:bg-[#455b3c]" title="Diagnosis">
                    <i data-lucide="stethoscope" class="w-6 h-6"></i>
                </a>
                <a href="#" id="nav-treatment" class="nav-item p-2 rounded-lg hover:bg-[#455b3c]" title="Final Diagnosis">
                    <i data-lucide="syringe" class="w-6 h-6"></i>
                </a>
                <a href="#" id="nav-clinic" class="nav-item p-2 rounded-lg hover:bg-[#455b3c]" title="Online Clinic">
                    <i data-lucide="message-square" class="w-6 h-6"></i>
                </a>
                <a href="#" id="nav-notifications" class="nav-item p-2 rounded-lg hover:bg-[#455b3c] relative" title="Notifications">
                    <i data-lucide="bell" class="w-6 h-6"></i>
                    <span id="notification-badge" class="absolute top-1 right-1 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center hidden"></span>
                </a>
                 <a href="#" id="nav-admin" class="nav-item p-2 rounded-lg hover:bg-[#455b3c]" title="Admin Dashboard">
                    <i data-lucide="shield-alert" class="w-6 h-6"></i>
                </a>
                <a href="#" id="nav-advisory" class="nav-item p-2 rounded-lg hover:bg-[#455b3c]" title="Predictive Advisory">
                    <i data-lucide="cloud-lightning" class="w-6 h-6"></i>
                </a>
            </nav>

            <!-- Logout Button -->
            <div class="mt-auto">
                <button id="sidebar-logout-btn" class="nav-item p-2 rounded-lg hover:bg-red-700" title="Logout">
                    <i data-lucide="log-out" class="w-6 h-6"></i>
                </button>
            </div>
        </aside>

        <!-- Main content area that holds all screens -->
        <div id="screen-container" class="h-screen overflow-y-auto">
            <!-- Loading Screen -->
            <div id="loading-screen" class="screen active flex-col justify-center items-center h-full bg-[#fff2c9] text-[#384532]">
                <svg class="animate-spin h-10 w-10 text-[#455b3c]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-lg text-[#455b3c]">Loading Agri-Guard...</p>
            </div>

            <!-- Login Screen -->
            <div id="login-screen" class="screen h-full text-white flex-col md:flex-row bg-gradient-to-br from-[#384532] via-[#455b3c] to-[#cc9244]">
                <div class="w-full md:w-1/2 flex flex-col justify-center items-center p-6">
                    <div class="text-center mb-10">
                        <i data-lucide="leaf" class="w-16 h-16 text-[#f1c232] mx-auto"></i>
                        <h1 class="text-4xl font-bold text-white mt-4">Agri-Guard</h1>
                        <p class="text-lg text-gray-200">Tobacco Pest Monitoring</p>
                        <p class="text-sm text-gray-300 mt-1">Ilocos Region, Philippines</p>
                    </div>
                    <div id="offline-message-container" class="w-full max-w-sm text-center mb-4"></div>
                    <div class="w-full max-w-sm">
                        <button id="google-signin-btn" class="w-full bg-white text-gray-700 font-semibold py-3 px-4 border border-gray-300 rounded-lg shadow-sm flex items-center justify-center mb-3 hover:bg-gray-50">
                            <img src="https://www.google.com/images/branding/googlelogo/1x/googlelogo_color_272x92dp.png" alt="Google" class="mr-3 h-6">
                            Sign in with Google
                        </button>
                        <button id="guest-signin-btn" class="w-full text-gray-200 py-2 hover:text-white hover:underline">Continue as Guest</button>
                    </div>
                    <div class="mt-4 text-center text-xs text-gray-300">
                        By signing in, you agree to our <a href="#" id="privacy-policy-link" class="underline hover:text-white">Privacy Policy</a>. All personal data is encrypted in transit.
                    </div>
                </div>
                <div id="weather-dashboard-container" class="w-full md:w-1/2 p-6 hidden md:flex flex-col justify-center items-center">
                    <!-- Weather dashboard will be inserted here -->
                </div>
                <div id="pest-cards-container" class="w-full md:w-1/2 p-6 hidden md:flex md:flex-wrap md:justify-center overflow-y-auto">
                    <!-- Pest and disease cards will be inserted here by JavaScript -->
                </div>
            </div>

            <!-- Privacy Policy Screen -->
            <div id="privacy-policy-screen" class="screen flex-col h-full bg-[#fff2c9] text-[#384532]">
                <header class="bg-white p-4 shadow-md flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Privacy Policy</h2>
                    <button id="close-privacy-policy-btn" class="p-2 rounded-full hover:bg-gray-100">
                        <i data-lucide="x" class="w-6 h-6 text-gray-600"></i>
                    </button>
                </header>
                <main class="flex-1 p-6 overflow-y-auto">
                    <p class="mb-4"><strong>Last updated: August 11, 2025</strong></p>
                    <p class="mb-4">This Privacy Policy describes Our policies and procedures on the collection, use and disclosure of Your information when You use the Service and tells You about Your privacy rights and how the law protects You.</p>
                    <h3 class="text-lg font-bold mt-6 mb-2">Interpretation and Definitions</h3>
                    <p class="mb-4">The words of which the initial letter is capitalized have meanings defined under the following conditions. The following definitions shall have the same meaning regardless of whether they appear in singular or in plural.</p>
                    <h3 class="text-lg font-bold mt-6 mb-2">Collecting and Using Your Personal Data</h3>
                    <p class="mb-4">While using Our Service, We may ask You to provide Us with certain personally identifiable information that can be used to contact or identify You. Personally identifiable information may include, but is not limited to: Email address, First name and last name, Phone number, Address, State, Province, ZIP/Postal code, City, Usage Data.</p>
                    <h3 class="text-lg font-bold mt-6 mb-2">Data Encryption</h3>
                    <p class="mb-4">We are committed to ensuring that your information is secure. To prevent unauthorized access or disclosure, we have put in place suitable physical, electronic and managerial procedures to safeguard and secure the information we collect online. All personal data is encrypted in transit between your device and our servers using Secure Socket Layer (SSL) technology.</p>
                    <h3 class="text-lg font-bold mt-6 mb-2">Contact Us</h3>
                    <p>If you have any questions about this Privacy Policy, You can contact us by email: privacy@agri-guard.com</p>
                </main>
            </div>

            <!-- Create Profile Screen -->
            <div id="profile-screen" class="screen flex-col h-full bg-[#fff2c9] text-[#384532]">
                <header class="bg-white p-4 shadow-md">
                    <h2 id="profile-title" class="text-2xl font-bold">Your Profile</h2>
                </header>
                <main class="flex-1 p-6 overflow-y-auto">
                    <div class="text-center mb-6">
                        <img id="profile-pic" src="https://placehold.co/96x96/e2e8f0/334155?text=User" class="w-24 h-24 rounded-full mx-auto mb-4">
                    </div>
                    <label for="fullName" class="block text-sm font-medium text-gray-700">Full Name</label>
                    <input type="text" id="fullName" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#455b3c] focus:border-[#455b3c]">

                    <label for="province" class="block text-sm font-medium text-gray-700 mt-4">Province</label>
                    <div id="province-multiselect-container" class="relative"></div>


                    <label for="municipality" class="block text-sm font-medium text-gray-700 mt-4">Municipality</label>
                    <div id="municipality-multiselect-container" class="relative"></div>


                    <label for="barangay" class="block text-sm font-medium text-gray-700 mt-4">Barangay</label>
                     <div id="barangay-multiselect-container" class="relative"></div>

                    <label for="birthdate" class="block text-sm font-medium text-gray-700 mt-4">Birthdate</label>
                    <input type="date" id="birthdate" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#455b3c] focus:border-[#455b3c]">
                    <label for="civilStatus" class="block text-sm font-medium text-gray-700 mt-4">Civil Status</label>
                    <select id="civilStatus" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#455b3c] focus:border-[#455b3c]">
                        <option>Single</option>
                        <option>Married</option>
                        <option>Widowed</option>
                        <option>Divorced</option>
                    </select>
                    <label for="religion" class="block text-sm font-medium text-gray-700 mt-4">Religion</label>
                    <input type="text" id="religion" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#455b3c] focus:border-[#455b3c]">
                    <label for="yearsFarming" class="block text-sm font-medium text-gray-700 mt-4">Years in Tobacco Farming</label>
                    <input type="number" id="yearsFarming" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#455b3c] focus:border-[#455b3c]">
                    <label for="familyMembers" class="block text-sm font-medium text-gray-700 mt-4">Number of Family Members</label>
                    <input type="number" id="familyMembers" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#455b3c] focus:border-[#455b3c]">
                    <label for="education" class="block text-sm font-medium text-gray-700 mt-4">Highest Educational Attainment</label>
                    <select id="education" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#455b3c] focus:border-[#455b3c]">
                        <option>No formal education</option>
                        <option>Elementary</option>
                        <option>High School</option>
                        <option>Vocational</option>
                        <option>College</option>
                        <option>Post-graduate</option>
                    </select>
                    <div class="mt-4">
                        <label for="isFarmer" class="flex items-center">
                            <input type="checkbox" id="isFarmer" class="h-4 w-4 text-[#455b3c] border-gray-300 rounded focus:ring-[#455b3c]">
                            <span class="ml-2 text-sm font-medium text-gray-700">I am a farmer</span>
                        </label>
                    </div>
                    <div id="rsbsa-container" class="hidden mt-4">
                        <label for="rsbsaNumber" class="block text-sm font-medium text-gray-700">RSBSA Number (Optional)</label>
                        <input type="text" id="rsbsaNumber" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#455b3c] focus:border-[#455b3c]">
                    </div>
                    <div id="role-management-section" class="mt-6">
                        <h3 class="text-lg font-medium text-gray-800">Your Role</h3>
                        <p class="mt-1 text-sm text-gray-600">Your current role is: <span id="current-role-display" class="font-semibold"></span></p>

                        <div id="role-request-section" class="mt-4">
                            <label for="request-role-select" class="block text-sm font-medium text-gray-700">Request a different role:</label>
                            <div class="mt-1 flex rounded-md shadow-sm">
                                <select id="request-role-select" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md">
                                    <option>Extension Worker</option>
                                    <option>Branch Coordinator</option>
                                    <option>Expert</option>
                                </select>
                                <button id="request-role-change-btn" class="ml-3 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">
                                    Request Change
                                </button>
                            </div>
                            <p id="role-request-status" class="mt-2 text-sm text-gray-500"></p>
                        </div>
                    </div>
                    <div class="mt-8 space-y-4">
                        <button id="edit-profile-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hidden">Edit Profile</button>
                        <button id="save-profile-btn" class="w-full bg-gradient-to-r from-[#f1c232] to-[#cc9244] text-white font-bold py-3 px-4 rounded-lg shadow-md">Save and Continue</button>
                        <button id="cancel-edit-btn" class="w-full bg-gray-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hidden">Cancel</button>
                    </div>
                </main>
            </div>

            <!-- Farm List Screen (Home) -->
            <div id="farm-list-screen" class="screen flex-col h-full bg-[#fff2c9] text-[#384532]">
                <header class="bg-white p-4 shadow-md">
                    <div class="header-nav-container flex items-center mb-2">
                        <button class="back-button p-2 rounded-full hover:bg-gray-100 mr-2 hidden">
                            <i data-lucide="arrow-left" class="w-6 h-6 text-gray-600"></i>
                        </button>
                        <div class="breadcrumbs text-sm text-gray-500"></div>
                    </div>
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold">My Farm Plots</h2>
                            <p id="welcome-message" class="text-sm text-gray-600"></p>
                        </div>
                        <div id="connection-status" class="text-center py-1 px-3 rounded-full text-sm font-semibold"></div>
                    </div>
                </header>
                <main id="farm-list-container" class="flex-1 p-4 overflow-y-auto">
                    <!-- Farm cards will be inserted here by JavaScript -->
                    <div id="no-farms-message" class="text-center text-gray-500 mt-20">
                        <i data-lucide="map-pin" class="w-12 h-12 mx-auto text-gray-400"></i>
                        <p class="mt-4">No farm plots found.</p>
                        <p>Add your first plot to start monitoring.</p>
                    </div>
                </main>
                <button id="add-farm-btn" class="absolute bottom-6 right-6 bg-gradient-to-r from-[#f1c232] to-[#cc9244] text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center">
                    <i data-lucide="plus" class="w-8 h-8"></i>
                </button>
            </div>

            <!-- Extension Worker Dashboard Screen -->
            <div id="ew-dashboard-screen" class="screen flex-col h-full bg-[#fff2c9] text-[#384532]">
                <header class="bg-white p-4 shadow-md">
                    <div class="header-nav-container flex items-center mb-2">
                        <button class="back-button p-2 rounded-full hover:bg-gray-100 mr-2 hidden">
                            <i data-lucide="arrow-left" class="w-6 h-6 text-gray-600"></i>
                        </button>
                        <div class="breadcrumbs text-sm text-gray-500"></div>
                    </div>
                    <h2 class="text-2xl font-bold">Extension Worker Dashboard</h2>
                    <p id="ew-welcome-message" class="text-sm text-gray-600"></p>
                </header>
                <main id="ew-dashboard-container" class="flex-1 p-4 overflow-y-auto">
                    <!-- Farmer list table will be inserted here -->
                    <div class="text-center text-gray-500 mt-20">
                        <i data-lucide="users" class="w-12 h-12 mx-auto text-gray-400"></i>
                        <p class="mt-4">Loading assigned farmers...</p>
                    </div>
                </main>
            </div>

            <!-- Coordinator Dashboard Screen -->
            <div id="coordinator-dashboard-screen" class="screen flex-col h-full bg-[#fff2c9] text-[#384532]">
                <header class="bg-white p-4 shadow-md">
                    <div class="header-nav-container flex items-center mb-2">
                        <button class="back-button p-2 rounded-full hover:bg-gray-100 mr-2 hidden">
                            <i data-lucide="arrow-left" class="w-6 h-6 text-gray-600"></i>
                        </button>
                        <div class="breadcrumbs text-sm text-gray-500"></div>
                    </div>
                    <h2 class="text-2xl font-bold">Coordinator Dashboard</h2>
                    <p id="coordinator-welcome-message" class="text-sm text-gray-600"></p>
                </header>
                <main id="coordinator-dashboard-container" class="flex-1 p-4 overflow-y-auto">
                    <!-- Extension Worker list table will be inserted here -->
                     <div class="text-center text-gray-500 mt-20">
                        <i data-lucide="briefcase" class="w-12 h-12 mx-auto text-gray-400"></i>
                        <p class="mt-4">Loading extension workers...</p>
                    </div>
                </main>
            </div>

            <!-- Expert Dashboard Screen -->
            <div id="expert-dashboard-screen" class="screen flex-col h-full bg-[#fff2c9] text-[#384532]">
                <header class="bg-white p-4 shadow-md">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold">Expert Dashboard</h2>
                            <p id="expert-welcome-message" class="text-sm text-gray-600"></p>
                        </div>
                        <button id="export-csv-btn" class="bg-gradient-to-r from-[#f1c232] to-[#cc9244] text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-[#cc9244]">
                            Export All Data to CSV
                        </button>
                    </div>

                    <!-- Filters -->
                    <div id="expert-filters" class="mt-4 pt-4 border-t border-gray-200 grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="col-span-1 md:col-span-4">
                            <p class="text-sm font-medium text-gray-700">Filter by Pest/Disease</p>
                            <div id="expert-pest-disease-filter-container" class="relative mt-1"></div>
                        </div>

                        <div class="col-span-1 md:col-span-4">
                             <p class="text-sm font-medium text-gray-700">Filter by Location</p>
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-1">
                                <div id="expert-province-filter-container" class="relative"></div>
                                <div id="expert-municipality-filter-container" class="relative"></div>
                                <div id="expert-barangay-filter-container" class="relative"></div>
                             </div>
                        </div>
                         <div class="col-span-1 md:col-span-4 flex justify-end">
                            <button id="expert-clear-location-filters-btn" class="text-sm text-blue-600 hover:underline">Clear All Filters</button>
                        </div>
                    </div>
                </header>
                <main class="flex-1 p-4 overflow-y-auto">
                    <div class="flex flex-col lg:flex-row gap-6">
                        <!-- Main Content -->
                        <div class="flex-1 flex flex-col gap-6">
                            <!-- Map Container -->
                            <div class="bg-white p-4 rounded-lg shadow">
                                <h3 class="text-lg font-bold mb-2">Pest & Disease Distribution Map</h3>
                                <div id="expert-map" class="w-full h-[60vh] bg-gray-200 rounded-md shadow-inner"></div>
                                <div id="expert-map-legend" class="mt-4"></div>
                            </div>

                            <!-- Stats and Data Extraction Container -->
                            <div class="space-y-6">
                                <!-- Stats -->
                                <div class="bg-white p-4 rounded-lg shadow">
                                    <h3 class="text-lg font-bold mb-4">Key Statistics</h3>
                                    <div id="expert-stats-container" class="grid grid-cols-2 gap-4">
                                        <div class="text-center p-2 rounded-lg bg-gray-100">
                                            <p class="text-2xl font-bold" id="stat-reports-count">0</p>
                                            <p class="text-sm text-gray-600">Total Reports</p>
                                        </div>
                                        <div class="text-center p-2 rounded-lg bg-gray-100">
                                            <p class="text-2xl font-bold" id="stat-diagnosed-count">0</p>
                                            <p class="text-sm text-gray-600">Diagnosed</p>
                                        </div>
                                        <div class="text-center p-2 rounded-lg bg-gray-100">
                                            <p class="text-2xl font-bold" id="stat-treated-count">0</p>
                                            <p class="text-sm text-gray-600">Treated</p>
                                        </div>
                                        <div class="text-center p-2 rounded-lg bg-gray-100">
                                            <p class="text-2xl font-bold" id="stat-pests-count">0</p>
                                            <p class="text-sm text-gray-600">Unique Pests</p>
                                        </div>
                                        <div class="text-center p-2 rounded-lg bg-gray-100">
                                            <p class="text-2xl font-bold" id="stat-diseases-count">0</p>
                                            <p class="text-sm text-gray-600">Unique Diseases</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Data Extraction (Button moved to header) -->
                            </div>
                        </div>

                        <!-- Case Details Side Panel -->
                        <div id="expert-case-details-panel" class="hidden w-full lg:w-1/3 bg-white rounded-lg shadow-lg p-4 flex-col">
                            <div class="flex justify-between items-center mb-4 border-b pb-2">
                                <h3 class="text-xl font-bold">Case Details</h3>
                                <button id="close-expert-panel-btn" class="p-1 rounded-full hover:bg-gray-200">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            <div id="expert-panel-content" class="overflow-y-auto flex-1">
                                <!-- Details will be populated here -->
                                <p class="text-gray-500">Click on a highlighted area on the map to see details.</p>
                            </div>
                        </div>
                    </div>
                </main>
            </div>

            <!-- Admin Dashboard Screen -->
            <div id="admin-dashboard-screen" class="screen flex-col h-full bg-[#fff2c9] text-[#384532]">
                <header class="bg-white p-4 shadow-md">
                    <h2 class="text-2xl font-bold">Administrator Dashboard</h2>
                    <p id="admin-welcome-message" class="text-sm text-gray-600"></p>
                </header>
                <main class="flex-1 p-4 overflow-y-auto">
                    <div class="mb-4 border-b border-gray-200">
                        <nav class="flex space-x-4" aria-label="Tabs">
                            <button id="admin-users-tab" class="px-3 py-2 font-medium text-sm rounded-t-md border-b-2 border-[#455b3c] text-[#384532]">
                                User Management
                            </button>
                            <button id="admin-reports-tab" class="px-3 py-2 font-medium text-sm rounded-t-md border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                Report Management
                            </button>
                            <button id="admin-role-requests-tab" class="px-3 py-2 font-medium text-sm rounded-t-md border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                Role Requests
                            </button>
                        </nav>
                    </div>
                    <div id="admin-users-content">
                        <!-- User management table will be inserted here -->
                        <div class="text-center text-gray-500 mt-20">
                            <i data-lucide="users" class="w-12 h-12 mx-auto text-gray-400"></i>
                            <p class="mt-4">Loading users...</p>
                        </div>
                    </div>
                    <div id="admin-reports-content" class="hidden">
                        <!-- Report management table will be inserted here -->
                        <div class="text-center text-gray-500 mt-20">
                            <i data-lucide="file-text" class="w-12 h-12 mx-auto text-gray-400"></i>
                            <p class="mt-4">Loading reports...</p>
                        </div>
                    </div>
                    <div id="admin-role-requests-content" class="hidden">
                        <!-- Role requests table will be inserted here -->
                        <div class="text-center text-gray-500 mt-20">
                            <i data-lucide="user-check" class="w-12 h-12 mx-auto text-gray-400"></i>
                            <p class="mt-4">Loading role requests...</p>
                        </div>
                    </div>
                </main>
            </div>

            <!-- Dashboard Screen -->
            <div id="dashboard-screen" class="screen flex-col h-full bg-[#fff2c9] text-[#384532]">
                <header class="bg-white p-4 shadow-md">
                    <div class="header-nav-container flex items-center mb-2">
                        <button class="back-button p-2 rounded-full hover:bg-gray-100 mr-2 hidden">
                            <i data-lucide="arrow-left" class="w-6 h-6 text-gray-600"></i>
                        </button>
                        <div class="breadcrumbs text-sm text-gray-500"></div>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            <h2 id="dashboard-farm-name" class="text-2xl font-bold">Farm Health Log</h2>
                            <p id="dashboard-farm-variety" class="text-sm text-gray-600 ml-4"></p>
                        </div>
                        <div>
                            <button id="edit-farm-details-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Edit Details</button>
                            <button id="delete-farm-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md ml-2">Delete Farm</button>
                            <button id="new-submission-btn" class="bg-gradient-to-r from-[#f1c232] to-[#cc9244] text-white font-bold py-2 px-4 rounded-lg shadow-md ml-2">New Report</button>
                        </div>
                    </div>
                </header>
                <main id="dashboard-main" class="flex-1 p-4 overflow-y-auto">
                    <div class="text-center text-gray-500 mt-20">
                        <i data-lucide="clipboard-list" class="w-12 h-12 mx-auto text-gray-400"></i>
                        <p class="mt-4">Submission history will appear here.</p>
                    </div>
                </main>
            </div>

            <!-- New Submission Screen -->
            <div id="new-submission-screen" class="screen flex-col h-full bg-[#fff2c9] text-[#384532]">
                <header class="bg-white p-4 shadow-md">
                    <div class="header-nav-container flex items-center mb-2">
                        <button class="back-button p-2 rounded-full hover:bg-gray-100 mr-2 hidden">
                            <i data-lucide="arrow-left" class="w-6 h-6 text-gray-600"></i>
                        </button>
                        <div class="breadcrumbs text-sm text-gray-500"></div>
                    </div>
                    <h2 class="text-2xl font-bold">New Scouting Report</h2>
                </header>
                <main class="flex-1 p-6 overflow-y-auto">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Farm Location</label>
                    <div id="report-map" class="w-full h-48 bg-gray-200 rounded-md shadow-inner"></div>

                    <label class="block text-sm font-medium text-gray-700 mb-2">Upload Image(s) of Affected Plant</p></label>
                    <div class="mt-1 p-4 border-2 border-gray-300 border-dashed rounded-md">
                        <div id="submission-image-preview-container" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4 mb-4">
                             <div id="image-placeholder-icon" class="col-span-full text-center text-gray-400 py-4">
                                <i data-lucide="image" class="mx-auto h-12 w-12"></i>
                                <p>No images selected</p>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="flex text-sm text-gray-600 justify-center">
                                <label for="image-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-[#455b3c] hover:text-[#384532] focus-within:outline-none">
                                    <span>Upload files</span>
                                    <input id="image-upload" name="image-upload" type="file" class="sr-only" accept="image/*" multiple>
                                </label>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">PNG, JPG, GIF up to 10MB</p>
                            <div class="mt-4">
                                <button id="open-camera-btn" type="button" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#455b3c]">
                                    <i data-lucide="camera" class="mr-2 h-5 w-5"></i>
                                    Capture with Camera
                                </button>
                            </div>
                        </div>
                    </div>

                    <fieldset id="symptoms-checklist" class="mt-6">
                        <legend class="text-base font-medium text-gray-900">Observed Symptoms</legend>
                        <div class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div class="flex items-start"><div class="flex items-center h-5"><input id="symptom-leaf-spots" value="leaf-spots" type="checkbox" class="symptom-checkbox focus:ring-[#455b3c] h-4 w-4 text-[#455b3c] border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="symptom-leaf-spots" class="font-medium text-gray-700">Leaf Spots</label></div></div>
                            <div class="flex items-start"><div class="flex items-center h-5"><input id="symptom-wilting" value="wilting" type="checkbox" class="symptom-checkbox focus:ring-[#455b3c] h-4 w-4 text-[#455b3c] border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="symptom-wilting" class="font-medium text-gray-700">Wilting</label></div></div>
                            <div class="flex items-start"><div class="flex items-center h-5"><input id="symptom-yellowing" value="yellowing" type="checkbox" class="symptom-checkbox focus:ring-[#455b3c] h-4 w-4 text-[#455b3c] border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="symptom-yellowing" class="font-medium text-gray-700">Yellowing</label></div></div>
                            <div class="flex items-start"><div class="flex items-center h-5"><input id="symptom-stunted-growth" value="stunted-growth" type="checkbox" class="symptom-checkbox focus:ring-[#455b3c] h-4 w-4 text-[#455b3c] border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="symptom-stunted-growth" class="font-medium text-gray-700">Stunted Growth</label></div></div>
                            <div class="flex items-start"><div class="flex items-center h-5"><input id="symptom-holes-in-leaves" value="holes-in-leaves" type="checkbox" class="symptom-checkbox focus:ring-[#455b3c] h-4 w-4 text-[#455b3c] border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="symptom-holes-in-leaves" class="font-medium text-gray-700">Holes in Leaves</label></div></div>
                            <div class="flex items-start"><div class="flex items-center h-5"><input id="symptom-galls" value="galls" type="checkbox" class="symptom-checkbox focus:ring-[#455b3c] h-4 w-4 text-[#455b3c] border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="symptom-galls" class="font-medium text-gray-700">Galls (swellings)</label></div></div>
                            <div class="flex items-start"><div class="flex items-center h-5"><input id="symptom-mosaic" value="mosaic" type="checkbox" class="symptom-checkbox focus:ring-[#455b3c] h-4 w-4 text-[#455b3c] border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="symptom-mosaic" class="font-medium text-gray-700">Mosaic/Mottling</label></div></div>
                            <div class="flex items-start"><div class="flex items-center h-5"><input id="symptom-leaf-curl" value="leaf-curl" type="checkbox" class="symptom-checkbox focus:ring-[#455b3c] h-4 w-4 text-[#455b3c] border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="symptom-leaf-curl" class="font-medium text-gray-700">Leaf Curling/Distortion</label></div></div>
                            <div class="flex items-start"><div class="flex items-center h-5"><input id="symptom-sooty-mold" value="sooty-mold" type="checkbox" class="symptom-checkbox focus:ring-[#455b3c] h-4 w-4 text-[#455b3c] border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="symptom-sooty-mold" class="font-medium text-gray-700">Sooty Mould</label></div></div>
                            <div class="flex items-start"><div class="flex items-center h-5"><input id="symptom-rust" value="rust" type="checkbox" class="symptom-checkbox focus:ring-[#455b3c] h-4 w-4 text-[#455b3c] border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="symptom-rust" class="font-medium text-gray-700">Rust</label></div></div>
                            <div class="flex items-start"><div class="flex items-center h-5"><input id="symptom-stem-lesions" value="stem-lesions" type="checkbox" class="symptom-checkbox focus:ring-[#455b3c] h-4 w-4 text-[#455b3c] border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="symptom-stem-lesions" class="font-medium text-gray-700">Stem Lesions/Cankers</label></div></div>
                            <div class="flex items-start"><div class="flex items-center h-5"><input id="symptom-root-rot" value="root-rot" type="checkbox" class="symptom-checkbox focus:ring-[#455b3c] h-4 w-4 text-[#455b3c] border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="symptom-root-rot" class="font-medium text-gray-700">Root Rot</label></div></div>
                        </div>
                    </fieldset>

                    <fieldset id="distribution-radios" class="mt-6">
                        <legend class="text-base font-medium text-gray-900">Pest/Disease Distribution in the Field</legend>
                        <div class="mt-4 grid grid-cols-2 gap-4">
                            <div class="flex items-center"><input id="dist-isolated" name="distribution" value="isolated" type="radio" class="focus:ring-[#455b3c] h-4 w-4 text-[#455b3c] border-gray-300"><label for="dist-isolated" class="ml-3 block text-sm font-medium text-gray-700">Isolated / Random</label></div>
                            <div class="flex items-center"><input id="dist-patches" name="distribution" value="patches" type="radio" class="focus:ring-[#455b3c] h-4 w-4 text-[#455b3c] border-gray-300"><label for="dist-patches" class="ml-3 block text-sm font-medium text-gray-700">In Patches (Foci)</label></div>
                            <div class="flex items-center"><input id="dist-lines" name="distribution" value="lines" type="radio" class="focus:ring-[#455b3c] h-4 w-4 text-[#455b3c] border-gray-300"><label for="dist-lines" class="ml-3 block text-sm font-medium text-gray-700">In Lines / Rows</label></div>
                            <div class="flex items-center"><input id="dist-overall" name="distribution" value="overall" type="radio" class="focus:ring-[#455b3c] h-4 w-4 text-[#455b3c] border-gray-300"><label for="dist-overall" class="ml-3 block text-sm font-medium text-gray-700">Overall (Whole Plot)</label></div>
                            <div class="flex items-center"><input id="dist-edge" name="distribution" value="edge" type="radio" class="focus:ring-[#455b3c] h-4 w-4 text-[#455b3c] border-gray-300"><label for="dist-edge" class="ml-3 block text-sm font-medium text-gray-700">Edge of Field</label></div>
                            <div class="flex items-center"><input id="dist-low-lying" name="distribution" value="low-lying" type="radio" class="focus:ring-[#455b3c] h-4 w-4 text-[#455b3c] border-gray-300"><label for="dist-low-lying" class="ml-3 block text-sm font-medium text-gray-700">Low-lying Areas</label></div>
                        </div>
                    </fieldset>

                    <fieldset id="severity-radios" class="mt-6">
                        <legend class="text-base font-medium text-gray-900">Severity</legend>
                        <div class="mt-4 space-y-4">
                            <div class="flex items-center"><input id="sev-low" name="severity" value="low" type="radio" class="focus:ring-[#455b3c] h-4 w-4 text-[#455b3c] border-gray-300"><label for="sev-low" class="ml-3 block text-sm font-medium text-gray-700">Low</label></div>
                            <div class="flex items-center"><input id="sev-medium" name="severity" value="medium" type="radio" class="focus:ring-[#455b3c] h-4 w-4 text-[#455b3c] border-gray-300"><label for="sev-medium" class="ml-3 block text-sm font-medium text-gray-700">Medium</label></div>
                            <div class="flex items-center"><input id="sev-high" name="severity" value="high" type="radio" class="focus:ring-[#455b3c] h-4 w-4 text-[#455b3c] border-gray-300"><label for="sev-high" class="ml-3 block text-sm font-medium text-gray-700">High</label></div>
                        </div>
                    </fieldset>

                    <div id="additional-questions" class="mt-6 space-y-6">
                        <fieldset>
                            <legend class="text-base font-medium text-gray-900">Affected Plant Parts</legend>
                            <div class="mt-4 grid grid-cols-2 gap-4">
                                <div class="flex items-start"><div class="flex items-center h-5"><input id="part-leaves" value="leaves" type="checkbox" class="affected-part-checkbox focus:ring-[#455b3c] h-4 w-4 text-[#455b3c] border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="part-leaves" class="font-medium text-gray-700">Leaves</label></div></div>
                                <div class="flex items-start"><div class="flex items-center h-5"><input id="part-stems" value="stems" type="checkbox" class="affected-part-checkbox focus:ring-[#455b3c] h-4 w-4 text-[#455b3c] border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="part-stems" class="font-medium text-gray-700">Stems</label></div></div>
                                <div class="flex items-start"><div class="flex items-center h-5"><input id="part-roots" value="roots" type="checkbox" class="affected-part-checkbox focus:ring-[#455b3c] h-4 w-4 text-[#455b3c] border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="part-roots" class="font-medium text-gray-700">Roots</label></div></div>
                                <div class="flex items-start"><div class="flex items-center h-5"><input id="part-flowers" value="flowers" type="checkbox" class="affected-part-checkbox focus:ring-[#455b3c] h-4 w-4 text-[#455b3c] border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="part-flowers" class="font-medium text-gray-700">Flowers / Buds</label></div></div>
                                <div class="flex items-start"><div class="flex items-center h-5"><input id="part-whole" value="whole-plant" type="checkbox" class="affected-part-checkbox focus:ring-[#455b3c] h-4 w-4 text-[#455b3c] border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="part-whole" class="font-medium text-gray-700">Whole Plant</label></div></div>
                            </div>
                        </fieldset>

                        <div>
                            <label for="symptom-onset-date" class="block text-sm font-medium text-gray-700">When did symptoms first appear?</label>
                            <input type="date" id="symptom-onset-date" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#455b3c] focus:border-[#455b3c]">
                        </div>

                        <fieldset>
                            <legend class="text-base font-medium text-gray-900">Symptom Progression</legend>
                            <div class="mt-4 space-y-4">
                                <div class="flex items-center"><input id="prog-spreading" name="progression" value="spreading" type="radio" class="focus:ring-[#455b3c] h-4 w-4 text-[#455b3c] border-gray-300"><label for="prog-spreading" class="ml-3 block text-sm font-medium text-gray-700">Spreading</label></div>
                                <div class="flex items-center"><input id="prog-improving" name="progression" value="improving" type="radio" class="focus:ring-[#455b3c] h-4 w-4 text-[#455b3c] border-gray-300"><label for="prog-improving" class="ml-3 block text-sm font-medium text-gray-700">Improving</glabel></div>
                                <div class="flex items-center"><input id="prog-constant" name="progression" value="constant" type="radio" class="focus:ring-[#455b3c] h-4 w-4 text-[#455b3c] border-gray-300"><label for="prog-constant" class="ml-3 block text-sm font-medium text-gray-700">Constant</label></div>
                            </div>
                        </fieldset>

                        <div>
                            <label for="pest-signs" class="block text-sm font-medium text-gray-700">Signs of Pests</label>
                            <textarea id="pest-signs" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#455b3c] focus:border-[#455b3c]" placeholder="e.g., visible insects, eggs, webs, trails, etc."></textarea>
                        </div>
                    </div>
                    
                    <button id="save-submission-btn" class="mt-8 w-full bg-gradient-to-r from-[#f1c232] to-[#cc9244] text-white font-bold py-3 px-4 rounded-lg shadow-md">Save Submission</button>
                </main>
            </div>

            <!-- Camera Screen -->
            <div id="camera-screen" class="screen flex-col h-screen bg-black text-white">
                <header class="bg-gray-900 p-4 flex justify-between items-center z-20">
                    <button id="back-to-submission-btn" class="p-2 rounded-full hover:bg-gray-700">
                        <i data-lucide="arrow-left" class="w-6 h-6"></i>
                    </button>
                    <h2 class="text-xl font-bold">Capture Media</h2>
                    <div class="w-10"></div> <!-- Spacer -->
                </header>
                <main class="flex-1 relative flex justify-center items-center">
                    <video id="camera-feed" class="w-full h-full object-cover" autoplay playsinline></video>
                    <div id="camera-overlay" class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <div class="w-11/12 h-2/3 border-4 border-dashed border-white rounded-lg" style="border-color: rgba(255, 255, 255, 0.7);">
                            <p class="text-white text-center mt-4">Place affected leaf inside this box</p>
                        </div>
                    </div>
                    <canvas id="photo-canvas" class="hidden"></canvas>
                </main>
                <footer class="bg-gray-900 p-4 flex justify-around items-center z-20">
                    <button id="capture-photo-btn" class="p-4 bg-white rounded-full focus:outline-none">
                        <i data-lucide="camera" class="w-8 h-8 text-gray-900"></i>
                    </button>
                    <button id="record-video-btn" class="p-4 bg-red-600 rounded-full focus:outline-none">
                        <i data-lucide="video" class="w-8 h-8 text-white"></i>
                    </button>
                </footer>
            </div>

            <!-- Reports Screen -->
            <div id="reports-screen" class="screen flex-col h-full bg-[#fff2c9] text-[#384532]">
                <header class="bg-white p-4 shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">All Pest & Disease Reports</h2>
                    </div>
                    <div id="report-filters" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="col-span-1 md:col-span-4">
                            <p class="text-sm font-medium text-gray-700">Filter by Status</p>
                            <div class="flex flex-wrap gap-2 mt-1">
                                <button data-filter="all" class="report-filter-btn bg-gradient-to-r from-[#f1c232] to-[#cc9244] text-white px-3 py-1 rounded-full text-sm font-semibold">All</button>
                                <button data-filter="pending" class="report-filter-btn bg-gray-200 text-gray-800 px-3 py-1 rounded-full text-sm font-semibold">Pending Diagnosis</button>
                                <button data-filter="diagnosed" class="report-filter-btn bg-gray-200 text-gray-800 px-3 py-1 rounded-full text-sm font-semibold">Diagnosed</button>
                                <button data-filter="treated" class="report-filter-btn bg-gray-200 text-gray-800 px-3 py-1 rounded-full text-sm font-semibold">Treatment Provided</button>
                            </div>
                        </div>

                        <div class="col-span-1 md:col-span-4">
                             <p class="text-sm font-medium text-gray-700">Filter by Location</p>
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-1">
                                <div id="province-filter-container" class="relative"></div>
                                <div id="municipality-filter-container" class="relative"></div>
                                <div id="barangay-filter-container" class="relative"></div>
                             </div>
                        </div>
                         <div class="col-span-1 md:col-span-4 flex justify-end">
                            <button id="clear-location-filters-btn" class="text-sm text-blue-600 hover:underline">Clear Location Filters</button>
                        </div>
                    </div>
                </header>
                <main id="reports-container" class="flex-1 p-4 overflow-y-auto">
                    <!-- Report cards will be inserted here by JavaScript -->
                </main>
            </div>

            <!-- Diagnosis Screen -->
            <div id="diagnosis-screen" class="screen flex-col h-full bg-[#fff2c9] text-[#384532]">
                <header class="bg-white p-4 shadow-md">
                    <h2 class="text-2xl font-bold">Reports for Diagnosis</h2>
                </header>
                <main id="diagnosis-reports-container" class="flex-1 p-4 overflow-y-auto">
                    <!-- Reports awaiting diagnosis will be loaded here by JavaScript -->
                    <div class="text-center text-gray-500 mt-20">
                        <i data-lucide="loader" class="w-12 h-12 mx-auto text-gray-400 animate-spin"></i>
                        <p class="mt-4">Loading reports...</p>
                    </div>
                </main>
            </div>

            <!-- Treatment Screen -->
            <div id="treatment-screen" class="screen flex-col h-full bg-[#fff2c9] text-[#384532]">
                <header class="bg-white p-4 shadow-md">
                    <h2 class="text-2xl font-bold">Reports for Final Diagnosis & Treatment</h2>
                </header>
                <main id="treatment-reports-container" class="flex-1 p-4 overflow-y-auto">
                    <!-- Diagnosed reports will be loaded here by JavaScript -->
                    <div class="text-center text-gray-500 mt-20">
                        <i data-lucide="loader" class="w-12 h-12 mx-auto text-gray-400 animate-spin"></i>
                        <p class="mt-4">Loading reports...</p>
                    </div>
                </main>
            </div>

            <!-- Online Clinic Screen -->
            <div id="online-clinic-screen" class="screen flex-col h-full bg-[#fff2c9] text-[#384532]">
                <header class="bg-white p-4 shadow-md">
                    <h2 class="text-2xl font-bold">Online Clinic</h2>
                </header>
                <main class="flex-1 p-4">
                    <p>Expert consultation features will be available here.</p>
                </main>
            </div>

            <!-- Notifications Screen -->
            <div id="notifications-screen" class="screen flex-col h-full bg-[#fff2c9] text-[#384532]">
                <header class="bg-white p-4 shadow-md">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold">Notifications</h2>
                        <button id="mark-all-read-btn" class="text-sm text-blue-600 hover:underline">Mark all as read</button>
                    </div>
                </header>
                <main id="notifications-container" class="flex-1 p-4 overflow-y-auto">
                    <div class="text-center text-gray-500 mt-20">
                        <i data-lucide="bell-off" class="w-12 h-12 mx-auto text-gray-400"></i>
                        <p class="mt-4">You have no new notifications.</p>
                    </div>
                </main>
            </div>

            <!-- Advisory Screen -->
            <div id="advisory-screen" class="screen flex-col h-full bg-[#fff2c9] text-[#384532]">
                <header class="bg-white p-4 shadow-md">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold">Predictive Advisories</h2>
                        <div>
                            <label for="province-select" class="text-sm font-medium text-gray-700 mr-2">Select Province:</label>
                            <select id="province-select" class="px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#455b3c] focus:border-[#455b3c]">
                                <!-- Options will be populated by JavaScript -->
                            </select>
                <select id="municipality-select" class="hidden ml-4 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#455b3c] focus:border-[#455b3c]">
                    <!-- Options will be populated by JavaScript -->
                </select>
                <button id="view-risk-map-btn" class="ml-4 px-4 py-2 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700">View Geographic Risk</button>
                        </div>
                    </div>
                </header>
                <main id="advisory-container" class="flex-1 p-4 overflow-y-auto">
                    <div id="advisory-loading" class="text-center text-gray-500 mt-20 hidden">
                        <i data-lucide="loader" class="w-12 h-12 mx-auto text-gray-400 animate-spin"></i>
                        <p class="mt-4">Generating advisories...</p>
                    </div>
                    <div id="advisory-content" class="h-full">
                        <div id="advisory-list-container" class="flex flex-row gap-4 h-full">
                            <div id="advisory-list" class="w-2/3 h-full overflow-y-auto space-y-4">
                                <!-- Advisories will be rendered here -->
                            </div>
                            <div id="weather-dashboard" class="w-1/3 bg-white p-4 rounded-lg shadow-sm hidden">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">7-Day Weather Forecast</h3>
                                <div class="relative h-[50vh]"> <!-- Constrain chart height -->
                                    <canvas id="weather-chart-canvas-advisory"></canvas>
                                </div>
                            </div>
                        </div>
                        <div id="advisory-map-container" class="hidden h-full relative">
                            <div id="advisory-map" class="w-full h-full rounded-lg shadow-inner"></div>
                            <div id="farm-risk-stats" class="absolute top-2 right-2 bg-white bg-opacity-80 p-3 rounded-lg shadow-md z-[1000]">
                                <h4 class="font-bold text-sm mb-2 text-gray-800">Farm Risk Analysis</h4>
                                <div id="farm-risk-stats-content">
                                    <p class="text-xs text-gray-600">Loading farm data...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>

            <!-- Farm Setup Screen -->
            <div id="farm-setup-screen" class="screen flex-col h-full bg-[#fff2c9] text-[#384532]">
                <header class="bg-white p-4 shadow-md">
                    <h2 class="text-2xl font-bold">Map Your Farm Plot</h2>
                </header>
                <main class="flex-1 p-6">
                    <p class="mb-4 text-gray-700">Please use the drawing tool on the map to outline the boundary of your farm plot. You can pan and zoom to find your location.</p>
                    <div id="map" class="w-full h-96 bg-gray-200 rounded-md shadow-inner"></div>
                    <div class="mt-6 text-right">
                        <button id="cancel-farm-setup-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md mr-2">Cancel</button>
                        <button id="save-farm-map-btn" class="bg-gradient-to-r from-[#f1c232] to-[#cc9244] text-white font-bold py-2 px-4 rounded-lg shadow-md" disabled>Save Farm Area</button>
                    </div>
                </main>
            </div>

        </div>
    </div>

    <!-- Modals -->
    <!-- Pest Details Modal -->
    <div id="pest-details-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50">
        <div id="pest-details-panel" class="absolute top-0 right-0 h-full w-full max-w-md bg-white shadow-xl transform transition-transform duration-300 ease-in-out translate-x-full">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 id="pest-modal-title" class="text-xl font-bold">Pest/Disease Details</h3>
                <button id="close-pest-details-modal-btn" class="p-1"><i data-lucide="x"></i></button>
            </div>
            <div id="pest-modal-content" class="p-6" style="max-height: calc(100vh - 65px); overflow-y: auto;">
                <!-- Details will be loaded here dynamically -->
            </div>
        </div>
    </div>

    <!-- Diagnosis Modal -->
    <div id="diagnosis-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg m-4">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Diagnose Report</h3>
                <button id="close-diagnosis-modal-btn" class="p-1"><i data-lucide="x"></i></button>
            </div>
            <div class="p-6 max-h-[80vh] overflow-y-auto">
                <div id="diagnosis-report-details" class="mb-4">
                    <!-- Report details will be loaded here -->
                </div>
                <h4 class="text-lg font-bold mt-4 mb-2">Add Diagnosis</h4>
                <label for="pest-disease-select" class="block text-sm font-medium text-gray-700">Identified Pest/Disease</label>
                <select id="pest-disease-select" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#455b3c] focus:border-[#455b3c]">
                    <option value="">Select a pest or disease...</option>
                </select>
                <div id="pest-disease-info" class="mt-4 p-3 bg-gray-50 rounded-lg border border-gray-200 text-sm hidden">
                    <!-- Pest/disease info will be displayed here -->
                </div>
                <label for="diagnosis-notes" class="block text-sm font-medium text-gray-700 mt-4">Diagnosis Notes</label>
                <textarea id="diagnosis-notes" rows="4" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm"></textarea>
                <button id="save-diagnosis-btn" class="w-full bg-gradient-to-r from-[#f1c232] to-[#cc9244] text-white font-bold py-3 px-4 rounded-lg shadow-md mt-6">Save Diagnosis</button>
            </div>
        </div>
    </div>

    <!-- Report Details Modal -->
    <div id="report-details-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl m-4">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Full Report Details</h3>
                <button id="close-report-details-modal-btn" class="p-1"><i data-lucide="x"></i></button>
            </div>
            <div id="report-details-content" class="p-6 max-h-[80vh] overflow-y-auto">
                <!-- Report details will be loaded here dynamically -->
            </div>
            <div id="report-details-actions" class="p-4 border-t text-right">
                <!-- Action buttons like "Escalate" will be injected here -->
            </div>
        </div>
    </div>

    <!-- Escalation Modal -->
    <div id="escalation-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg m-4">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Escalate Report to Expert</h3>
                <button id="close-escalation-modal-btn" class="p-1"><i data-lucide="x"></i></button>
            </div>
            <div class="p-6 max-h-[80vh] overflow-y-auto">
                <p class="text-sm text-gray-600 mb-4">Please provide the following additional details before escalating this report to an expert for final diagnosis.</p>

                <label for="infestation-percentage" class="block text-sm font-medium text-gray-700">Percentage of Infestation (%)</label>
                <input type="number" id="infestation-percentage" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">

                <label for="samples-collected-date" class="block text-sm font-medium text-gray-700 mt-4">Date Samples Collected</label>
                <input type="date" id="samples-collected-date" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">

                <label for="farmer-contact" class="block text-sm font-medium text-gray-700 mt-4">Farmer's Contact Number</label>
                <input type="tel" id="farmer-contact" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">

                <label for="samples-notes" class="block text-sm font-medium text-gray-700 mt-4">Notes on Samples Collected (e.g., leaves, soil, roots)</label>
                <textarea id="samples-notes" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm"></textarea>

                <button id="confirm-escalate-btn" class="w-full bg-orange-600 text-white font-bold py-3 px-4 rounded-lg shadow-md mt-6">Confirm and Escalate</button>
            </div>
        </div>
    </div>

    <!-- Treatment Modal -->
    <div id="treatment-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg m-4">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Final Diagnosis & Treatment Plan</h3>
                <button id="close-treatment-modal-btn" class="p-1"><i data-lucide="x"></i></button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[80vh]">
                <div id="treatment-report-details" class="mb-4">
                    <!-- Report and diagnosis details will be loaded here -->
                </div>

                <h4 class="text-lg font-bold mt-4 mb-2">Final Diagnosis</h4>
                <label for="final-pest-disease-select" class="block text-sm font-medium text-gray-700">Identified Pest/Disease</label>
                 <select id="final-pest-disease-select" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    <option value="">Select a pest or disease...</option>
                </select>
                <div id="final-pest-disease-info" class="mt-4 p-3 bg-gray-50 rounded-lg border border-gray-200 text-sm hidden">
                    <!-- Final pest/disease info will be displayed here -->
                </div>
                <label for="final-diagnosis-notes" class="block text-sm font-medium text-gray-700 mt-4">Final Diagnosis Notes</label>
                <textarea id="final-diagnosis-notes" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm"></textarea>

                <h4 class="text-lg font-bold mt-6 mb-2">Add Treatment Plan</h4>

                <div id="treatment-plan-container" class="mt-4 space-y-4">
                    <div>
                        <label class="text-base font-medium text-gray-900">Prevention</label>
                        <div id="treatment-prevention-list" class="mt-2 space-y-2 text-sm">
                            <!-- Prevention checkboxes will be inserted here -->
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="text-base font-medium text-gray-900">Monitoring</label>
                        <div id="treatment-monitoring-list" class="mt-2 space-y-2 text-sm">
                            <!-- Monitoring checkboxes will be inserted here -->
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="text-base font-medium text-gray-900">Direct Control</label>
                        <div id="treatment-control-list" class="mt-2 space-y-2 text-sm">
                            <!-- Control checkboxes will be inserted here -->
                        </div>
                    </div>
                </div>


                <label for="treatment-instructions" class="block text-sm font-medium text-gray-700 mt-4">Specific Instructions</label>
                <textarea id="treatment-instructions" rows="4" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm"></textarea>

                <label for="follow-up-date" class="block text-sm font-medium text-gray-700 mt-4">Follow-up Date</label>
                <input type="date" id="follow-up-date" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">

                <div class="mt-6 flex flex-col sm:flex-row gap-4">
                    <button id="save-treatment-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md order-1 sm:order-2">Save Treatment Plan</button>
                    <button id="escalate-from-treatment-btn" class="w-full bg-orange-500 text-white font-bold py-3 px-4 rounded-lg shadow-md order-2 sm:order-1">Escalate to Expert</button>
                </div>
            </div>
        </div>
    </div>

    <div id="farm-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-40">
         <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Add New Farm Plot</h3>
                <button id="close-farm-modal-btn" class="p-1"><i data-lucide="x"></i></button>
            </div>
            <div class="p-6">
                <label for="farmName" class="block text-sm font-medium text-gray-700">Plot Name</label>
                <input type="text" id="farmName" placeholder="e.g., North Field" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                <label for="tobaccoVariety" class="block text-sm font-medium text-gray-700 mt-4">Tobacco Variety</label>
                <input type="text" id="tobaccoVariety" placeholder="e.g., Virginia" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                <label for="plantingDate" class="block text-sm font-medium text-gray-700 mt-4">Date of Planting</label>
                <input type="date" id="plantingDate" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                <button id="next-farm-map-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md mt-6">Next: Set Location</button>
            </div>
        </div>
    </div>

    <!-- Change Role Modal -->
    <div id="change-role-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Change Role for <span id="change-role-user-name"></span></h3>
                <button id="close-change-role-modal-btn" class="p-1"><i data-lucide="x"></i></button>
            </div>
            <div class="p-6">
                <label for="role-select" class="block text-sm font-medium text-gray-700">New Role</label>
                <select id="role-select" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                    <option>Farmer</option>
                    <option>Extension Worker</option>
                    <option>Branch Coordinator</option>
                    <option>Expert</option>
                    <option>Administrator</option>
                </select>
                <input type="hidden" id="change-role-user-id">
                <button id="save-role-change-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md mt-6">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Weather Advance Settings Modal -->
    <div id="weather-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl m-4">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Advanced Weather Settings</h3>
                <button id="close-weather-settings-btn" class="p-1"><i data-lucide="x"></i></button>
            </div>
            <div class="p-6 max-h-[80vh] overflow-y-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Left Column: Settings -->
                    <div>
                        <h4 class="text-lg font-bold mb-2">Time Settings</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="forecast-days" class="block text-sm font-medium text-gray-700">Forecast Days</label>
                                <input type="number" id="forecast-days" value="7" min="1" max="16" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="past-days" class="block text-sm font-medium text-gray-700">Past Days</label>
                                <input type="number" id="past-days" value="0" min="0" max="92" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                            </div>
                        </div>

                        <h4 class="text-lg font-bold mt-4 mb-2">Hourly Weather Variables</h4>
                        <div id="hourly-vars-multiselect-container" class="relative"></div>

                        <h4 class="text-lg font-bold mt-4 mb-2">Daily Weather Variables</h4>
                        <div id="daily-vars-multiselect-container" class="relative"></div>

                        <h4 class="text-lg font-bold mt-4 mb-2">Current Weather</h4>
                        <div id="current-vars-multiselect-container" class="relative"></div>

                        <div class="hidden">
                            <h4 class="text-lg font-bold mt-4 mb-2">API URL</h4>
                            <textarea id="weather-api-url" rows="3" class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm" readonly></textarea>
                        </div>
                    </div>

                    <!-- Right Column: Chart Preview -->
                    <div>
                        <h4 class="text-lg font-bold mb-2">Chart Preview</h4>
                        <div class="bg-gray-100 p-4 rounded-lg min-h-[400px]">
                            <canvas id="weather-chart-canvas"></canvas>
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex justify-between items-center">
                    <button id="clear-selections-btn" class="text-sm text-blue-600 hover:underline">Clear All Selections</button>
                    <div class="space-x-2">
                        <button id="print-chart-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md">Print Chart</button>
                        <button id="fullscreen-chart-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md">Full-screen</button>
                        <button id="preview-chart-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Preview Chart</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Address Data -->
    <script src="address-provider.js"></script>

    <!-- Leaflet JS for mapping -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <!-- Chart.js for weather chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the IDB library for offline storage
        import { openDB } from 'https://cdn.jsdelivr.net/npm/idb@8/+esm';

        // Import project-specific modules
        import { conditionGroups } from './src/climateTriggers.js';
        import { municipalityCoordinates } from './src/municipalityCoordinates.js';
        import { generateAdvisories, generateGeographicRisk, fetchWeatherForecast } from './src/predictive-modeling.js';

        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup,
            signInAnonymously,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            collection,
            addDoc,
            onSnapshot,
            serverTimestamp,
            getDocs,
            query,
            where,
            orderBy,
            limit,
            collectionGroup,
            arrayUnion
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import {
            getStorage,
            ref,
            uploadString,
            getDownloadURL,
            deleteObject
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // --- 1. FIREBASE CONFIGURATION ---
        // IMPORTANT: Replace with your project's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB3yPx1dWJQwqn-SglOjGzrQ6BAZFngMDc",
            authDomain: "pest-monitoring-app-ph.firebaseapp.com",
            projectId: "pest-monitoring-app-ph",
            storageBucket: "pest-monitoring-app-ph.firebasestorage.app",
            messagingSenderId: "948653534237",
            appId: "1:948653534237:web:dc195109343b4d5a12eaf4",
            measurementId: "G-YRFNHDN5VV"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- 2. PWA & OFFLINE SETUP ---
        let pestAndDiseaseData = {}; // Global variable to hold the data
        let pestImageData = {}; // Global variable to hold image data

        window.pestDiseaseDataPromise = (async function() {
            try {
                const response = await fetch('pestDiseases.json');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                pestAndDiseaseData = await response.json();
                console.log('Pest and disease data loaded successfully.');
                return true;
            } catch (error) {
                console.error('Failed to load pest and disease data:', error);
                pestAndDiseaseData = null;
                return false;
            }
        })();

        window.pestImageDataPromise = (async function() {
            try {
                const response = await fetch('pestImages.json');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                pestImageData = await response.json();
                console.log('Pest image data loaded successfully.');
                return true;
            } catch (error) {
                console.error('Failed to load pest image data:', error);
                pestImageData = null;
                return false;
            }
        })();

        // Initialize IndexedDB
        const dbPromise = openDB('agri-guard-db', 2, {
            upgrade(db, oldVersion, newVersion, transaction) {
                if (oldVersion < 1) {
                    db.createObjectStore('outbox', { autoIncrement: true });
                }
                if (oldVersion < 2) {
                    db.createObjectStore('submission_outbox', { autoIncrement: true });
                }
            },
        });
        console.log('IndexedDB setup initiated.');

        // Register the service worker for offline capabilities
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('ServiceWorker registration successful with scope: ', registration.scope))
                    .catch(err => console.log('ServiceWorker registration failed: ', err));
            });
        }
        
        // --- 3. UI & STATE MANAGEMENT ---
        let activeListeners = [];
        let currentLatitude = 17.5747; // Default fallback
        let currentLongitude = 120.3869; // Default fallback

        function detachAllListeners() {
            console.log(`Detaching ${activeListeners.length} active listeners.`);
            activeListeners.forEach(unsubscribe => unsubscribe());
            activeListeners = [];
        }

        const screens = {
            loading: document.getElementById('loading-screen'),
            login: document.getElementById('login-screen'),
            profile: document.getElementById('profile-screen'),
            farmList: document.getElementById('farm-list-screen'),
            dashboard: document.getElementById('dashboard-screen'),
            newSubmission: document.getElementById('new-submission-screen'),
            camera: document.getElementById('camera-screen'),
            reports: document.getElementById('reports-screen'),
            diagnosis: document.getElementById('diagnosis-screen'),
            treatment: document.getElementById('treatment-screen'),
            onlineClinic: document.getElementById('online-clinic-screen'),
            notifications: document.getElementById('notifications-screen'),
            privacyPolicy: document.getElementById('privacy-policy-screen'),
            farmSetup: document.getElementById('farm-setup-screen'),
            ewDashboard: document.getElementById('ew-dashboard-screen'),
            coordinatorDashboard: document.getElementById('coordinator-dashboard-screen'),
            expertDashboard: document.getElementById('expert-dashboard-screen'),
            adminDashboard: document.getElementById('admin-dashboard-screen'),
            advisory: document.getElementById('advisory-screen')
        };

        // --- Weather Settings Modal ---
        let hourlyWeatherSelect, dailyWeatherSelect, currentWeatherSelect;
        let weatherChart = null; // To hold the chart instance

        function updateWeatherApiUrl() {
            const lat = currentLatitude;
            const lon = currentLongitude;

            const forecastDays = document.getElementById('forecast-days').value;
            const pastDays = document.getElementById('past-days').value;
            const hourly = hourlyWeatherSelect.getSelectedValues();
            const daily = dailyWeatherSelect.getSelectedValues();
            const current = currentWeatherSelect.getSelectedValues();

            let apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`;

            if (hourly.length > 0) {
                apiUrl += `&hourly=${hourly.join(',')}`;
            }
            if (daily.length > 0) {
                apiUrl += `&daily=${daily.join(',')}`;
            }
            if (current.length > 0) {
                apiUrl += `&current=${current.join(',')}`;
            }

            apiUrl += `&forecast_days=${forecastDays}`;
            apiUrl += `&past_days=${pastDays}`;
            apiUrl += `&timezone=Asia/Manila`;

            document.getElementById('weather-api-url').value = apiUrl;
        }

        document.getElementById('preview-chart-btn').addEventListener('click', async () => {
            const apiUrl = document.getElementById('weather-api-url').value;
            if (!apiUrl) {
                showToast('API URL is not generated yet.', 'error');
                return;
            }

            showSavingOverlay('Loading chart data...');

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.reason || 'Failed to fetch weather data');
                }
                const data = await response.json();

                const canvas = document.getElementById('weather-chart-canvas');
                const ctx = canvas.getContext('2d');

                if (weatherChart) {
                    weatherChart.destroy();
                }

                if (!data.hourly || !data.hourly.time || Object.keys(data.hourly).length <= 1) {
                    showToast('No hourly data available to plot a chart.', 'info');
                    if(weatherChart) weatherChart.clear();
                    hideSavingOverlay();
                    return;
                }

                const datasets = [];
                const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
                let colorIndex = 0;

                for (const key in data.hourly) {
                    if (key === 'time') continue;

                    datasets.push({
                        label: `${key} (${data.hourly_units[key] || ''})`,
                        data: data.hourly[key],
                        borderColor: colors[colorIndex % colors.length],
                        backgroundColor: colors[colorIndex % colors.length] + '33', // with transparency
                        fill: false,
                        tension: 0.1,
                        yAxisID: key.includes('temperature') ? 'y_temp' : (key.includes('precipitation') ? 'y_precip' : 'y_other')
                    });
                    colorIndex++;
                }

                weatherChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.hourly.time.map(t => new Date(t).toLocaleString()),
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Time'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Hourly Weather Data Preview'
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('Error fetching or rendering chart:', error);
                showToast(`Chart Error: ${error.message}`, 'error');
            } finally {
                hideSavingOverlay();
            }
        });

        document.getElementById('fullscreen-chart-btn').addEventListener('click', () => {
            const chartContainer = document.getElementById('weather-chart-canvas').parentElement;
            if (chartContainer.requestFullscreen) {
                chartContainer.requestFullscreen();
            } else if (chartContainer.webkitRequestFullscreen) { /* Safari */
                chartContainer.webkitRequestFullscreen();
            } else if (chartContainer.msRequestFullscreen) { /* IE11 */
                chartContainer.msRequestFullscreen();
            }
        });

        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement && weatherChart) {
                // A short timeout can help ensure the DOM has fully exited fullscreen
                // before we ask the chart to resize.
                setTimeout(() => {
                    weatherChart.resize();
                }, 100);
            }
        });

        document.getElementById('print-chart-btn').addEventListener('click', () => {
            const chartCanvas = document.getElementById('weather-chart-canvas');
            if (!chartCanvas || !weatherChart) {
                showToast('Please generate a chart first.', 'error');
                return;
            }

            const printStyle = document.createElement('style');
            printStyle.id = 'print-styles';
            printStyle.innerHTML = `
                @media print {
                    body * {
                        visibility: hidden;
                    }
                    .chart-container-for-print, .chart-container-for-print * {
                        visibility: visible;
                    }
                    .chart-container-for-print {
                        position: absolute;
                        left: 0;
                        top: 0;
                        width: 100vw;
                        height: 100vh;
                    }
                }
            `;
            document.head.appendChild(printStyle);
            chartCanvas.parentElement.classList.add('chart-container-for-print');
            window.print();
        });

        window.onafterprint = () => {
            const printStyle = document.getElementById('print-styles');
            if (printStyle) {
                printStyle.remove();
            }
            const chartContainer = document.querySelector('.chart-container-for-print');
            if(chartContainer) {
                chartContainer.classList.remove('chart-container-for-print');
            }
        };

        document.getElementById('clear-selections-btn').addEventListener('click', () => {
            hourlyWeatherSelect.setSelectedValues([]);
            dailyWeatherSelect.setSelectedValues([]);
            currentWeatherSelect.setSelectedValues([]);
            updateWeatherApiUrl();
        });

        function initializeWeatherSettings() {
            function formatVariableName(str) {
                const overrides = {
                    'temperature_2m': 'Temperature (2m)',
                    'relative_humidity_2m': 'Relative Humidity (2m)',
                    'dew_point_2m': 'Dew Point (2m)',
                    'et0_fao_evapotranspiration': 'Reference Evapotranspiration (ET)',
                    'wind_speed_10m': 'Wind Speed (10m)',
                    'wind_direction_10m': 'Wind Direction (10m)',
                    'wind_gusts_10m': 'Wind Gusts (10m)',
                    'soil_temperature_0cm': 'Soil Temperature (0cm)',
                    'soil_temperature_6cm': 'Soil Temperature (6cm)',
                    'soil_temperature_18cm': 'Soil Temperature (18cm)',
                    'soil_temperature_54cm': 'Soil Temperature (54cm)',
                    'soil_moisture_0_to_1cm': 'Soil Moisture (0-1cm)',
                    'soil_moisture_1_to_3cm': 'Soil Moisture (1-3cm)',
                    'soil_moisture_3_to_9cm': 'Soil Moisture (3-9cm)',
                    'soil_moisture_9_to_27cm': 'Soil Moisture (9-27cm)',
                    'soil_moisture_27_to_81cm': 'Soil Moisture (27-81cm)',
                    'temperature_2m_max': 'Max Temperature (2m)',
                    'temperature_2m_min': 'Min Temperature (2m)',
                    'apparent_temperature_max': 'Max Apparent Temperature',
                    'apparent_temperature_min': 'Min Apparent Temperature',
                    'uv_index_max': 'Max UV Index',
                    'precipitation_probability_max': 'Max Precipitation Probability',
                    'wind_speed_10m_max': 'Max Wind Speed (10m)',
                    'wind_gusts_10m_max': 'Max Wind Gusts (10m)',
                    'wind_direction_10m_dominant': 'Dominant Wind Direction (10m)',
                    'shortwave_radiation_sum': 'Shortwave Radiation Sum'
                };
                if (overrides[str]) {
                    return overrides[str];
                }
                const result = str.replace(/_/g, ' ');
                return result.charAt(0).toUpperCase() + result.slice(1);
            }

            const hourlyVariableNames = [
                'temperature_2m', 'relative_humidity_2m', 'dew_point_2m', 'apparent_temperature',
                'precipitation_probability', 'precipitation', 'rain', 'showers', 'snowfall', 'snow_depth',
                'weather_code', 'pressure_msl', 'surface_pressure', 'cloud_cover', 'cloud_cover_low',
                'cloud_cover_mid', 'cloud_cover_high', 'visibility', 'evapotranspiration',
                'et0_fao_evapotranspiration', 'vapour_pressure_deficit', 'wind_speed_10m', 'wind_direction_10m',
                'wind_gusts_10m', 'soil_temperature_0cm', 'soil_temperature_6cm', 'soil_temperature_18cm', 'soil_temperature_54cm',
                'soil_moisture_0_to_1cm', 'soil_moisture_1_to_3cm', 'soil_moisture_3_to_9cm', 'soil_moisture_9_to_27cm', 'soil_moisture_27_to_81cm',
                'is_day', 'sunshine_duration', 'uv_index'
            ];
            const dailyVariableNames = [
                'weather_code', 'temperature_2m_max', 'temperature_2m_min', 'apparent_temperature_max',
                'apparent_temperature_min', 'sunrise', 'sunset', 'daylight_duration', 'sunshine_duration',
                'uv_index_max', 'precipitation_sum', 'rain_sum', 'showers_sum', 'snowfall_sum',
                'precipitation_hours', 'precipitation_probability_max', 'wind_speed_10m_max',
                'wind_gusts_10m_max', 'wind_direction_10m_dominant', 'shortwave_radiation_sum',
                'et0_fao_evapotranspiration'
            ];
             const currentVariableNames = [
                'temperature_2m', 'relative_humidity_2m', 'apparent_temperature', 'is_day', 'precipitation',
                'rain', 'showers', 'snowfall', 'weather_code', 'cloud_cover', 'pressure_msl',
                'surface_pressure', 'wind_speed_10m', 'wind_direction_10m', 'wind_gusts_10m'
            ];

            const hourlyVariables = hourlyVariableNames.map(v => ({ value: v, label: formatVariableName(v) })).sort((a, b) => a.label.localeCompare(b.label));
            const dailyVariables = dailyVariableNames.map(v => ({ value: v, label: formatVariableName(v) })).sort((a, b) => a.label.localeCompare(b.label));
            const currentVariables = currentVariableNames.map(v => ({ value: v, label: formatVariableName(v) })).sort((a, b) => a.label.localeCompare(b.label));

            hourlyWeatherSelect = createMultiSelect('hourly-vars-multiselect-container', 'Select Hourly Variables', true);
            hourlyWeatherSelect.populate(hourlyVariables);

            dailyWeatherSelect = createMultiSelect('daily-vars-multiselect-container', 'Select Daily Variables', true);
            dailyWeatherSelect.populate(dailyVariables);

            currentWeatherSelect = createMultiSelect('current-vars-multiselect-container', 'Select Current Variables', true);
            currentWeatherSelect.populate(currentVariables);

            const inputs = ['forecast-days', 'past-days'];
            inputs.forEach(id => {
                document.getElementById(id).addEventListener('input', updateWeatherApiUrl);
            });

            hourlyWeatherSelect.onChange(updateWeatherApiUrl);
            dailyWeatherSelect.onChange(updateWeatherApiUrl);
            currentWeatherSelect.onChange(updateWeatherApiUrl);

            // Also call it once to populate the URL initially
            updateWeatherApiUrl();
        }

        initializeWeatherSettings();

        // --- Privacy Policy Navigation ---
        document.getElementById('privacy-policy-link').addEventListener('click', (e) => {
            e.preventDefault();
            showScreen('privacyPolicy');
        });

        document.getElementById('close-privacy-policy-btn').addEventListener('click', () => {
            // This should ideally return to the previous screen.
            // For simplicity, we'll return to the login screen as the link is only there.
            showScreen('login');
        });

        // --- Camera Navigation ---
        document.getElementById('open-camera-btn').addEventListener('click', () => {
            showScreen('camera');
        });

        document.getElementById('back-to-submission-btn').addEventListener('click', () => {
            showScreen('newSubmission');
        });

        // --- Sidebar Navigation ---
        document.getElementById('nav-farm-list').addEventListener('click', () => {
            if (!userProfile) return;

            let screen;
            const context = {
                isFreshNavigation: true,
                userId: currentUser.uid,
                userName: userProfile.fullName,
                label: 'Dashboard'
            };

            if (userProfile.role === 'Extension Worker') {
                screen = 'ewDashboard';
            } else if (userProfile.role === 'Branch Coordinator') {
                screen = 'coordinatorDashboard';
            } else if (userProfile.role === 'Expert') {
                screen = 'expertDashboard';
            } else { // Default to Farmer
                screen = 'farmList';
            }
            showScreen(screen, context);
        });
        document.getElementById('nav-profile').addEventListener('click', () => showScreen('profile', { isFreshNavigation: true, label: 'My Profile' }));
        document.getElementById('nav-reports').addEventListener('click', () => showScreen('reports', { isFreshNavigation: true, label: 'All Reports' }));
        document.getElementById('nav-diagnosis').addEventListener('click', () => showScreen('diagnosis', { isFreshNavigation: true, label: 'For Diagnosis' }));
        document.getElementById('nav-treatment').addEventListener('click', () => showScreen('treatment', { isFreshNavigation: true, label: 'For Treatment' }));
        document.getElementById('nav-clinic').addEventListener('click', () => showScreen('onlineClinic', { isFreshNavigation: true, label: 'Online Clinic' }));
        document.getElementById('nav-notifications').addEventListener('click', () => showScreen('notifications', { isFreshNavigation: true, label: 'Notifications' }));
        document.getElementById('nav-admin').addEventListener('click', () => showScreen('adminDashboard', { isFreshNavigation: true, label: 'Admin Dashboard' }));
        document.getElementById('nav-advisory').addEventListener('click', () => showScreen('advisory', { isFreshNavigation: true, label: 'Predictive Advisory' }));
        document.getElementById('sidebar-logout-btn').addEventListener('click', () => signOut(auth));

        // --- Advisory Screen Logic ---
        function initializeAdvisoryScreen() {
            const provinceSelect = document.getElementById('province-select');
            const municipalitySelect = document.getElementById('municipality-select');
            const advisoryList = document.getElementById('advisory-list');

            if (!provinceSelect || !municipalitySelect || !advisoryList) return;

            // Add the delegated event listener for pest/disease links
            advisoryList.addEventListener('click', (e) => {
                const link = e.target.closest('.pest-advisory-link');
                if (link) {
                    e.preventDefault();
                    const pestName = link.dataset.pestName;
                    if (pestName) {
                        showPestDetailsByName(pestName);
                    }
                }
            });

            // Populate province dropdown
            const provinces = Object.keys(municipalityCoordinates);
            provinceSelect.innerHTML = '<option value="">Select a Province</option>';
            provinces.forEach(p => {
                const option = document.createElement('option');
                option.value = p;
                option.textContent = p;
                provinceSelect.appendChild(option);
            });
            provinceSelect.addEventListener('change', async (e) => {
                const selectedProvince = e.target.value;
                const advisoryListContainer = document.getElementById('advisory-list-container');
                const advisoryMapContainer = document.getElementById('advisory-map-container');
                const weatherDashboard = document.getElementById('weather-dashboard');

                // Reset everything
                advisoryListContainer.querySelector('#advisory-list').innerHTML = '';
                weatherDashboard.classList.add('hidden');
                municipalitySelect.innerHTML = '<option value="">Select a Municipality</option>';
                municipalitySelect.classList.add('hidden');
                advisoryMapContainer.classList.add('hidden');
                advisoryListContainer.classList.remove('hidden');

                if (!selectedProvince) return;

                // Populate municipality dropdown
                const municipalities = Object.keys(municipalityCoordinates[selectedProvince]);
                municipalities.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m;
                    option.textContent = m;
                    municipalitySelect.appendChild(option);
                });
                municipalitySelect.classList.remove('hidden');
            });

            municipalitySelect.addEventListener('change', async (e) => {
                const selectedMunicipality = e.target.value;
                const selectedProvince = provinceSelect.value;
                const advisoryListContainer = document.getElementById('advisory-list');
                const weatherDashboard = document.getElementById('weather-dashboard');
                const loadingIndicator = document.getElementById('advisory-loading');

                advisoryListContainer.innerHTML = '';
                weatherDashboard.classList.add('hidden');
                if (!selectedMunicipality) return;

                loadingIndicator.classList.remove('hidden');

                try {
                    const forecast = await fetchWeatherForecast(selectedProvince, selectedMunicipality);
                    renderWeatherDashboard(forecast);
                    weatherDashboard.classList.remove('hidden');

                    const advisoryData = await generateAdvisories(selectedProvince, selectedMunicipality);
                    renderAdvisories(advisoryData);
                } catch (error) {
                    console.error("Error fetching data for municipality:", error);
                    advisoryListContainer.innerHTML = `<p class="text-red-500">Could not load data for ${selectedMunicipality}.</p>`;
                }


                loadingIndicator.classList.add('hidden');
                lucide.createIcons();
            });

            document.getElementById('view-risk-map-btn').addEventListener('click', async () => {
                const advisoryListContainer = document.getElementById('advisory-list-container');
                const advisoryMapContainer = document.getElementById('advisory-map-container');
                const loadingIndicator = document.getElementById('advisory-loading');
                const weatherDashboard = document.getElementById('weather-dashboard');

                // Reset UI
                advisoryListContainer.querySelector('#advisory-list').innerHTML = '';
                weatherDashboard.classList.add('hidden');
                advisoryListContainer.classList.add('hidden');
                advisoryMapContainer.classList.remove('hidden');
                loadingIndicator.classList.remove('hidden');

                // Fetch all farm lots from all users
                const farmLots = [];
                try {
                    const usersSnapshot = await getDocs(collection(db, 'users'));
                    for (const userDoc of usersSnapshot.docs) {
                        const farmLotsCollection = collection(db, 'users', userDoc.id, 'farmLots');
                        const farmLotsSnapshot = await getDocs(farmLotsCollection);
                        farmLotsSnapshot.forEach(farmDoc => {
                            const farmData = farmDoc.data();
                            if (farmData.polygonCoordinates && farmData.polygonCoordinates.length > 0) {
                                farmLots.push(farmData);
                            }
                        });
                    }
                } catch (error) {
                    console.error("Error fetching farm lots for risk analysis:", error);
                    // Continue without farm data if it fails
                }

                const riskData = await generateGeographicRisk(farmLots);
                renderRiskMap(riskData.riskSummary, riskData.farmRiskCounts);

                loadingIndicator.classList.add('hidden');
            });
        }

        function renderAdvisories(data) {
            const container = document.getElementById('advisory-list');
            container.innerHTML = '';

            if (data.error) {
                container.innerHTML = `<p class="text-red-500">${data.error}</p>`;
                return;
            }

            if (Object.keys(data).length === 0) {
                container.innerHTML = `<p class="text-center text-gray-600 mt-8">No specific pest or disease risks detected in the 7-day forecast for this province.</p>`;
                return;
            }

            let html = `
                <div class="space-y-6">
                    <div>
                        <h3 class="text-xl font-bold text-gray-800 border-b-2 border-[#455b3c] pb-2 mb-4">When to Scout</h3>
                        ${renderScoutingSection(data)}
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-800 border-b-2 border-[#455b3c] pb-2 mb-4">Optimal Timing for Treatment</h3>
                        ${renderTreatmentSection(data)}
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        function renderScoutingSection(data) {
            const groupedAdvisories = {};

            // Group advisories by condition set
            Object.entries(data).forEach(([date, advisories]) => {
                advisories.forEach(advisory => {
                    const conditionKey = advisory.conditions.sort().join(',');
                    if (!groupedAdvisories[conditionKey]) {
                        groupedAdvisories[conditionKey] = {
                            title: conditionGroups[conditionKey] || "General Advisory",
                            pests: {}
                        };
                    }
                    if (!groupedAdvisories[conditionKey].pests[advisory.name]) {
                        groupedAdvisories[conditionKey].pests[advisory.name] = {
                            advice: advisory.scoutingAdvice,
                            dates: new Set()
                        };
                    }
                    groupedAdvisories[conditionKey].pests[advisory.name].dates.add(new Date(date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }));
                });
            });

            if (Object.keys(groupedAdvisories).length === 0) return '<p>No scouting advisories for the next 7 days.</p>';

            let content = '';
            for (const key in groupedAdvisories) {
                const group = groupedAdvisories[key];
                content += `
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <p class="font-bold text-lg text-[#384532]">${group.title}</p>`;

                for (const pestName in group.pests) {
                    const pestInfo = group.pests[pestName];
                    content += `
                        <div class="mt-3 pl-4 border-l-4 border-gray-200">
                            <a href="#" class="font-semibold text-md text-gray-800 hover:underline pest-advisory-link" data-pest-name="${pestName}">${pestName}</a>
                            <p class="text-sm text-gray-600 mt-1">${pestInfo.advice}</p>
                            <p class="text-sm font-semibold text-blue-600 mt-2">Favorable On: ${[...pestInfo.dates].join(', ')}</p>
                        </div>`;
                }
                content += `</div>`;
            }
            return content;
        }

        function renderTreatmentSection(data) {
            const groupedAdvisories = {};

            // Group advisories by condition set
            Object.entries(data).forEach(([date, advisories]) => {
                advisories.forEach(advisory => {
                    const conditionKey = advisory.conditions.sort().join(',');
                    if (!groupedAdvisories[conditionKey]) {
                        groupedAdvisories[conditionKey] = {
                            title: conditionGroups[conditionKey] || "General Advisory",
                            pests: {}
                        };
                    }
                    if (!groupedAdvisories[conditionKey].pests[advisory.name]) {
                        groupedAdvisories[conditionKey].pests[advisory.name] = {
                            advice: advisory.optimalTreatment,
                            dates: new Set()
                        };
                    }
                    groupedAdvisories[conditionKey].pests[advisory.name].dates.add(new Date(date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }));
                });
            });

            if (Object.keys(groupedAdvisories).length === 0) return '<p>No specific treatment timing advisories for the next 7 days.</p>';

            let content = '';
            for (const key in groupedAdvisories) {
                const group = groupedAdvisories[key];
                 content += `
                    <div class="bg-white p-4 rounded-lg shadow-sm mb-4">
                        <p class="font-bold text-lg text-[#384532]">${group.title}</p>`;

                for (const pestName in group.pests) {
                    const pestInfo = group.pests[pestName];
                    content += `
                        <div class="mt-3 pl-4 border-l-4 border-gray-200">
                            <a href="#" class="font-semibold text-md text-gray-800 hover:underline pest-advisory-link" data-pest-name="${pestName}">${pestName}</a>
                            <p class="text-sm text-gray-600 mt-1">${pestInfo.advice}</p>
                            <p class="text-sm font-semibold text-red-600 mt-2">Highest Risk Period: ${[...pestInfo.dates].join(', ')}</p>
                        </div>`;
                }
                 content += `</div>`;
            }
            return content;
        }

        let advisoryWeatherChart = null;
        function renderWeatherDashboard(forecast) {
            const canvas = document.getElementById('weather-chart-canvas-advisory');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            if (advisoryWeatherChart) {
                advisoryWeatherChart.destroy();
            }

            if (!forecast || !forecast.daily || !forecast.daily.time) {
                return;
            }

            advisoryWeatherChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: forecast.daily.time.map(t => new Date(t).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })),
                    datasets: [
                        {
                            label: 'Max Temp (C)',
                            data: forecast.daily.temperature_2m_max,
                            backgroundColor: 'rgba(255, 99, 132, 0.5)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            yAxisID: 'y_temp',
                            type: 'line',
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: 'Min Temp (C)',
                            data: forecast.daily.temperature_2m_min,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            yAxisID: 'y_temp',
                            type: 'line',
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: 'Precipitation (mm)',
                            data: forecast.daily.precipitation_sum,
                            backgroundColor: 'rgba(75, 192, 192, 0.5)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            yAxisID: 'y_precip',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                        },
                        y_temp: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Temperature (C)'
                            }
                        },
                        y_precip: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Precipitation (mm)'
                            },
                            grid: {
                                drawOnChartArea: false, // only draw grid for temp axis
                            },
                        }
                    }
                }
            });
        }

        let advisoryMap = null;
        function renderRiskMap(data, farmRiskCounts) {
            const mapContainer = document.getElementById('advisory-map');
            if (!mapContainer) return;

            // Clear previous map instance
            if (advisoryMap) {
                advisoryMap.remove();
                advisoryMap = null;
            }

            advisoryMap = L.map(mapContainer).setView([17.5, 121.0], 7); // Centered on Northern Luzon
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(advisoryMap);

            if (data.error) {
                mapContainer.innerHTML = `<p class="text-red-500 p-4">${data.error}</p>`;
                return;
            }

            const allScores = Object.values(data).flatMap(province => Object.values(province).map(mun => mun.score)).filter(s => s > 0);
            const maxScore = Math.max(...allScores, 1); // Avoid division by zero

            for (const provinceName in data) {
                for (const municipalityName in data[provinceName]) {
                    const municipalityData = data[provinceName][municipalityName];
                    if (municipalityData.score === -1) continue;

                    const { lat, lng } = municipalityData.coords;
                    const riskScore = municipalityData.score;

                    let color = '#4ade80'; // green
                    if (riskScore > maxScore * 0.66) {
                        color = '#f87171'; // red
                    } else if (riskScore > maxScore * 0.33) {
                        color = '#facc15'; // yellow
                    }

                    const circle = L.circle([lat, lng], {
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.6,
                        radius: 8000 // 8km radius
                    }).addTo(advisoryMap);

                    circle.bindPopup(`<b>${municipalityName}, ${provinceName}</b><br>Risk Score: ${riskScore}`);
                }
            }

            // Add legend
            const legend = L.control({position: 'bottomright'});
            legend.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'info legend bg-white p-2 rounded-md shadow-md');
                const grades = [0, Math.ceil(maxScore * 0.33), Math.ceil(maxScore * 0.66)];
                const labels = ['<strong>Risk Level</strong>'];
                const colors = ['#4ade80', '#facc15', '#f87171'];

                for (let i = 0; i < grades.length; i++) {
                    labels.push(
                        `<i style="background:${colors[i]}; width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.7;"></i> ` +
                        grades[i] + (grades[i + 1] ? `&ndash;${grades[i + 1] - 1}` : '+'));
                }
                div.innerHTML = labels.join('<br>');
                return div;
            };
            legend.addTo(advisoryMap);

            // --- New: Update Farm Risk Stats ---
            const statsContainer = document.getElementById('farm-risk-stats-content');
            if (statsContainer && farmRiskCounts) {
                statsContainer.innerHTML = `
                    <div class="flex items-center text-sm mb-1">
                        <span class="w-4 h-4 rounded-full mr-2" style="background-color: #f87171;"></span>
                        <span class="font-medium text-gray-700">High Risk:</span>
                        <span class="ml-auto font-bold text-gray-900">${farmRiskCounts.high} farms</span>
                    </div>
                    <div class="flex items-center text-sm mb-1">
                        <span class="w-4 h-4 rounded-full mr-2" style="background-color: #facc15;"></span>
                        <span class="font-medium text-gray-700">Moderate Risk:</span>
                        <span class="ml-auto font-bold text-gray-900">${farmRiskCounts.moderate} farms</span>
                    </div>
                    <div class="flex items-center text-sm">
                        <span class="w-4 h-4 rounded-full mr-2" style="background-color: #4ade80;"></span>
                        <span class="font-medium text-gray-700">Low Risk:</span>
                        <span class="ml-auto font-bold text-gray-900">${farmRiskCounts.low} farms</span>
                    </div>
                     ${farmRiskCounts.unknown > 0 ? `
                    <div class="flex items-center text-xs mt-2 text-gray-500">
                        <span class="w-3 h-3 rounded-full mr-2 bg-gray-400"></span>
                        <span>${farmRiskCounts.unknown} farms couldn't be located.</span>
                    </div>` : ''}
                `;
            }
        }


        // --- Pest/Disease Card Logic ---
        function showPestDetailsByName(name) {
            const allItems = [
                ...(pestAndDiseaseData.major_insect_pests || []).map(p => ({...p, type: 'Pest'})),
                ...(pestAndDiseaseData.fungal_and_bacterial_diseases || []).map(d => ({...d, type: 'Disease'}))
            ];
            const item = allItems.find(i => (i['Pest Common Name'] || i['Disease Name']) === name);

            if (!item) {
                console.error(`Details for "${name}" not found.`);
                showToast(`Details for "${name}" not found.`, 'error');
                return;
            }

            const modal = document.getElementById('pest-details-modal');
            const title = document.getElementById('pest-modal-title');
            const content = document.getElementById('pest-modal-content');

            title.textContent = name;
            let contentHTML = `<p class="text-sm text-gray-600 mb-4">${item['Characteristic Visual Damage'] || item['Primary Visual Symptoms']}</p>`;

            if (item.management) {
                contentHTML += '<h5 class="font-bold mt-4 text-lg border-b pb-1 mb-2">Management</h5>';
                const { prevention, monitoring, direct_control } = item.management;

                if (prevention && prevention.length > 0) {
                    contentHTML += `
                        <div class="mt-3">
                            <div class="flex items-center">
                                <i data-lucide="shield" class="w-5 h-5 mr-2 text-blue-600"></i>
                                <h6 class="font-semibold text-gray-800">Prevention</h6>
                            </div>
                            <ul class="list-disc list-inside pl-7 text-sm text-gray-700 mt-1 space-y-1">
                                ${prevention.map(i => `<li>${i}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }

                if (monitoring && monitoring.length > 0) {
                    contentHTML += `
                        <div class="mt-4">
                            <div class="flex items-center">
                                <i data-lucide="search" class="w-5 h-5 mr-2 text-yellow-600"></i>
                                <h6 class="font-semibold text-gray-800">Monitoring</h6>
                            </div>
                            <ul class="list-disc list-inside pl-7 text-sm text-gray-700 mt-1 space-y-1">
                                ${monitoring.map(i => `<li>${i}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }

                if (direct_control && direct_control.length > 0) {
                    contentHTML += `
                        <div class="mt-4">
                            <div class="flex items-center">
                                <i data-lucide="syringe" class="w-5 h-5 mr-2 text-red-600"></i>
                                <h6 class="font-semibold text-gray-800">Direct Control</h6>
                            </div>
                            <ul class="list-disc list-inside pl-7 text-sm text-gray-700 mt-1 space-y-1">
                                ${direct_control.map(i => `<li>${i}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
            }

            content.innerHTML = contentHTML;
            lucide.createIcons();

            const panel = document.getElementById('pest-details-panel');
            modal.classList.remove('hidden');
            setTimeout(() => { // Allow display:block to take effect before starting transition
                panel.classList.remove('translate-x-full');
            }, 10);
        }

        async function loadPestAndDiseaseCards() {
            const container = document.getElementById('pest-cards-container');
            if (!container) return;
            container.innerHTML = '';

            await Promise.all([window.pestDiseaseDataPromise, window.pestImageDataPromise]);

            if (!pestAndDiseaseData || (!pestAndDiseaseData.major_insect_pests && !pestAndDiseaseData.fungal_and_bacterial_diseases)) {
                container.innerHTML = '<p class="text-white">Could not load pest and disease data.</p>';
                return;
            }

            const imageMap = new Map();
            if (pestImageData && pestImageData.pests) {
                pestImageData.pests.forEach(p => imageMap.set(p.name, p.image_url));
            }
            if (pestImageData && pestImageData.diseases) {
                pestImageData.diseases.forEach(d => imageMap.set(d.name, d.image_url));
            }

            const allItems = [
                ...(pestAndDiseaseData.major_insect_pests || []).map(p => ({...p, type: 'Pest'})),
                ...(pestAndDiseaseData.fungal_and_bacterial_diseases || []).map(d => ({...d, type: 'Disease'}))
            ];

            allItems.forEach(item => {
                const card = document.createElement('div');
                card.className = 'pest-card rounded-lg overflow-hidden m-2';

                const name = item['Pest Common Name'] || item['Disease Name'];
                const imageUrl = imageMap.get(name) || 'https://placehold.co/200x150/cccccc/333333?text=' + name.split(' ').join('+');

                card.innerHTML = `
                    <img src="${imageUrl}" alt="${name}" class="w-full h-full object-cover">
                `;

                const nameContainer = document.createElement('div');
                nameContainer.className = 'pest-name';

                const nameText = document.createElement('p');
                nameText.textContent = name;
                nameContainer.appendChild(nameText);

                // Check if the text is long and add the animation class
                // This is a rough estimation. A better way would be to measure the text width in the DOM.
                if (name.length > 20) {
                    nameContainer.classList.add('is-long');
                }

                card.appendChild(nameContainer);

                card.addEventListener('click', () => {
                    showPestDetailsByName(name);
                });

                container.appendChild(card);
            });
        }

        document.getElementById('close-pest-details-modal-btn').addEventListener('click', () => {
            const modal = document.getElementById('pest-details-modal');
            const panel = document.getElementById('pest-details-panel');

            panel.classList.add('translate-x-full');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300); // Match transition duration
        });

        document.getElementById('close-weather-settings-btn').addEventListener('click', () => {
            document.getElementById('weather-settings-modal').classList.add('hidden');
            document.getElementById('weather-settings-modal').classList.remove('flex');
        });

        // --- Weather Dashboard Logic ---
        async function loadWeatherDashboard() {
            const container = document.getElementById('weather-dashboard-container');
            if (!container) return;

            container.innerHTML = `<div class="text-center text-white p-6"><p>Fetching location...</p></div>`;

            const locationSuccess = (position) => {
                const { latitude, longitude } = position.coords;
                fetchAndDisplayWeather(latitude, longitude);
            };

            const locationError = (error) => {
                console.warn(`Could not get location (${error.code}): ${error.message}`);
                // Fallback to default location
                fetchAndDisplayWeather(17.5747, 120.3869);
            };

            if ('geolocation' in navigator) {
                navigator.geolocation.getCurrentPosition(locationSuccess, locationError, {
                    enableHighAccuracy: false,
                    timeout: 10000,
                    maximumAge: 0
                });
            } else {
                console.warn('Geolocation is not supported by this browser.');
                locationError({ code: -1, message: "Geolocation not supported" });
            }
        }

        async function fetchAndDisplayWeather(lat, lon) {
            currentLatitude = lat;
            currentLongitude = lon;
            const container = document.getElementById('weather-dashboard-container');
            container.innerHTML = `<div class="text-center text-white p-6"><p>Loading weather data...</p></div>`;

            // 1. Reverse Geocoding to get location name
            let locationName = "Unknown Location";
            try {
                const geoResponse = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                const geoData = await geoResponse.json();
                if (geoData.address) {
                    locationName = `${geoData.address.village || geoData.address.town || geoData.address.city}, ${geoData.address.country}`;
                }
            } catch (e) {
                console.error("Reverse geocoding failed:", e);
            }

            // 2. Fetch comprehensive weather data
            const weatherParams = "temperature_2m,relative_humidity_2m,weather_code,surface_pressure,wind_speed_10m,wind_direction_10m,soil_moisture_0_to_1cm,et0_fao_evapotranspiration";
            const hourlyParams = "precipitation_probability";
            const dailyParams = "sunrise,sunset";
            const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=${weatherParams}&hourly=${hourlyParams}&daily=${dailyParams}&timezone=Asia/Manila&forecast_days=1`;

            try {
                const weatherResponse = await fetch(apiUrl);
                if (!weatherResponse.ok) {
                    throw new Error('Weather data not available');
                }
                const data = await weatherResponse.json();
                const weather = data.current;
                const daily = data.daily;

                const { text, icon } = getWeatherInfo(weather.weather_code);
                const sunrise = new Date(daily.sunrise[0]).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const sunset = new Date(daily.sunset[0]).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const hourly = data.hourly;

                const generateRainForecastHTML = (hourly) => {
                    if (!hourly || !hourly.time || !hourly.precipitation_probability) {
                        return '';
                    }

                    const now = new Date();
                    // Find the index of the first future or current hour in the time array
                    let startIndex = hourly.time.findIndex(time => new Date(time) >= now);
                    if (startIndex === -1) { // If all times are in the past, just start from the last possible block
                        startIndex = Math.max(0, hourly.time.length - 12);
                    }

                    let forecastHTML = '<div class="mt-4 pt-4 border-t border-white/20"><h4 class="text-lg font-bold text-white mb-2 text-center">12-Hour Rain Forecast</h4><div class="flex justify-between text-center">';

                    let hoursAdded = 0;
                    for (let i = 0; i < 6; i++) {
                        const timeIndex1 = startIndex + (i * 2);
                        const timeIndex2 = timeIndex1 + 1;

                        if (timeIndex2 >= hourly.time.length) break;

                        const label = i === 0 ? "Now" : `+${i*2}h`;
                        const prob1 = hourly.precipitation_probability[timeIndex1];
                        const prob2 = hourly.precipitation_probability[timeIndex2];
                        const maxProb = Math.round(Math.max(prob1, prob2));

                        forecastHTML += `
                            <div class="flex-1">
                                <p class="text-sm font-semibold">${label}</p>
                                <i data-lucide="cloud-drizzle" class="w-6 h-6 mx-auto my-1 text-blue-200"></i>
                                <p class="text-xs">${maxProb}%</p>
                            </div>
                        `;
                        hoursAdded++;
                    }

                    if (hoursAdded === 0) return ''; // Do not show the section if no forecast could be generated

                    forecastHTML += '</div></div>';
                    return forecastHTML;
                };

                const weatherHTML = `
                    <div class="bg-black bg-opacity-20 p-6 rounded-lg shadow-lg backdrop-blur-sm border border-white/10 w-full max-w-md">
                        <div class="text-center mb-4">
                            <h3 class="text-2xl font-bold text-white">Weather Dashboard</h3>
                            <p class="text-lg text-gray-300">${locationName}</p>
                        </div>
                        <div class="flex items-center justify-center space-x-4 mb-6">
                            <i data-lucide="${icon}" class="w-20 h-20 text-[#f1c232]"></i>
                            <div>
                                <p class="text-6xl font-bold text-white">${Math.round(weather.temperature_2m)}C</p>
                                <p class="text-xl text-gray-200 capitalize -mt-1">${text}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-white">
                            <div class="text-center bg-white/10 p-3 rounded-lg">
                                <i data-lucide="droplets" class="w-6 h-6 mx-auto mb-1 text-blue-300"></i>
                                <p class="font-bold text-gray-300 text-sm">Humidity</p>
                                <p>${weather.relative_humidity_2m}%</p>
                            </div>
                            <div class="text-center bg-white/10 p-3 rounded-lg">
                                <i data-lucide="wind" class="w-6 h-6 mx-auto mb-1 text-gray-300"></i>
                                <p class="font-bold text-gray-300 text-sm">Wind</p>
                                <p>${weather.wind_speed_10m} km/h</p>
                            </div>
                             <div class="text-center bg-white/10 p-3 rounded-lg">
                                <i data-lucide="compass" class="w-6 h-6 mx-auto mb-1 text-gray-300" style="transform: rotate(${weather.wind_direction_10m}deg);"></i>
                                <p class="font-bold text-gray-300 text-sm">Direction</p>
                                <p>${weather.wind_direction_10m}</p>
                            </div>
                            <div class="text-center bg-white/10 p-3 rounded-lg">
                                <i data-lucide="thermometer-snowflake" class="w-6 h-6 mx-auto mb-1 text-green-300"></i>
                                <p class="font-bold text-gray-300 text-sm">Soil Moisture</p>
                                <p>${(weather.soil_moisture_0_to_1cm || 0).toFixed(3)} m/m</p>
                            </div>
                            <div class="text-center bg-white/10 p-3 rounded-lg">
                                <i data-lucide="sunrise" class="w-6 h-6 mx-auto mb-1 text-orange-300"></i>
                                <p class="font-bold text-gray-300 text-sm">Sunrise</p>
                                <p>${sunrise}</p>
                            </div>
                            <div class="text-center bg-white/10 p-3 rounded-lg">
                                <i data-lucide="sunset" class="w-6 h-6 mx-auto mb-1 text-purple-300"></i>
                                <p class="font-bold text-gray-300 text-sm">Sunset</p>
                                <p>${sunset}</p>
                            </div>
                        </div>
                         <div class="text-center bg-white/10 p-3 rounded-lg mt-4">
                            <i data-lucide="leaf" class="w-6 h-6 mx-auto mb-1 text-lime-300"></i>
                            <p class="font-bold text-gray-300 text-sm">Evapotranspiration (FAO)</p>
                            <p>${(weather.et_0_fao_evapotranspiration || 0).toFixed(3)} mm</p>
                        </div>
                        ${generateRainForecastHTML(hourly)}
                         <div class="mt-4 text-center">
                            <button id="open-weather-settings-btn" class="text-white font-bold py-2 px-4 rounded-lg shadow-md bg-white/20 hover:bg-white/30">
                                Advance Settings
                            </button>
                        </div>
                    </div>
                `;
                container.innerHTML = weatherHTML;
                lucide.createIcons();

                document.getElementById('open-weather-settings-btn').addEventListener('click', () => {
                    document.getElementById('weather-settings-modal').classList.remove('hidden');
                    document.getElementById('weather-settings-modal').classList.add('flex');
                    lucide.createIcons(); // Re-render icons in the modal
                });

            } catch (error) {
                console.error('Error fetching weather data:', error);
                container.innerHTML = `<div class="text-center text-white p-6 bg-red-500/30 rounded-lg"><p>Could not load weather data.</p></div>`;
            }
        }

        function getWeatherInfo(code) {
            const weatherMap = {
                0: { text: "Clear sky", icon: "sun" },
                1: { text: "Mainly clear", icon: "sun" },
                2: { text: "Partly cloudy", icon: "cloud-sun" },
                3: { text: "Overcast", icon: "cloud" },
                45: { text: "Fog", icon: "cloud-fog" },
                46: { text: "Depositing rime fog", icon: "cloud-fog" },
                51: { text: "Light drizzle", icon: "cloud-drizzle" },
                53: { text: "Moderate drizzle", icon: "cloud-drizzle" },
                55: { text: "Dense drizzle", icon: "cloud-drizzle" },
                61: { text: "Slight rain", icon: "cloud-rain" },
                63: { text: "Moderate rain", icon: "cloud-rain" },
                65: { text: "Heavy rain", icon: "cloud-rain" },
                80: { text: "Slight rain showers", icon: "cloud-hail" },
                81: { text: "Moderate rain showers", icon: "cloud-hail" },
                82: { text: "Violent rain showers", icon: "cloud-hail" },
            };
            return weatherMap[code] || { text: "Unknown", icon: "cloud-question" };
        }


        // --- Sidebar is now fixed, toggle logic removed ---

        let currentUser = null;
        let userProfile = null;
        let selectedRole = 'Farmer';
        let navigationHistory = [];

        function updateNavigationControls() {
            const activeScreen = document.querySelector('.screen.active');
            if (!activeScreen) return;

            const backButton = activeScreen.querySelector('.back-button');

            if (backButton) {
                if (navigationHistory.length > 1) {
                    backButton.classList.remove('hidden');
                } else {
                    backButton.classList.add('hidden');
                }
            }

            updateBreadcrumbs();
        }

        function updateBreadcrumbs() {
            const activeScreen = document.querySelector('.screen.active');
            if (!activeScreen) return;
            const breadcrumbsContainer = activeScreen.querySelector('.breadcrumbs');
            if (!breadcrumbsContainer) return;

            breadcrumbsContainer.innerHTML = ''; // Clear old breadcrumbs

            navigationHistory.forEach((state, index) => {
                const label = state.context.label || state.screenName;

                if (index < navigationHistory.length - 1) {
                    // It's a link
                    const link = document.createElement('a');
                    link.href = '#';
                    link.textContent = label;
                    link.dataset.historyIndex = index;
                    link.className = 'hover:underline';
                    breadcrumbsContainer.appendChild(link);

                    const separator = document.createElement('span');
                    separator.textContent = ' / ';
                    separator.className = 'mx-2';
                    breadcrumbsContainer.appendChild(separator);
                } else {
                    // It's the current page, just text
                    const current = document.createElement('span');
                    current.textContent = label;
                    current.className = 'font-semibold text-gray-700';
                    breadcrumbsContainer.appendChild(current);
                }
            });
        }

        document.getElementById('screen-container').addEventListener('click', (e) => {
            const backButton = e.target.closest('.back-button');
            const breadcrumbLink = e.target.closest('.breadcrumbs a');

            if (backButton) {
                if (navigationHistory.length > 1) {
                    navigationHistory.pop(); // Remove the current screen
                    const lastState = navigationHistory[navigationHistory.length - 1];
                    showScreen(lastState.screenName, lastState.context, true);
                }
            } else if (breadcrumbLink) {
                e.preventDefault();
                const historyIndex = parseInt(breadcrumbLink.dataset.historyIndex, 10);

                // Truncate the history to the point we are navigating back to
                navigationHistory = navigationHistory.slice(0, historyIndex + 1);

                const lastState = navigationHistory[navigationHistory.length - 1];
                showScreen(lastState.screenName, lastState.context, true);
            }
        });

        // Function to switch between screens
        async function showScreen(screenName, context = {}, isBack = false) {
            if (!isBack) {
                if (context.isFreshNavigation) {
                    navigationHistory = [{ screenName, context }];
                } else {
                    const lastState = navigationHistory[navigationHistory.length - 1];
                    if (!lastState || lastState.screenName !== screenName || JSON.stringify(lastState.context) !== JSON.stringify(context)) {
                        navigationHistory.push({ screenName, context });
                    }
                }
            }

            detachAllListeners(); // Clean up listeners from the previous screen

            // Stop camera if navigating away from it
            if (mediaStream && screenName !== 'camera') {
                stopCamera();
            }

            const sidebar = document.getElementById('sidebar');
            const screenContainer = document.getElementById('screen-container');
            const noSidebarScreens = ['loading', 'login', 'camera', 'privacyPolicy'];

            if (noSidebarScreens.includes(screenName)) {
                sidebar.classList.add('hidden');
                screenContainer.classList.remove('with-sidebar');
            } else {
                sidebar.classList.remove('hidden');
                screenContainer.classList.add('with-sidebar');
            }

            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            if (screens[screenName]) {
                screens[screenName].classList.add('active');
            }

            // The context for the current screen is from the last item in history.
            const currentContext = navigationHistory.length > 0 ? navigationHistory[navigationHistory.length - 1].context : {};

            // Attach listeners and load data for the new screen
            switch (screenName) {
                case 'farmList':
                    loadFarms(currentContext);
                    break;
                case 'dashboard':
                    currentFarmId = currentContext.farmId; // Still needed by some functions
                    loadSubmissions(currentContext);
                    document.getElementById('dashboard-farm-name').textContent = currentContext.farmName || 'Farm Health Log';
                    document.getElementById('dashboard-farm-variety').textContent = currentContext.tobaccoVariety || '';
                    break;
                case 'reports':
                    loadAllReports();
                    break;
                case 'camera':
                    startCamera();
                    break;
                case 'diagnosis':
                    loadReportsForDiagnosis();
                    break;
                case 'treatment':
                    loadReportsForTreatment();
                    break;
                case 'onlineClinic':
                    if (userProfile && userProfile.role === 'Expert') {
                        loadOnlineClinicReports();
                    }
                    break;
                case 'ewDashboard':
                    loadExtensionWorkerDashboard(currentContext);
                    break;
                case 'coordinatorDashboard':
                    loadCoordinatorDashboard(currentContext);
                    break;
                case 'expertDashboard':
                if (!window.expertFiltersInitialized) {
                    initializeExpertDashboardFilters();
                    window.expertFiltersInitialized = true;
                }
                    loadExpertStats();
                    loadExpertMap();
                    break;
                case 'adminDashboard':
                    loadAdminUserManagement(); // Default to users tab
                    attachAdminTabListeners();
                    break;
            case 'advisory':
                initializeAdvisoryScreen();
                break;
                case 'newSubmission':
                    await initializeReportMap(currentContext);
                    break;
            }

            lucide.createIcons();
            updateNavigationControls();
        }

        function updateUIVisibilityBasedOnRole() {
            if (!userProfile) return;

            const roles = {
                isFarmer: userProfile.role === 'Farmer',
                isWorker: userProfile.role === 'Extension Worker',
                isCoordinator: userProfile.role === 'Branch Coordinator',
                isExpert: userProfile.role === 'Expert',
                isAdmin: userProfile.role === 'Administrator'
            };

            const nav = {
                farmList: document.getElementById('nav-farm-list'),
                profile: document.getElementById('nav-profile'),
                reports: document.getElementById('nav-reports'),
                diagnosis: document.getElementById('nav-diagnosis'),
                treatment: document.getElementById('nav-treatment'),
                clinic: document.getElementById('nav-clinic'),
                admin: document.getElementById('nav-admin')
            };

            // Hide all role-specific nav items by default
            Object.values(nav).forEach(item => item.style.display = 'none');

            // Show items common to most roles
            nav.profile.style.display = 'block';
            nav.reports.style.display = 'block';

            if (roles.isFarmer) {
                nav.farmList.style.display = 'block';
            } else if (roles.isWorker) {
                nav.farmList.style.display = 'block';
                nav.diagnosis.style.display = 'block';
            } else if (roles.isCoordinator) {
                nav.farmList.style.display = 'block';
                nav.diagnosis.style.display = 'block';
                nav.treatment.style.display = 'block';
            } else if (roles.isExpert) {
                nav.farmList.style.display = 'block';
                nav.clinic.style.display = 'block';
            } else if (roles.isAdmin) {
                nav.admin.style.display = 'block';
                // Farm list is intentionally hidden for admins
            }
        }

        let toastTimeout;
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');

            toastMessage.textContent = message;

            // Reset classes
            toast.className = 'fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-md transition-opacity duration-300';

            if (type === 'success') {
                toast.classList.add('bg-green-600');
            } else if (type === 'error') {
                toast.classList.add('bg-red-600');
            } else {
                toast.classList.add('bg-gray-800');
            }

            toast.classList.remove('opacity-0');

            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                toast.classList.add('opacity-0');
            }, 3000);
        }

        function showSavingOverlay(message = 'Saving...') {
            document.getElementById('saving-message').textContent = message;
            const overlay = document.getElementById('saving-overlay');
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
        }

        function hideSavingOverlay() {
            const overlay = document.getElementById('saving-overlay');
            overlay.classList.add('hidden');
            overlay.classList.remove('flex');
        }

        // --- CAMERA LOGIC ---
        const cameraFeed = document.getElementById('camera-feed');
        const photoCanvas = document.getElementById('photo-canvas');
        const capturePhotoBtn = document.getElementById('capture-photo-btn');
        const recordVideoBtn = document.getElementById('record-video-btn');
        let mediaStream = null;
        let mediaRecorder = null;
        let recordedChunks = [];

        async function startCamera() {
            try {
                if (!('mediaDevices' in navigator) || !('getUserMedia' in navigator.mediaDevices)) {
                    throw new Error('Camera API is not available in this browser.');
                }

                const constraints = {
                    video: {
                        facingMode: 'environment', // Prioritize back camera
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };

                mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraFeed.srcObject = mediaStream;
                cameraFeed.play();
            } catch (error) {
                console.error('Error accessing camera:', error);
                showToast(`Could not access camera: ${error.message}`, 'error');
                // Fallback or show an error message
                showScreen('newSubmission');
            }
        }

        function stopCamera() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
        }

        capturePhotoBtn.addEventListener('click', () => {
            const context = photoCanvas.getContext('2d');
            photoCanvas.width = cameraFeed.videoWidth;
            photoCanvas.height = cameraFeed.videoHeight;
            context.drawImage(cameraFeed, 0, 0, photoCanvas.width, photoCanvas.height);

            photoCanvas.toBlob(blob => {
                handleFiles([blob]);
            }, 'image/jpeg', 0.9);

            // Stop the camera and go back to the form
            stopCamera();
            showScreen('newSubmission');
        });

        recordVideoBtn.addEventListener('click', () => {
            // Placeholder for video recording functionality
            showToast('Video recording is not yet implemented.', 'info');
        });


        // --- MAP & FARM SETUP LOGIC ---
        let map;
        let reportMap;
        let drawnItems;
        let pendingFarmData = {};

        async function initializeMapForEdit(farmId) {
             if (!currentUser || !farmId) return;

            try {
                const farmDocRef = doc(db, 'users', currentUser.uid, 'farmLots', farmId);
                const farmDocSnap = await getDoc(farmDocRef);

                if (farmDocSnap.exists()) {
                    const farmData = farmDocSnap.data();
                    const coordinates = farmData.polygonCoordinates;

                    if (coordinates && coordinates.length > 0) {
                        const latLngs = coordinates.map(c => [c.lat, c.lng]);
                        const polygon = L.polygon(latLngs, {color: '#22c55e'});

                        drawnItems.clearLayers();
                        drawnItems.addLayer(polygon);
                        map.fitBounds(polygon.getBounds());
                        document.getElementById('save-farm-map-btn').disabled = false;
                    }
                }
            } catch (error) {
                console.error("Error loading farm data for editing:", error);
            }
        }

        async function initializeReportMap(context) {
            const farmId = context.farmId;
            const targetUserId = context.userId || currentUser.uid;

            if (!currentUser || !farmId) return;

            try {
                const farmDocRef = doc(db, 'users', targetUserId, 'farmLots', farmId);
                const farmDocSnap = await getDoc(farmDocRef);

                if (farmDocSnap.exists()) {
                    const farmData = farmDocSnap.data();
                    const coordinates = farmData.polygonCoordinates;

                    if (reportMap) {
                        reportMap.remove();
                    }

                    reportMap = L.map('report-map', {
                        scrollWheelZoom: false,
                        dragging: false,
                        zoomControl: false
                    });

                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Tiles &copy; Esri'
                    }).addTo(reportMap);

                    if (coordinates && coordinates.length > 0) {
                        const latLngs = coordinates.map(c => [c.lat, c.lng]);
                        const polygon = L.polygon(latLngs, {color: '#22c55e'}).addTo(reportMap);
                        reportMap.fitBounds(polygon.getBounds());
                    }
                }
            } catch (error) {
                console.error("Error loading farm data for report map:", error);
            }
        }

        function initializeMap() {
            // If map is already initialized, just reset its view
            if (map) {
                map.setView([12.8797, 121.7740], 5); // Reset to PH view
                if(drawnItems) {
                    drawnItems.clearLayers();
                }
                return;
            }

            // Initialize the map and set its view to the Philippines
            map = L.map('map').setView([12.8797, 121.7740], 5);

            // Add a satellite tile layer to the map
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            }).addTo(map);

            // Initialize the FeatureGroup to store editable layers
            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            // Initialize the draw control and pass it the FeatureGroup
            const drawControl = new L.Control.Draw({
                edit: {
                    featureGroup: drawnItems,
                    remove: true
                },
                draw: {
                    polygon: {
                        allowIntersection: false,
                        drawError: {
                            color: '#e1e100',
                            message: '<strong>Oh snap!</strong> you can\'t draw that!'
                        },
                        shapeOptions: {
                            color: '#22c55e'
                        }
                    },
                    polyline: false,
                    rectangle: false,
                    circle: false,
                    marker: false,
                    circlemarker: false
                }
            });
            map.addControl(drawControl);

            map.on(L.Draw.Event.CREATED, function (event) {
                const layer = event.layer;
                drawnItems.clearLayers(); // Clear previous drawings
                drawnItems.addLayer(layer);
                document.getElementById('save-farm-map-btn').disabled = false;
            });

            map.on(L.Draw.Event.DELETED, function() {
                if (drawnItems.getLayers().length === 0) {
                    document.getElementById('save-farm-map-btn').disabled = true;
                }
            });

             // Attempt to get user's location
            map.locate({setView: true, maxZoom: 16});
            map.on('locationfound', e => {
                L.marker(e.latlng).addTo(map)
                    .bindPopup("You are somewhere around here.").openPopup();
            });
            map.on('locationerror', e => {
                console.log(e.message);
                // Silently fails if location is not available. Map defaults to PH view.
            });
        }


        // --- 3.5 MULTI-SELECT COMPONENT ---
        function createMultiSelect(containerId, placeholder, isMultiSelect = true) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`MultiSelect container not found: #${containerId}`);
                return;
            }
            container.innerHTML = `
                <button type="button" class="w-full bg-white border border-gray-300 rounded-md shadow-sm px-3 py-2 text-left cursor-pointer focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-green-500 flex items-center justify-between">
                    <span class="block truncate text-gray-500">${placeholder}</span>
                    <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400"></i>
                </button>
                <div class="absolute z-20 mt-1 w-full bg-white shadow-lg rounded-md hidden max-h-60 overflow-auto border border-gray-200">
                    <ul class="py-1">
                        <!-- Options will be inserted here -->
                    </ul>
                </div>
            `;

            const button = container.querySelector('button');
            const buttonText = button.querySelector('span');
            const dropdown = container.querySelector('div');
            const list = container.querySelector('ul');
            let options = [];

            const toggleDropdown = (e) => {
                 e.stopPropagation();
                 // Close other dropdowns
                document.querySelectorAll('.multi-select-dropdown').forEach(d => {
                    if (d !== dropdown) d.classList.add('hidden');
                });
                dropdown.classList.toggle('hidden');
            };

            button.addEventListener('click', toggleDropdown);

            let changeCallback = () => {};

            const instance = {
                populate: (items) => { // items is an array of {value, label} objects
                    list.innerHTML = '';
                    options = items;
                    if (!items || items.length === 0) {
                        list.innerHTML = `<li class="px-3 py-2 text-gray-500">No options available</li>`;
                    } else {
                        items.forEach(item => {
                            const li = document.createElement('li');
                            li.className = 'px-3 py-2 cursor-pointer hover:bg-gray-100 flex items-center';
                            li.dataset.value = item.value;

                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.className = 'h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500 mr-3';
                            if (!isMultiSelect) {
                                checkbox.type = 'radio';
                                checkbox.name = `radio-${containerId}`;
                            }

                            li.appendChild(checkbox);

                            const span = document.createElement('span');
                            span.className = 'font-normal block truncate';
                            span.textContent = item.label;
                            li.appendChild(span);

                            list.appendChild(li);

                            li.addEventListener('click', (e) => {
                                e.stopPropagation();
                                if (e.target.tagName !== 'INPUT') {
                                    checkbox.checked = !checkbox.checked;
                                }

                                if (!isMultiSelect) {
                                    list.querySelectorAll('input').forEach(rb => {
                                        if (rb !== checkbox) rb.checked = false;
                                    });
                                    dropdown.classList.add('hidden');
                                }
                                instance.updateButtonText();
                                changeCallback(instance.getSelectedValues());
                            });
                        });
                    }
                    instance.updateButtonText();
                    lucide.createIcons();
                },
                getSelectedValues: () => {
                    const selected = [];
                    list.querySelectorAll('input:checked').forEach(checkbox => {
                        selected.push(checkbox.closest('li').dataset.value);
                    });
                    return selected;
                },
                setSelectedValues: (values) => {
                    list.querySelectorAll('input').forEach(checkbox => {
                        checkbox.checked = values.includes(checkbox.closest('li').dataset.value);
                    });
                    instance.updateButtonText();
                },
                updateButtonText: () => {
                    const selectedValues = instance.getSelectedValues();
                    if (selectedValues.length === 0) {
                        buttonText.textContent = placeholder;
                        buttonText.classList.add('text-gray-500');
                        buttonText.classList.remove('text-gray-900');
                    } else {
                        const selectedLabels = options
                            .filter(opt => selectedValues.includes(opt.value))
                            .map(opt => opt.label);

                        if (selectedLabels.length <= 2) {
                            buttonText.textContent = selectedLabels.join(', ');
                        } else {
                            buttonText.textContent = `${selectedLabels.length} items selected`;
                        }
                        buttonText.classList.remove('text-gray-500');
                        buttonText.classList.add('text-gray-900');
                    }
                },
                onChange: (callback) => {
                    changeCallback = callback;
                },
                enable: () => {
                    button.disabled = false;
                    button.classList.remove('bg-gray-100', 'cursor-not-allowed');
                },
                disable: () => {
                    button.disabled = true;
                    button.classList.add('bg-gray-100', 'cursor-not-allowed');
                },
                clear: () => {
                    list.innerHTML = `<li class="px-3 py-2 text-gray-500">No options available</li>`;
                    options = [];
                    instance.updateButtonText();
                }
            };

            dropdown.classList.add('multi-select-dropdown');
            return instance;
        }


        // --- 4. AUTHENTICATION LOGIC ---
        const profileTitle = document.getElementById('profile-title');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const profileFormElements = document.querySelectorAll('#profile-screen input, #profile-screen select, #profile-screen textarea, #profile-screen .role-btn');

        function setProfileMode(mode) { // 'edit', 'view', 'new'
            if (mode === 'view') {
                profileTitle.textContent = 'Your Profile';
                profileFormElements.forEach(el => el.disabled = true);
                editProfileBtn.classList.remove('hidden');
                saveProfileBtn.classList.add('hidden');
                cancelEditBtn.classList.add('hidden');
            } else if (mode === 'edit') {
                profileTitle.textContent = 'Edit Profile';
                profileFormElements.forEach(el => el.disabled = false);
                saveProfileBtn.textContent = 'Save Changes';
                editProfileBtn.classList.add('hidden');
                saveProfileBtn.classList.remove('hidden');
                cancelEditBtn.classList.remove('hidden');
            } else { // new
                profileTitle.textContent = 'Complete Your Profile';
                profileFormElements.forEach(el => el.disabled = false);
                saveProfileBtn.textContent = 'Save and Continue';
                editProfileBtn.classList.add('hidden');
                saveProfileBtn.classList.remove('hidden');
                cancelEditBtn.classList.add('hidden');
            }
        }

        // --- Address Dropdown Logic ---
        let profileProvince, profileMunicipality, profileBarangay;
        let filterProvince, filterMunicipality, filterBarangay;
        let expertFilterPestDisease, expertFilterProvince, expertFilterMunicipality, expertFilterBarangay;

        function initializeAddressFilters() {
            // For Profile Screen
            profileProvince = createMultiSelect('province-multiselect-container', 'Select Province', false);
            profileMunicipality = createMultiSelect('municipality-multiselect-container', 'Select Municipality', false);
            profileBarangay = createMultiSelect('barangay-multiselect-container', 'Select Barangay', false);

            profileProvince.populate(window.philippineAddresses.provinces.map(p => ({ value: p.name, label: p.name })));
            profileMunicipality.disable();
            profileBarangay.disable();

            profileProvince.onChange(selectedProvinces => {
                profileMunicipality.clear();
                profileBarangay.clear();
                if (selectedProvinces.length > 0) {
                    const provinceData = window.philippineAddresses.provinces.find(p => p.name === selectedProvinces[0]);
                    profileMunicipality.populate(provinceData.municipalities.map(m => ({ value: m.name, label: m.name })));
                    profileMunicipality.enable();
                } else {
                    profileMunicipality.disable();
                    profileBarangay.disable();
                }
            });

            profileMunicipality.onChange(selectedMunicipalities => {
                profileBarangay.clear();
                if (selectedMunicipalities.length > 0) {
                    const selectedProvinceName = profileProvince.getSelectedValues()[0];
                    const provinceData = window.philippineAddresses.provinces.find(p => p.name === selectedProvinceName);
                    const municipalityData = provinceData.municipalities.find(m => m.name === selectedMunicipalities[0]);
                    if (municipalityData && municipalityData.barangays) {
                        profileBarangay.populate(municipalityData.barangays.map(b => ({ value: b, label: b })));
                        profileBarangay.enable();
                    }
                } else {
                    profileBarangay.disable();
                }
            });

            // For Reports Screen Filters
            filterProvince = createMultiSelect('province-filter-container', 'All Provinces', true);
            filterMunicipality = createMultiSelect('municipality-filter-container', 'All Municipalities', true);
            filterBarangay = createMultiSelect('barangay-filter-container', 'All Barangays', true);

            filterProvince.populate(window.philippineAddresses.provinces.map(p => ({ value: p.name, label: p.name })));
            filterMunicipality.disable();
            filterBarangay.disable();

            filterProvince.onChange(selectedProvinces => {
                filterMunicipality.clear();
                filterBarangay.clear();
                filterMunicipality.disable();
                filterBarangay.disable();
                if (selectedProvinces.length > 0) {
                    const municipalities = selectedProvinces.flatMap(provinceName => {
                        const provinceData = window.philippineAddresses.provinces.find(p => p.name === provinceName);
                        return provinceData.municipalities.map(m => m.name);
                    });
                    filterMunicipality.populate([...new Set(municipalities)].sort().map(m => ({ value: m, label: m })));
                    filterMunicipality.enable();
                }
                loadAllReports();
            });

            filterMunicipality.onChange(selectedMunicipalities => {
                filterBarangay.clear();
                filterBarangay.disable();
                if (selectedMunicipalities.length > 0) {
                    const selectedProvinces = filterProvince.getSelectedValues();
                    const barangays = selectedProvinces.flatMap(provinceName => {
                        const provinceData = window.philippineAddresses.provinces.find(p => p.name === provinceName);
                        return provinceData.municipalities
                            .filter(m => selectedMunicipalities.includes(m.name))
                            .flatMap(m => m.barangays);
                    });
                    filterBarangay.populate([...new Set(barangays)].sort().map(b => ({ value: b, label: b })));
                    filterBarangay.enable();
                }
                loadAllReports();
            });

            filterBarangay.onChange(() => {
                loadAllReports();
            });

            const clearFiltersBtn = document.getElementById('clear-location-filters-btn');
            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', () => {
                    filterProvince.setSelectedValues([]);
                    filterMunicipality.setSelectedValues([]);
                    filterBarangay.setSelectedValues([]);
                    filterMunicipality.clear();
                    filterBarangay.clear();
                    filterMunicipality.disable();
                    filterBarangay.disable();
                    loadAllReports();
                });
            }
        }

        // --- RSBSA Logic ---
        const isFarmerCheckbox = document.getElementById('isFarmer');
        const rsbsaContainer = document.getElementById('rsbsa-container');
        isFarmerCheckbox.addEventListener('change', () => {
            rsbsaContainer.classList.toggle('hidden', !isFarmerCheckbox.checked);
        });

        function populateProfileFields(profile) {
            document.getElementById('profile-pic').src = profile.photoURL || (currentUser && currentUser.photoURL) || 'https://placehold.co/96x96/e2e8f0/334155?text=User';
            document.getElementById('fullName').value = profile.fullName || '';

            // Populate address fields only if the data is ready
            if (window.philippineAddresses && window.philippineAddresses.provinces.length > 0) {
                if (profile.province) {
                    profileProvince.setSelectedValues([profile.province]);
                    const provinceData = window.philippineAddresses.provinces.find(p => p.name === profile.province);
                    if (provinceData) {
                        profileMunicipality.populate(provinceData.municipalities.map(m => m.name));
                        profileMunicipality.enable();
                        if (profile.municipality) {
                            profileMunicipality.setSelectedValues([profile.municipality]);
                            const municipalityData = provinceData.municipalities.find(m => m.name === profile.municipality);
                            if (municipalityData) {
                                profileBarangay.populate(municipalityData.barangays);
                                profileBarangay.enable();
                                if (profile.barangay) {
                                    profileBarangay.setSelectedValues([profile.barangay]);
                                }
                            }
                        }
                    }
                }
            }

            // RSBSA Number
            if (profile.rsbsaNumber) {
                isFarmerCheckbox.checked = true;
                rsbsaContainer.classList.remove('hidden');
                document.getElementById('rsbsaNumber').value = profile.rsbsaNumber;
            } else {
                isFarmerCheckbox.checked = false;
                rsbsaContainer.classList.add('hidden');
                document.getElementById('rsbsaNumber').value = '';
            }

            document.getElementById('birthdate').value = profile.birthdate || '';
            document.getElementById('civilStatus').value = profile.civilStatus || 'Single';
            document.getElementById('religion').value = profile.religion || '';
            document.getElementById('yearsFarming').value = profile.yearsFarming || '';
            document.getElementById('familyMembers').value = profile.familyMembers || '';
            document.getElementById('education').value = profile.education || 'No formal education';

            selectedRole = profile.role || 'Farmer';
            document.getElementById('current-role-display').textContent = selectedRole;
            updateRoleRequestStatus();
            updateUIVisibilityBasedOnRole();
        }

        // --- Authentication Flow with Offline Fallback ---
        const authTimeout = setTimeout(() => {
            console.log("Authentication timed out. Assuming offline, showing login screen.");
            // If after the timeout we still don't have a user, show the login screen.
            // This prevents getting stuck on the loading screen when offline.
            if (!currentUser) {
                showScreen('login');
            }
        }, 4000); // 4-second timeout for auth state

        onAuthStateChanged(auth, async (user) => {
            clearTimeout(authTimeout); // Auth state resolved, clear the timeout.

            if (user) {
                currentUser = user;
                updateOnlineStatus();

                // Wait for the address and pest/disease data to be ready
                await Promise.all([window.addressDataPromise, window.pestDiseaseDataPromise, window.pestImageDataPromise]);

                // Now that address data is loaded, populate the dropdowns
                initializeAddressFilters();
                
                const userDocRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists()) {
                    userProfile = docSnap.data();

                    const requiredFields = ['fullName', 'province', 'municipality', 'barangay', 'birthdate', 'civilStatus', 'religion', 'yearsFarming', 'familyMembers', 'education', 'role'];
                    const isProfileComplete = requiredFields.every(field => userProfile[field] !== undefined && userProfile[field] !== null && userProfile[field] !== '');

                    // Populate all fields, including the now-ready address dropdowns
                    populateProfileFields(userProfile);

                    if (isProfileComplete) {
                        setProfileMode('view');
                        listenForNotifications();

                        // Role-based routing
                        let screen;
                        const context = {
                            isFreshNavigation: true,
                            userId: currentUser.uid,
                            userName: userProfile.fullName,
                            label: 'Dashboard'
                        };

                        if (userProfile.role === 'Extension Worker') {
                            screen = 'ewDashboard';
                            document.getElementById('ew-welcome-message').textContent = `Welcome, ${userProfile.fullName}`;
                            document.getElementById('add-farm-btn').style.display = 'none';
                        } else if (userProfile.role === 'Branch Coordinator') {
                            screen = 'coordinatorDashboard';
                            document.getElementById('coordinator-welcome-message').textContent = `Welcome, ${userProfile.fullName}`;
                            document.getElementById('add-farm-btn').style.display = 'none';
                        } else if (userProfile.role === 'Expert') {
                            screen = 'expertDashboard';
                            document.getElementById('expert-welcome-message').textContent = `Welcome, ${userProfile.fullName}`;
                            document.getElementById('add-farm-btn').style.display = 'none';
                        } else if (userProfile.role === 'Administrator') {
                            screen = 'adminDashboard';
                            document.getElementById('admin-welcome-message').textContent = `Welcome, ${userProfile.fullName}`;
                            document.getElementById('add-farm-btn').style.display = 'none';
                        } else { // Default to Farmer
                            screen = 'farmList';
                            document.getElementById('welcome-message').textContent = `Welcome, ${userProfile.fullName}`;
                            document.getElementById('add-farm-btn').style.display = 'flex';
                        }
                        showScreen(screen, context);
                    } else {
                        setProfileMode('new');
                        showToast('Please complete your profile to continue.', 'info');
                        showScreen('profile', { isFreshNavigation: true, label: 'Complete Profile' });
                        document.getElementById('add-farm-btn').style.display = 'none';
                    }
                } else {
                    userProfile = {};
                    populateProfileFields({
                        fullName: user.displayName,
                        photoURL: user.photoURL
                    });
                    setProfileMode('new');
                    showScreen('profile');
                    document.getElementById('add-farm-btn').style.display = 'none';
                }
            } else {
                currentUser = null;
                userProfile = null;
                showScreen('login');
                await loadPestAndDiseaseCards();
                loadWeatherDashboard();
            }
        });

        // Event Listeners for Sign-in buttons
        document.getElementById('google-signin-btn').addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(error => console.error("Google Sign-in Error", error));
        });

        
        document.getElementById('guest-signin-btn').addEventListener('click', () => {
            signInAnonymously(auth).catch(error => console.error("Anonymous Sign-in Error", error));
        });

        // --- 5. PROFILE MANAGEMENT ---
        editProfileBtn.addEventListener('click', () => {
            setProfileMode('edit');
        });

        cancelEditBtn.addEventListener('click', () => {
            populateProfileFields(userProfile); // Revert changes
            setProfileMode('view');
        });

        document.getElementById('request-role-change-btn').addEventListener('click', () => {
            const requestedRole = document.getElementById('request-role-select').value;
            if (confirm(`Are you sure you want to request the role: ${requestedRole}?`)) {
                requestRoleChange(requestedRole);
            }
        });

        async function requestRoleChange(requestedRole) {
            if (!currentUser) {
                showToast('You must be logged in to request a role change.', 'error');
                return;
            }

            // Check for existing pending request first
            const q = query(collection(db, "roleRequests"), where("userId", "==", currentUser.uid), where("status", "==", "pending"));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                showToast('You already have a pending role change request.', 'error');
                return;
            }

            showSavingOverlay('Submitting Request...');
            try {
                const roleRequestsCollection = collection(db, 'roleRequests');
                await addDoc(roleRequestsCollection, {
                    userId: currentUser.uid,
                    userName: userProfile.fullName,
                    currentRole: userProfile.role,
                    requestedRole: requestedRole,
                    status: 'pending',
                    timestamp: serverTimestamp()
                });

                showToast('Your role change request has been submitted for review.', 'success');
                updateRoleRequestStatus();
            } catch (error) {
                console.error("Error submitting role change request:", error);
                showToast('Could not submit your request. Please try again.', 'error');
            } finally {
                hideSavingOverlay();
            }
        }

        async function updateRoleRequestStatus() {
            if (!currentUser) return;
            const requestBtn = document.getElementById('request-role-change-btn');
            const requestStatusEl = document.getElementById('role-request-status');
            const requestRoleSelect = document.getElementById('request-role-select');
            const roleRequestSection = document.getElementById('role-request-section');

            if (userProfile.role === 'Administrator' || userProfile.role === 'Expert') {
                roleRequestSection.classList.add('hidden');
                return;
            } else {
                 roleRequestSection.classList.remove('hidden');
            }

            requestBtn.disabled = true;
            requestStatusEl.textContent = 'Checking for pending requests...';

            const q = query(collection(db, "roleRequests"), where("userId", "==", currentUser.uid), where("status", "==", "pending"));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                const pendingRequest = querySnapshot.docs[0].data();
                requestStatusEl.textContent = `You have a pending request for the role: ${pendingRequest.requestedRole}.`;
                requestRoleSelect.disabled = true;
            } else {
                requestStatusEl.textContent = 'You can request a role change if needed.';
                requestBtn.disabled = false;
                requestRoleSelect.disabled = false;
            }
        }

        document.getElementById('save-profile-btn').addEventListener('click', async () => {
            const fullName = document.getElementById('fullName').value;
            const province = profileProvince.getSelectedValues()[0] || '';
            const municipality = profileMunicipality.getSelectedValues()[0] || '';
            const barangay = profileBarangay.getSelectedValues()[0] || '';
            const birthdate = document.getElementById('birthdate').value;
            const civilStatus = document.getElementById('civilStatus').value;
            const religion = document.getElementById('religion').value;
            const yearsFarming = document.getElementById('yearsFarming').value;
            const familyMembers = document.getElementById('familyMembers').value;
            const education = document.getElementById('education').value;
            const rsbsaNumber = document.getElementById('rsbsaNumber').value;

            if (!fullName.trim() || !province.trim() || !municipality.trim() || !barangay.trim() || !birthdate.trim() || !civilStatus.trim() || !religion.trim() || !yearsFarming.trim() || !familyMembers.trim() || !education.trim()) {
                showToast('Please fill out all fields.', 'error');
                return;
            }
            
            showSavingOverlay('Saving Profile...');

            const profileData = {
                fullName: fullName.trim(),
                province: province,
                municipality: municipality,
                barangay: barangay,
                birthdate: birthdate,
                civilStatus: civilStatus,
                religion: religion.trim(),
                yearsFarming: parseInt(yearsFarming),
                familyMembers: parseInt(familyMembers),
                education: education,
                email: currentUser.email || '',
                photoURL: currentUser.photoURL || '',
                rsbsaNumber: rsbsaNumber.trim()
            };

            try {
                const userDocRef = doc(db, "users", currentUser.uid);
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists()) {
                    // For existing profiles, set updatedAt
                    profileData.updatedAt = serverTimestamp();
                } else {
                    // For new profiles, set createdAt and default role
                    profileData.createdAt = serverTimestamp();
                    profileData.role = 'Farmer';
                }

                await setDoc(userDocRef, profileData, { merge: true });

                showToast("Profile saved successfully!", "success");

                // Re-fetch the profile to ensure local data is consistent and clean
                const updatedDocSnap = await getDoc(userDocRef);
                if (updatedDocSnap.exists()) {
                    userProfile = updatedDocSnap.data();
                } else {
                    // This case should ideally not happen if setDoc was successful.
                    // We'll optimistically use the data we sent, but remove the server-only fields.
                    if(profileData.updatedAt) delete profileData.updatedAt;
                    if(profileData.createdAt) delete profileData.createdAt;
                    userProfile = profileData;
                }

                const requiredFields = ['fullName', 'province', 'municipality', 'barangay', 'birthdate', 'civilStatus', 'religion', 'yearsFarming', 'familyMembers', 'education', 'role'];
                const isProfileComplete = requiredFields.every(field => userProfile[field] !== undefined && userProfile[field] !== null && userProfile[field] !== '');

                if (isProfileComplete) {
                    populateProfileFields(userProfile); // Repopulate with the latest saved data
                    setProfileMode('view');

                    // Role-based routing after profile save
                    let screen;
                    const context = {
                        isFreshNavigation: true,
                        userId: currentUser.uid,
                        userName: userProfile.fullName,
                        label: 'Dashboard'
                    };

                    if (userProfile.role === 'Extension Worker') {
                        screen = 'ewDashboard';
                        document.getElementById('ew-welcome-message').textContent = `Welcome, ${userProfile.fullName}`;
                        document.getElementById('add-farm-btn').style.display = 'none';
                    } else if (userProfile.role === 'Branch Coordinator') {
                        screen = 'coordinatorDashboard';
                        document.getElementById('coordinator-welcome-message').textContent = `Welcome, ${userProfile.fullName}`;
                        document.getElementById('add-farm-btn').style.display = 'none';
                    } else if (userProfile.role === 'Expert') {
                        screen = 'expertDashboard';
                        document.getElementById('expert-welcome-message').textContent = `Welcome, ${userProfile.fullName}`;
                        document.getElementById('add-farm-btn').style.display = 'none';
                    } else { // Default to Farmer
                        screen = 'farmList';
                        document.getElementById('welcome-message').textContent = `Welcome, ${userProfile.fullName}`;
                        document.getElementById('add-farm-btn').style.display = 'flex';
                    }
                    showScreen(screen, context);

                } else {
                    setProfileMode('new');
                }

            } catch (error) {
                console.error("Error saving profile:", error);
                showToast("Could not save profile. Please check connection.", 'error');
            } finally {
                hideSavingOverlay();
            }
        });

        // --- 6. FARM MANAGEMENT & SETUP FLOW ---
        const farmModal = document.getElementById('farm-modal');
        document.getElementById('add-farm-btn').addEventListener('click', () => farmModal.style.display = 'flex');
        document.getElementById('close-farm-modal-btn').addEventListener('click', () => farmModal.style.display = 'none');

        // --- New Farm Flow ---
        let isEditMode = false; // To track if we are editing or creating a new farm

        document.getElementById('edit-farm-details-btn').addEventListener('click', async () => {
            if (!currentFarmId || !currentUser) {
                showToast('No farm selected.', 'error');
                return;
            }
            isEditMode = true;

            // Fetch current farm data
            const farmDocRef = doc(db, 'users', currentUser.uid, 'farmLots', currentFarmId);
            const farmDocSnap = await getDoc(farmDocRef);

            if (farmDocSnap.exists()) {
                const farmData = farmDocSnap.data();
                // Pre-fill the modal
                document.getElementById('farmName').value = farmData.farmName || '';
                document.getElementById('tobaccoVariety').value = farmData.tobaccoVariety || '';
                document.getElementById('plantingDate').value = farmData.plantingDate || '';

                // Change button text and show modal
                document.getElementById('next-farm-map-btn').textContent = 'Update Details & Set Location';
                farmModal.style.display = 'flex';
            } else {
                showToast('Could not find farm details to edit.', 'error');
            }
        });

        // Reset edit mode when adding a new farm
        document.getElementById('add-farm-btn').addEventListener('click', () => {
            isEditMode = false;
            // Clear fields and reset button text for new entry
            document.getElementById('farmName').value = '';
            document.getElementById('tobaccoVariety').value = '';
            document.getElementById('plantingDate').value = '';
            document.getElementById('next-farm-map-btn').textContent = 'Next: Set Location';
            farmModal.style.display = 'flex';
        });


        document.getElementById('next-farm-map-btn').addEventListener('click', () => {
            const farmName = document.getElementById('farmName').value.trim();
            const tobaccoVariety = document.getElementById('tobaccoVariety').value.trim();
            const plantingDate = document.getElementById('plantingDate').value;

            if (!farmName || !tobaccoVariety || !plantingDate) {
                showToast('Please fill out all farm details.', 'error');
                return;
            }

            pendingFarmData = {
                farmName,
                tobaccoVariety,
                plantingDate
            };

            farmModal.style.display = 'none';

            if (isEditMode) {
                document.getElementById('save-farm-map-btn').textContent = 'Update Farm Area';
            } else {
                document.getElementById('save-farm-map-btn').textContent = 'Save Farm Area';
            }

            showScreen('farmSetup');
            // Invalidate map size and re-center, needed when map is in a hidden div
            setTimeout(() => {
                initializeMap(); // General map init
                if (isEditMode) {
                    initializeMapForEdit(currentFarmId); // Load existing polygon if editing
                }
            }, 100);
        });

        document.getElementById('cancel-farm-setup-btn').addEventListener('click', () => {
            pendingFarmData = {};
            drawnItems.clearLayers();
            document.getElementById('save-farm-map-btn').disabled = true;
            showScreen('farmList'); // Go back to the farm list
        });

        document.getElementById('delete-farm-btn').addEventListener('click', async () => {
            if (!currentFarmId || !currentUser) {
                showToast('No farm selected.', 'error');
                return;
            }

            if (confirm('Are you sure you want to delete this farm plot? This action cannot be undone.')) {
                try {
                    const farmDocRef = doc(db, 'users', currentUser.uid, 'farmLots', currentFarmId);
                    await deleteDoc(farmDocRef);
                    showToast('Deletion Successful: The farm plot has been removed.', 'success');
                    currentFarmId = null;
                    showScreen('farmList');
                } catch (error) {
                    console.error("Error deleting farm plot:", error);
                    showToast('Failed to delete farm plot. Please try again.', 'error');
                }
            }
        });

        document.getElementById('save-farm-map-btn').addEventListener('click', async () => {
            if (drawnItems.getLayers().length === 0) {
                showToast('Please draw or select a farm area on the map first.', 'error');
                return;
            }

            showSavingOverlay('Saving Farm Plot...');

            // Extract polygon data
            const geojson = drawnItems.getLayers()[0].toGeoJSON();
            const coordinates = geojson.geometry.coordinates[0].map(p => ({ lat: p[1], lng: p[0] }));

            const farmData = {
                ...pendingFarmData,
                polygonCoordinates: coordinates,
            };

            if (!currentUser) {
                showToast('Error: No user logged in.', 'error');
                hideSavingOverlay();
                return;
            }

            try {
                if (isEditMode) {
                    // Update existing document
                    farmData.updatedAt = serverTimestamp();
                    const farmDocRef = doc(db, 'users', currentUser.uid, 'farmLots', currentFarmId);
                    await updateDoc(farmDocRef, farmData);
                    showToast('Update Successful: The farm plot details have been saved.', 'success');
                } else {
                    // Create new document
                    farmData.createdAt = serverTimestamp();
                    const farmLotsCollection = collection(db, 'users', currentUser.uid, 'farmLots');
                    await addDoc(farmLotsCollection, farmData);
                    showToast('Creation Successful: A new farm plot has been added.', 'success');
                }

                // Reset state
                isEditMode = false;
                pendingFarmData = {};
                drawnItems.clearLayers();
                document.getElementById('save-farm-map-btn').disabled = true;
                document.getElementById('farmName').value = '';
                document.getElementById('tobaccoVariety').value = '';
                document.getElementById('plantingDate').value = '';

                showScreen('farmList'); // Go back to the farm list
            } catch (error) {
                console.error("Error saving farm plot:", error);
                showToast('Could not save farm plot. Please try again.', 'error');
            } finally {
                hideSavingOverlay();
            }
        });
        
        // --- 8. NEW SUBMISSION LOGIC ---
        const imageUploadInput = document.getElementById('image-upload');
        const imagePreviewContainer = document.getElementById('submission-image-preview-container');
        const imagePlaceholder = document.getElementById('image-placeholder-icon');

        imageUploadInput.addEventListener('change', (event) => {
            handleFiles(event.target.files);
        });

        function handleFiles(files) {
            if (!files || files.length === 0) return;

            const placeholder = imagePreviewContainer.querySelector('#image-placeholder-icon');
            if (placeholder) {
                placeholder.classList.add('hidden');
            }

            for (const file of files) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const imgContainer = document.createElement('div');
                        imgContainer.className = 'relative aspect-square group';
                        imgContainer.innerHTML = `
                            <img src="${e.target.result}" class="w-full h-full object-cover rounded-md">
                            <button class="absolute top-1 right-1 bg-red-600 text-white rounded-full p-0.5 w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">&times;</button>
                        `;
                        imgContainer.querySelector('button').addEventListener('click', (btnEvent) => {
                            btnEvent.stopPropagation();
                            imgContainer.remove();
                             if (imagePreviewContainer.querySelectorAll('img').length === 0) {
                                if(placeholder) placeholder.classList.remove('hidden');
                            }
                        });
                        imagePreviewContainer.appendChild(imgContainer);
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        document.getElementById('save-submission-btn').addEventListener('click', async () => {
            const imagePreviews = imagePreviewContainer.querySelectorAll('img');
            const imageDataUrls = Array.from(imagePreviews).map(img => img.src);
            const symptoms = Array.from(document.querySelectorAll('#symptoms-checklist input:checked')).map(cb => cb.value);
            const distribution = document.querySelector('#distribution-radios input:checked')?.value;
            const severity = document.querySelector('#severity-radios input:checked')?.value;
            const affectedParts = Array.from(document.querySelectorAll('.affected-part-checkbox:checked')).map(cb => cb.value);
            const onsetDate = document.getElementById('symptom-onset-date').value;
            const progression = document.querySelector('input[name="progression"]:checked')?.value;
            const pestSigns = document.getElementById('pest-signs').value;


            if (imageDataUrls.length === 0 || symptoms.length === 0 || !distribution || !severity) {
                showToast('Please fill out all fields and select at least one image.', 'error');
                return;
            }

            if (!currentFarmId || !currentUser) {
                showToast('Could not identify the current farm or user. Please go back to the farm list.', 'error');
                return;
            }

            // Note: The 'edit' functionality has been temporarily removed to fix the core upload issue.
            // A more robust edit feature would require comparing image arrays and deleting/uploading as needed.
            if (isEditSubmissionMode) {
                showToast('Editing reports with new images is not yet supported. Please create a new report.', 'error');
                return;
            }

            showSavingOverlay('Uploading images...');

            try {
                // Generate a new submission ID client-side to use in the storage path
                const submissionDocRef = doc(collection(db, 'users', currentUser.uid, 'farmLots', currentFarmId, 'submissions'));
                const submissionId = submissionDocRef.id;

                // Create a reference and upload task for each image
                const uploadPromises = imageDataUrls.map((dataUrl, index) => {
                    const storageRef = ref(storage, `submissions/${currentUser.uid}/${submissionId}/image_${index}.jpg`);
                    // uploadString is efficient for data URLs
                    return uploadString(storageRef, dataUrl, 'data_url').then(snapshot => getDownloadURL(snapshot.ref));
                });

                // Wait for all uploads to complete and get their download URLs
                const imageDownloadUrls = await Promise.all(uploadPromises);

                showSavingOverlay('Saving report data...');

                const submissionData = {
                    imageDownloadUrls: imageDownloadUrls, // <-- Store URLs, not base64 data
                    symptoms,
                    distribution,
                    severity,
                    affectedParts,
                    onsetDate,
                    progression,
                    pestSigns,
                    timestamp: serverTimestamp(),
                    gps_coordinates: { latitude: 17.5734, longitude: 120.3856 } // Simulate GPS data
                };

                // Save the complete document to Firestore now that images are uploaded
                await setDoc(submissionDocRef, submissionData);

                showToast('Report Submitted: Your new report has been saved.', 'success');

                // Reset state and form
                isEditSubmissionMode = false;
                currentSubmissionId = null;
                imagePreviewContainer.innerHTML = '<div id="image-placeholder-icon" class="col-span-full text-center text-gray-400 py-4"><i data-lucide="image" class="mx-auto h-12 w-12"></i><p>No images selected</p></div>';


                // Go back to the dashboard, which will be re-rendered
                const lastContext = navigationHistory[navigationHistory.length - 2] || { screenName: 'farmList', context: {} };
                showScreen(lastContext.screenName, lastContext.context);

            } catch (error) {
                console.error('Failed to save submission:', error);
                showToast('Could not save report. Please try again. Error: ' + error.message, 'error');
            } finally {
                hideSavingOverlay();
            }
        });

        let currentFarmId = null;
        let isEditSubmissionMode = false;
        let currentSubmissionId = null;

        // --- Submission Edit Flow ---
        document.getElementById('dashboard-main').addEventListener('click', async (e) => {
            if (e.target && e.target.classList.contains('edit-submission-btn')) {
                currentSubmissionId = e.target.getAttribute('data-id');
                if (!currentSubmissionId || !currentUser || !currentFarmId) {
                    showToast('Error: Cannot find submission to edit.', 'error');
                    return;
                }
                isEditSubmissionMode = true;

                try {
                    // FIX: Use the userId from the navigation context to fetch the correct farmer's data
                    const currentState = navigationHistory[navigationHistory.length - 1];
                    const targetUserId = currentState?.context?.userId || currentUser.uid;

                    const submissionDocRef = doc(db, 'users', targetUserId, 'farmLots', currentFarmId, 'submissions', currentSubmissionId);
                    const submissionDocSnap = await getDoc(submissionDocRef);

                    if (submissionDocSnap.exists()) {
                        const sub = submissionDocSnap.data();

                        // Pre-fill the form
                        // Clear existing previews before adding new ones
                        const placeholder = imagePreviewContainer.querySelector('#image-placeholder-icon');
                        imagePreviewContainer.innerHTML = '';
                        if(placeholder) imagePreviewContainer.appendChild(placeholder);

                    const imageUrls = sub.imageDownloadUrls || (sub.imageDataUrl ? [sub.imageDataUrl] : []);

                        if (imageUrls.length > 0) {
                             // This is a simplified way to handle blobs. A real app might need more robust handling.
                            const files = imageUrls.map(url => fetch(url).then(res => res.blob()));
                            Promise.all(files).then(blobs => handleFiles(blobs));
                        }


                        // Reset checkboxes before setting new state
                        document.querySelectorAll('#symptoms-checklist input[type="checkbox"]').forEach(cb => cb.checked = false);
                        sub.symptoms.forEach(symptomValue => {
                            const checkbox = document.getElementById(`symptom-${symptomValue}`);
                            if (checkbox) checkbox.checked = true;
                        });

                        // Reset radios before setting new state
                        document.querySelectorAll('#distribution-radios input[type="radio"]').forEach(rb => rb.checked = false);
                        const distRadio = document.getElementById(`dist-${sub.distribution}`);
                        if (distRadio) distRadio.checked = true;

                        document.querySelectorAll('#severity-radios input[type="radio"]').forEach(rb => rb.checked = false);
                        const sevRadio = document.getElementById(`sev-${sub.severity}`);
                        if (sevRadio) sevRadio.checked = true;

                        // Update button and show screen
                        document.getElementById('save-submission-btn').textContent = 'Update Report';
                        const lastContext = navigationHistory[navigationHistory.length - 1]?.context || {};
                        const newContext = { ...lastContext, label: 'Edit Report' };
                        showScreen('newSubmission', newContext);
                        initializeReportMap(currentFarmId);

                    } else {
                        showToast('Submission data not found.', 'error');
                    }
                } catch (error) {
                    console.error("Error fetching submission for edit:", error);
                    showToast('Could not load submission data.', 'error');
                }
            }
        });

        document.getElementById('new-submission-btn').addEventListener('click', () => {
            isEditSubmissionMode = false;
            currentSubmissionId = null;

            // Reset the form for a new entry
            const placeholder = imagePreviewContainer.querySelector('#image-placeholder-icon');
            imagePreviewContainer.innerHTML = ''; // Clear all previews
            if (placeholder) {
                placeholder.classList.remove('hidden');
                imagePreviewContainer.appendChild(placeholder);
            }
            imageUploadInput.value = '';

            document.querySelectorAll('#symptoms-checklist input:checked').forEach(cb => cb.checked = false);
            document.querySelectorAll('#distribution-radios input:checked').forEach(rb => rb.checked = false);
            document.querySelectorAll('#severity-radios input:checked').forEach(rb => rb.checked = false);

            document.getElementById('save-submission-btn').textContent = 'Save Submission';

            const lastContext = navigationHistory[navigationHistory.length - 1]?.context || {};
            const newContext = { ...lastContext, label: 'New Report' };
            showScreen('newSubmission', newContext);
        });

        function loadSubmissions(context) {
            const farmId = context.farmId;
            const targetUserId = context.userId || currentUser.uid;
            if (!targetUserId || !farmId) return;

            const submissionsCollection = collection(db, 'users', targetUserId, 'farmLots', farmId, 'submissions');
            const dashboardMain = document.getElementById('dashboard-main');

            const unsubscribe = onSnapshot(submissionsCollection, (querySnapshot) => {
                dashboardMain.innerHTML = ''; // Clear existing content

                if (querySnapshot.empty) {
                    dashboardMain.innerHTML = `
                    <div class="text-center text-gray-500 mt-20">
                        <i data-lucide="clipboard-list" class="w-12 h-12 mx-auto text-gray-400"></i>
                        <p class="mt-4">No scouting reports found for this farm.</p>
                        <p>Click 'New Report' to add one.</p>
                    </div>`;
                } else {
                    querySnapshot.forEach(doc => {
                        const submission = doc.data();
                        const submissionId = doc.id;
                        const card = document.createElement('div');
                        card.className = 'bg-white p-4 rounded-xl mb-4 shadow-sm border border-gray-200';

                        // Fallback for older data that might not have a proper timestamp
                        const submissionDate = submission.timestamp?.toDate ? submission.timestamp.toDate() : new Date();
                        const dateString = submissionDate.toLocaleDateString();
                        const timeString = submissionDate.toLocaleTimeString();

                        const thumbnailUrl = (submission.imageDownloadUrls && submission.imageDownloadUrls.length > 0)
                            ? submission.imageDownloadUrls[0]
                            : (submission.imageDataUrl || 'https://placehold.co/96x96/e2e8f0/334155?text=No+Image');


                        card.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div class="flex">
                                    <img src="${thumbnailUrl}" class="w-24 h-24 rounded-md mr-4 object-cover">
                                    <div>
                                        <p class="font-bold">Report from ${dateString} at ${timeString}</p>
                                        <p class="text-sm"><strong>Symptoms:</strong> ${submission.symptoms.join(', ')}</p>
                                        <p class="text-sm"><strong>Distribution:</strong> ${submission.distribution}</p>
                                        <p class="text-sm"><strong>Severity:</strong> ${submission.severity}</p>
                                    </div>
                                </div>
                                <div>
                                    <button class="edit-submission-btn bg-blue-500 text-white text-xs font-bold py-1 px-2 rounded" data-id="${submissionId}">Edit</button>
                                </div>
                            </div>
                        `;
                        dashboardMain.appendChild(card);
                    });
                }
                lucide.createIcons();
            });
            activeListeners.push(unsubscribe);
        }

        let currentReportFilter = 'all';

        document.getElementById('report-filters').addEventListener('click', (e) => {
            if (e.target.classList.contains('report-filter-btn')) {
                const filter = e.target.getAttribute('data-filter');
                currentReportFilter = filter;

                document.querySelectorAll('.report-filter-btn').forEach(b => {
                    b.classList.remove('bg-green-600', 'text-white');
                    b.classList.add('bg-gray-200', 'text-gray-800');
                });
                e.target.classList.add('bg-green-600', 'text-white');
                e.target.classList.remove('bg-gray-200', 'text-gray-800');

                loadAllReports();
            }
        });

        async function loadAllReports() {
            if (!currentUser) return;

            const reportsContainer = document.getElementById('reports-container');
            reportsContainer.innerHTML = `<div class="text-center text-gray-500 mt-20"><i data-lucide="loader" class="w-12 h-12 mx-auto text-gray-400 animate-spin"></i><p class="mt-4">Loading reports...</p></div>`;
            lucide.createIcons();

            try {
                // For coordinators, fetch all reports. For farmers, fetch only their own.
                let allSubmissions = [];
                if (userProfile.role === 'Farmer') {
                    const farmLotsCollection = collection(db, 'users', currentUser.uid, 'farmLots');
                    const farmLotsSnapshot = await getDocs(farmLotsCollection);
                    for (const farmDoc of farmLotsSnapshot.docs) {
                        const farmData = farmDoc.data();
                        const submissionsCollection = collection(db, 'users', currentUser.uid, 'farmLots', farmDoc.id, 'submissions');
                        const submissionsSnapshot = await getDocs(submissionsCollection);
                        submissionsSnapshot.forEach(submissionDoc => {
                            allSubmissions.push({
                                ...submissionDoc.data(),
                                id: submissionDoc.id,
                                farmName: farmData.farmName,
                                userId: currentUser.uid,
                                farmId: farmDoc.id
                            });
                        });
                    }
                } else { // For Extension Worker, Coordinator, Expert, etc.
                    const submissionsQuery = collectionGroup(db, 'submissions');
                    const submissionsSnapshot = await getDocs(submissionsQuery);

                    const farmCache = {};
                    const userCache = {};

                    for (const submissionDoc of submissionsSnapshot.docs) {
                        const submissionData = submissionDoc.data();
                        const farmLotRef = submissionDoc.ref.parent.parent;
                        const userRef = farmLotRef.parent.parent;

                        // Fetch Farm Data from cache or Firestore
                        let farmData = farmCache[farmLotRef.id];
                        if (!farmData) {
                            const farmDoc = await getDoc(farmLotRef);
                            if (farmDoc.exists()) {
                                farmData = farmDoc.data();
                                farmCache[farmLotRef.id] = farmData;
                            }
                        }

                        // Fetch User Profile from cache or Firestore (gracefully)
                        let userProfileData = userCache[userRef.id];
                        if (!userProfileData) {
                            try {
                                const userDoc = await getDoc(userRef);
                                if (userDoc.exists()) {
                                    userProfileData = userDoc.data();
                                    userCache[userRef.id] = userProfileData;
                                }
                            } catch (e) {
                                userProfileData = { fullName: 'Unknown Farmer' };
                                userCache[userRef.id] = userProfileData;
                            }
                        }

                        if (farmData && userProfileData) {
                            allSubmissions.push({
                                ...submissionData,
                                id: submissionDoc.id,
                                farmName: farmData.farmName,
                                userProfile: userProfileData,
                                userId: userRef.id,
                                farmId: farmLotRef.id
                            });
                        }
                    }
                }

                // Client-side filtering
                let filteredSubmissions = allSubmissions;

                // Filter by status
                if (currentReportFilter === 'pending') {
                    filteredSubmissions = allSubmissions.filter(s => !s.initialDiagnosis);
                } else if (currentReportFilter === 'diagnosed') {
                    filteredSubmissions = allSubmissions.filter(s => s.initialDiagnosis && !s.finalDiagnosis);
                } else if (currentReportFilter === 'treated') {
                    filteredSubmissions = allSubmissions.filter(s => s.finalDiagnosis && s.treatment);
                }

                // Filter by location
                const selectedProvinces = filterProvince.getSelectedValues();
                const selectedMunicipalities = filterMunicipality.getSelectedValues();
                const selectedBarangays = filterBarangay.getSelectedValues();

                if (selectedProvinces.length > 0 || selectedMunicipalities.length > 0 || selectedBarangays.length > 0) {
                    filteredSubmissions = filteredSubmissions.filter(s => {
                        const userProfile = s.userProfile;
                        if (!userProfile) return false;

                        const provinceMatch = selectedProvinces.length === 0 || selectedProvinces.includes(userProfile.province);
                        const municipalityMatch = selectedMunicipalities.length === 0 || selectedMunicipalities.includes(userProfile.municipality);
                        const barangayMatch = selectedBarangays.length === 0 || selectedBarangays.includes(userProfile.barangay);

                        return provinceMatch && municipalityMatch && barangayMatch;
                    });
                }

                filteredSubmissions.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
                renderAllReports(filteredSubmissions);

            } catch (error) {
                console.error("Error loading all reports:", error);
                showToast("Could not load reports. Please try again.", "error");
                reportsContainer.innerHTML = `<div class="text-center text-red-500 mt-20"><p>Could not load reports.</p></div>`;
            }
        }

        let currentDiagnosisTarget = null; // Holds { userId, farmId, submissionId }
        let currentEscalationTarget = null; // Holds { userId, farmId, submissionId }

        async function loadReportsForDiagnosis() {
            if (!currentUser) return;

            // This is a placeholder for role checking. In a real app, you'd secure this.
            // For now, we assume if you can see the button, you have access.

            const diagnosisContainer = document.getElementById('diagnosis-reports-container');
            diagnosisContainer.innerHTML = `<div class="text-center text-gray-500 mt-20"><i data-lucide="loader" class="w-12 h-12 mx-auto text-gray-400 animate-spin"></i><p class="mt-4">Loading reports...</p></div>`;
            lucide.createIcons();

            try {
                // Inefficient Query: This iterates through all users and their farms.
                // A better DB structure would be a single top-level 'submissions' collection
                // that could be queried directly.
                const usersSnapshot = await getDocs(collection(db, 'users'));
                let submissionsForDiagnosis = [];

                for (const userDoc of usersSnapshot.docs) {
                    const farmLotsCollection = collection(db, 'users', userDoc.id, 'farmLots');
                    const farmLotsSnapshot = await getDocs(farmLotsCollection);

                    for (const farmDoc of farmLotsSnapshot.docs) {
                        const submissionsCollection = collection(db, 'users', userDoc.id, 'farmLots', farmDoc.id, 'submissions');
                        const submissionsSnapshot = await getDocs(submissionsCollection);

                        submissionsSnapshot.forEach(submissionDoc => {
                            const submissionData = submissionDoc.data();
                            // Show reports that don't have an initial diagnosis yet.
                            if (!submissionData.initialDiagnosis) {
                                submissionsForDiagnosis.push({
                                    ...submissionData,
                                    userId: userDoc.id,
                                    farmId: farmDoc.id,
                                    submissionId: submissionDoc.id,
                                    farmName: farmDoc.data().farmName // Include farm name for context
                                });
                            }
                        });
                    }
                }

                renderReportsForDiagnosis(submissionsForDiagnosis);

            } catch (error) {
                console.error("Error loading reports for diagnosis:", error);
                diagnosisContainer.innerHTML = `<div class="text-center text-red-500 mt-20"><p>Error loading reports. You may not have the required permissions.</p></div>`;
                showToast("Could not load reports for diagnosis.", "error");
            }
        }

        function renderReportsForDiagnosis(submissions) {
            const diagnosisContainer = document.getElementById('diagnosis-reports-container');
            diagnosisContainer.innerHTML = '';

            if (submissions.length === 0) {
                diagnosisContainer.innerHTML = `
                    <div class="text-center text-gray-500 mt-20">
                        <i data-lucide="check-circle-2" class="w-12 h-12 mx-auto text-green-500"></i>
                        <p class="mt-4">No reports are currently awaiting diagnosis.</p>
                        <p>Good job!</p>
                    </div>`;
                lucide.createIcons();
                return;
            }

            submissions.forEach(submission => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-xl mb-4 shadow-sm border border-gray-200 cursor-pointer hover:shadow-md transition-shadow';
                card.setAttribute('data-user-id', submission.userId);
                card.setAttribute('data-farm-id', submission.farmId);
                card.setAttribute('data-submission-id', submission.submissionId);

                const submissionDate = submission.timestamp?.toDate ? submission.timestamp.toDate() : new Date();
                const dateString = submissionDate.toLocaleDateString();

                const thumbnailUrl = (submission.imageDownloadUrls && submission.imageDownloadUrls.length > 0)
                    ? submission.imageDownloadUrls[0]
                    : (submission.imageDataUrl || 'https://placehold.co/96x96/e2e8f0/334155?text=No+Image');


                card.innerHTML = `
                    <div class="flex items-start">
                        <img src="${thumbnailUrl}" class="w-24 h-24 rounded-md mr-4 object-cover">
                        <div class="flex-grow">
                            <p class="font-bold text-lg">${submission.farmName}</p>
                            <p class="text-sm text-gray-500 mb-2">Reported on ${dateString}</p>
                            <p class="text-sm"><strong>Symptoms:</strong> <span class="capitalize">${submission.symptoms.join(', ')}</span></p>
                            <p class="text-sm"><strong>Severity:</strong> <span class="capitalize">${submission.severity}</span></p>
                        </div>
                    </div>
                `;

                card.addEventListener('click', () => {
                    currentDiagnosisTarget = {
                        userId: submission.userId,
                        farmId: submission.farmId,
                        submissionId: submission.submissionId
                    };

                    const imageUrls = submission.imageDownloadUrls || (submission.imageDataUrl ? [submission.imageDataUrl] : []);
                    const imageGridHTML = imageUrls.length > 0
                        ? `<div class="grid grid-cols-2 md:grid-cols-3 gap-2 my-2">${imageUrls.map(url => `<a href="${url}" target="_blank"><img src="${url}" class="rounded-lg w-full aspect-square object-cover"></a>`).join('')}</div>`
                        : `<p class="text-sm text-gray-500">No image submitted.</p>`;

                    // Populate and show the modal
                    const detailsContainer = document.getElementById('diagnosis-report-details');
                    detailsContainer.innerHTML = `
                        <p><strong>Farm:</strong> ${submission.farmName}</p>
                        ${imageGridHTML}
                        <p><strong>Symptoms:</strong> ${submission.symptoms.join(', ')}</p>
                        <p><strong>Distribution:</strong> ${submission.distribution}</p>
                        <p><strong>Severity:</strong> ${submission.severity}</p>
                    `;

                    // Populate dropdown and reset fields
                    const pestDiseaseSelect = document.getElementById('pest-disease-select');
                    populatePestDiseaseDropdown(pestDiseaseSelect);
                    document.getElementById('pest-disease-info').innerHTML = '';
                    document.getElementById('pest-disease-info').classList.add('hidden');
                    document.getElementById('diagnosis-notes').value = '';

                    document.getElementById('diagnosis-modal').classList.remove('hidden');
                    document.getElementById('diagnosis-modal').classList.add('flex');
                    lucide.createIcons();
                });

                diagnosisContainer.appendChild(card);
            });
            lucide.createIcons();
        }

        let currentTreatmentTarget = null; // Holds { userId, farmId, submissionId }

        async function loadReportsForTreatment() {
            if (!currentUser) return;

            const treatmentContainer = document.getElementById('treatment-reports-container');
            treatmentContainer.innerHTML = `<div class="text-center text-gray-500 mt-20"><i data-lucide="loader" class="w-12 h-12 mx-auto text-gray-400 animate-spin"></i><p class="mt-4">Loading reports...</p></div>`;
            lucide.createIcons();

            try {
                const usersSnapshot = await getDocs(collection(db, 'users'));
                let submissionsForTreatment = [];

                for (const userDoc of usersSnapshot.docs) {
                    const farmLotsCollection = collection(db, 'users', userDoc.id, 'farmLots');
                    const farmLotsSnapshot = await getDocs(farmLotsCollection);

                    for (const farmDoc of farmLotsSnapshot.docs) {
                        const submissionsCollection = collection(db, 'users', userDoc.id, 'farmLots', farmDoc.id, 'submissions');
                        const submissionsSnapshot = await getDocs(submissionsCollection);

                        submissionsSnapshot.forEach(submissionDoc => {
                            const submissionData = submissionDoc.data();
                            const canReEvaluate = ['Branch Coordinator', 'Expert', 'Administrator'].includes(userProfile.role);
                            if (submissionData.initialDiagnosis && (!submissionData.finalDiagnosis || canReEvaluate)) {
                                submissionsForTreatment.push({
                                    ...submissionData,
                                    userId: userDoc.id,
                                    farmId: farmDoc.id,
                                    submissionId: submissionDoc.id,
                                    farmName: farmDoc.data().farmName
                                });
                            }
                        });
                    }
                }

                renderReportsForTreatment(submissionsForTreatment);

            } catch (error) {
                console.error("Error loading reports for treatment:", error);
                treatmentContainer.innerHTML = `<div class="text-center text-red-500 mt-20"><p>Error loading reports.</p></div>`;
                showToast("Could not load reports for treatment.", "error");
            }
        }

        function setupTreatmentModal(submissionData) {
            currentTreatmentTarget = {
                userId: submissionData.userId,
                farmId: submissionData.farmId,
                submissionId: submissionData.submissionId
            };

            const detailsContainer = document.getElementById('treatment-report-details');
            detailsContainer.innerHTML = `
                <p class="font-bold text-lg">${submissionData.farmName}</p>
                <p class="font-semibold text-gray-800 mt-2">Initial Diagnosis:</p>
                <div class="pl-2 border-l-2 border-gray-200">
                    <p><strong>Pest/Disease:</strong> ${submissionData.initialDiagnosis.pestDisease}</p>
                    <p class="text-sm text-gray-600"><strong>Notes:</strong> ${submissionData.initialDiagnosis.notes || 'N/A'}</p>
                    <p class="text-sm text-gray-600"><strong>Diagnosed by:</strong> ${submissionData.initialDiagnosis.diagnosedByName || 'N/A'}</p>
                </div>
            `;

            const finalPestDiseaseSelect = document.getElementById('final-pest-disease-select');
            const saveBtn = document.getElementById('save-treatment-btn');
            const escalateBtn = document.getElementById('escalate-from-treatment-btn');

            const populateAndCheck = () => {
                const selectedName = finalPestDiseaseSelect.value;
                if (!selectedName) return;

                const allItems = [
                    ...(pestAndDiseaseData.fungal_and_bacterial_diseases || []),
                    ...(pestAndDiseaseData.major_insect_pests || [])
                ];
                const selectedItem = allItems.find(item => (item['Disease Name'] || item['Pest Common Name']) === selectedName);

                if (selectedItem && selectedItem.management) {
                    populateCheckboxes(document.getElementById('treatment-prevention-list'), selectedItem.management.prevention, 'prevention');
                    populateCheckboxes(document.getElementById('treatment-monitoring-list'), selectedItem.management.monitoring, 'monitoring');
                    populateCheckboxes(document.getElementById('treatment-control-list'), selectedItem.management.direct_control, 'control');

                    if (submissionData.treatment) {
                        const { prevention, monitoring, control } = submissionData.treatment;
                        const checkItems = (list, category) => {
                            if (list) list.forEach(item => {
                                const checkbox = document.querySelector(`#treatment-${category}-list input[value="${item.replace(/"/g, '\\"')}"]`);
                                if (checkbox) checkbox.checked = true;
                            });
                        };
                        checkItems(prevention, 'prevention');
                        checkItems(monitoring, 'monitoring');
                        checkItems(control, 'control');
                    }
                }
            };

            finalPestDiseaseSelect.onchange = populateAndCheck;
            populatePestDiseaseDropdown(finalPestDiseaseSelect);

            if (submissionData.finalDiagnosis) {
                saveBtn.textContent = 'Update Treatment Plan';
                escalateBtn.classList.add('hidden');
                const { instructions, followUpDate } = submissionData.treatment || {};
                finalPestDiseaseSelect.value = submissionData.finalDiagnosis.pestDisease;
                document.getElementById('final-diagnosis-notes').value = submissionData.finalDiagnosis.notes || '';
                document.getElementById('treatment-instructions').value = instructions || '';
                document.getElementById('follow-up-date').value = followUpDate || '';
            } else {
                saveBtn.textContent = 'Save Treatment Plan';
                if (userProfile.role === 'Branch Coordinator' && !submissionData.isEscalated) {
                    escalateBtn.classList.remove('hidden');
                } else {
                    escalateBtn.classList.add('hidden');
                }
                finalPestDiseaseSelect.value = submissionData.initialDiagnosis.pestDisease;
                document.getElementById('final-diagnosis-notes').value = submissionData.initialDiagnosis.notes || '';
                document.getElementById('treatment-instructions').value = '';
                document.getElementById('follow-up-date').value = '';
            }

            populateAndCheck();

            document.getElementById('treatment-modal').classList.remove('hidden');
            document.getElementById('treatment-modal').classList.add('flex');
            lucide.createIcons();
        }

        function renderReportsForTreatment(submissions) {
            const treatmentContainer = document.getElementById('treatment-reports-container');
            treatmentContainer.innerHTML = '';

            if (submissions.length === 0) {
                treatmentContainer.innerHTML = `
                    <div class="text-center text-gray-500 mt-20">
                        <i data-lucide="check-circle-2" class="w-12 h-12 mx-auto text-green-500"></i>
                        <p class="mt-4">No reports are currently awaiting a treatment plan.</p>
                    </div>`;
                lucide.createIcons();
                return;
            }

            submissions.forEach(submission => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-xl mb-4 shadow-sm border border-gray-200 cursor-pointer hover:shadow-md transition-shadow';

                card.addEventListener('click', () => {
                    setupTreatmentModal(submission);
                });

                if (submission.finalDiagnosis) {
                    card.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-bold text-lg">${submission.farmName}</p>
                                <p><strong>Final Diagnosis:</strong> ${submission.finalDiagnosis.pestDisease}</p>
                                <p class="text-sm text-green-600">Treatment has been provided.</p>
                            </div>
                            <button class="bg-yellow-500 text-white text-sm font-bold py-2 px-3 rounded-lg">Re-evaluate</button>
                        </div>
                    `;
                } else {
                    card.innerHTML = `
                        <div class="flex justify-between items-center">
                             <div>
                                <p class="font-bold text-lg">${submission.farmName}</p>
                                <p><strong>Initial Diagnosis:</strong> ${submission.initialDiagnosis.pestDisease}</p>
                                <p class="text-sm text-gray-600">Diagnosed by ${submission.initialDiagnosis.diagnosedByName || 'an expert'}</p>
                            </div>
                            <button class="bg-blue-500 text-white text-sm font-bold py-2 px-3 rounded-lg">Provide Treatment</button>
                        </div>
                    `;
                }
                treatmentContainer.appendChild(card);
            });
            lucide.createIcons();
        }

        // --- Treatment Modal Logic ---
        function populateCheckboxes(container, items, category) {
            container.innerHTML = '';
            if (!items || items.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No recommendations available.</p>';
                return;
            }
            items.forEach((item, index) => {
                const checkboxId = `${category}-${index}`;
                const div = document.createElement('div');
                div.className = 'flex items-start';
                div.innerHTML = `
                    <div class="flex items-center h-5">
                        <input id="${checkboxId}" name="${category}" value="${item}" type="checkbox" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300 rounded">
                    </div>
                    <div class="ml-3 text-sm">
                        <label for="${checkboxId}" class="font-medium text-gray-700">${item}</label>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        document.getElementById('final-pest-disease-select').addEventListener('change', (e) => {
            const selectedName = e.target.value;
            const infoContainer = document.getElementById('final-pest-disease-info');
            const preventionContainer = document.getElementById('treatment-prevention-list');
            const monitoringContainer = document.getElementById('treatment-monitoring-list');
            const controlContainer = document.getElementById('treatment-control-list');

            // Clear everything first
            infoContainer.innerHTML = '';
            infoContainer.classList.add('hidden');
            preventionContainer.innerHTML = '';
            monitoringContainer.innerHTML = '';
            controlContainer.innerHTML = '';

            if (!selectedName) return;

            const allItems = [
                ...(pestAndDiseaseData.fungal_and_bacterial_diseases || []),
                ...(pestAndDiseaseData.major_insect_pests || [])
            ];
            const selectedItem = allItems.find(item => (item['Disease Name'] || item['Pest Common Name']) === selectedName);

            if (selectedItem) {
                // Populate info section
                let infoHTML = '';
                if (selectedItem['Causal Agents']) { // It's a disease
                    infoHTML += `<p><strong>Causal Agent:</strong> ${selectedItem['Causal Agents']}</p>`;
                    infoHTML += `<p class="mt-2"><strong>Symptoms:</strong> ${selectedItem['Primary Visual Symptoms']}</p>`;
                } else { // It's a pest
                    infoHTML += `<p><strong>Scientific Name:</strong> ${selectedItem['Scientific Name']}</p>`;
                    infoHTML += `<p><strong>Feeding Guild:</strong> ${selectedItem['Feeding Guild']}</p>`;
                    infoHTML += `<p class="mt-2"><strong>Damage:</strong> ${selectedItem['Characteristic Visual Damage']}</p>`;
                }
                if (selectedItem['Key Plant Parts Affected']) {
                    infoHTML += `<p class="mt-2"><strong>Key Parts Affected:</strong> ${selectedItem['Key Plant Parts Affected'].join(', ')}</p>`;
                }
                infoContainer.innerHTML = infoHTML;
                infoContainer.classList.remove('hidden');

                // Populate treatment plan checkboxes
                const management = selectedItem.management;
                if (management) {
                    populateCheckboxes(preventionContainer, management.prevention, 'prevention');
                    populateCheckboxes(monitoringContainer, management.monitoring, 'monitoring');
                    populateCheckboxes(controlContainer, management.direct_control, 'control');
                }
            }
        });

        document.getElementById('close-treatment-modal-btn').addEventListener('click', () => {
            document.getElementById('treatment-modal').classList.add('hidden');
            document.getElementById('treatment-modal').classList.remove('flex');
            currentTreatmentTarget = null;
        });

        document.getElementById('close-escalation-modal-btn').addEventListener('click', () => {
            document.getElementById('escalation-modal').classList.add('hidden');
            document.getElementById('escalation-modal').classList.remove('flex');
            currentEscalationTarget = null;
        });

        document.getElementById('escalate-from-treatment-btn').addEventListener('click', () => {
            if (!currentTreatmentTarget) return;

            currentEscalationTarget = { ...currentTreatmentTarget };

            document.getElementById('treatment-modal').classList.add('hidden');
            document.getElementById('escalation-modal').classList.remove('hidden');
            document.getElementById('escalation-modal').classList.add('flex');
        });

        document.getElementById('confirm-escalate-btn').addEventListener('click', async () => {
            if (!currentEscalationTarget) {
                showToast('No report targeted for escalation.', 'error');
                return;
            }

            const infestationPercentage = document.getElementById('infestation-percentage').value;
            const samplesCollectedDate = document.getElementById('samples-collected-date').value;
            const farmerContact = document.getElementById('farmer-contact').value;
            const samplesNotes = document.getElementById('samples-notes').value.trim();

            if (!infestationPercentage || !samplesCollectedDate || !farmerContact || !samplesNotes) {
                showToast('Please fill out all escalation fields.', 'error');
                return;
            }

            showSavingOverlay('Escalating Report...');

            const escalationData = {
                isEscalated: true,
                escalatedAt: serverTimestamp(),
                escalatedBy: currentUser.uid,
                escalatedByName: userProfile.fullName,
                escalationDetails: {
                    infestationPercentage: Number(infestationPercentage),
                    samplesCollectedDate,
                    farmerContact,
                    samplesNotes
                }
            };

            try {
                const { userId, farmId, submissionId } = currentEscalationTarget;
                const submissionDocRef = doc(db, 'users', userId, 'farmLots', farmId, 'submissions', submissionId);

                await updateDoc(submissionDocRef, escalationData);

                showToast('Report escalated to expert successfully!', 'success');
                document.getElementById('close-escalation-modal-btn').click();
                loadAllReports(); // Refresh the reports list

            } catch (error) {
                console.error('Error escalating report:', error);
                showToast('Could not escalate report. Please try again.', 'error');
            } finally {
                hideSavingOverlay();
            }
        });

        document.getElementById('save-treatment-btn').addEventListener('click', async () => {
            if (!currentTreatmentTarget) {
                showToast('No report selected for treatment.', 'error');
                return;
            }

            const finalPestDisease = document.getElementById('final-pest-disease-select').value;
            const finalDiagnosisNotes = document.getElementById('final-diagnosis-notes').value.trim();

            const prevention = Array.from(document.querySelectorAll('#treatment-prevention-list input:checked')).map(cb => cb.value);
            const monitoring = Array.from(document.querySelectorAll('#treatment-monitoring-list input:checked')).map(cb => cb.value);
            const control = Array.from(document.querySelectorAll('#treatment-control-list input:checked')).map(cb => cb.value);

            const instructions = document.getElementById('treatment-instructions').value.trim();
            const followUpDate = document.getElementById('follow-up-date').value;

            if (!finalPestDisease) {
                showToast('Please provide a final diagnosis.', 'error');
                return;
            }
             if (prevention.length === 0 && monitoring.length === 0 && control.length === 0) {
                showToast('Please select at least one treatment action.', 'error');
                return;
            }
             if (!instructions) {
                showToast('Please provide specific instructions.', 'error');
                return;
            }


            showSavingOverlay('Saving Final Diagnosis & Treatment...');

            const finalDiagnosisData = {
                pestDisease: finalPestDisease,
                notes: finalDiagnosisNotes,
                diagnosedBy: currentUser.uid,
                diagnosedByName: userProfile.fullName,
                diagnosedAt: serverTimestamp()
            };

            const treatmentData = {
                prevention,
                monitoring,
                control,
                instructions,
                followUpDate,
                createdBy: currentUser.uid,
                createdByName: userProfile.fullName,
                createdAt: serverTimestamp()
            };

            try {
                const { userId, farmId, submissionId } = currentTreatmentTarget;
                const submissionDocRef = doc(db, 'users', userId, 'farmLots', farmId, 'submissions', submissionId);

                await updateDoc(submissionDocRef, {
                    finalDiagnosis: finalDiagnosisData,
                    treatment: treatmentData,
                    status: 'Treatment Provided'
                });

                showToast('Final diagnosis and treatment plan saved!', 'success');
                document.getElementById('close-treatment-modal-btn').click();

                // Refresh the current screen to show changes
                const activeScreenId = document.querySelector('.screen.active').id;
                if (activeScreenId === 'treatment-screen') {
                    loadReportsForTreatment();
                } else if (activeScreenId === 'online-clinic-screen') {
                    loadOnlineClinicReports();
                } else {
                    // Fallback refresh
                    loadReportsForTreatment();
                }

            } catch (error) {
                console.error('Error saving treatment plan:', error);
                showToast('Could not save treatment plan.', 'error');
            } finally {
                hideSavingOverlay();
            }
        });

        // --- Diagnosis Modal Logic ---

        function populatePestDiseaseDropdown(selectElement) {
            if (!pestAndDiseaseData) {
                console.error("Pest and disease data not loaded.");
                selectElement.innerHTML = '<option value="">Failed to load data</option>';
                return;
            }

            selectElement.innerHTML = '<option value="">Select a pest or disease...</option>';

            const diseases = pestAndDiseaseData.fungal_and_bacterial_diseases || [];
            const pests = pestAndDiseaseData.major_insect_pests || [];

            // Add diseases
            const diseaseGroup = document.createElement('optgroup');
            diseaseGroup.label = 'Fungal & Bacterial Diseases';
            diseases.forEach(disease => {
                const option = document.createElement('option');
                option.value = disease['Disease Name'];
                option.textContent = disease['Disease Name'];
                diseaseGroup.appendChild(option);
            });
            selectElement.appendChild(diseaseGroup);

            // Add pests
            const pestGroup = document.createElement('optgroup');
            pestGroup.label = 'Major Insect Pests';
            pests.forEach(pest => {
                const option = document.createElement('option');
                option.value = pest['Pest Common Name'];
                option.textContent = pest['Pest Common Name'];
                pestGroup.appendChild(option);
            });
            selectElement.appendChild(pestGroup);
        }

        document.getElementById('pest-disease-select').addEventListener('change', (e) => {
            const selectedName = e.target.value;
            const infoContainer = document.getElementById('pest-disease-info');

            if (!selectedName) {
                infoContainer.innerHTML = '';
                infoContainer.classList.add('hidden');
                return;
            }

            const allItems = [
                ...(pestAndDiseaseData.fungal_and_bacterial_diseases || []),
                ...(pestAndDiseaseData.major_insect_pests || [])
            ];

            const selectedItem = allItems.find(item => (item['Disease Name'] || item['Pest Common Name']) === selectedName);

            if (selectedItem) {
                let infoHTML = '';
                if (selectedItem['Causal Agents']) { // It's a disease
                    infoHTML += `<p><strong>Causal Agent:</strong> ${selectedItem['Causal Agents']}</p>`;
                    infoHTML += `<p class="mt-2"><strong>Symptoms:</strong> ${selectedItem['Primary Visual Symptoms']}</p>`;
                } else { // It's a pest
                    infoHTML += `<p><strong>Scientific Name:</strong> ${selectedItem['Scientific Name']}</p>`;
                    infoHTML += `<p><strong>Feeding Guild:</strong> ${selectedItem['Feeding Guild']}</p>`;
                    infoHTML += `<p class="mt-2"><strong>Damage:</strong> ${selectedItem['Characteristic Visual Damage']}</p>`;
                }
                if (selectedItem['Key Plant Parts Affected']) {
                    infoHTML += `<p class="mt-2"><strong>Key Parts Affected:</strong> ${selectedItem['Key Plant Parts Affected'].join(', ')}</p>`;
                }
                infoContainer.innerHTML = infoHTML;
                infoContainer.classList.remove('hidden');
            } else {
                infoContainer.innerHTML = '';
                infoContainer.classList.add('hidden');
            }
        });

        document.getElementById('close-diagnosis-modal-btn').addEventListener('click', () => {
            document.getElementById('diagnosis-modal').classList.add('hidden');
            document.getElementById('diagnosis-modal').classList.remove('flex');
            currentDiagnosisTarget = null;
        });

        document.getElementById('save-diagnosis-btn').addEventListener('click', async () => {
            if (!currentDiagnosisTarget) {
                showToast('No report selected for diagnosis.', 'error');
                return;
            }

            const pestDisease = document.getElementById('pest-disease-select').value;
            const notes = document.getElementById('diagnosis-notes').value.trim();

            if (!pestDisease) {
                showToast('Please identify a pest or disease from the dropdown.', 'error');
                return;
            }

            showSavingOverlay('Saving Diagnosis...');

            const initialDiagnosisData = {
                pestDisease,
                notes,
                diagnosedBy: currentUser.uid,
                diagnosedByName: userProfile.fullName,
                diagnosedAt: serverTimestamp()
            };

            try {
                const { userId, farmId, submissionId } = currentDiagnosisTarget;
                const submissionDocRef = doc(db, 'users', userId, 'farmLots', farmId, 'submissions', submissionId);

                await updateDoc(submissionDocRef, {
                    initialDiagnosis: initialDiagnosisData,
                    status: 'Pending Final Diagnosis'
                });

                showToast('Initial diagnosis submitted successfully!', 'success');
                document.getElementById('close-diagnosis-modal-btn').click(); // Close modal
                loadReportsForDiagnosis(); // Refresh the list

            } catch (error) {
                console.error('Error saving diagnosis:', error);
                showToast('Could not save diagnosis. Please try again.', 'error');
            } finally {
                hideSavingOverlay();
            }
        });

        function renderAllReports(submissions) {
    const reportsContainer = document.getElementById('reports-container');
    reportsContainer.innerHTML = '';

    if (submissions.length === 0) {
        reportsContainer.innerHTML = `
            <div class="text-center text-gray-500 mt-20">
                <i data-lucide="folder-search" class="w-12 h-12 mx-auto text-gray-400"></i>
                <p class="mt-4">No reports found for the selected filter.</p>
            </div>`;
        lucide.createIcons();
        return;
    }

    // Create a grid container
    const gridContainer = document.createElement('div');
    gridContainer.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 p-6';
    reportsContainer.appendChild(gridContainer);

    submissions.forEach(submission => {
        const reportButton = document.createElement('button');
        reportButton.className = 'relative aspect-square bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden text-left p-4 flex flex-col justify-between transform transition-transform duration-200 hover:scale-105 hover:shadow-lg';

        const submissionDate = submission.timestamp?.toDate ? submission.timestamp.toDate() : new Date();
        const dateString = submissionDate.toLocaleDateString();

        let statusHTML = '';
        if (submission.status === 'Treatment Provided') {
            statusHTML = `<span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-white bg-blue-500">Treated</span>`;
        } else if (submission.status === 'Pending Final Diagnosis') {
            statusHTML = `<span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-yellow-800 bg-yellow-200">Diagnosed</span>`;
        } else {
            statusHTML = `<span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-red-800 bg-red-200">Pending</span>`;
        }

        let farmerNameHTML = '';
        if (submission.userProfile && userProfile.role !== 'Farmer') {
            farmerNameHTML = `<p class="text-sm text-gray-500 truncate">Farmer: ${submission.userProfile.fullName}</p>`;
        }

        const thumbnailUrl = (submission.imageDownloadUrls && submission.imageDownloadUrls.length > 0)
            ? submission.imageDownloadUrls[0]
            : (submission.imageDataUrl || 'https://placehold.co/96x96/e2e8f0/334155?text=No+Image');

        reportButton.innerHTML = `
            <div class="absolute inset-0 bg-cover bg-center" style="background-image: url('${thumbnailUrl}');">
                <div class="absolute inset-0 bg-black bg-opacity-40 group-hover:bg-opacity-60 transition-all"></div>
            </div>
            <div class="relative z-10 flex flex-col h-full text-white">
                <div class="flex justify-between items-start">
                    <p class="font-bold text-lg">${submission.farmName}</p>
                    ${statusHTML}
                </div>
                <div class="mt-auto">
                    ${farmerNameHTML}
                    <p class="text-sm"><strong>Symptoms:</strong> <span class="capitalize">${submission.symptoms.join(', ')}</span></p>
                    <p class="text-xs mt-1">${dateString}</p>
                </div>
            </div>
        `;

        reportButton.addEventListener('click', async () => {
            // Record the view action
            const reportRef = doc(db, 'users', submission.userId, 'farmLots', submission.farmId, 'submissions', submission.id);
            await updateDoc(reportRef, {
                history: arrayUnion({
                    action: 'view',
                    timestamp: new Date(),
                    userId: currentUser.uid,
                    userName: userProfile.fullName
                })
            });

            const modal = document.getElementById('report-details-modal');
            const modalContent = document.getElementById('report-details-content');
            const modalActions = document.getElementById('report-details-actions');
            const closeModalBtn = document.getElementById('close-report-details-modal-btn');
            let detailMap = null;

            modalContent.innerHTML = `<div class="text-center text-gray-500 p-8"><i data-lucide="loader" class="animate-spin inline-block"></i> Loading details...</div>`;
            modalActions.innerHTML = '';
            lucide.createIcons();

            modal.classList.remove('hidden');
            modal.classList.add('flex');

            const mapId = `report-map-${submission.id}`;

            let initialDiagnosisHTML = '';
            if (submission.initialDiagnosis) {
                initialDiagnosisHTML = `
                    <div class="mt-4 pt-4 border-t">
                        <h4 class="font-bold text-gray-800">Initial Diagnosis</h4>
                        <p class="text-sm"><strong>Pest/Disease:</strong> ${submission.initialDiagnosis.pestDisease}</p>
                        <p class="text-sm"><strong>Notes:</strong> ${submission.initialDiagnosis.notes || 'N/A'}</p>
                        <p class="text-xs text-gray-500 mt-1">by ${submission.initialDiagnosis.diagnosedByName}</p>
                    </div>`;
            }

            let finalDiagnosisHTML = '';
            if (submission.finalDiagnosis) {
                finalDiagnosisHTML = `
                    <div class="mt-4 pt-4 border-t">
                        <h4 class="font-bold text-gray-800">Final Diagnosis</h4>
                        <p class="text-sm"><strong>Pest/Disease:</strong> ${submission.finalDiagnosis.pestDisease}</p>
                        <p class="text-sm"><strong>Notes:</strong> ${submission.finalDiagnosis.notes || 'N/A'}</p>
                        <p class="text-xs text-gray-500 mt-1">by ${submission.finalDiagnosis.diagnosedByName}</p>
                    </div>`;
            }

            let treatmentHTML = '';
            if (submission.treatment) {
                const { prevention, monitoring, control, instructions, followUpDate } = submission.treatment;

                const createSection = (title, items) => {
                    if (!items || items.length === 0) return '';
                    return `
                        <div class="mt-3">
                            <h5 class="font-semibold text-gray-700">${title}</h5>
                            <ul class="list-disc list-inside text-sm text-gray-600 mt-1 space-y-1">
                                ${items.map(item => `<li>${item}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                };

                treatmentHTML = `
                    <div class="mt-4 pt-4 border-t">
                        <h4 class="font-bold text-lg text-gray-800">Treatment Plan</h4>
                        ${createSection('Prevention', prevention)}
                        ${createSection('Monitoring', monitoring)}
                        ${createSection('Direct Control', control)}
                        <div class="mt-3">
                            <h5 class="font-semibold text-gray-700">Specific Instructions</h5>
                            <p class="text-sm text-gray-600 mt-1">${instructions || 'N/A'}</p>
                        </div>
                        ${followUpDate ? `
                        <div class="mt-3">
                            <h5 class="font-semibold text-gray-700">Follow-up Date</h5>
                            <p class="text-sm text-gray-600 mt-1">${followUpDate}</p>
                        </div>` : ''}
                    </div>`;
            }

            const imageUrls = submission.imageDownloadUrls || (submission.imageDataUrl ? [submission.imageDataUrl] : []);
            const imageGridHTML = imageUrls.length > 0
                ? `<div class="grid grid-cols-2 md:grid-cols-3 gap-2">${imageUrls.map(url => `<a href="${url}" target="_blank"><img src="${url}" class="rounded-lg w-full aspect-square object-cover"></a>`).join('')}</div>`
                : `<p class="text-sm text-gray-500">No images submitted.</p>`;


            let additionalInfoHTML = '';
            if (submission.affectedParts || submission.onsetDate || submission.progression || submission.pestSigns) {
                additionalInfoHTML = `
                    <div class="mt-4 pt-4 border-t">
                        <h4 class="font-bold text-gray-800">Additional Information</h4>
                        ${submission.affectedParts ? `<p class="text-sm"><strong>Affected Parts:</strong> ${submission.affectedParts.join(', ')}</p>` : ''}
                        ${submission.onsetDate ? `<p class="text-sm"><strong>Symptom Onset:</strong> ${submission.onsetDate}</p>` : ''}
                        ${submission.progression ? `<p class="text-sm"><strong>Progression:</strong> ${submission.progression}</p>` : ''}
                        ${submission.pestSigns ? `<p class="text-sm"><strong>Pest Signs:</strong> ${submission.pestSigns}</p>` : ''}
                    </div>
                `;
            }

            modalContent.innerHTML = `
                <div id="${mapId}" class="w-full h-48 bg-gray-200 rounded-md shadow-inner mb-4"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                     <div>
                        <h4 class="font-bold text-gray-800 mb-2">Uploaded Images</h4>
                        ${imageGridHTML}
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-800">Report Information</h4>
                        <p class="text-sm"><strong>Symptoms:</strong> ${submission.symptoms.join(', ')}</p>
                        <p class="text-sm"><strong>Distribution:</strong> ${submission.distribution}</p>
                        <p class="text-sm"><strong>Severity:</strong> ${submission.severity}</p>
                    </div>
                </div>
                ${additionalInfoHTML}
                ${initialDiagnosisHTML}
                ${finalDiagnosisHTML}
                ${treatmentHTML}
            `;

            modalActions.innerHTML = `
                <button id="edit-report-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Update</button>
                <button id="delete-report-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md ml-2">Delete</button>
            `;
            document.getElementById('edit-report-btn').addEventListener('click', () => {
                // Navigate to the edit screen
                isEditSubmissionMode = true;
                currentSubmissionId = submission.id;
                const lastContext = navigationHistory[navigationHistory.length - 1]?.context || {};
                const newContext = { ...lastContext, farmId: submission.farmId, submissionId: submission.id, label: 'Edit Report' };
                showScreen('newSubmission', newContext);
                modal.classList.add('hidden');
            });

            document.getElementById('delete-report-btn').addEventListener('click', async () => {
                if (confirm('Are you sure you want to delete this report? This action cannot be undone.')) {
                    showSavingOverlay('Deleting Report...');
                    try {
                        const reportDocRef = doc(db, 'users', submission.userId, 'farmLots', submission.farmId, 'submissions', submission.id);
                        await deleteDoc(reportDocRef);
                        showToast('Report deleted successfully.', 'success');
                        modal.classList.add('hidden');
                        loadAllReports(); // Refresh the reports list
                    } catch (error) {
                        console.error('Error deleting report:', error);
                        showToast('Failed to delete report.', 'error');
                    } finally {
                        hideSavingOverlay();
                    }
                }
            });

            try {
                const farmDocRef = doc(db, 'users', submission.userId, 'farmLots', submission.farmId);
                const farmDocSnap = await getDoc(farmDocRef);
                if (farmDocSnap.exists()) {
                    const farmData = farmDocSnap.data();
                    const coordinates = farmData.polygonCoordinates;

                    detailMap = L.map(mapId, { scrollWheelZoom: false, dragging: false, zoomControl: false });
                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Tiles &copy; Esri'
                    }).addTo(detailMap);

                    if (coordinates && coordinates.length > 0) {
                        const latLngs = coordinates.map(c => [c.lat, c.lng]);
                        const polygon = L.polygon(latLngs, {color: '#22c55e'}).addTo(detailMap);
                        detailMap.fitBounds(polygon.getBounds());
                    }
                    setTimeout(() => detailMap.invalidateSize(), 0);
                }
            } catch (e) {
                console.error("Could not load map for report", e);
                document.getElementById(mapId).innerHTML = '<p class="text-red-500">Could not load map.</p>';
            }

            lucide.createIcons();

            const closeModal = () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                if (detailMap) {
                    detailMap.remove();
                }
                closeModalBtn.removeEventListener('click', closeModal);
            };
            closeModalBtn.addEventListener('click', closeModal, { once: true });
        });

        gridContainer.appendChild(reportButton);
    });
    lucide.createIcons();
}

        function loadFarms(context) {
            const targetUserId = context.userId || (currentUser ? currentUser.uid : null);
            if (!targetUserId) return;

            const welcomeMessage = document.getElementById('welcome-message');
            const farmListTitle = document.querySelector('#farm-list-screen h2');
            const addFarmBtn = document.getElementById('add-farm-btn');

            if (context.userId && context.userId !== currentUser.uid) {
                // Viewing someone else's farms (drill-down)
                welcomeMessage.textContent = `Viewing farms for ${context.userName}`;
                farmListTitle.textContent = `${context.userName}'s Farm Plots`;
                addFarmBtn.style.display = 'none';
            } else {
                // Viewing own farms
                welcomeMessage.textContent = `Welcome, ${userProfile.fullName}`;
                farmListTitle.textContent = 'My Farm Plots';
                if (userProfile.role === 'Farmer') {
                    addFarmBtn.style.display = 'flex';
                } else {
                    addFarmBtn.style.display = 'none';
                }
            }

            const farmLotsCollection = collection(db, 'users', targetUserId, 'farmLots');
            const unsubscribe = onSnapshot(farmLotsCollection, (querySnapshot) => {
                const farmListContainer = document.getElementById('farm-list-container');
                farmListContainer.innerHTML = ''; // Clear existing list
                
                if (querySnapshot.empty) {
                    farmListContainer.innerHTML = `
                        <div class="text-center text-gray-500 mt-20">
                            <i data-lucide="map-pin" class="w-12 h-12 mx-auto text-gray-400"></i>
                            <p class="mt-4">No farm plots found for this user.</p>
                        </div>`;
                } else {
                    querySnapshot.forEach((doc) => {
                        const farm = doc.data();
                        const farmId = doc.id;
                        const farmCard = document.createElement('div');
                        farmCard.className = 'bg-white p-4 rounded-xl mb-4 shadow-sm border border-gray-200 cursor-pointer hover:shadow-md';
                        farmCard.setAttribute('data-id', farmId);

                        const plantingDate = farm.plantingDate ? new Date(farm.plantingDate).toLocaleDateString() : 'N/A';

                        farmCard.innerHTML = `
                            <p class="text-xl font-bold text-gray-800">${farm.farmName}</p>
                            <p class="text-md text-gray-600">Variety: ${farm.tobaccoVariety || 'N/A'}</p>
                            <p class="text-sm text-gray-500">Planted on: ${plantingDate}</p>
                        `;

                        farmCard.addEventListener('click', () => {
                            const newContext = { ...context, farmId: farmId, farmName: farm.farmName, tobaccoVariety: farm.tobaccoVariety, label: farm.farmName };
                            showScreen('dashboard', newContext);
                        });

                        farmListContainer.appendChild(farmCard);
                    });
                }
                lucide.createIcons();
            });
            activeListeners.push(unsubscribe);
        }

        async function loadExtensionWorkerDashboard(context) {
            const ewDashboardContainer = document.getElementById('ew-dashboard-container');
            const welcomeMessage = document.getElementById('ew-welcome-message');
            const dashboardTitle = document.querySelector('#ew-dashboard-screen h2');

            if (context.userId && context.userId !== currentUser.uid) {
                // Coordinator viewing a specific EW's list
                welcomeMessage.textContent = `Viewing farmers for ${context.userName}`;
                dashboardTitle.textContent = `${context.userName}'s Farmer List`;
            } else {
                // EW viewing their own dashboard
                welcomeMessage.textContent = `Welcome, ${userProfile.fullName}`;
                dashboardTitle.textContent = 'Extension Worker Dashboard';
            }

            if (!currentUser) return;
            ewDashboardContainer.innerHTML = `
                <div class="text-center text-gray-500 mt-20">
                    <i data-lucide="loader" class="w-12 h-12 mx-auto text-gray-400 animate-spin"></i>
                    <p class="mt-4">Loading assigned farmers...</p>
                </div>`;
            lucide.createIcons();

            try {
                const usersCollection = collection(db, 'users');
                const q = query(usersCollection, where("role", "==", "Farmer"));
                const querySnapshot = await getDocs(q);

                let farmers = [];
                querySnapshot.forEach(doc => {
                    farmers.push({ id: doc.id, ...doc.data() });
                });

                let farmersWithData = [];
                for (const farmer of farmers) {
                    let latestReportTimestamp = null;
                    const farmLotsCollection = collection(db, 'users', farmer.id, 'farmLots');
                    const farmLotsSnapshot = await getDocs(farmLotsCollection);

                    for (const farmDoc of farmLotsSnapshot.docs) {
                        const submissionsCollection = collection(db, 'users', farmer.id, 'farmLots', farmDoc.id, 'submissions');
                        const subQuery = query(submissionsCollection, orderBy("timestamp", "desc"), limit(1));
                        const submissionsSnapshot = await getDocs(subQuery);

                        if (!submissionsSnapshot.empty) {
                            const latestSubmission = submissionsSnapshot.docs[0].data();
                            const currentTimestamp = latestSubmission.timestamp.toDate();
                            if (!latestReportTimestamp || currentTimestamp > latestReportTimestamp) {
                                latestReportTimestamp = currentTimestamp;
                            }
                        }
                    }
                    farmersWithData.push({ ...farmer, lastReportDate: latestReportTimestamp });
                }

                farmersWithData.sort((a, b) => (b.lastReportDate || 0) - (a.lastReportDate || 0));
                renderFarmerTable(farmersWithData, context);

            } catch (error) {
                console.error("Error loading Extension Worker dashboard:", error);
                ewDashboardContainer.innerHTML = `<div class="text-center text-red-500 mt-20"><p>Could not load farmer data. Check console for details.</p></div>`;
            }
        }

        function renderFarmerTable(farmers, context) {
            const container = document.getElementById('ew-dashboard-container');
            if (!farmers || farmers.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 mt-20">
                        <i data-lucide="users" class="w-12 h-12 mx-auto text-gray-400"></i>
                        <p class="mt-4">No farmers found or assigned.</p>
                    </div>`;
                lucide.createIcons();
                return;
            }

            const tableHtml = `
                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Farmer Name</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Report Date</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="farmer-table-body">
                            ${farmers.map(farmer => `
                                <tr class="hover:bg-gray-50 cursor-pointer" data-farmer-id="${farmer.id}" data-farmer-name="${farmer.fullName}">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900">${farmer.fullName}</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        ${farmer.barangay}, ${farmer.municipality}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        ${farmer.lastReportDate ? farmer.lastReportDate.toLocaleDateString() : 'No reports yet'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = tableHtml;
        }

        async function loadCoordinatorDashboard(context) {
            if (!currentUser) return;

            const container = document.getElementById('coordinator-dashboard-container');
            container.innerHTML = `<div class="text-center text-gray-500 mt-20"><i data-lucide="loader" class="w-12 h-12 mx-auto text-gray-400 animate-spin"></i><p class="mt-4">Loading extension workers...</p></div>`;
            lucide.createIcons();

            try {
                const usersCollection = collection(db, 'users');
                const q = query(usersCollection, where("role", "==", "Extension Worker"));
                const querySnapshot = await getDocs(q);

                let extensionWorkers = [];
                querySnapshot.forEach(doc => {
                    extensionWorkers.push({ id: doc.id, ...doc.data() });
                });

                extensionWorkers.sort((a, b) => a.fullName.localeCompare(b.fullName));

                const workersWithData = extensionWorkers.map(worker => ({
                    ...worker,
                    lastReportDate: null // Placeholder
                }));

                renderExtensionWorkerTable(workersWithData, context);

            } catch (error) {
                console.error("Error loading Coordinator dashboard:", error);
                container.innerHTML = `<div class="text-center text-red-500 mt-20"><p>Could not load worker data. Check console for details.</p></div>`;
            }
        }

        function renderExtensionWorkerTable(workers, context) {
            const container = document.getElementById('coordinator-dashboard-container');
            if (!workers || workers.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 mt-20"><i data-lucide="briefcase" class="w-12 h-12 mx-auto text-gray-400"></i><p class="mt-4">No Extension Workers found.</p></div>`;
                lucide.createIcons();
                return;
            }

            const tableHtml = `
                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Worker Name</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Report Received</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="ew-table-body">
                            ${workers.map(worker => `
                                <tr class="hover:bg-gray-50 cursor-pointer" data-worker-id="${worker.id}" data-worker-name="${worker.fullName}">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900">${worker.fullName}</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        ${worker.lastReportDate ? worker.lastReportDate.toLocaleDateString() : 'Data unavailable'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = tableHtml;
        }
        
        // Removed old syncOutbox function as it's now obsolete with the new online-only farm setup flow.

        async function syncSubmissionOutbox() {
            if (!navigator.onLine || !currentUser) return;

            const idb = await dbPromise;
            const allSubmissions = await idb.getAll('submission_outbox');
            if (allSubmissions.length === 0) return;

            const connectionStatusEl = document.getElementById('connection-status');
            connectionStatusEl.textContent = `Syncing ${allSubmissions.length} submission(s)...`;
            connectionStatusEl.className = 'text-center py-1 text-sm font-semibold bg-yellow-100 text-yellow-800';

            try {
                for (const submission of allSubmissions) {
                    const { id, farmId, ...dataToSync } = submission;
                    if (!farmId) continue;

                    const submissionsCollection = collection(db, 'users', currentUser.uid, 'farmLots', farmId, 'submissions');
                    await addDoc(submissionsCollection, dataToSync);
                }

                await idb.clear('submission_outbox');
            } catch (error) {
                console.error('Error syncing submission outbox:', error);
                connectionStatusEl.textContent = 'Sync Failed';
                connectionStatusEl.className = 'text-center py-1 text-sm font-semibold bg-red-100 text-red-800';
            }
        }

        async function loadOnlineClinicReports() {
            if (!currentUser || !userProfile || userProfile.role !== 'Expert') return;

            const clinicContainer = document.getElementById('online-clinic-screen').querySelector('main');
            clinicContainer.innerHTML = `<div class="text-center text-gray-500 mt-20"><i data-lucide="loader" class="w-12 h-12 mx-auto text-gray-400 animate-spin"></i><p class="mt-4">Loading escalated reports...</p></div>`;
            lucide.createIcons();

            try {
                const q = query(collectionGroup(db, 'submissions'), where("isEscalated", "==", true));
                const submissionsSnapshot = await getDocs(q);

                let escalatedSubmissions = [];
                const userProfilesCache = {}; // Cache for all user profiles fetched
                const farmCache = {}; // Cache for farm data

                for (const submissionDoc of submissionsSnapshot.docs) {
                    const submissionData = submissionDoc.data();
                    const farmLotRef = submissionDoc.ref.parent.parent;
                    const farmerRef = farmLotRef.parent.parent;
                    const coordinatorId = submissionData.escalatedBy;

                    // Fetch Farm Data
                    let farmData = farmCache[farmLotRef.id];
                    if (!farmData) {
                        const farmDoc = await getDoc(farmLotRef);
                        if (farmDoc.exists()) {
                            farmData = farmDoc.data();
                            farmCache[farmLotRef.id] = farmData;
                        }
                    }

                    // Fetch Farmer Profile (gracefully)
                    let farmerProfile = userProfilesCache[farmerRef.id];
                    if (!farmerProfile) {
                        try {
                            const userDoc = await getDoc(farmerRef);
                            if (userDoc.exists()) {
                                farmerProfile = userDoc.data();
                                userProfilesCache[farmerRef.id] = farmerProfile;
                            }
                        } catch (e) {
                            console.warn(`Could not fetch farmer profile ${farmerRef.id}`);
                            farmerProfile = { fullName: 'Unknown Farmer' };
                            userProfilesCache[farmerRef.id] = farmerProfile;
                        }
                    }

                    // Fetch Coordinator Profile (gracefully)
                    let coordinatorProfile = null;
                    if (coordinatorId) {
                        coordinatorProfile = userProfilesCache[coordinatorId];
                        if (!coordinatorProfile) {
                            try {
                                const coordinatorDocRef = doc(db, 'users', coordinatorId);
                                const coordinatorDoc = await getDoc(coordinatorDocRef);
                                if (coordinatorDoc.exists()) {
                                    coordinatorProfile = coordinatorDoc.data();
                                    userProfilesCache[coordinatorId] = coordinatorProfile;
                                }
                            } catch (e) {
                                console.warn(`Could not fetch coordinator profile ${coordinatorId}`);
                                coordinatorProfile = { fullName: 'Unknown Coordinator' };
                                userProfilesCache[coordinatorId] = coordinatorProfile;
                            }
                        }
                    }

                    if (farmData) { // Only add if we have the essential farm data
                        escalatedSubmissions.push({
                            ...submissionData,
                            userId: farmerRef.id,
                            farmId: farmLotRef.id,
                            submissionId: submissionDoc.id,
                            farmName: farmData.farmName,
                            farmerProfile: farmerProfile || { fullName: 'Unknown Farmer' },
                            coordinatorProfile: coordinatorProfile
                        });
                    }
                }

                escalatedSubmissions.sort((a, b) => (b.escalatedAt?.toDate() || 0) - (a.escalatedAt?.toDate() || 0));
                renderOnlineClinicReports(escalatedSubmissions);

            } catch (error) {
                console.error("Error loading online clinic reports:", error);
                clinicContainer.innerHTML = `<div class="text-center text-red-500 mt-20"><p>Error loading reports.</p></div>`;
                showToast("Could not load clinic reports.", "error");
            }
        }

        function initializeExpertDashboardFilters() {
            // Pest/Disease Filter
            expertFilterPestDisease = createMultiSelect('expert-pest-disease-filter-container', 'All Pests & Diseases', true);
            if (pestAndDiseaseData) {
                const allPestsAndDiseases = [
                    ...(pestAndDiseaseData.fungal_and_bacterial_diseases || []).map(d => d['Disease Name']),
                    ...(pestAndDiseaseData.major_insect_pests || []).map(p => p['Pest Common Name'])
                ].sort();
                expertFilterPestDisease.populate(allPestsAndDiseases.map(p => ({ value: p, label: p })));
            }
            expertFilterPestDisease.onChange(() => {
                loadExpertStats();
                loadExpertMap();
            });

            // Location Filters
            expertFilterProvince = createMultiSelect('expert-province-filter-container', 'All Provinces', true);
            expertFilterMunicipality = createMultiSelect('expert-municipality-filter-container', 'All Municipalities', true);
            expertFilterBarangay = createMultiSelect('expert-barangay-filter-container', 'All Barangays', true);

            expertFilterProvince.populate(window.philippineAddresses.provinces.map(p => ({ value: p.name, label: p.name })));
            expertFilterMunicipality.disable();
            expertFilterBarangay.disable();

            const reloadData = () => {
                loadExpertStats();
                loadExpertMap();
            };

            expertFilterProvince.onChange(selectedProvinces => {
                expertFilterMunicipality.clear();
                expertFilterBarangay.clear();
                expertFilterMunicipality.disable();
                expertFilterBarangay.disable();
                if (selectedProvinces.length > 0) {
                    const municipalities = selectedProvinces.flatMap(provinceName => {
                        const provinceData = window.philippineAddresses.provinces.find(p => p.name === provinceName);
                        return provinceData ? provinceData.municipalities.map(m => m.name) : [];
                    });
                    expertFilterMunicipality.populate([...new Set(municipalities)].sort().map(m => ({ value: m, label: m })));
                    expertFilterMunicipality.enable();
                }
                reloadData();
            });

            expertFilterMunicipality.onChange(selectedMunicipalities => {
                expertFilterBarangay.clear();
                expertFilterBarangay.disable();
                if (selectedMunicipalities.length > 0) {
                    const selectedProvinces = expertFilterProvince.getSelectedValues();
                    const barangays = selectedProvinces.flatMap(provinceName => {
                        const provinceData = window.philippineAddresses.provinces.find(p => p.name === provinceName);
                        return provinceData ? provinceData.municipalities
                            .filter(m => selectedMunicipalities.includes(m.name))
                            .flatMap(m => m.barangays) : [];
                    });
                    expertFilterBarangay.populate([...new Set(barangays)].sort().map(b => ({ value: b, label: b })));
                    expertFilterBarangay.enable();
                }
                reloadData();
            });

            expertFilterBarangay.onChange(reloadData);

            document.getElementById('expert-clear-location-filters-btn').addEventListener('click', () => {
                expertFilterPestDisease.setSelectedValues([]);
                expertFilterProvince.setSelectedValues([]);
                expertFilterMunicipality.setSelectedValues([]);
                expertFilterBarangay.setSelectedValues([]);
                expertFilterMunicipality.clear();
                expertFilterBarangay.clear();
                expertFilterMunicipality.disable();
                expertFilterBarangay.disable();
                reloadData();
            });
        }

        async function loadExpertStats() {
            const statsContainer = document.getElementById('expert-stats-container');
            const fields = {
                reports: document.getElementById('stat-reports-count'),
                diagnosed: document.getElementById('stat-diagnosed-count'),
                treated: document.getElementById('stat-treated-count'),
                pests: document.getElementById('stat-pests-count'),
                diseases: document.getElementById('stat-diseases-count'),
            };
            Object.values(fields).forEach(field => field.textContent = '...');

            // Get filter values
            const selectedPests = expertFilterPestDisease ? expertFilterPestDisease.getSelectedValues() : [];
            const selectedProvinces = expertFilterProvince ? expertFilterProvince.getSelectedValues() : [];
            const selectedMunicipalities = expertFilterMunicipality ? expertFilterMunicipality.getSelectedValues() : [];
            const selectedBarangays = expertFilterBarangay ? expertFilterBarangay.getSelectedValues() : [];

            try {
                const submissionsQuery = collectionGroup(db, 'submissions');
                const submissionsSnapshot = await getDocs(submissionsQuery);
                const userCache = {};

                const filteredDocs = [];

                for (const submissionDoc of submissionsSnapshot.docs) {
                    const submissionData = submissionDoc.data();
                    const userRef = submissionDoc.ref.parent.parent; // This gets the farmLot document reference
                    const farmerRef = userRef.parent.parent; // This gets the user document reference

                    if (!userCache[farmerRef.id]) {
                        try {
                            const userDoc = await getDoc(farmerRef);
                            userCache[farmerRef.id] = userDoc.exists() ? userDoc.data() : null;
                        } catch (e) {
                            console.warn(`Could not fetch user profile ${farmerRef.id}`, e);
                            userCache[farmerRef.id] = null;
                        }
                    }
                    const userProfile = userCache[farmerRef.id];

                    const pestDisease = submissionData.finalDiagnosis?.pestDisease || submissionData.initialDiagnosis?.pestDisease;
                    const pestMatch = selectedPests.length === 0 || (pestDisease && selectedPests.includes(pestDisease));

                    let locationMatch = true;
                    if (selectedProvinces.length > 0 || selectedMunicipalities.length > 0 || selectedBarangays.length > 0) {
                        if (!userProfile) {
                            locationMatch = false;
                        } else {
                            const provinceMatch = selectedProvinces.length === 0 || selectedProvinces.includes(userProfile.province);
                            const municipalityMatch = selectedMunicipalities.length === 0 || selectedMunicipalities.includes(userProfile.municipality);
                            const barangayMatch = selectedBarangays.length === 0 || selectedBarangays.includes(userProfile.barangay);
                            locationMatch = provinceMatch && municipalityMatch && barangayMatch;
                        }
                    }

                    if (pestMatch && locationMatch) {
                        filteredDocs.push(submissionDoc);
                    }
                }

                let reportCount = filteredDocs.length;
                let diagnosedCount = 0;
                let treatedCount = 0;
                const pestSet = new Set();
                const diseaseSet = new Set();

                filteredDocs.forEach(submissionDoc => {
                    const data = submissionDoc.data();
                    if (data.initialDiagnosis) diagnosedCount++;
                    if (data.treatment) treatedCount++;
                    if (data.finalDiagnosis && data.finalDiagnosis.pestDisease) {
                        if (!pestAndDiseaseData.major_insect_pests) return;
                        const allPests = pestAndDiseaseData.major_insect_pests.map(p => p['Pest Common Name']);
                        if (allPests.includes(data.finalDiagnosis.pestDisease)) {
                            pestSet.add(data.finalDiagnosis.pestDisease);
                        } else {
                            diseaseSet.add(data.finalDiagnosis.pestDisease);
                        }
                    }
                });

                fields.reports.textContent = reportCount;
                fields.diagnosed.textContent = diagnosedCount;
                fields.treated.textContent = treatedCount;
                fields.pests.textContent = pestSet.size;
                fields.diseases.textContent = diseaseSet.size;

            } catch (error) {
                console.error("Error loading expert statistics:", error);
                Object.values(fields).forEach(field => field.textContent = 'Err');
                showToast("Could not load statistics.", "error");
            }
        }

        // --- Expert Panel Logic ---
        const expertPanel = document.getElementById('expert-case-details-panel');
        const expertPanelContent = document.getElementById('expert-panel-content');
        const closeExpertPanelBtn = document.getElementById('close-expert-panel-btn');

        function openExpertPanel(details) {
            const { farm, submission, user, pestDisease } = details;

            const reportDate = submission.timestamp?.toDate ? submission.timestamp.toDate().toLocaleDateString() : 'N/A';

            const imagesHTML = (submission.imageDownloadUrls && submission.imageDownloadUrls.length > 0)
                ? `<div class="grid grid-cols-2 gap-2 mt-2">${submission.imageDownloadUrls.map(url => `
                    <a href="${url}" target="_blank" class="block">
                        <img src="${url}" alt="Reported image" class="rounded-md object-cover aspect-square w-full hover:opacity-80 transition-opacity">
                    </a>`).join('')}
                  </div>`
                : '<p class="text-sm text-gray-500">No images submitted.</p>';

            let diagnosisHTML = '';
            if (submission.initialDiagnosis) {
                diagnosisHTML += `
                    <div class="mt-2">
                        <p class="text-sm"><strong class="font-semibold text-gray-700">Initial:</strong> ${submission.initialDiagnosis.pestDisease}</p>
                        <p class="text-xs text-gray-500 mb-1">By ${submission.initialDiagnosis.diagnosedByName || 'N/A'}</p>
                        ${submission.initialDiagnosis.notes ? `<p class="text-sm italic text-gray-700 bg-gray-50 p-2 rounded">"${submission.initialDiagnosis.notes}"</p>` : ''}
                    </div>
                `;
            }
            if (submission.finalDiagnosis) {
                diagnosisHTML += `
                    <div class="mt-3 pt-3 border-t border-gray-100">
                        <p class="text-sm"><strong class="font-semibold text-gray-700">Final:</strong> ${submission.finalDiagnosis.pestDisease}</p>
                        <p class="text-xs text-gray-500 mb-1">By ${submission.finalDiagnosis.diagnosedByName || 'N/A'}</p>
                        ${submission.finalDiagnosis.notes ? `<p class="text-sm italic text-gray-700 bg-gray-50 p-2 rounded">"${submission.finalDiagnosis.notes}"</p>` : ''}
                    </div>
                `;
            }

            let treatmentHTML = '';
            if (submission.treatment) {
                const { prevention, monitoring, control, instructions, followUpDate } = submission.treatment;

                const createSection = (title, items) => {
                    if (!items || items.length === 0) return '';
                    return `
                        <div class="mt-2">
                            <h6 class="font-semibold text-gray-700">${title}</h6>
                            <ul class="list-disc list-inside text-sm text-gray-600 mt-1 space-y-1">
                                ${items.map(item => `<li>${item}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                };

                treatmentHTML = `
                    <div class="border-t pt-3">
                        <h5 class="font-semibold text-gray-800 mb-1">Treatment Plan</h5>
                        ${createSection('Prevention', prevention)}
                        ${createSection('Monitoring', monitoring)}
                        ${createSection('Direct Control', control)}
                        <div class="mt-2">
                            <h6 class="font-semibold text-gray-700">Specific Instructions</h6>
                            <p class="text-sm text-gray-600 mt-1">${instructions || 'N/A'}</p>
                        </div>
                        ${followUpDate ? `
                        <div class="mt-2">
                            <h6 class="font-semibold text-gray-700">Follow-up Date</h6>
                            <p class="text-sm text-gray-600 mt-1">${followUpDate}</p>
                        </div>` : ''}
                    </div>`;
            }

            const contentHTML = `
                <div class="space-y-4 text-sm">
                    <div>
                        <p class="font-bold text-base text-gray-800">${farm.farmName}</p>
                        <p class="text-gray-600">Owned by: ${user.fullName}</p>
                        <p class="text-xs text-gray-500">${user.barangay}, ${user.municipality}</p>
                    </div>

                    <div class="border-t pt-3">
                        <h5 class="font-semibold text-gray-800 mb-1">Report Details</h5>
                        <p><strong>Date:</strong> ${reportDate}</p>
                        <p><strong>Symptoms:</strong> <span class="capitalize">${submission.symptoms.join(', ')}</span></p>
                        <p><strong>Distribution:</strong> <span class="capitalize">${submission.distribution}</span></p>
                        <p><strong>Severity:</strong> <span class="capitalize">${submission.severity}</span></p>
                    </div>

                    <div class="border-t pt-3">
                        <h5 class="font-semibold text-gray-800 mb-1">Submitted Images</h5>
                        ${imagesHTML}
                    </div>

                    ${diagnosisHTML ? `
                    <div class="border-t pt-3">
                        <h5 class="font-semibold text-gray-800 mb-1">Diagnosis</h5>
                        ${diagnosisHTML}
                    </div>` : ''}

                    ${treatmentHTML}
                </div>
            `;

            expertPanelContent.innerHTML = contentHTML;
            expertPanel.classList.remove('hidden');
        }

        function closeExpertPanel() {
            expertPanel.classList.add('hidden');
        }

        closeExpertPanelBtn.addEventListener('click', closeExpertPanel);


        let expertMap = null;
        async function loadExpertMap() {
            const mapContainer = document.getElementById('expert-map');
            const legendContainer = document.getElementById('expert-map-legend');
            mapContainer.innerHTML = '';
            legendContainer.innerHTML = '';

            if (expertMap) {
                expertMap.remove();
            }
            expertMap = L.map('expert-map').setView([12.8797, 121.7740], 5);
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri'
            }).addTo(expertMap);

            const colorPalette = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF'];
            let colorIndex = 0;
            const pestDiseaseColors = {};

            // Get filter values
            const selectedPests = expertFilterPestDisease ? expertFilterPestDisease.getSelectedValues() : [];
            const selectedProvinces = expertFilterProvince ? expertFilterProvince.getSelectedValues() : [];
            const selectedMunicipalities = expertFilterMunicipality ? expertFilterMunicipality.getSelectedValues() : [];
            const selectedBarangays = expertFilterBarangay ? expertFilterBarangay.getSelectedValues() : [];

            try {
                const submissionsQuery = query(collectionGroup(db, 'submissions'), where("initialDiagnosis", "!=", null));
                const submissionsSnapshot = await getDocs(submissionsQuery);

                const layers = [];
                const farmCache = {};
                const userCache = {};

                for (const submissionDoc of submissionsSnapshot.docs) {
                    const submissionData = submissionDoc.data();
                    const farmLotRef = submissionDoc.ref.parent.parent;
                    const userRef = farmLotRef.parent.parent;

                    if (!userCache[userRef.id]) {
                        try {
                            const userDoc = await getDoc(userRef);
                            userCache[userRef.id] = userDoc.exists() ? userDoc.data() : null;
                        } catch (e) {
                            userCache[userRef.id] = null;
                        }
                    }
                    const userProfile = userCache[userRef.id];

                    const pestDisease = submissionData.finalDiagnosis?.pestDisease || submissionData.initialDiagnosis?.pestDisease;
                    const pestMatch = selectedPests.length === 0 || (pestDisease && selectedPests.includes(pestDisease));

                    let locationMatch = true;
                    if (selectedProvinces.length > 0 || selectedMunicipalities.length > 0 || selectedBarangays.length > 0) {
                        if (!userProfile) {
                            locationMatch = false;
                        } else {
                            const provinceMatch = selectedProvinces.length === 0 || selectedProvinces.includes(userProfile.province);
                            const municipalityMatch = selectedMunicipalities.length === 0 || selectedMunicipalities.includes(userProfile.municipality);
                            const barangayMatch = selectedBarangays.length === 0 || selectedBarangays.includes(userProfile.barangay);
                            locationMatch = provinceMatch && municipalityMatch && barangayMatch;
                        }
                    }

                    if (!pestMatch || !locationMatch) {
                        continue;
                    }

                    if (!farmCache[farmLotRef.id]) {
                        const farmDoc = await getDoc(farmLotRef);
                        if (farmDoc.exists()) farmCache[farmLotRef.id] = farmDoc.data();
                    }
                    const farmData = farmCache[farmLotRef.id];

                    if (!farmData || !farmData.polygonCoordinates || farmData.polygonCoordinates.length === 0) continue;
                    if (!pestDisease) continue;

                    if (!pestDiseaseColors[pestDisease]) {
                        pestDiseaseColors[pestDisease] = colorPalette[colorIndex % colorPalette.length];
                        colorIndex++;
                    }

                    const latLngs = farmData.polygonCoordinates.map(c => [c.lat, c.lng]);
                    const polygon = L.polygon(latLngs, { color: pestDiseaseColors[pestDisease], weight: 2, fillOpacity: 0.5 });
                    const center = L.polygon(latLngs).getBounds().getCenter();
                    const marker = L.marker(center, {
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style='background-color:${pestDiseaseColors[pestDisease]};' class='marker-pin'></div>`,
                            iconSize: [30, 42],
                            iconAnchor: [15, 42]
                        })
                    });

                    const caseDetails = { farm: farmData, submission: submissionData, user: userProfile, pestDisease: pestDisease };
                    polygon.on('click', () => openExpertPanel(caseDetails));
                    marker.on('click', () => openExpertPanel(caseDetails));

                    layers.push(polygon, marker);
                }

                if (layers.length > 0) {
                    const featureGroup = L.featureGroup(layers).addTo(expertMap);
                    expertMap.fitBounds(featureGroup.getBounds().pad(0.1));
                } else {
                    expertMap.setView([12.8797, 121.7740], 5);
                }

                legendContainer.innerHTML = ' <h3 class="text-sm font-bold mb-2">Legend</h3>';
                for (const [name, color] of Object.entries(pestDiseaseColors)) {
                    legendContainer.innerHTML += `<div class="flex items-center mb-1"><div class="w-4 h-4 rounded-full mr-2" style="background-color:${color};"></div><span>${name}</span></div>`;
                }

            } catch (error) {
                console.error("Error loading expert map:", error);
                mapContainer.innerHTML = '<p class="text-red-500">Could not load map.</p>';
                showToast("Could not load map data.", "error");
            }
        }

        function renderOnlineClinicReports(submissions) {
            const clinicContainer = document.getElementById('online-clinic-screen').querySelector('main');
            clinicContainer.innerHTML = '';

            if (submissions.length === 0) {
                clinicContainer.innerHTML = `
                    <div class="text-center text-gray-500 mt-20">
                        <i data-lucide="check-circle-2" class="w-12 h-12 mx-auto text-green-500"></i>
                        <p class="mt-4">No reports are currently escalated to the clinic.</p>
                    </div>`;
                lucide.createIcons();
                return;
            }

            submissions.forEach(submission => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-xl mb-4 shadow-sm border border-gray-200';

                const escalatedDate = submission.escalatedAt?.toDate ? submission.escalatedAt.toDate().toLocaleDateString() : 'N/A';

                let finalDiagnosisHTML = '';
                if (submission.finalDiagnosis) {
                    finalDiagnosisHTML = `<p class="text-sm text-green-600 font-semibold mt-2">Status: Final Diagnosis Provided</p>`;
                } else {
                    finalDiagnosisHTML = `<p class="text-sm text-orange-600 font-semibold mt-2">Status: Awaiting Final Diagnosis</p>`;
                }

                const farmer = submission.farmerProfile;
                const coordinator = submission.coordinatorProfile;

                const farmerHTML = farmer ? `<p class="text-sm"><strong>Farmer:</strong> ${farmer.fullName} (${farmer.municipality}, ${farmer.province})</p>` : '';
                const coordinatorHTML = coordinator ? `<p class="text-sm"><strong>Escalated by:</strong> ${coordinator.fullName}</p>` : `<p class="text-sm"><strong>Escalated by:</strong> ${submission.escalatedByName || 'Unknown'}</p>`;


                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-lg">${submission.farmName}</p>
                            ${farmerHTML}
                            ${coordinatorHTML}
                            <p class="text-sm text-gray-500">Escalated on ${escalatedDate}</p>
                        </div>
                        ${(() => {
                            const canReEvaluate = ['Branch Coordinator', 'Expert', 'Administrator'].includes(userProfile.role);
                            if (submission.finalDiagnosis && canReEvaluate) {
                                return `<button class="view-clinic-report-btn bg-yellow-500 text-white text-sm font-bold py-2 px-3 rounded-lg" data-submission='${JSON.stringify(submission)}'>Re-evaluate</button>`;
                            }
                            return `<button class="view-clinic-report-btn bg-blue-500 text-white text-sm font-bold py-2 px-3 rounded-lg" data-submission='${JSON.stringify(submission)}'>Review Case</button>`;
                        })()}
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-100">
                        <p class="font-semibold">Escalation Details</p>
                        <p class="text-sm"><strong>Infestation:</strong> ${submission.escalationDetails.infestationPercentage}%</p>
                        <p class="text-sm"><strong>Samples Collected:</strong> ${submission.escalationDetails.samplesCollectedDate}</p>
                        <p class="text-sm"><strong>Farmer Contact:</strong> ${submission.escalationDetails.farmerContact}</p>
                        <p class="text-sm"><strong>Sample Notes:</strong> ${submission.escalationDetails.samplesNotes}</p>
                        ${finalDiagnosisHTML}
                    </div>
                `;

                card.querySelector('.view-clinic-report-btn').addEventListener('click', (e) => {
                    const submissionData = JSON.parse(e.currentTarget.getAttribute('data-submission'));
                    setupTreatmentModal(submissionData);
                });

                clinicContainer.appendChild(card);
            });
            lucide.createIcons();
        }

        function escapeCsvCell(cell) {
            if (cell === null || cell === undefined) {
                return '';
            }
            let str = String(cell);
            // If the cell contains a comma, a quote, or a newline, wrap it in double quotes.
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                // Escape any existing double quotes by doubling them up.
                str = str.replace(/"/g, '""');
                return `"${str}"`;
            }
            return str;
        }

        async function exportReportsToCSV() {
            showSavingOverlay('Exporting Data...');
            try {
                const headers = [
                    'Report ID', 'Farmer Name', 'Farmer Contact', 'Farm Name', 'Farm Location (Lat)', 'Farm Location (Lng)',
                    'Report Date', 'Symptoms', 'Distribution', 'Severity',
                    'Initial Diagnosis By', 'Initial Diagnosis Date', 'Initial Pest/Disease', 'Initial Diagnosis Notes',
                    'Is Escalated', 'Escalated By', 'Escalated Date', 'Infestation %', 'Samples Collected Date', 'Escalation Notes',
                    'Final Diagnosis By', 'Final Diagnosis Date', 'Final Pest/Disease', 'Final Diagnosis Notes',
                    'Treatment By', 'Treatment Date', 'Treatment Prevention', 'Treatment Monitoring', 'Treatment Control', 'Treatment Instructions', 'Follow-up Date'
                ];

                let csvContent = headers.map(escapeCsvCell).join(',') + '\r\n';

                const usersSnapshot = await getDocs(collection(db, 'users'));
                for (const userDoc of usersSnapshot.docs) {
                    const userData = userDoc.data();
                    const farmLotsCollection = collection(db, 'users', userDoc.id, 'farmLots');
                    const farmLotsSnapshot = await getDocs(farmLotsCollection);

                    for (const farmDoc of farmLotsSnapshot.docs) {
                        const farmData = farmDoc.data();
                        const center = L.polygon(farmData.polygonCoordinates.map(c => [c.lat, c.lng])).getBounds().getCenter();

                        const submissionsCollection = collection(db, 'users', userDoc.id, 'farmLots', farmDoc.id, 'submissions');
                        const submissionsSnapshot = await getDocs(submissionsCollection);

                        submissionsSnapshot.forEach(submissionDoc => {
                            const s = submissionDoc.data();
                            const row = [
                                submissionDoc.id,
                                userData.fullName,
                                s.escalationDetails?.farmerContact || userData.contactNumber || '',
                                farmData.farmName,
                                center.lat,
                                center.lng,
                                s.timestamp?.toDate ? s.timestamp.toDate().toISOString() : '',
                                Array.isArray(s.symptoms) ? s.symptoms.join('; ') : '',
                                s.distribution,
                                s.severity,
                                s.initialDiagnosis?.diagnosedByName || '',
                                s.initialDiagnosis?.diagnosedAt?.toDate ? s.initialDiagnosis.diagnosedAt.toDate().toISOString() : '',
                                s.initialDiagnosis?.pestDisease || '',
                                s.initialDiagnosis?.notes || '',
                                s.isEscalated || false,
                                s.escalatedByName || '',
                                s.escalatedAt?.toDate ? s.escalatedAt.toDate().toISOString() : '',
                                s.escalationDetails?.infestationPercentage || '',
                                s.escalationDetails?.samplesCollectedDate || '',
                                s.escalationDetails?.samplesNotes || '',
                                s.finalDiagnosis?.diagnosedByName || '',
                                s.finalDiagnosis?.diagnosedAt?.toDate ? s.finalDiagnosis.diagnosedAt.toDate().toISOString() : '',
                                s.finalDiagnosis?.pestDisease || '',
                                s.finalDiagnosis?.notes || '',
                                s.treatment?.createdByName || '',
                                s.treatment?.createdAt?.toDate ? s.treatment.createdAt.toDate().toISOString() : '',
                                Array.isArray(s.treatment?.prevention) ? s.treatment.prevention.join('; ') : '',
                                Array.isArray(s.treatment?.monitoring) ? s.treatment.monitoring.join('; ') : '',
                                Array.isArray(s.treatment?.control) ? s.treatment.control.join('; ') : '',
                                s.treatment?.instructions || '',
                                s.treatment?.followUpDate || ''
                            ];
                            csvContent += row.map(escapeCsvCell).join(',') + '\r\n';
                        });
                    }
                }

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `agri_guard_export_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (error) {
                console.error("Error exporting data:", error);
                showToast("Could not export data.", "error");
            } finally {
                hideSavingOverlay();
            }
        }

        document.getElementById('export-csv-btn').addEventListener('click', exportReportsToCSV);

        // --- 7. ADMIN DASHBOARD LOGIC ---
        function attachAdminTabListeners() {
            const tabs = {
                users: document.getElementById('admin-users-tab'),
                reports: document.getElementById('admin-reports-tab'),
                requests: document.getElementById('admin-role-requests-tab')
            };
            const contents = {
                users: document.getElementById('admin-users-content'),
                reports: document.getElementById('admin-reports-content'),
                requests: document.getElementById('admin-role-requests-content')
            };
            const loaders = {
                users: loadAdminUserManagement,
                reports: loadAdminReportManagement,
                requests: loadRoleRequests
            };

            function switchTab(activeTab) {
                Object.keys(tabs).forEach(key => {
                    const tab = tabs[key];
                    const content = contents[key];
                    if (key === activeTab) {
                        tab.classList.add('border-green-600', 'text-green-700');
                        tab.classList.remove('border-transparent', 'text-gray-500');
                        content.classList.remove('hidden');
                        if(loaders[key]) loaders[key]();
                    } else {
                        tab.classList.remove('border-green-600', 'text-green-700');
                        tab.classList.add('border-transparent', 'text-gray-500');
                        content.classList.add('hidden');
                    }
                });
            }

            tabs.users.addEventListener('click', () => switchTab('users'));
            tabs.reports.addEventListener('click', () => switchTab('reports'));
            tabs.requests.addEventListener('click', () => switchTab('requests'));
        }

        async function loadAdminUserManagement() {
            if (!currentUser || !userProfile || userProfile.role !== 'Administrator') {
                document.getElementById('admin-users-content').innerHTML = '<p class="text-red-500">You do not have permission to view this page.</p>';
                return;
            }

            const usersContent = document.getElementById('admin-users-content');
            usersContent.innerHTML = `<div class="text-center text-gray-500 mt-20"><i data-lucide="loader" class="w-12 h-12 mx-auto text-gray-400 animate-spin"></i><p class="mt-4">Loading users...</p></div>`;
            lucide.createIcons();

            try {
                const usersSnapshot = await getDocs(collection(db, 'users'));
                const users = [];
                usersSnapshot.forEach(doc => {
                    users.push({ id: doc.id, ...doc.data() });
                });

                renderUserTable(users);
            } catch (error) {
                console.error("Error loading users for admin dashboard:", error);
                usersContent.innerHTML = `<p class="text-red-500">Could not load users.</p>`;
            }
        }

        function renderUserTable(users) {
            const container = document.getElementById('admin-users-content');
            if (!users || users.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 mt-20"><i data-lucide="users" class="w-12 h-12 mx-auto text-gray-400"></i><p class="mt-4">No users found.</p></div>`;
                lucide.createIcons();
                return;
            }

            const tableHtml = `
                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${users.map(user => `
                                <tr id="user-row-${user.id}">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900">${user.fullName}</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.email || 'N/A'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.role}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <button class="text-indigo-600 hover:text-indigo-900 mr-4 change-role-btn" data-user-id="${user.id}" data-user-name="${user.fullName}" data-current-role="${user.role}">Change Role</button>
                                        <button class="text-red-600 hover:text-red-900 delete-user-btn" data-user-id="${user.id}" data-user-name="${user.fullName}">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = tableHtml;
        }

        async function loadAdminReportManagement() {
            if (!currentUser || !userProfile || userProfile.role !== 'Administrator') {
                document.getElementById('admin-reports-content').innerHTML = '<p class="text-red-500">You do not have permission to view this page.</p>';
                return;
            }

            const reportsContent = document.getElementById('admin-reports-content');
            reportsContent.innerHTML = `<div class="text-center text-gray-500 mt-20"><i data-lucide="loader" class="w-12 h-12 mx-auto text-gray-400 animate-spin"></i><p class="mt-4">Loading reports...</p></div>`;
            lucide.createIcons();

            try {
                let allSubmissions = [];
                const usersSnapshot = await getDocs(collection(db, 'users'));
                for (const userDoc of usersSnapshot.docs) {
                     const farmLotsCollection = collection(db, 'users', userDoc.id, 'farmLots');
                    const farmLotsSnapshot = await getDocs(farmLotsCollection);
                    for (const farmDoc of farmLotsSnapshot.docs) {
                        const farmData = farmDoc.data();
                        const submissionsCollection = collection(db, 'users', userDoc.id, 'farmLots', farmDoc.id, 'submissions');
                        const submissionsSnapshot = await getDocs(submissionsCollection);
                        submissionsSnapshot.forEach(submissionDoc => {
                            allSubmissions.push({
                                ...submissionDoc.data(),
                                id: submissionDoc.id,
                                farmName: farmData.farmName,
                                userName: userDoc.data().fullName,
                                userId: userDoc.id,
                                farmId: farmDoc.id
                            });
                        });
                    }
                }

                allSubmissions.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
                renderReportTable(allSubmissions);

            } catch (error) {
                console.error("Error loading reports for admin:", error);
                reportsContent.innerHTML = `<p class="text-red-500">Could not load reports.</p>`;
            }
        }

        function renderReportTable(submissions) {
            const container = document.getElementById('admin-reports-content');
            if (!submissions || submissions.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 mt-20"><i data-lucide="file-text" class="w-12 h-12 mx-auto text-gray-400"></i><p class="mt-4">No reports found.</p></div>`;
                lucide.createIcons();
                return;
            }

            const tableHtml = `
                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Farmer</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Farm</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Report Date</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Symptoms</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${submissions.map(sub => `
                                <tr id="report-row-${sub.id}">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${sub.userName}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sub.farmName}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sub.timestamp?.toDate().toLocaleDateString() || 'N/A'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 capitalize">${sub.symptoms.join(', ')}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <button class="text-red-600 hover:text-red-900 delete-report-btn" data-user-id="${sub.userId}" data-farm-id="${sub.farmId}" data-submission-id="${sub.id}" data-farm-name="${sub.farmName}">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = tableHtml;
        }

        document.getElementById('admin-users-content').addEventListener('click', (e) => {
            if (e.target.classList.contains('change-role-btn')) {
                const userId = e.target.dataset.userId;
                const userName = e.target.dataset.userName;
                const currentRole = e.target.dataset.currentRole;

                document.getElementById('change-role-user-name').textContent = userName;
                document.getElementById('role-select').value = currentRole;
                document.getElementById('change-role-user-id').value = userId;

                document.getElementById('change-role-modal').classList.remove('hidden');
                document.getElementById('change-role-modal').classList.add('flex');
            }

            if (e.target.classList.contains('delete-user-btn')) {
                const userId = e.target.dataset.userId;
                const userName = e.target.dataset.userName;
                if (confirm(`Are you sure you want to delete user: ${userName}? This action cannot be undone.`)) {
                    deleteUser(userId);
                }
            }
        });

        document.getElementById('close-change-role-modal-btn').addEventListener('click', () => {
            document.getElementById('change-role-modal').classList.add('hidden');
        });

        document.getElementById('save-role-change-btn').addEventListener('click', async () => {
            const newRole = document.getElementById('role-select').value;
            const userId = document.getElementById('change-role-user-id').value;

            if (!newRole || !userId) {
                showToast('Could not change role. User ID or new role is missing.', 'error');
                return;
            }

            showSavingOverlay('Updating Role...');
            try {
                const userDocRef = doc(db, 'users', userId);
                await updateDoc(userDocRef, { role: newRole });
                showToast('User role updated successfully!', 'success');
                document.getElementById('change-role-modal').classList.add('hidden');
                loadAdminUserManagement(); // Refresh the user list
            } catch (error) {
                console.error('Error updating user role:', error);
                showToast('Failed to update user role.', 'error');
            } finally {
                hideSavingOverlay();
            }
        });

        async function deleteUser(userId) {
            if (!userId) {
                showToast('Cannot delete user. User ID is missing.', 'error');
                return;
            }

            showSavingOverlay('Deleting User...');
            try {
                // This only deletes the Firestore document, not the Auth user.
                // Deleting Auth user requires a Cloud Function.
                const userDocRef = doc(db, 'users', userId);
                await deleteDoc(userDocRef);
                showToast('User deleted successfully from the database.', 'success');
                loadAdminUserManagement(); // Refresh the user list
            } catch (error) {
                console.error('Error deleting user:', error);
                showToast('Failed to delete user.', 'error');
            } finally {
                hideSavingOverlay();
            }
        }

        async function loadRoleRequests() {
            if (!currentUser || !userProfile || userProfile.role !== 'Administrator') {
                document.getElementById('admin-role-requests-content').innerHTML = '<p class="text-red-500">You do not have permission to view this page.</p>';
                return;
            }

            const requestsContent = document.getElementById('admin-role-requests-content');
            requestsContent.innerHTML = `<div class="text-center text-gray-500 mt-20"><i data-lucide="loader" class="w-12 h-12 mx-auto text-gray-400 animate-spin"></i><p class="mt-4">Loading pending requests...</p></div>`;
            lucide.createIcons();

            try {
                const q = query(collection(db, "roleRequests"), where("status", "==", "pending"));
                const querySnapshot = await getDocs(q);
                const requests = [];
                querySnapshot.forEach(doc => {
                    requests.push({ id: doc.id, ...doc.data() });
                });

                renderRoleRequestsTable(requests);
            } catch (error) {
                console.error("Error loading role requests:", error);
                requestsContent.innerHTML = `<p class="text-red-500">Could not load role requests.</p>`;
            }
        }

        function renderRoleRequestsTable(requests) {
            const container = document.getElementById('admin-role-requests-content');
            if (!requests || requests.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 mt-20"><i data-lucide="check-circle" class="w-12 h-12 mx-auto text-gray-400"></i><p class="mt-4">No pending role requests.</p></div>`;
                lucide.createIcons();
                return;
            }

            const tableHtml = `
                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Role</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Requested Role</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${requests.map(req => `
                                <tr id="request-row-${req.id}">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${req.userName}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${req.currentRole}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-700">${req.requestedRole}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${req.timestamp?.toDate().toLocaleDateString() || 'N/A'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <button class="text-green-600 hover:text-green-900 mr-4 approve-role-btn" data-request-id="${req.id}" data-user-id="${req.userId}" data-new-role="${req.requestedRole}">Approve</button>
                                        <button class="text-red-600 hover:text-red-900 deny-role-btn" data-request-id="${req.id}">Deny</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = tableHtml;
        }
        // --- 8. DRILL-DOWN NAVIGATION ---
        document.getElementById('admin-role-requests-content').addEventListener('click', (e) => {
            if (e.target.classList.contains('approve-role-btn')) {
                const requestId = e.target.dataset.requestId;
                const userId = e.target.dataset.userId;
                const newRole = e.target.dataset.newRole;
                if (confirm(`Are you sure you want to approve this request and set the user's role to ${newRole}?`)) {
                    approveRoleRequest(requestId, userId, newRole);
                }
            }
            if (e.target.classList.contains('deny-role-btn')) {
                const requestId = e.target.dataset.requestId;
                if (confirm('Are you sure you want to deny this role request?')) {
                    denyRoleRequest(requestId);
                }
            }
        });

        async function approveRoleRequest(requestId, userId, newRole) {
            showSavingOverlay('Approving Request...');
            try {
                const userDocRef = doc(db, 'users', userId);
                const requestDocRef = doc(db, 'roleRequests', requestId);

                await updateDoc(userDocRef, { role: newRole });
                await updateDoc(requestDocRef, { status: 'approved', reviewedBy: userProfile.fullName, reviewedAt: serverTimestamp() });

                showToast('Role request approved successfully!', 'success');
                loadRoleRequests(); // Refresh the list
            } catch (error) {
                console.error("Error approving role request:", error);
                showToast('Failed to approve role request.', 'error');
            } finally {
                hideSavingOverlay();
            }
        }

        async function denyRoleRequest(requestId) {
            showSavingOverlay('Denying Request...');
            try {
                const requestDocRef = doc(db, 'roleRequests', requestId);
                await updateDoc(requestDocRef, { status: 'denied', reviewedBy: userProfile.fullName, reviewedAt: serverTimestamp() });

                showToast('Role request denied.', 'success');
                loadRoleRequests(); // Refresh the list
            } catch (error) {
                console.error("Error denying role request:", error);
                showToast('Failed to deny role request.', 'error');
            } finally {
                hideSavingOverlay();
            }
        }
        document.getElementById('admin-reports-content').addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-report-btn')) {
                const userId = e.target.dataset.userId;
                const farmId = e.target.dataset.farmId;
                const submissionId = e.target.dataset.submissionId;
                const farmName = e.target.dataset.farmName;

                if (confirm(`Are you sure you want to delete this report from ${farmName}? This action cannot be undone.`)) {
                    deleteReport(userId, farmId, submissionId);
                }
            }
        });

        async function deleteReport(userId, farmId, submissionId) {
            if (!userId || !farmId || !submissionId) {
                showToast('Cannot delete report. ID is missing.', 'error');
                return;
            }

            showSavingOverlay('Deleting Report...');
            try {
                const reportDocRef = doc(db, 'users', userId, 'farmLots', farmId, 'submissions', submissionId);
                await deleteDoc(reportDocRef);
                showToast('Report deleted successfully.', 'success');
                loadAdminReportManagement(); // Refresh the list
            } catch (error) {
                console.error('Error deleting report:', error);
                showToast('Failed to delete report.', 'error');
            } finally {
                hideSavingOverlay();
            }
        }

        let currentViewContext = {}; // Used to pass data between screens. DEPRECATED but kept for safety.

        document.getElementById('ew-dashboard-container').addEventListener('click', (e) => {
            const row = e.target.closest('tr[data-farmer-id]');
            if (row) {
                const farmerId = row.dataset.farmerId;
                const farmerName = row.dataset.farmerName;
                const lastContext = navigationHistory[navigationHistory.length - 1]?.context || {};
                const newContext = { ...lastContext, userId: farmerId, userName: farmerName, label: farmerName };
                showScreen('farmList', newContext);
            }
        });

        document.getElementById('coordinator-dashboard-container').addEventListener('click', (e) => {
            const row = e.target.closest('tr[data-worker-id]');
            if (row) {
                const workerId = row.dataset.workerId;
                const workerName = row.dataset.workerName;
                const lastContext = navigationHistory[navigationHistory.length - 1]?.context || {};
                const newContext = { ...lastContext, userId: workerId, userName: workerName, label: workerName };
                showScreen('ewDashboard', newContext);
            }
        });

        // --- 8. CONNECTION STATUS UI ---
        const connectionStatusEl = document.getElementById('connection-status');
        async function updateOnlineStatus() {
            const db = await dbPromise;
            const farmOutboxCount = await db.count('outbox');
            const submissionOutboxCount = await db.count('submission_outbox');
            const offlineMessageContainer = document.getElementById('offline-message-container');
            const googleBtn = document.getElementById('google-signin-btn');
            const guestBtn = document.getElementById('guest-signin-btn');

            if (navigator.onLine) {
                 if (connectionStatusEl) {
                    connectionStatusEl.textContent = 'Online';
                    connectionStatusEl.className = 'text-center py-1 px-2 rounded-full text-sm font-semibold bg-blue-100 text-blue-800';
                }
                if (offlineMessageContainer) offlineMessageContainer.innerHTML = '';
                if (googleBtn) {
                    googleBtn.disabled = false;
                    googleBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                if (guestBtn) {
                    guestBtn.disabled = false;
                    guestBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }

                if (farmOutboxCount > 0) {
                    syncOutbox();
                }
                if (submissionOutboxCount > 0) {
                    syncSubmissionOutbox();
                }

            } else {
                if (connectionStatusEl) {
                    let message = 'Offline Mode';
                    const totalOutboxCount = farmOutboxCount + submissionOutboxCount;
                    if (totalOutboxCount > 0) {
                        message += ` (${totalOutboxCount} item(s) waiting to sync)`;
                    }
                    connectionStatusEl.textContent = message;
                    connectionStatusEl.className = 'text-center py-1 px-2 rounded-full text-sm font-semibold bg-gray-200 text-gray-800';
                }
                if (offlineMessageContainer) {
                    offlineMessageContainer.innerHTML = `<p class="text-red-600 bg-red-100 p-3 rounded-lg">You are currently offline. Please connect to sign in.</p>`;
                }
                if (googleBtn) {
                    googleBtn.disabled = true;
                    googleBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
                if (guestBtn) {
                    guestBtn.disabled = true;
                    guestBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }
        }
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus();

        // --- 9. NOTIFICATIONS LOGIC ---
        // Note: This implementation focuses on high-priority, role-specific notifications.
        // Notifications for "new reports" or "new users" were omitted as they could be
        // overwhelming or are better handled by server-side functions to avoid client-side complexity.
        let notificationListeners = [];
        let allNotifications = {};

        function listenForNotifications() {
            // Detach any existing listeners to prevent duplicates
            notificationListeners.forEach(unsubscribe => unsubscribe());
            notificationListeners = [];

            if (!currentUser || !userProfile) return;

            const processAndRenderNotifications = () => {
                let flatNotifications = Object.values(allNotifications).flat();
                const readIds = JSON.parse(localStorage.getItem('readNotifications') || '[]');
                const unreadNotifications = flatNotifications.filter(n => !readIds.includes(n.id));

                const badge = document.getElementById('notification-badge');
                if (unreadNotifications.length > 0) {
                    badge.textContent = unreadNotifications.length > 9 ? '9+' : unreadNotifications.length;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
                renderNotifications(unreadNotifications);
            };

            if (userProfile.role === 'Administrator') {
                const reqQuery = query(collection(db, "roleRequests"), where("status", "==", "pending"));
                const reqUnsubscribe = onSnapshot(reqQuery, (snapshot) => {
                    allNotifications['roleRequests'] = snapshot.docs.map(doc => ({
                        id: doc.id,
                        message: `${doc.data().userName} requested to be a ${doc.data().requestedRole}.`,
                        timestamp: doc.data().timestamp,
                        action: () => showScreen('adminDashboard', { isFreshNavigation: true, tab: 'requests', label: 'Admin Dashboard' })
                    }));
                    processAndRenderNotifications();
                });
                notificationListeners.push(reqUnsubscribe);
            }

            if (userProfile.role === 'Expert') {
                const escalatedQuery = query(collectionGroup(db, 'submissions'), where("isEscalated", "==", true));
                const escalatedUnsubscribe = onSnapshot(escalatedQuery, (snapshot) => {
                    allNotifications['escalatedReports'] = snapshot.docs.map(doc => ({
                        id: doc.id,
                        message: `A new case has been escalated for expert review.`,
                        timestamp: doc.data().escalatedAt,
                        action: () => showScreen('onlineClinic', { isFreshNavigation: true, label: 'Online Clinic' })
                    }));
                    processAndRenderNotifications();
                });
                notificationListeners.push(escalatedUnsubscribe);
            }
        }

        function renderNotifications(notifications) {
            const container = document.getElementById('notifications-container');
            container.innerHTML = '';

            if (notifications.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 mt-20"><i data-lucide="bell-off" class="w-12 h-12 mx-auto text-gray-400"></i><p class="mt-4">You have no new notifications.</p></div>`;
                lucide.createIcons();
                return;
            }

            notifications.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));

            notifications.forEach(notif => {
                const card = document.createElement('div');
                card.className = 'bg-white p-3 rounded-lg mb-2 shadow-sm border border-blue-200 cursor-pointer hover:bg-blue-50';
                card.innerHTML = `
                    <p class="font-medium text-gray-800">${notif.message}</p>
                    <p class="text-xs text-gray-500 mt-1">${notif.timestamp ? notif.timestamp.toDate().toLocaleString() : ''}</p>
                `;
                card.addEventListener('click', () => {
                    if (notif.action) notif.action();

                    const readIds = JSON.parse(localStorage.getItem('readNotifications') || '[]');
                    if (!readIds.includes(notif.id)) {
                        readIds.push(notif.id);
                        localStorage.setItem('readNotifications', JSON.stringify(readIds));
                    }
                    // Re-render notifications to remove the clicked one
                    const updatedNotifications = notifications.filter(n => n.id !== notif.id);
                    renderNotifications(updatedNotifications);
                    // Update badge
                     const badge = document.getElementById('notification-badge');
                    if (updatedNotifications.length > 0) {
                        badge.textContent = updatedNotifications.length > 9 ? '9+' : updatedNotifications.length;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                });
                container.appendChild(card);
            });
        }

        document.getElementById('mark-all-read-btn').addEventListener('click', () => {
            const allIds = Object.values(allNotifications).flat().map(n => n.id);
            localStorage.setItem('readNotifications', JSON.stringify(allIds));
            renderNotifications([]);
            document.getElementById('notification-badge').classList.add('hidden');
        });

    </script>
</body>
</html>
