<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agri-Guard</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Theme Color for PWA -->
    <meta name="theme-color" content="#22c55e">
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Leaflet CSS for mapping -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />

    <style>
        /* Simple transition for showing/hiding screens */
        .screen { display: none; }
        .screen.active { display: flex; }
        body { font-family: 'Inter', sans-serif; } /* Using a common sans-serif font */

        /* Fixed Sidebar */
        #sidebar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            z-index: 10;
        }

        #screen-container.with-sidebar {
            margin-left: 4rem; /* ml-16 */
        }
        #map { height: 400px; }
        #report-map { height: 200px; margin-bottom: 1.5rem; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-5 right-5 bg-green-600 text-white py-2 px-4 rounded-lg shadow-md opacity-0 transition-opacity duration-300 z-50">
        <p id="toast-message"></p>
    </div>

    <div id="app-container" class="h-screen w-screen relative">
        <!-- Fixed Icon-Only Sidebar -->
        <aside id="sidebar" class="w-16 bg-green-800 text-white p-4 hidden flex-col items-center">
            <!-- Logo -->
            <div class="mb-10">
                 <i data-lucide="leaf" class="w-8 h-8 text-green-400"></i>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 flex flex-col items-center space-y-4">
                <a href="#" id="nav-farm-list" class="nav-item p-2 rounded-lg hover:bg-green-700" title="My Farms">
                    <i data-lucide="layout-dashboard" class="w-6 h-6"></i>
                </a>
                <a href="#" id="nav-profile" class="nav-item p-2 rounded-lg hover:bg-green-700" title="Profile">
                    <i data-lucide="user" class="w-6 h-6"></i>
                </a>
                <a href="#" id="nav-reports" class="nav-item p-2 rounded-lg hover:bg-green-700" title="Reports">
                    <i data-lucide="file-text" class="w-6 h-6"></i>
                </a>
                <a href="#" id="nav-diagnosis" class="nav-item p-2 rounded-lg hover:bg-green-700" title="Diagnosis">
                    <i data-lucide="stethoscope" class="w-6 h-6"></i>
                </a>
                <a href="#" id="nav-treatment" class="nav-item p-2 rounded-lg hover:bg-green-700" title="Treatment">
                    <i data-lucide="syringe" class="w-6 h-6"></i>
                </a>
                <a href="#" id="nav-clinic" class="nav-item p-2 rounded-lg hover:bg-green-700" title="Online Clinic">
                    <i data-lucide="message-square" class="w-6 h-6"></i>
                </a>
            </nav>

            <!-- Logout Button -->
            <div class="mt-auto">
                <button id="sidebar-logout-btn" class="nav-item p-2 rounded-lg hover:bg-red-700" title="Logout">
                    <i data-lucide="log-out" class="w-6 h-6"></i>
                </button>
            </div>
        </aside>

        <!-- Main content area that holds all screens -->
        <div id="screen-container" class="h-screen overflow-y-auto">
            <!-- Loading Screen -->
            <div id="loading-screen" class="screen active flex-col justify-center items-center h-full bg-green-50 text-gray-800">
                <svg class="animate-spin h-10 w-10 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-lg text-green-700">Loading Agri-Guard...</p>
            </div>

            <!-- Login Screen -->
            <div id="login-screen" class="screen flex-col justify-center items-center h-full p-6 bg-green-50 text-gray-800">
                <div class="text-center mb-10">
                    <i data-lucide="leaf" class="w-16 h-16 text-green-600 mx-auto"></i>
                    <h1 class="text-4xl font-bold text-green-900 mt-4">Agri-Guard</h1>
                    <p class="text-lg text-green-700">Tobacco Pest Monitoring</p>
                    <p class="text-sm text-gray-500 mt-1">Ilocos Region, Philippines</p>
                </div>
                <div class="w-full max-w-sm">
                    <button id="google-signin-btn" class="w-full bg-white text-gray-700 font-semibold py-3 px-4 border border-gray-300 rounded-lg shadow-sm flex items-center justify-center mb-3">
                        <img src="/assets/icons/google-logo.svg" alt="Google" class="mr-3"> <!-- Placeholder for Google Icon -->
                        Sign in with Google
                    </button>
                    <button id="facebook-signin-btn" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg shadow-sm flex items-center justify-center mb-4">
                         <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z" clip-rule="evenodd" /></svg>
                        Sign in with Facebook
                    </button>
                    <button id="guest-signin-btn" class="w-full text-gray-600 py-2">Continue as Guest</button>
                </div>
                <div class="mt-4 text-center text-xs text-gray-500">
                    By signing in, you agree to our <a href="#" id="privacy-policy-link" class="underline hover:text-green-700">Privacy Policy</a>. All personal data is encrypted in transit.
                </div>
            </div>

            <!-- Privacy Policy Screen -->
            <div id="privacy-policy-screen" class="screen flex-col h-full bg-green-50 text-gray-800">
                <header class="bg-white p-4 shadow-md flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Privacy Policy</h2>
                    <button id="close-privacy-policy-btn" class="p-2 rounded-full hover:bg-gray-100">
                        <i data-lucide="x" class="w-6 h-6 text-gray-600"></i>
                    </button>
                </header>
                <main class="flex-1 p-6 overflow-y-auto">
                    <p class="mb-4"><strong>Last updated: August 11, 2025</strong></p>
                    <p class="mb-4">This Privacy Policy describes Our policies and procedures on the collection, use and disclosure of Your information when You use the Service and tells You about Your privacy rights and how the law protects You.</p>
                    <h3 class="text-lg font-bold mt-6 mb-2">Interpretation and Definitions</h3>
                    <p class="mb-4">The words of which the initial letter is capitalized have meanings defined under the following conditions. The following definitions shall have the same meaning regardless of whether they appear in singular or in plural.</p>
                    <h3 class="text-lg font-bold mt-6 mb-2">Collecting and Using Your Personal Data</h3>
                    <p class="mb-4">While using Our Service, We may ask You to provide Us with certain personally identifiable information that can be used to contact or identify You. Personally identifiable information may include, but is not limited to: Email address, First name and last name, Phone number, Address, State, Province, ZIP/Postal code, City, Usage Data.</p>
                    <h3 class="text-lg font-bold mt-6 mb-2">Data Encryption</h3>
                    <p class="mb-4">We are committed to ensuring that your information is secure. To prevent unauthorized access or disclosure, we have put in place suitable physical, electronic and managerial procedures to safeguard and secure the information we collect online. All personal data is encrypted in transit between your device and our servers using Secure Socket Layer (SSL) technology.</p>
                    <h3 class="text-lg font-bold mt-6 mb-2">Contact Us</h3>
                    <p>If you have any questions about this Privacy Policy, You can contact us by email: privacy@agri-guard.com</p>
                </main>
            </div>

            <!-- Create Profile Screen -->
            <div id="profile-screen" class="screen flex-col h-full bg-green-50 text-gray-800">
                <header class="bg-white p-4 shadow-md">
                    <h2 id="profile-title" class="text-2xl font-bold">Your Profile</h2>
                </header>
                <main class="flex-1 p-6 overflow-y-auto">
                    <div class="text-center mb-6">
                        <img id="profile-pic" src="https://placehold.co/96x96/e2e8f0/334155?text=User" class="w-24 h-24 rounded-full mx-auto mb-4">
                    </div>
                    <label for="fullName" class="block text-sm font-medium text-gray-700">Full Name</label>
                    <input type="text" id="fullName" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">

                    <label for="province" class="block text-sm font-medium text-gray-700 mt-4">Province</label>
                    <select id="province" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        <option>Loading provinces...</option>
                    </select>

                    <label for="municipality" class="block text-sm font-medium text-gray-700 mt-4">Municipality</label>
                    <select id="municipality" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" disabled></select>

                    <label for="barangay" class="block text-sm font-medium text-gray-700 mt-4">Barangay</label>
                    <select id="barangay" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" disabled></select>

                    <label for="birthdate" class="block text-sm font-medium text-gray-700 mt-4">Birthdate</label>
                    <input type="date" id="birthdate" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    <label for="civilStatus" class="block text-sm font-medium text-gray-700 mt-4">Civil Status</label>
                    <select id="civilStatus" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        <option>Single</option>
                        <option>Married</option>
                        <option>Widowed</option>
                        <option>Divorced</option>
                    </select>
                    <label for="religion" class="block text-sm font-medium text-gray-700 mt-4">Religion</label>
                    <input type="text" id="religion" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    <label for="yearsFarming" class="block text-sm font-medium text-gray-700 mt-4">Years in Tobacco Farming</label>
                    <input type="number" id="yearsFarming" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    <label for="familyMembers" class="block text-sm font-medium text-gray-700 mt-4">Number of Family Members</label>
                    <input type="number" id="familyMembers" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    <label for="education" class="block text-sm font-medium text-gray-700 mt-4">Highest Educational Attainment</label>
                    <select id="education" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        <option>No formal education</option>
                        <option>Elementary</option>
                        <option>High School</option>
                        <option>Vocational</option>
                        <option>College</option>
                        <option>Post-graduate</option>
                    </select>
                    <div class="mt-4">
                        <label for="isFarmer" class="flex items-center">
                            <input type="checkbox" id="isFarmer" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                            <span class="ml-2 text-sm font-medium text-gray-700">I am a farmer</span>
                        </label>
                    </div>
                    <div id="rsbsa-container" class="hidden mt-4">
                        <label for="rsbsaNumber" class="block text-sm font-medium text-gray-700">RSBSA Number (Optional)</label>
                        <input type="text" id="rsbsaNumber" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    </div>
                    <p class="mt-6 mb-2 font-medium text-gray-700">Select Your Role:</p>
                    <div class="flex gap-4">
                        <button id="role-farmer-btn" class="role-btn flex-1 p-4 rounded-lg border-2 border-green-600 bg-green-600 text-white">Farmer</button>
                        <button id="role-worker-btn" class="role-btn flex-1 p-4 rounded-lg border-2 border-gray-300">Extension Worker</button>
                    </div>
                    <div class="mt-8 space-y-4">
                        <button id="edit-profile-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hidden">Edit Profile</button>
                        <button id="save-profile-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md">Save and Continue</button>
                        <button id="cancel-edit-btn" class="w-full bg-gray-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hidden">Cancel</button>
                    </div>
                </main>
            </div>

            <!-- Farm List Screen (Home) -->
            <div id="farm-list-screen" class="screen flex-col h-full bg-green-50 text-gray-800">
                <header class="bg-white p-4 shadow-md flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold">My Farm Plots</h2>
                        <p id="welcome-message" class="text-sm text-gray-600"></p>
                    </div>
                    <div id="connection-status" class="text-center py-1 px-3 rounded-full text-sm font-semibold"></div>
                </header>
                <main id="farm-list-container" class="flex-1 p-4 overflow-y-auto">
                    <!-- Farm cards will be inserted here by JavaScript -->
                    <div id="no-farms-message" class="text-center text-gray-500 mt-20">
                        <i data-lucide="map-pin" class="w-12 h-12 mx-auto text-gray-400"></i>
                        <p class="mt-4">No farm plots found.</p>
                        <p>Add your first plot to start monitoring.</p>
                    </div>
                </main>
                <button id="add-farm-btn" class="absolute bottom-6 right-6 bg-green-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center">
                    <i data-lucide="plus" class="w-8 h-8"></i>
                </button>
            </div>

            <!-- Dashboard Screen -->
            <div id="dashboard-screen" class="screen flex-col h-full bg-green-50 text-gray-800">
                <header class="bg-white p-4 shadow-md flex justify-between items-center">
                    <div class="flex items-center">
                        <h2 id="dashboard-farm-name" class="text-2xl font-bold">Farm Health Log</h2>
                        <p id="dashboard-farm-variety" class="text-sm text-gray-600 ml-4"></p>
                    </div>
                    <div>
                        <button id="edit-farm-details-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Edit Details</button>
                        <button id="delete-farm-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md ml-2">Delete Farm</button>
                        <button id="new-submission-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md ml-2">New Report</button>
                    </div>
                </header>
                <main id="dashboard-main" class="flex-1 p-4 overflow-y-auto">
                    <div class="text-center text-gray-500 mt-20">
                        <i data-lucide="clipboard-list" class="w-12 h-12 mx-auto text-gray-400"></i>
                        <p class="mt-4">Submission history will appear here.</p>
                    </div>
                </main>
            </div>

            <!-- New Submission Screen -->
            <div id="new-submission-screen" class="screen flex-col h-full bg-green-50 text-gray-800">
                <header class="bg-white p-4 shadow-md flex items-center">
                    <button id="back-to-dashboard-btn" class="p-2 rounded-full hover:bg-gray-100 mr-2">
                        <i data-lucide="arrow-left" class="w-6 h-6 text-gray-600"></i>
                    </button>
                    <h2 class="text-2xl font-bold">New Scouting Report</h2>
                </header>
                <main class="flex-1 p-6 overflow-y-auto">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Farm Location</label>
                    <div id="report-map" class="w-full h-48 bg-gray-200 rounded-md shadow-inner"></div>

                    <label class="block text-sm font-medium text-gray-700 mb-2">Upload Image of Affected Plant</label>
                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                        <div class="space-y-1 text-center">
                            <i id="image-placeholder-icon" data-lucide="image" class="mx-auto h-12 w-12 text-gray-400"></i>
                            <img id="submission-image-preview" src="" class="hidden mx-auto max-h-48 rounded-md">
                            <div class="flex text-sm text-gray-600">
                                <label for="image-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-green-600 hover:text-green-500 focus-within:outline-none">
                                    <span>Upload a file</span>
                                    <input id="image-upload" name="image-upload" type="file" class="sr-only" accept="image/*">
                                </label>
                                <p class="pl-1">or drag and drop</p>
                            </div>
                            <p class="text-xs text-gray-500">PNG, JPG, GIF up to 10MB</p>
                             <div class="mt-4">
                                <button id="open-camera-btn" type="button" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                    <i data-lucide="camera" class="mr-2 h-5 w-5"></i>
                                    Capture with Camera
                                </button>
                            </div>
                        </div>
                    </div>

                    <fieldset id="symptoms-checklist" class="mt-6">
                        <legend class="text-base font-medium text-gray-900">Observed Symptoms</legend>
                        <div class="mt-4 grid grid-cols-2 gap-4">
                            <div class="flex items-start"><div class="flex items-center h-5"><input id="symptom-spots" value="spots" type="checkbox" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="symptom-spots" class="font-medium text-gray-700">Leaf Spots</label></div></div>
                            <div class="flex items-start"><div class="flex items-center h-5"><input id="symptom-wilting" value="wilting" type="checkbox" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="symptom-wilting" class="font-medium text-gray-700">Wilting</label></div></div>
                            <div class="flex items-start"><div class="flex items-center h-5"><input id="symptom-yellowing" value="yellowing" type="checkbox" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="symptom-yellowing" class="font-medium text-gray-700">Yellowing</label></div></div>
                        </div>
                    </fieldset>

                    <fieldset id="distribution-radios" class="mt-6">
                        <legend class="text-base font-medium text-gray-900">Pest/Disease Distribution</legend>
                        <div class="mt-4 space-y-4">
                            <div class="flex items-center"><input id="dist-isolated" name="distribution" value="isolated" type="radio" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300"><label for="dist-isolated" class="ml-3 block text-sm font-medium text-gray-700">Isolated Plants</label></div>
                            <div class="flex items-center"><input id="dist-patches" name="distribution" value="patches" type="radio" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300"><label for="dist-patches" class="ml-3 block text-sm font-medium text-gray-700">In Patches</label></div>
                        </div>
                    </fieldset>

                    <fieldset id="severity-radios" class="mt-6">
                        <legend class="text-base font-medium text-gray-900">Severity</legend>
                        <div class="mt-4 space-y-4">
                            <div class="flex items-center"><input id="sev-low" name="severity" value="low" type="radio" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300"><label for="sev-low" class="ml-3 block text-sm font-medium text-gray-700">Low</label></div>
                            <div class="flex items-center"><input id="sev-medium" name="severity" value="medium" type="radio" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300"><label for="sev-medium" class="ml-3 block text-sm font-medium text-gray-700">Medium</label></div>
                            <div class="flex items-center"><input id="sev-high" name="severity" value="high" type="radio" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300"><label for="sev-high" class="ml-3 block text-sm font-medium text-gray-700">High</label></div>
                        </div>
                    </fieldset>
                    
                    <button id="save-submission-btn" class="mt-8 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md">Save Submission</button>
                </main>
            </div>

            <!-- Camera Screen -->
            <div id="camera-screen" class="screen flex-col h-screen bg-black text-white">
                <header class="bg-gray-900 p-4 flex justify-between items-center z-20">
                    <button id="back-to-submission-btn" class="p-2 rounded-full hover:bg-gray-700">
                        <i data-lucide="arrow-left" class="w-6 h-6"></i>
                    </button>
                    <h2 class="text-xl font-bold">Capture Media</h2>
                    <div class="w-10"></div> <!-- Spacer -->
                </header>
                <main class="flex-1 relative flex justify-center items-center">
                    <video id="camera-feed" class="w-full h-full object-cover" autoplay playsinline></video>
                    <div id="camera-overlay" class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <div class="w-11/12 h-2/3 border-4 border-dashed border-white rounded-lg" style="border-color: rgba(255, 255, 255, 0.7);">
                            <p class="text-white text-center mt-4">Place affected leaf inside this box</p>
                        </div>
                    </div>
                    <canvas id="photo-canvas" class="hidden"></canvas>
                </main>
                <footer class="bg-gray-900 p-4 flex justify-around items-center z-20">
                    <button id="capture-photo-btn" class="p-4 bg-white rounded-full focus:outline-none">
                        <i data-lucide="camera" class="w-8 h-8 text-gray-900"></i>
                    </button>
                    <button id="record-video-btn" class="p-4 bg-red-600 rounded-full focus:outline-none">
                        <i data-lucide="video" class="w-8 h-8 text-white"></i>
                    </button>
                </footer>
            </div>

            <!-- Reports Screen -->
            <div id="reports-screen" class="screen flex-col h-full bg-green-50 text-gray-800">
                <header class="bg-white p-4 shadow-md">
                    <h2 class="text-2xl font-bold">Reports</h2>
                </header>
                <main class="flex-1 p-4">
                    <p>Reports will be displayed here.</p>
                </main>
            </div>

            <!-- Diagnosis Screen -->
            <div id="diagnosis-screen" class="screen flex-col h-full bg-green-50 text-gray-800">
                <header class="bg-white p-4 shadow-md">
                    <h2 class="text-2xl font-bold">Diagnosis</h2>
                </header>
                <main class="flex-1 p-4">
                    <p>Diagnosis tools and information will be available here.</p>
                </main>
            </div>

            <!-- Treatment Screen -->
            <div id="treatment-screen" class="screen flex-col h-full bg-green-50 text-gray-800">
                <header class="bg-white p-4 shadow-md">
                    <h2 class="text-2xl font-bold">Treatment</h2>
                </header>
                <main class="flex-1 p-4">
                    <p>Treatment recommendations will be available here.</p>
                </main>
            </div>

            <!-- Online Clinic Screen -->
            <div id="online-clinic-screen" class="screen flex-col h-full bg-green-50 text-gray-800">
                <header class="bg-white p-4 shadow-md">
                    <h2 class="text-2xl font-bold">Online Clinic</h2>
                </header>
                <main class="flex-1 p-4">
                    <p>Expert consultation features will be available here.</p>
                </main>
            </div>

            <!-- Farm Setup Screen -->
            <div id="farm-setup-screen" class="screen flex-col h-full bg-green-50 text-gray-800">
                <header class="bg-white p-4 shadow-md">
                    <h2 class="text-2xl font-bold">Map Your Farm Plot</h2>
                </header>
                <main class="flex-1 p-6">
                    <p class="mb-4 text-gray-700">Please use the drawing tool on the map to outline the boundary of your farm plot. You can pan and zoom to find your location.</p>
                    <div id="map" class="w-full h-96 bg-gray-200 rounded-md shadow-inner"></div>
                    <div class="mt-6 text-right">
                        <button id="cancel-farm-setup-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md mr-2">Cancel</button>
                        <button id="save-farm-map-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md" disabled>Save Farm Area</button>
                    </div>
                </main>
            </div>

        </div>
    </div>

    <!-- Modals -->
    <div id="farm-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-40">
         <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Add New Farm Plot</h3>
                <button id="close-farm-modal-btn" class="p-1"><i data-lucide="x"></i></button>
            </div>
            <div class="p-6">
                <label for="farmName" class="block text-sm font-medium text-gray-700">Plot Name</label>
                <input type="text" id="farmName" placeholder="e.g., North Field" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                <label for="tobaccoVariety" class="block text-sm font-medium text-gray-700 mt-4">Tobacco Variety</label>
                <input type="text" id="tobaccoVariety" placeholder="e.g., Virginia" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                <label for="plantingDate" class="block text-sm font-medium text-gray-700 mt-4">Date of Planting</label>
                <input type="date" id="plantingDate" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                <button id="next-farm-map-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md mt-6">Next: Set Location</button>
            </div>
        </div>
    </div>

    <!-- Address Data -->
    <script src="address-provider.js"></script>

    <!-- Leaflet JS for mapping -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the IDB library for offline storage
        import { openDB } from '/assets/js/idb.js';

        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            FacebookAuthProvider,
            signInWithPopup,
            signInAnonymously,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            collection,
            addDoc,
            onSnapshot,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- 1. FIREBASE CONFIGURATION ---
        // IMPORTANT: Replace with your project's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB3yPx1dWJQwqn-SglOjGzrQ6BAZFngMDc",
            authDomain: "pest-monitoring-app-ph.firebaseapp.com",
            projectId: "pest-monitoring-app-ph",
            storageBucket: "pest-monitoring-app-ph.appspot.com",
            messagingSenderId: "948653534237",
            appId: "1:948653534237:web:dc195109343b4d5a12eaf4",
            measurementId: "G-YRFNHDN5VV"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 2. PWA & OFFLINE SETUP ---
        // Initialize IndexedDB
        const dbPromise = openDB('agri-guard-db', 3, {
            upgrade(db, oldVersion, newVersion, transaction) {
                switch (oldVersion) {
                    case 0:
                        // A fresh database install
                        db.createObjectStore('user-profile'); // Key-value store, key is static 'profile'
                        db.createObjectStore('farm-lots', { keyPath: 'id' });
                        db.createObjectStore('submissions', { keyPath: 'id' });
                        db.createObjectStore('outbox', { autoIncrement: true });
                    case 1:
                        // Upgrading from v1 to v2
                        db.createObjectStore('submission_outbox', { autoIncrement: true });
                    case 2:
                        // Upgrading from v2 to v3
                        if (db.objectStoreNames.contains('submission_outbox')) {
                            // This logic is to migrate data if needed, for now we'll just delete it
                            // and create the new stores. A real-world scenario might involve
                            // reading from the old store and writing to the new one.
                            db.deleteObjectStore('submission_outbox');
                        }
                         if (!db.objectStoreNames.contains('user-profile')) {
                            db.createObjectStore('user-profile');
                        }
                        if (!db.objectStoreNames.contains('farm-lots')) {
                            db.createObjectStore('farm-lots', { keyPath: 'id' });
                        }
                         if (!db.objectStoreNames.contains('submissions')) {
                            db.createObjectStore('submissions', { keyPath: 'id' });
                        }
                        // The original 'outbox' from v1 is kept and will be our unified outbox.
                }
            },
        });
        console.log('IndexedDB setup initiated.');

        // Register the service worker for offline capabilities
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('ServiceWorker registration successful with scope: ', registration.scope))
                    .catch(err => console.log('ServiceWorker registration failed: ', err));
            });
        }
        
        // --- 3. UI & STATE MANAGEMENT ---
        const screens = {
            loading: document.getElementById('loading-screen'),
            login: document.getElementById('login-screen'),
            profile: document.getElementById('profile-screen'),
            farmList: document.getElementById('farm-list-screen'),
            dashboard: document.getElementById('dashboard-screen'),
            newSubmission: document.getElementById('new-submission-screen'),
            camera: document.getElementById('camera-screen'),
            reports: document.getElementById('reports-screen'),
            diagnosis: document.getElementById('diagnosis-screen'),
            treatment: document.getElementById('treatment-screen'),
            onlineClinic: document.getElementById('online-clinic-screen'),
            privacyPolicy: document.getElementById('privacy-policy-screen'),
            farmSetup: document.getElementById('farm-setup-screen')
        };

        // --- Privacy Policy Navigation ---
        document.getElementById('privacy-policy-link').addEventListener('click', (e) => {
            e.preventDefault();
            showScreen('privacyPolicy');
        });

        document.getElementById('close-privacy-policy-btn').addEventListener('click', () => {
            // This should ideally return to the previous screen.
            // For simplicity, we'll return to the login screen as the link is only there.
            showScreen('login');
        });

        // --- Camera Navigation ---
        document.getElementById('open-camera-btn').addEventListener('click', () => {
            showScreen('camera');
        });

        document.getElementById('back-to-submission-btn').addEventListener('click', () => {
            showScreen('newSubmission');
        });

        // --- Sidebar Navigation ---
        document.getElementById('nav-farm-list').addEventListener('click', () => showScreen('farmList'));
        document.getElementById('nav-profile').addEventListener('click', () => showScreen('profile'));
        document.getElementById('nav-reports').addEventListener('click', () => showScreen('reports'));
        document.getElementById('nav-diagnosis').addEventListener('click', () => showScreen('diagnosis'));
        document.getElementById('nav-treatment').addEventListener('click', () => showScreen('treatment'));
        document.getElementById('nav-clinic').addEventListener('click', () => showScreen('onlineClinic'));
        document.getElementById('sidebar-logout-btn').addEventListener('click', () => signOut(auth));

        // --- Sidebar is now fixed, toggle logic removed ---

        let currentUser = null;
        let userProfile = null;
        let selectedRole = 'Farmer';

        // Function to switch between screens
        function showScreen(screenName) {
            // Stop camera if navigating away from it
            if (mediaStream && screenName !== 'camera') {
                stopCamera();
            }

            const sidebar = document.getElementById('sidebar');
            const screenContainer = document.getElementById('screen-container');

            const noSidebarScreens = ['loading', 'login', 'camera','privacyPolicy'];


            if (noSidebarScreens.includes(screenName)) {
                sidebar.classList.add('hidden');
                screenContainer.classList.remove('with-sidebar'); // Use new class
            } else {
                sidebar.classList.remove('hidden');
                screenContainer.classList.add('with-sidebar'); // Use new class
            }

            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            if (screens[screenName]) {
                screens[screenName].classList.add('active');
            }

            // Start camera if navigating to it
            if (screenName === 'camera') {
                startCamera();
            }

            lucide.createIcons();
        }

        let toastTimeout;
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');

            toastMessage.textContent = message;

            // Reset classes
            toast.className = 'fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-md transition-opacity duration-300';

            if (type === 'success') {
                toast.classList.add('bg-green-600');
            } else if (type === 'error') {
                toast.classList.add('bg-red-600');
            } else {
                toast.classList.add('bg-gray-800');
            }

            toast.classList.remove('opacity-0');

            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                toast.classList.add('opacity-0');
            }, 3000);
        }

        // --- CAMERA LOGIC ---
        const cameraFeed = document.getElementById('camera-feed');
        const photoCanvas = document.getElementById('photo-canvas');
        const capturePhotoBtn = document.getElementById('capture-photo-btn');
        const recordVideoBtn = document.getElementById('record-video-btn');
        let mediaStream = null;
        let mediaRecorder = null;
        let recordedChunks = [];

        async function startCamera() {
            try {
                if (!('mediaDevices' in navigator) || !('getUserMedia' in navigator.mediaDevices)) {
                    throw new Error('Camera API is not available in this browser.');
                }

                const constraints = {
                    video: {
                        facingMode: 'environment', // Prioritize back camera
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };

                mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraFeed.srcObject = mediaStream;
                cameraFeed.play();
            } catch (error) {
                console.error('Error accessing camera:', error);
                showToast(`Could not access camera: ${error.message}`, 'error');
                // Fallback or show an error message
                showScreen('newSubmission');
            }
        }

        function stopCamera() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
        }

        capturePhotoBtn.addEventListener('click', () => {
            const context = photoCanvas.getContext('2d');
            photoCanvas.width = cameraFeed.videoWidth;
            photoCanvas.height = cameraFeed.videoHeight;
            context.drawImage(cameraFeed, 0, 0, photoCanvas.width, photoCanvas.height);

            const imageDataUrl = photoCanvas.toDataURL('image/jpeg', 0.9); // 90% quality

            // Set the captured image on the submission form
            const imagePreview = document.getElementById('submission-image-preview');
            const imagePlaceholder = document.getElementById('image-placeholder-icon');
            imagePreview.src = imageDataUrl;
            imagePreview.classList.remove('hidden');
            imagePlaceholder.classList.add('hidden');

            // Stop the camera and go back to the form
            stopCamera();
            showScreen('newSubmission');
        });

        recordVideoBtn.addEventListener('click', () => {
            // Placeholder for video recording functionality
            showToast('Video recording is not yet implemented.', 'info');
        });


        // --- MAP & FARM SETUP LOGIC ---
        let map;
        let reportMap;
        let drawnItems;
        let pendingFarmData = {};

        async function initializeMapForEdit(farmId) {
             if (!currentUser || !farmId) return;

            try {
                const farmDocRef = doc(db, 'users', currentUser.uid, 'farmLots', farmId);
                const farmDocSnap = await getDoc(farmDocRef);

                if (farmDocSnap.exists()) {
                    const farmData = farmDocSnap.data();
                    const coordinates = farmData.polygonCoordinates;

                    if (coordinates && coordinates.length > 0) {
                        const latLngs = coordinates.map(c => [c.lat, c.lng]);
                        const polygon = L.polygon(latLngs, {color: '#22c55e'});

                        drawnItems.clearLayers();
                        drawnItems.addLayer(polygon);
                        map.fitBounds(polygon.getBounds());
                        document.getElementById('save-farm-map-btn').disabled = false;
                    }
                }
            } catch (error) {
                console.error("Error loading farm data for editing:", error);
            }
        }

        async function initializeReportMap(farmId) {
            if (!currentUser || !farmId) return;

            try {
                const farmDocRef = doc(db, 'users', currentUser.uid, 'farmLots', farmId);
                const farmDocSnap = await getDoc(farmDocRef);

                if (farmDocSnap.exists()) {
                    const farmData = farmDocSnap.data();
                    const coordinates = farmData.polygonCoordinates;

                    if (reportMap) {
                        reportMap.remove();
                    }

                    reportMap = L.map('report-map', {
                        scrollWheelZoom: false,
                        dragging: false,
                        zoomControl: false
                    });

                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Tiles &copy; Esri'
                    }).addTo(reportMap);

                    if (coordinates && coordinates.length > 0) {
                        const latLngs = coordinates.map(c => [c.lat, c.lng]);
                        const polygon = L.polygon(latLngs, {color: '#22c55e'}).addTo(reportMap);
                        reportMap.fitBounds(polygon.getBounds());
                    }
                }
            } catch (error) {
                console.error("Error loading farm data for report map:", error);
            }
        }

        function initializeMap() {
            // If map is already initialized, just reset its view
            if (map) {
                map.setView([12.8797, 121.7740], 5); // Reset to PH view
                if(drawnItems) {
                    drawnItems.clearLayers();
                }
                return;
            }

            // Initialize the map and set its view to the Philippines
            map = L.map('map').setView([12.8797, 121.7740], 5);

            // Add a satellite tile layer to the map
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            }).addTo(map);

            // Initialize the FeatureGroup to store editable layers
            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            // Initialize the draw control and pass it the FeatureGroup
            const drawControl = new L.Control.Draw({
                edit: {
                    featureGroup: drawnItems,
                    remove: true
                },
                draw: {
                    polygon: {
                        allowIntersection: false,
                        drawError: {
                            color: '#e1e100',
                            message: '<strong>Oh snap!</strong> you can\'t draw that!'
                        },
                        shapeOptions: {
                            color: '#22c55e'
                        }
                    },
                    polyline: false,
                    rectangle: false,
                    circle: false,
                    marker: false,
                    circlemarker: false
                }
            });
            map.addControl(drawControl);

            map.on(L.Draw.Event.CREATED, function (event) {
                const layer = event.layer;
                drawnItems.clearLayers(); // Clear previous drawings
                drawnItems.addLayer(layer);
                document.getElementById('save-farm-map-btn').disabled = false;
            });

            map.on(L.Draw.Event.DELETED, function() {
                if (drawnItems.getLayers().length === 0) {
                    document.getElementById('save-farm-map-btn').disabled = true;
                }
            });

             // Attempt to get user's location
            map.locate({setView: true, maxZoom: 16});
            map.on('locationfound', e => {
                L.marker(e.latlng).addTo(map)
                    .bindPopup("You are somewhere around here.").openPopup();
            });
            map.on('locationerror', e => {
                console.log(e.message);
                // Silently fails if location is not available. Map defaults to PH view.
            });
        }


        // --- 4. AUTHENTICATION LOGIC ---
        const profileTitle = document.getElementById('profile-title');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const profileFormElements = document.querySelectorAll('#profile-screen input, #profile-screen select, #profile-screen textarea, #profile-screen .role-btn');

        function setProfileMode(mode) { // 'edit', 'view', 'new'
            if (mode === 'view') {
                profileTitle.textContent = 'Your Profile';
                profileFormElements.forEach(el => el.disabled = true);
                editProfileBtn.classList.remove('hidden');
                saveProfileBtn.classList.add('hidden');
                cancelEditBtn.classList.add('hidden');
            } else if (mode === 'edit') {
                profileTitle.textContent = 'Edit Profile';
                profileFormElements.forEach(el => el.disabled = false);
                saveProfileBtn.textContent = 'Save Changes';
                editProfileBtn.classList.add('hidden');
                saveProfileBtn.classList.remove('hidden');
                cancelEditBtn.classList.remove('hidden');
            } else { // new
                profileTitle.textContent = 'Complete Your Profile';
                profileFormElements.forEach(el => el.disabled = false);
                saveProfileBtn.textContent = 'Save and Continue';
                editProfileBtn.classList.add('hidden');
                saveProfileBtn.classList.remove('hidden');
                cancelEditBtn.classList.add('hidden');
            }
        }

        // --- Address Dropdown Logic ---
        const provinceSelect = document.getElementById('province');
        const municipalitySelect = document.getElementById('municipality');
        const barangaySelect = document.getElementById('barangay');

        function populateProvinces() {
            provinceSelect.innerHTML = '<option value="">Select Province</option>';
            if (window.philippineAddresses && window.philippineAddresses.provinces) {
                window.philippineAddresses.provinces.forEach(province => {
                    const option = document.createElement('option');
                    option.value = province.name;
                    option.textContent = province.name;
                    provinceSelect.appendChild(option);
                });
            } else {
                provinceSelect.innerHTML = '<option value="">Failed to load addresses</option>';
            }
        }

        provinceSelect.addEventListener('change', () => {
            const selectedProvinceName = provinceSelect.value;
            const selectedProvince = window.philippineAddresses.provinces.find(p => p.name === selectedProvinceName);
            municipalitySelect.innerHTML = '<option value="">Select Municipality</option>';
            barangaySelect.innerHTML = '<option value="">Select Barangay</option>';
            barangaySelect.disabled = true;

            if (selectedProvince) {
                municipalitySelect.disabled = false;
                selectedProvince.municipalities.forEach(municipality => {
                    const option = document.createElement('option');
                    option.value = municipality.name;
                    option.textContent = municipality.name;
                    municipalitySelect.appendChild(option);
                });
            } else {
                municipalitySelect.disabled = true;
            }
        });

        municipalitySelect.addEventListener('change', () => {
            const selectedProvinceName = provinceSelect.value;
            const selectedMunicipalityName = municipalitySelect.value;
            const selectedProvince = window.philippineAddresses.provinces.find(p => p.name === selectedProvinceName);
            const selectedMunicipality = selectedProvince?.municipalities.find(m => m.name === selectedMunicipalityName);
            barangaySelect.innerHTML = '<option value="">Select Barangay</option>';

            if (selectedMunicipality && selectedMunicipality.barangays) {
                barangaySelect.disabled = false;
                selectedMunicipality.barangays.forEach(barangay => {
                    const option = document.createElement('option');
                    option.value = barangay;
                    option.textContent = barangay;
                    barangaySelect.appendChild(option);
                });
            } else {
                barangaySelect.disabled = true;
            }
        });

        // --- RSBSA Logic ---
        const isFarmerCheckbox = document.getElementById('isFarmer');
        const rsbsaContainer = document.getElementById('rsbsa-container');
        isFarmerCheckbox.addEventListener('change', () => {
            rsbsaContainer.classList.toggle('hidden', !isFarmerCheckbox.checked);
        });

        function populateProfileFields(profile) {
            document.getElementById('profile-pic').src = profile.photoURL || (currentUser && currentUser.photoURL) || 'https://placehold.co/96x96/e2e8f0/334155?text=User';
            document.getElementById('fullName').value = profile.fullName || '';

            // Populate address fields only if the data is ready
            if (window.philippineAddresses && window.philippineAddresses.provinces.length > 0) {
                if (profile.province) {
                    provinceSelect.value = profile.province;
                    provinceSelect.dispatchEvent(new Event('change'));

                    setTimeout(() => {
                        if (profile.municipality) {
                            municipalitySelect.value = profile.municipality;
                            municipalitySelect.dispatchEvent(new Event('change'));

                            setTimeout(() => {
                                 if (profile.barangay) {
                                    barangaySelect.value = profile.barangay;
                                }
                            }, 100);
                        }
                    }, 100);
                }
            }

            // RSBSA Number
            if (profile.rsbsaNumber) {
                isFarmerCheckbox.checked = true;
                rsbsaContainer.classList.remove('hidden');
                document.getElementById('rsbsaNumber').value = profile.rsbsaNumber;
            } else {
                isFarmerCheckbox.checked = false;
                rsbsaContainer.classList.add('hidden');
                document.getElementById('rsbsaNumber').value = '';
            }

            document.getElementById('birthdate').value = profile.birthdate || '';
            document.getElementById('civilStatus').value = profile.civilStatus || 'Single';
            document.getElementById('religion').value = profile.religion || '';
            document.getElementById('yearsFarming').value = profile.yearsFarming || '';
            document.getElementById('familyMembers').value = profile.familyMembers || '';
            document.getElementById('education').value = profile.education || 'No formal education';

            selectedRole = profile.role || 'Farmer';
            document.querySelectorAll('.role-btn').forEach(btn => {
                btn.classList.remove('bg-green-600', 'text-white');
                btn.classList.add('border-gray-300');
            });
            if (selectedRole === 'Farmer') {
                document.getElementById('role-farmer-btn').classList.add('bg-green-600', 'text-white');
            } else {
                document.getElementById('role-worker-btn').classList.add('bg-green-600', 'text-white');
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                updateOnlineStatus();

                // Wait for the address data to be ready (it's cached by SW, so this should be fast)
                await window.addressDataPromise;
                populateProvinces();

                // --- Offline First Profile Loading ---
                const localDB = await dbPromise;
                const localProfile = await localDB.get('user-profile', 'profile');

                if (localProfile) {
                    console.log("Profile loaded from IndexedDB");
                    handleUserProfile(localProfile);
                }

                if (navigator.onLine) {
                    console.log("Fetching profile from Firestore...");
                    const userDocRef = doc(db, "users", user.uid);
                    try {
                        const docSnap = await getDoc(userDocRef);
                        if (docSnap.exists()) {
                            const remoteProfile = docSnap.data();
                            await localDB.put('user-profile', remoteProfile, 'profile'); // Update local cache
                            console.log("Updated local profile from Firestore");
                            handleUserProfile(remoteProfile); // Re-handle with fresh data
                        } else {
                             // User exists in auth, but not in firestore db.
                             // This means it's a new user.
                            handleUserProfile({
                                fullName: user.displayName || '',
                                photoURL: user.photoURL || ''
                            }, true);
                        }
                    } catch (error) {
                        console.error("Error fetching profile from Firestore:", error);
                        if (!localProfile) {
                             // If firestore fails and we have no local data, it's a problem.
                             showToast("Could not load user profile.", "error");
                        }
                    }
                } else if (!localProfile) {
                    showToast("You are offline and no profile data is available.", "error");
                    // Potentially sign out or show a more specific offline message
                }

            } else {
                // User is signed out, clear local data
                currentUser = null;
                userProfile = null;
                const localDB = await dbPromise;
                await Promise.all([
                    localDB.clear('user-profile'),
                    localDB.clear('farm-lots'),
                    localDB.clear('submissions'),
                    localDB.clear('outbox')
                ]);
                showScreen('login');
            }
        });

        function handleUserProfile(profile, isNewUser = false) {
            userProfile = profile;
            populateProfileFields(userProfile);

             if (isNewUser) {
                setProfileMode('new');
                showScreen('profile');
                document.getElementById('add-farm-btn').style.display = 'none';
                return;
            }

            const requiredFields = ['fullName', 'province', 'municipality', 'barangay', 'birthdate', 'civilStatus', 'religion', 'yearsFarming', 'familyMembers', 'education', 'role'];
            const isProfileComplete = requiredFields.every(field => userProfile[field] !== undefined && userProfile[field] !== null && userProfile[field] !== '');

            if (isProfileComplete) {
                setProfileMode('view');
                document.getElementById('welcome-message').textContent = `Welcome, ${userProfile.fullName}`;
                loadFarms(); // Load farms after profile is handled
                showScreen('farmList');
                document.getElementById('add-farm-btn').style.display = 'flex';
            } else {
                setProfileMode('new');
                showToast('Please complete your profile to continue.', 'info');
                showScreen('profile');
                document.getElementById('add-farm-btn').style.display = 'none';
            }
        }

        // Event Listeners for Sign-in buttons
        document.getElementById('google-signin-btn').addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(error => console.error("Google Sign-in Error", error));
        });

        document.getElementById('facebook-signin-btn').addEventListener('click', () => {
            const provider = new FacebookAuthProvider();
            signInWithPopup(auth, provider).catch(error => console.error("Facebook Sign-in Error", error));
        });
        
        document.getElementById('guest-signin-btn').addEventListener('click', () => {
            signInAnonymously(auth).catch(error => console.error("Anonymous Sign-in Error", error));
        });

        // --- 5. PROFILE MANAGEMENT ---
        editProfileBtn.addEventListener('click', () => {
            setProfileMode('edit');
        });

        cancelEditBtn.addEventListener('click', () => {
            populateProfileFields(userProfile); // Revert changes
            setProfileMode('view');
        });

        document.querySelectorAll('.role-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (btn.disabled) return;
                document.querySelectorAll('.role-btn').forEach(b => {
                    b.classList.remove('bg-green-600', 'text-white');
                    b.classList.add('border-gray-300');
                });
                btn.classList.add('bg-green-600', 'text-white');
                btn.classList.remove('border-gray-300');
                selectedRole = btn.id === 'role-farmer-btn' ? 'Farmer' : 'Extension Worker';
            });
        });

        document.getElementById('save-profile-btn').addEventListener('click', async () => {
            const fullName = document.getElementById('fullName').value;
            const province = document.getElementById('province').value;
            const municipality = document.getElementById('municipality').value;
            const barangay = document.getElementById('barangay').value;
            const birthdate = document.getElementById('birthdate').value;
            const civilStatus = document.getElementById('civilStatus').value;
            const religion = document.getElementById('religion').value;
            const yearsFarming = document.getElementById('yearsFarming').value;
            const familyMembers = document.getElementById('familyMembers').value;
            const education = document.getElementById('education').value;
            const rsbsaNumber = document.getElementById('rsbsaNumber').value;

            if (!fullName.trim() || !province.trim() || !municipality.trim() || !barangay.trim() || !birthdate.trim() || !civilStatus.trim() || !religion.trim() || !yearsFarming.trim() || !familyMembers.trim() || !education.trim()) {
                showToast('Please fill out all fields.', 'error');
                return;
            }
            
            const profileData = {
                fullName: fullName.trim(),
                province: province,
                municipality: municipality,
                barangay: barangay,
                birthdate: birthdate,
                civilStatus: civilStatus,
                religion: religion.trim(),
                yearsFarming: parseInt(yearsFarming),
                familyMembers: parseInt(familyMembers),
                education: education,
                role: selectedRole,
                email: currentUser.email || '',
                photoURL: currentUser.photoURL || '',
                rsbsaNumber: rsbsaNumber.trim(),
                updatedAt: new Date().toISOString() // Use ISO string for local timestamp
            };

            try {
                const localDB = await dbPromise;
                // Save to local DB first for instant UI update
                await localDB.put('user-profile', profileData, 'profile');

                // Add to outbox for syncing
                await localDB.add('outbox', {
                    type: 'SAVE_PROFILE',
                    payload: profileData,
                    timestamp: new Date().getTime()
                });

                showToast("Profile saved locally. It will sync when online.", "success");

                // Immediately handle the updated profile
                handleUserProfile(profileData);

                // Trigger background sync if online
                if (navigator.onLine) {
                    syncOutbox();
                }

            } catch (error) {
                console.error("Error saving profile locally:", error);
                showToast("Could not save profile locally.", 'error');
            }
        });

        // --- 6. FARM MANAGEMENT & SETUP FLOW ---
        const farmModal = document.getElementById('farm-modal');
        document.getElementById('add-farm-btn').addEventListener('click', () => farmModal.style.display = 'flex');
        document.getElementById('close-farm-modal-btn').addEventListener('click', () => farmModal.style.display = 'none');
        document.getElementById('back-to-dashboard-btn').addEventListener('click', () => showScreen('farmList'));

        // --- New Farm Flow ---
        let isEditMode = false; // To track if we are editing or creating a new farm

        document.getElementById('edit-farm-details-btn').addEventListener('click', async () => {
            if (!currentFarmId || !currentUser) {
                showToast('No farm selected.', 'error');
                return;
            }
            isEditMode = true;

            // Fetch current farm data
            const farmDocRef = doc(db, 'users', currentUser.uid, 'farmLots', currentFarmId);
            const farmDocSnap = await getDoc(farmDocRef);

            if (farmDocSnap.exists()) {
                const farmData = farmDocSnap.data();
                // Pre-fill the modal
                document.getElementById('farmName').value = farmData.farmName || '';
                document.getElementById('tobaccoVariety').value = farmData.tobaccoVariety || '';
                document.getElementById('plantingDate').value = farmData.plantingDate || '';

                // Change button text and show modal
                document.getElementById('next-farm-map-btn').textContent = 'Update Details & Set Location';
                farmModal.style.display = 'flex';
            } else {
                showToast('Could not find farm details to edit.', 'error');
            }
        });

        // Reset edit mode when adding a new farm
        document.getElementById('add-farm-btn').addEventListener('click', () => {
            isEditMode = false;
            // Clear fields and reset button text for new entry
            document.getElementById('farmName').value = '';
            document.getElementById('tobaccoVariety').value = '';
            document.getElementById('plantingDate').value = '';
            document.getElementById('next-farm-map-btn').textContent = 'Next: Set Location';
            farmModal.style.display = 'flex';
        });


        document.getElementById('next-farm-map-btn').addEventListener('click', () => {
            const farmName = document.getElementById('farmName').value.trim();
            const tobaccoVariety = document.getElementById('tobaccoVariety').value.trim();
            const plantingDate = document.getElementById('plantingDate').value;

            if (!farmName || !tobaccoVariety || !plantingDate) {
                showToast('Please fill out all farm details.', 'error');
                return;
            }

            pendingFarmData = {
                farmName,
                tobaccoVariety,
                plantingDate
            };

            farmModal.style.display = 'none';

            if (isEditMode) {
                document.getElementById('save-farm-map-btn').textContent = 'Update Farm Area';
            } else {
                document.getElementById('save-farm-map-btn').textContent = 'Save Farm Area';
            }

            showScreen('farmSetup');
            // Invalidate map size and re-center, needed when map is in a hidden div
            setTimeout(() => {
                initializeMap(); // General map init
                if (isEditMode) {
                    initializeMapForEdit(currentFarmId); // Load existing polygon if editing
                }
            }, 100);
        });

        document.getElementById('cancel-farm-setup-btn').addEventListener('click', () => {
            pendingFarmData = {};
            drawnItems.clearLayers();
            document.getElementById('save-farm-map-btn').disabled = true;
            showScreen('farmList'); // Go back to the farm list
        });

        document.getElementById('delete-farm-btn').addEventListener('click', async () => {
            if (!currentFarmId || !currentUser) {
                showToast('No farm selected.', 'error');
                return;
            }

            if (confirm('Are you sure you want to delete this farm plot? This action cannot be undone.')) {
                try {
                    const localDB = await dbPromise;
                    // Delete from local DB first
                    await localDB.delete('farm-lots', currentFarmId);

                    // Add to outbox for syncing
                    await localDB.add('outbox', {
                        type: 'DELETE_FARM',
                        payload: { id: currentFarmId },
                        timestamp: new Date().getTime()
                    });

                    showToast('Farm plot deleted locally.', 'success');
                    currentFarmId = null;
                    showScreen('farmList');
                    loadFarms(); // Reload list to show deletion

                    if (navigator.onLine) {
                        syncOutbox();
                    }
                } catch (error) {
                    console.error("Error deleting farm plot locally:", error);
                    showToast('Failed to delete farm plot locally. Please try again.', 'error');
                }
            }
        });

        document.getElementById('save-farm-map-btn').addEventListener('click', async () => {
            if (drawnItems.getLayers().length === 0) {
                showToast('Please draw or select a farm area on the map first.', 'error');
                return;
            }

            const geojson = drawnItems.getLayers()[0].toGeoJSON();
            const coordinates = geojson.geometry.coordinates[0].map(p => ({ lat: p[1], lng: p[0] }));

            // Use currentFarmId if editing, otherwise generate a temporary local ID
            const farmId = isEditMode ? currentFarmId : `local_${new Date().getTime()}`;

            const farmData = {
                ...pendingFarmData,
                id: farmId,
                polygonCoordinates: coordinates,
                updatedAt: new Date().toISOString(),
                // Add a flag to indicate this is a local-only item until synced
                isLocal: true
            };

            if (!isEditMode) {
                farmData.createdAt = new Date().toISOString();
            }

            try {
                const localDB = await dbPromise;
                await localDB.put('farm-lots', farmData);

                await localDB.add('outbox', {
                    type: isEditMode ? 'UPDATE_FARM' : 'CREATE_FARM',
                    payload: farmData,
                    timestamp: new Date().getTime()
                });

                showToast('Farm plot saved locally.', 'success');

                // Reset state
                isEditMode = false;
                pendingFarmData = {};
                drawnItems.clearLayers();
                document.getElementById('save-farm-map-btn').disabled = true;
                document.getElementById('farmName').value = '';
                document.getElementById('tobaccoVariety').value = '';
                document.getElementById('plantingDate').value = '';

                showScreen('farmList');
                loadFarms(); // Reload the list from local DB to show the change

                if (navigator.onLine) {
                    syncOutbox();
                }

            } catch (error) {
                console.error("Error saving farm plot locally:", error);
                showToast('Could not save farm plot locally.', 'error');
            }
        });
        
        // --- 8. NEW SUBMISSION LOGIC ---
        const imageUploadInput = document.getElementById('image-upload');
        const imagePreview = document.getElementById('submission-image-preview');
        const imagePlaceholder = document.getElementById('image-placeholder-icon');

        imageUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                    imagePlaceholder.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('save-submission-btn').addEventListener('click', async () => {
            const imageSrc = document.getElementById('submission-image-preview').src;
            const symptoms = Array.from(document.querySelectorAll('#symptoms-checklist input:checked')).map(cb => cb.value);
            const distribution = document.querySelector('#distribution-radios input:checked')?.value;
            const severity = document.querySelector('#severity-radios input:checked')?.value;

            if (!imageSrc.startsWith('data:image') || symptoms.length === 0 || !distribution || !severity) {
                showToast('Please fill out all fields and select an image.', 'error');
                return;
            }

            if (!currentFarmId || !currentUser) {
                showToast('Could not identify the current farm or user. Please go back to the farm list.', 'error');
                return;
            }

            const submissionId = isEditSubmissionMode ? currentSubmissionId : `local_${new Date().getTime()}`;
            const submissionData = {
                id: submissionId,
                farmId: currentFarmId,
                imageDataUrl: imageSrc,
                symptoms,
                distribution,
                severity,
                timestamp: new Date().toISOString(),
                gps_coordinates: { latitude: 17.5734, longitude: 120.3856 }, // Keep simulated GPS
                isLocal: true
            };

            try {
                const localDB = await dbPromise;
                await localDB.put('submissions', submissionData);

                await localDB.add('outbox', {
                    type: isEditSubmissionMode ? 'UPDATE_SUBMISSION' : 'CREATE_SUBMISSION',
                    payload: submissionData,
                    timestamp: new Date().getTime()
                });

                showToast('Report saved locally.', 'success');

                // Reset state and form
                isEditSubmissionMode = false;
                currentSubmissionId = null;
                // Manually reset the form instead of clicking the button, to avoid re-triggering map init
                document.getElementById('submission-image-preview').src = '';
                document.getElementById('submission-image-preview').classList.add('hidden');
                document.getElementById('image-placeholder-icon').classList.remove('hidden');
                document.getElementById('image-upload').value = '';
                document.querySelectorAll('#symptoms-checklist input:checked').forEach(cb => cb.checked = false);
                document.querySelectorAll('#distribution-radios input:checked').forEach(rb => rb.checked = false);
                document.querySelectorAll('#severity-radios input:checked').forEach(rb => rb.checked = false);


                showScreen('dashboard');
                loadSubmissions(currentFarmId); // Reload submissions for the current farm

                if (navigator.onLine) {
                    syncOutbox();
                }
            } catch (error) {
                console.error('Failed to save submission locally:', error);
                showToast('Could not save report locally. Please try again.', 'error');
            }
        });

        let currentFarmId = null;
        let isEditSubmissionMode = false;
        let currentSubmissionId = null;

        // --- Submission Edit Flow ---
        document.getElementById('dashboard-main').addEventListener('click', async (e) => {
            if (e.target && e.target.classList.contains('edit-submission-btn')) {
                currentSubmissionId = e.target.getAttribute('data-id');
                if (!currentSubmissionId || !currentUser || !currentFarmId) {
                    showToast('Error: Cannot find submission to edit.', 'error');
                    return;
                }
                isEditSubmissionMode = true;

                try {
                    const submissionDocRef = doc(db, 'users', currentUser.uid, 'farmLots', currentFarmId, 'submissions', currentSubmissionId);
                    const submissionDocSnap = await getDoc(submissionDocRef);

                    if (submissionDocSnap.exists()) {
                        const sub = submissionDocSnap.data();

                        // Pre-fill the form
                        document.getElementById('submission-image-preview').src = sub.imageDataUrl || '';
                        document.getElementById('submission-image-preview').classList.remove('hidden');
                        document.getElementById('image-placeholder-icon').classList.add('hidden');

                        // Reset checkboxes before setting new state
                        document.querySelectorAll('#symptoms-checklist input[type="checkbox"]').forEach(cb => cb.checked = false);
                        sub.symptoms.forEach(symptomValue => {
                            const checkbox = document.getElementById(`symptom-${symptomValue}`);
                            if (checkbox) checkbox.checked = true;
                        });

                        // Reset radios before setting new state
                        document.querySelectorAll('#distribution-radios input[type="radio"]').forEach(rb => rb.checked = false);
                        const distRadio = document.getElementById(`dist-${sub.distribution}`);
                        if (distRadio) distRadio.checked = true;

                        document.querySelectorAll('#severity-radios input[type="radio"]').forEach(rb => rb.checked = false);
                        const sevRadio = document.getElementById(`sev-${sub.severity}`);
                        if (sevRadio) sevRadio.checked = true;

                        // Update button and show screen
                        document.getElementById('save-submission-btn').textContent = 'Update Report';
                        showScreen('newSubmission');
                        initializeReportMap(currentFarmId);

                    } else {
                        showToast('Submission data not found.', 'error');
                    }
                } catch (error) {
                    console.error("Error fetching submission for edit:", error);
                    showToast('Could not load submission data.', 'error');
                }
            }
        });

        document.getElementById('new-submission-btn').addEventListener('click', () => {
            isEditSubmissionMode = false;
            currentSubmissionId = null;

            // Reset the form for a new entry
            document.getElementById('submission-image-preview').src = '';
            document.getElementById('submission-image-preview').classList.add('hidden');
            document.getElementById('image-placeholder-icon').classList.remove('hidden');
            document.getElementById('image-upload').value = '';
            document.querySelectorAll('#symptoms-checklist input:checked').forEach(cb => cb.checked = false);
            document.querySelectorAll('#distribution-radios input:checked').forEach(rb => rb.checked = false);
            document.querySelectorAll('#severity-radios input:checked').forEach(rb => rb.checked = false);

            document.getElementById('save-submission-btn').textContent = 'Save Submission';
            showScreen('newSubmission');
            // Invalidate map size and load data, needed when map is in a hidden div
            setTimeout(() => {
                initializeReportMap(currentFarmId);
            }, 100);
        });

        async function loadSubmissions(farmId) {
            if (!currentUser || !farmId) return;

            const localDB = await dbPromise;
            // A more complex query is needed here if we store all submissions in one store.
            // For simplicity, we'll assume a structure where we can filter by farmId or clear per farm.
            // Let's get all and filter for now.
            const allLocalSubmissions = await localDB.getAll('submissions');
            const localSubmissions = allLocalSubmissions.filter(s => s.farmId === farmId);
            if (localSubmissions.length > 0) {
                console.log(`Submissions for farm ${farmId} loaded from IndexedDB`);
                renderSubmissionsList(localSubmissions);
            }

            if (navigator.onLine) {
                const submissionsCollection = collection(db, 'users', currentUser.uid, 'farmLots', farmId, 'submissions');
                onSnapshot(submissionsCollection, async (querySnapshot) => {
                    console.log(`Received submissions update for farm ${farmId} from Firestore.`);
                    const remoteSubmissions = [];
                    querySnapshot.forEach(doc => {
                        remoteSubmissions.push({ id: doc.id, farmId: farmId, ...doc.data() });
                    });

                    // Invalidation: delete old subs for this farm, then add new ones.
                    const tx = (await dbPromise).transaction('submissions', 'readwrite');
                    const allSubs = await tx.store.getAll();
                    for (const sub of allSubs) {
                        if (sub.farmId === farmId) {
                            await tx.store.delete(sub.id);
                        }
                    }
                    for (const sub of remoteSubmissions) {
                        await tx.store.put(sub);
                    }
                    await tx.done;

                    console.log(`Updated local submissions for farm ${farmId}`);
                    const allUpdatedSubmissions = await localDB.getAll('submissions');
                    const updatedSubmissions = allUpdatedSubmissions.filter(s => s.farmId === farmId);
                    renderSubmissionsList(updatedSubmissions);

                }, (error) => {
                    console.error("Error with submissions snapshot:", error);
                     if (localSubmissions.length === 0) {
                        renderSubmissionsList([]);
                    }
                });
            } else if (localSubmissions.length === 0) {
                renderSubmissionsList([]);
            }
        }

        function renderSubmissionsList(submissions) {
            const dashboardMain = document.getElementById('dashboard-main');
            dashboardMain.innerHTML = ''; // Clear existing content

            if (!submissions || submissions.length === 0) {
                dashboardMain.innerHTML = `
                    <div class="text-center text-gray-500 mt-20">
                        <i data-lucide="clipboard-list" class="w-12 h-12 mx-auto text-gray-400"></i>
                        <p class="mt-4">No scouting reports found for this farm.</p>
                        <p>Click 'New Report' to add one.</p>
                    </div>`;
            } else {
                submissions.forEach(submission => {
                    const submissionId = submission.id;
                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-xl mb-4 shadow-sm border border-gray-200';

                    // Handle both Firestore timestamps and locally generated dates
                    const submissionDate = submission.timestamp?.toDate ? submission.timestamp.toDate() : new Date(submission.timestamp);
                    const dateString = submissionDate.toLocaleDateString();
                    const timeString = submissionDate.toLocaleTimeString();

                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex">
                                <img src="${submission.imageDataUrl || 'https://placehold.co/96x96/e2e8f0/334155?text=No+Image'}" class="w-24 h-24 rounded-md mr-4 object-cover">
                                <div>
                                    <p class="font-bold">Report from ${dateString} at ${timeString}</p>
                                    <p class="text-sm"><strong>Symptoms:</strong> ${submission.symptoms.join(', ')}</p>
                                    <p class="text-sm"><strong>Distribution:</strong> ${submission.distribution}</p>
                                    <p class="text-sm"><strong>Severity:</strong> ${submission.severity}</p>
                                </div>
                            </div>
                            <div>
                                <button class="edit-submission-btn bg-blue-500 text-white text-xs font-bold py-1 px-2 rounded" data-id="${submissionId}">Edit</button>
                            </div>
                        </div>
                    `;
                    dashboardMain.appendChild(card);
                });
            }
            lucide.createIcons();
        }

        async function loadFarms() {
            if (!currentUser) return;

            // --- Offline First Farm Loading ---
            const localDB = await dbPromise;
            const localFarms = await localDB.getAll('farm-lots');
            if (localFarms.length > 0) {
                console.log("Farms loaded from IndexedDB");
                renderFarmList(localFarms);
            }

            if (navigator.onLine) {
                const farmLotsCollection = collection(db, 'users', currentUser.uid, 'farmLots');
                onSnapshot(farmLotsCollection, async (querySnapshot) => {
                    console.log("Received farm list update from Firestore.");
                    const remoteFarms = [];
                    querySnapshot.forEach((doc) => {
                        remoteFarms.push({ id: doc.id, ...doc.data() });
                    });

                    // Simple cache invalidation: clear and re-populate
                    const tx = (await dbPromise).transaction('farm-lots', 'readwrite');
                    await tx.store.clear();
                    for (const farm of remoteFarms) {
                        await tx.store.put(farm);
                    }
                    await tx.done;

                    console.log("Updated local farm list from Firestore");
                    const updatedLocalFarms = await localDB.getAll('farm-lots');
                    renderFarmList(updatedLocalFarms);

                }, (error) => {
                    console.error("Error with farm list snapshot:", error);
                    if (localFarms.length === 0) {
                        renderFarmList([]); // Render empty state if firestore fails and we have no local data
                    }
                });
            } else if (localFarms.length === 0) {
                // Offline and no local data
                renderFarmList([]);
            }
        }

        function renderFarmList(farms) {
            const farmListContainer = document.getElementById('farm-list-container');
            farmListContainer.innerHTML = ''; // Clear existing list

            if (!farms || farms.length === 0) {
                farmListContainer.innerHTML = `
                    <div class="text-center text-gray-500 mt-20">
                        <i data-lucide="map-pin" class="w-12 h-12 mx-auto text-gray-400"></i>
                        <p class="mt-4">No farm plots found.</p>
                        <p>Click the '+' button to add your first plot and map its location.</p>
                    </div>`;
            } else {
                farms.forEach((farm) => {
                    const farmId = farm.id;
                    const farmCard = document.createElement('div');
                    farmCard.className = 'bg-white p-4 rounded-xl mb-4 shadow-sm border border-gray-200 cursor-pointer hover:shadow-md';
                    farmCard.setAttribute('data-id', farmId);

                    const plantingDate = farm.plantingDate ? new Date(farm.plantingDate).toLocaleDateString() : 'N/A';

                    farmCard.innerHTML = `
                        <p class="text-xl font-bold text-gray-800">${farm.farmName}</p>
                        <p class="text-md text-gray-600">Variety: ${farm.tobaccoVariety || 'N/A'}</p>
                        <p class="text-sm text-gray-500">Planted on: ${plantingDate}</p>
                    `;

                    farmCard.addEventListener('click', () => {
                        currentFarmId = farmId;
                        document.getElementById('dashboard-farm-name').textContent = farm.farmName;
                        document.getElementById('dashboard-farm-variety').textContent = farm.tobaccoVariety || 'N/A';
                        loadSubmissions(currentFarmId);
                        showScreen('dashboard');
                    });

                    farmListContainer.appendChild(farmCard);
                });
            }
            lucide.createIcons();
        }
        
        async function syncOutbox() {
            if (!navigator.onLine || !currentUser) return;

            const localDB = await dbPromise;
            const outboxItems = await localDB.getAll('outbox');
            if (outboxItems.length === 0) {
                console.log("Outbox is empty. Nothing to sync.");
                return;
            }

            console.log(`Syncing ${outboxItems.length} item(s) from the outbox...`);
            const connectionStatusEl = document.getElementById('connection-status');
            connectionStatusEl.textContent = `Syncing ${outboxItems.length} item(s)...`;
            connectionStatusEl.className = 'text-center py-1 text-sm font-semibold bg-yellow-100 text-yellow-800';

            for (const item of outboxItems) {
                try {
                    let { payload } = item;
                    // Remove local-only flags before sending to server
                    if (payload.isLocal) delete payload.isLocal;

                    if (item.type === 'SAVE_PROFILE') {
                        payload.updatedAt = serverTimestamp();
                        const userDocRef = doc(db, "users", currentUser.uid);
                        await setDoc(userDocRef, payload, { merge: true });
                    } else if (item.type === 'CREATE_FARM') {
                        const localId = payload.id;
                        payload.createdAt = serverTimestamp();
                        // Remove the temporary local ID from the payload
                        delete payload.id;
                        const farmLotsCollection = collection(db, 'users', currentUser.uid, 'farmLots');
                        const newDocRef = await addDoc(farmLotsCollection, payload);
                        // **Critical Step:** Update local data with the real Firestore ID
                        const dbTx = await localDB.transaction(['farm-lots', 'submissions'], 'readwrite');
                        await dbTx.objectStore('farm-lots').delete(localId);
                        payload.id = newDocRef.id;
                        await dbTx.objectStore('farm-lots').put(payload);
                        // Also update any submissions that were associated with the local farm ID
                        const submissions = await dbTx.objectStore('submissions').getAll();
                        for (const sub of submissions) {
                            if (sub.farmId === localId) {
                                sub.farmId = newDocRef.id;
                                await dbTx.objectStore('submissions').put(sub);
                            }
                        }
                        await dbTx.done;
                    } else if (item.type === 'UPDATE_FARM') {
                        payload.updatedAt = serverTimestamp();
                        const farmDocRef = doc(db, 'users', currentUser.uid, 'farmLots', payload.id);
                        await updateDoc(farmDocRef, payload);
                    } else if (item.type === 'DELETE_FARM') {
                        const farmDocRef = doc(db, 'users', currentUser.uid, 'farmLots', payload.id);
                        await deleteDoc(farmDocRef);
                    } else if (item.type === 'CREATE_SUBMISSION') {
                        payload.timestamp = serverTimestamp();
                        const localId = payload.id;
                        delete payload.id;
                        const submissionsCollection = collection(db, 'users', currentUser.uid, 'farmLots', payload.farmId, 'submissions');
                        const newDocRef = await addDoc(submissionsCollection, payload);
                        // Update local submission with real ID
                        await localDB.delete('submissions', localId);
                        payload.id = newDocRef.id;
                        await localDB.put('submissions', payload);
                    } else if (item.type === 'UPDATE_SUBMISSION') {
                         payload.timestamp = serverTimestamp();
                         const submissionDocRef = doc(db, 'users', currentUser.uid, 'farmLots', payload.farmId, 'submissions', payload.id);
                         await updateDoc(submissionDocRef, payload);
                    }

                    // If successful, remove the item from the outbox
                    await localDB.delete('outbox', item.id);
                    console.log(`Successfully synced and removed outbox item: ${item.type} (${item.id})`);

                } catch (error) {
                    console.error(`Failed to sync item ${item.id} (${item.type}):`, error);
                    connectionStatusEl.textContent = 'Sync Failed';
                    connectionStatusEl.className = 'text-center py-1 text-sm font-semibold bg-red-100 text-red-800';
                    // If one item fails, we stop to avoid potential data consistency issues.
                    // A more advanced implementation could handle retries or mark items as failed.
                    break;
                }
            }

            // After sync attempt, re-check outbox and update status
            const remainingItems = await localDB.count('outbox');
            if (remainingItems === 0) {
                 console.log("Outbox sync complete.");
                 // A full data reload might be good here to ensure consistency
                 loadFarms();
            }
            updateOnlineStatus(); // Refresh the connection status indicator
        }

        // --- 7. CONNECTION STATUS UI ---
        const connectionStatusEl = document.getElementById('connection-status');
        async function updateOnlineStatus() {
            const localDB = await dbPromise;
            const outboxCount = await localDB.count('outbox');

            if (navigator.onLine) {
                connectionStatusEl.textContent = 'Online';
                connectionStatusEl.className = 'text-center py-1 text-sm font-semibold bg-blue-100 text-blue-800';

                if (outboxCount > 0) {
                    syncOutbox(); // The only sync function we need now
                }
            } else {
                let message = 'Offline Mode';
                if (outboxCount > 0) {
                    message += ` (${outboxCount} item(s) waiting to sync)`;
                }
                connectionStatusEl.textContent = message;
                connectionStatusEl.className = 'text-center py-1 text-sm font-semibold bg-gray-200 text-gray-800';
            }
        }
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus();

    </script>
</body>
</html>
