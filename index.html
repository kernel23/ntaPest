<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agri-Guard</title>
    
    <!-- PWA Manifest commit-->
    <link rel="manifest" href="manifest.json">
    
    <!-- Theme Color for PWA -->
    <meta name="theme-color" content="#22c55e">
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Leaflet CSS for mapping -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />

    <style>
        /* Simple transition for showing/hiding screens */
        .screen { display: none; }
        .screen.active { display: flex; }
        body { font-family: 'Inter', sans-serif; } /* Using a common sans-serif font */

        /* Fixed Sidebar */
        #sidebar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            z-index: 10;
        }

        #screen-container.with-sidebar {
            margin-left: 4rem; /* ml-16 */
        }
        #map { height: 400px; }
        #report-map { height: 200px; margin-bottom: 1.5rem; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Saving Overlay -->
    <div id="saving-overlay" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center" style="z-index: 10000;">
        <div class="text-center text-white">
            <svg class="animate-spin h-10 w-10 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="saving-message" class="mt-4 text-lg">Saving...</p>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-green-600 text-white py-2 px-4 rounded-lg shadow-md opacity-0 transition-opacity duration-300" style="z-index: 10001;">
        <p id="toast-message"></p>
    </div>

    <div id="app-container" class="h-screen w-screen relative">
        <!-- Fixed Icon-Only Sidebar -->
        <aside id="sidebar" class="w-16 bg-green-800 text-white p-4 hidden flex-col items-center">
            <!-- Logo -->
            <div class="mb-10">
                 <i data-lucide="leaf" class="w-8 h-8 text-green-400"></i>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 flex flex-col items-center space-y-4">
                <a href="#" id="nav-farm-list" class="nav-item p-2 rounded-lg hover:bg-green-700" title="My Farms">
                    <i data-lucide="layout-dashboard" class="w-6 h-6"></i>
                </a>
                <a href="#" id="nav-profile" class="nav-item p-2 rounded-lg hover:bg-green-700" title="Profile">
                    <i data-lucide="user" class="w-6 h-6"></i>
                </a>
                <a href="#" id="nav-reports" class="nav-item p-2 rounded-lg hover:bg-green-700" title="Reports">
                    <i data-lucide="file-text" class="w-6 h-6"></i>
                </a>
                <a href="#" id="nav-diagnosis" class="nav-item p-2 rounded-lg hover:bg-green-700" title="Diagnosis">
                    <i data-lucide="stethoscope" class="w-6 h-6"></i>
                </a>
                <a href="#" id="nav-treatment" class="nav-item p-2 rounded-lg hover:bg-green-700" title="Final Diagnosis">
                    <i data-lucide="syringe" class="w-6 h-6"></i>
                </a>
                <a href="#" id="nav-clinic" class="nav-item p-2 rounded-lg hover:bg-green-700" title="Online Clinic">
                    <i data-lucide="message-square" class="w-6 h-6"></i>
                </a>
            </nav>

            <!-- Logout Button -->
            <div class="mt-auto">
                <button id="sidebar-logout-btn" class="nav-item p-2 rounded-lg hover:bg-red-700" title="Logout">
                    <i data-lucide="log-out" class="w-6 h-6"></i>
                </button>
            </div>
        </aside>

        <!-- Main content area that holds all screens -->
        <div id="screen-container" class="h-screen overflow-y-auto">
            <!-- Loading Screen -->
            <div id="loading-screen" class="screen active flex-col justify-center items-center h-full bg-green-50 text-gray-800">
                <svg class="animate-spin h-10 w-10 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-lg text-green-700">Loading Agri-Guard...</p>
            </div>

            <!-- Login Screen -->
            <div id="login-screen" class="screen flex-col justify-center items-center h-full p-6 bg-green-50 text-gray-800">
                <div class="text-center mb-10">
                    <i data-lucide="leaf" class="w-16 h-16 text-green-600 mx-auto"></i>
                    <h1 class="text-4xl font-bold text-green-900 mt-4">Agri-Guard</h1>
                    <p class="text-lg text-green-700">Tobacco Pest Monitoring</p>
                    <p class="text-sm text-gray-500 mt-1">Ilocos Region, Philippines</p>
                </div>
                <div class="w-full max-w-sm">
                    <button id="google-signin-btn" class="w-full bg-white text-gray-700 font-semibold py-3 px-4 border border-gray-300 rounded-lg shadow-sm flex items-center justify-center mb-3">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" alt="Google" class="mr-3"> <!-- Placeholder for Google Icon -->
                        Sign in with Google
                    </button>
                    <button id="facebook-signin-btn" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg shadow-sm flex items-center justify-center mb-4">
                         <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z" clip-rule="evenodd" /></svg>
                        Sign in with Facebook
                    </button>
                    <button id="guest-signin-btn" class="w-full text-gray-600 py-2">Continue as Guest</button>
                </div>
                <div class="mt-4 text-center text-xs text-gray-500">
                    By signing in, you agree to our <a href="#" id="privacy-policy-link" class="underline hover:text-green-700">Privacy Policy</a>. All personal data is encrypted in transit.
                </div>
            </div>

            <!-- Privacy Policy Screen -->
            <div id="privacy-policy-screen" class="screen flex-col h-full bg-green-50 text-gray-800">
                <header class="bg-white p-4 shadow-md flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Privacy Policy</h2>
                    <button id="close-privacy-policy-btn" class="p-2 rounded-full hover:bg-gray-100">
                        <i data-lucide="x" class="w-6 h-6 text-gray-600"></i>
                    </button>
                </header>
                <main class="flex-1 p-6 overflow-y-auto">
                    <p class="mb-4"><strong>Last updated: August 11, 2025</strong></p>
                    <p class="mb-4">This Privacy Policy describes Our policies and procedures on the collection, use and disclosure of Your information when You use the Service and tells You about Your privacy rights and how the law protects You.</p>
                    <h3 class="text-lg font-bold mt-6 mb-2">Interpretation and Definitions</h3>
                    <p class="mb-4">The words of which the initial letter is capitalized have meanings defined under the following conditions. The following definitions shall have the same meaning regardless of whether they appear in singular or in plural.</p>
                    <h3 class="text-lg font-bold mt-6 mb-2">Collecting and Using Your Personal Data</h3>
                    <p class="mb-4">While using Our Service, We may ask You to provide Us with certain personally identifiable information that can be used to contact or identify You. Personally identifiable information may include, but is not limited to: Email address, First name and last name, Phone number, Address, State, Province, ZIP/Postal code, City, Usage Data.</p>
                    <h3 class="text-lg font-bold mt-6 mb-2">Data Encryption</h3>
                    <p class="mb-4">We are committed to ensuring that your information is secure. To prevent unauthorized access or disclosure, we have put in place suitable physical, electronic and managerial procedures to safeguard and secure the information we collect online. All personal data is encrypted in transit between your device and our servers using Secure Socket Layer (SSL) technology.</p>
                    <h3 class="text-lg font-bold mt-6 mb-2">Contact Us</h3>
                    <p>If you have any questions about this Privacy Policy, You can contact us by email: privacy@agri-guard.com</p>
                </main>
            </div>

            <!-- Create Profile Screen -->
            <div id="profile-screen" class="screen flex-col h-full bg-green-50 text-gray-800">
                <header class="bg-white p-4 shadow-md">
                    <h2 id="profile-title" class="text-2xl font-bold">Your Profile</h2>
                </header>
                <main class="flex-1 p-6 overflow-y-auto">
                    <div class="text-center mb-6">
                        <img id="profile-pic" src="https://placehold.co/96x96/e2e8f0/334155?text=User" class="w-24 h-24 rounded-full mx-auto mb-4">
                    </div>
                    <label for="fullName" class="block text-sm font-medium text-gray-700">Full Name</label>
                    <input type="text" id="fullName" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">

                    <label for="province" class="block text-sm font-medium text-gray-700 mt-4">Province</label>
                    <select id="province" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        <option>Loading provinces...</option>
                    </select>

                    <label for="municipality" class="block text-sm font-medium text-gray-700 mt-4">Municipality</label>
                    <select id="municipality" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" disabled></select>

                    <label for="barangay" class="block text-sm font-medium text-gray-700 mt-4">Barangay</label>
                    <select id="barangay" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" disabled></select>

                    <label for="birthdate" class="block text-sm font-medium text-gray-700 mt-4">Birthdate</label>
                    <input type="date" id="birthdate" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    <label for="civilStatus" class="block text-sm font-medium text-gray-700 mt-4">Civil Status</label>
                    <select id="civilStatus" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        <option>Single</option>
                        <option>Married</option>
                        <option>Widowed</option>
                        <option>Divorced</option>
                    </select>
                    <label for="religion" class="block text-sm font-medium text-gray-700 mt-4">Religion</label>
                    <input type="text" id="religion" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    <label for="yearsFarming" class="block text-sm font-medium text-gray-700 mt-4">Years in Tobacco Farming</label>
                    <input type="number" id="yearsFarming" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    <label for="familyMembers" class="block text-sm font-medium text-gray-700 mt-4">Number of Family Members</label>
                    <input type="number" id="familyMembers" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    <label for="education" class="block text-sm font-medium text-gray-700 mt-4">Highest Educational Attainment</label>
                    <select id="education" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        <option>No formal education</option>
                        <option>Elementary</option>
                        <option>High School</option>
                        <option>Vocational</option>
                        <option>College</option>
                        <option>Post-graduate</option>
                    </select>
                    <div class="mt-4">
                        <label for="isFarmer" class="flex items-center">
                            <input type="checkbox" id="isFarmer" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                            <span class="ml-2 text-sm font-medium text-gray-700">I am a farmer</span>
                        </label>
                    </div>
                    <div id="rsbsa-container" class="hidden mt-4">
                        <label for="rsbsaNumber" class="block text-sm font-medium text-gray-700">RSBSA Number (Optional)</label>
                        <input type="text" id="rsbsaNumber" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    </div>
                    <p class="mt-6 mb-2 font-medium text-gray-700">Select Your Role:</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button id="role-farmer-btn" class="role-btn p-4 rounded-lg border-2 border-green-600 bg-green-600 text-white">Farmer</button>
                        <button id="role-worker-btn" class="role-btn p-4 rounded-lg border-2 border-gray-300">Extension Worker</button>
                        <button id="role-coordinator-btn" class="role-btn p-4 rounded-lg border-2 border-gray-300">Branch Coordinator</button>
                    </div>
                    <div class="mt-8 space-y-4">
                        <button id="edit-profile-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hidden">Edit Profile</button>
                        <button id="save-profile-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md">Save and Continue</button>
                        <button id="cancel-edit-btn" class="w-full bg-gray-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hidden">Cancel</button>
                    </div>
                </main>
            </div>

            <!-- Farm List Screen (Home) -->
            <div id="farm-list-screen" class="screen flex-col h-full bg-green-50 text-gray-800">
                <header class="bg-white p-4 shadow-md">
                    <div class="header-nav-container flex items-center mb-2">
                        <button class="back-button p-2 rounded-full hover:bg-gray-100 mr-2 hidden">
                            <i data-lucide="arrow-left" class="w-6 h-6 text-gray-600"></i>
                        </button>
                        <div class="breadcrumbs text-sm text-gray-500"></div>
                    </div>
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold">My Farm Plots</h2>
                            <p id="welcome-message" class="text-sm text-gray-600"></p>
                        </div>
                        <div id="connection-status" class="text-center py-1 px-3 rounded-full text-sm font-semibold"></div>
                    </div>
                </header>
                <main id="farm-list-container" class="flex-1 p-4 overflow-y-auto">
                    <!-- Farm cards will be inserted here by JavaScript -->
                    <div id="no-farms-message" class="text-center text-gray-500 mt-20">
                        <i data-lucide="map-pin" class="w-12 h-12 mx-auto text-gray-400"></i>
                        <p class="mt-4">No farm plots found.</p>
                        <p>Add your first plot to start monitoring.</p>
                    </div>
                </main>
                <button id="add-farm-btn" class="absolute bottom-6 right-6 bg-green-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center">
                    <i data-lucide="plus" class="w-8 h-8"></i>
                </button>
            </div>

            <!-- Extension Worker Dashboard Screen -->
            <div id="ew-dashboard-screen" class="screen flex-col h-full bg-green-50 text-gray-800">
                <header class="bg-white p-4 shadow-md">
                    <div class="header-nav-container flex items-center mb-2">
                        <button class="back-button p-2 rounded-full hover:bg-gray-100 mr-2 hidden">
                            <i data-lucide="arrow-left" class="w-6 h-6 text-gray-600"></i>
                        </button>
                        <div class="breadcrumbs text-sm text-gray-500"></div>
                    </div>
                    <h2 class="text-2xl font-bold">Extension Worker Dashboard</h2>
                    <p id="ew-welcome-message" class="text-sm text-gray-600"></p>
                </header>
                <main id="ew-dashboard-container" class="flex-1 p-4 overflow-y-auto">
                    <!-- Farmer list table will be inserted here -->
                    <div class="text-center text-gray-500 mt-20">
                        <i data-lucide="users" class="w-12 h-12 mx-auto text-gray-400"></i>
                        <p class="mt-4">Loading assigned farmers...</p>
                    </div>
                </main>
            </div>

            <!-- Coordinator Dashboard Screen -->
            <div id="coordinator-dashboard-screen" class="screen flex-col h-full bg-green-50 text-gray-800">
                <header class="bg-white p-4 shadow-md">
                    <div class="header-nav-container flex items-center mb-2">
                        <button class="back-button p-2 rounded-full hover:bg-gray-100 mr-2 hidden">
                            <i data-lucide="arrow-left" class="w-6 h-6 text-gray-600"></i>
                        </button>
                        <div class="breadcrumbs text-sm text-gray-500"></div>
                    </div>
                    <h2 class="text-2xl font-bold">Coordinator Dashboard</h2>
                    <p id="coordinator-welcome-message" class="text-sm text-gray-600"></p>
                </header>
                <main id="coordinator-dashboard-container" class="flex-1 p-4 overflow-y-auto">
                    <!-- Extension Worker list table will be inserted here -->
                     <div class="text-center text-gray-500 mt-20">
                        <i data-lucide="briefcase" class="w-12 h-12 mx-auto text-gray-400"></i>
                        <p class="mt-4">Loading extension workers...</p>
                    </div>
                </main>
            </div>

            <!-- Dashboard Screen -->
            <div id="dashboard-screen" class="screen flex-col h-full bg-green-50 text-gray-800">
                <header class="bg-white p-4 shadow-md">
                    <div class="header-nav-container flex items-center mb-2">
                        <button class="back-button p-2 rounded-full hover:bg-gray-100 mr-2 hidden">
                            <i data-lucide="arrow-left" class="w-6 h-6 text-gray-600"></i>
                        </button>
                        <div class="breadcrumbs text-sm text-gray-500"></div>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            <h2 id="dashboard-farm-name" class="text-2xl font-bold">Farm Health Log</h2>
                            <p id="dashboard-farm-variety" class="text-sm text-gray-600 ml-4"></p>
                        </div>
                        <div>
                            <button id="edit-farm-details-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Edit Details</button>
                            <button id="delete-farm-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md ml-2">Delete Farm</button>
                            <button id="new-submission-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md ml-2">New Report</button>
                        </div>
                    </div>
                </header>
                <main id="dashboard-main" class="flex-1 p-4 overflow-y-auto">
                    <div class="text-center text-gray-500 mt-20">
                        <i data-lucide="clipboard-list" class="w-12 h-12 mx-auto text-gray-400"></i>
                        <p class="mt-4">Submission history will appear here.</p>
                    </div>
                </main>
            </div>

            <!-- New Submission Screen -->
            <div id="new-submission-screen" class="screen flex-col h-full bg-green-50 text-gray-800">
                <header class="bg-white p-4 shadow-md">
                    <div class="header-nav-container flex items-center mb-2">
                        <button class="back-button p-2 rounded-full hover:bg-gray-100 mr-2 hidden">
                            <i data-lucide="arrow-left" class="w-6 h-6 text-gray-600"></i>
                        </button>
                        <div class="breadcrumbs text-sm text-gray-500"></div>
                    </div>
                    <h2 class="text-2xl font-bold">New Scouting Report</h2>
                </header>
                <main class="flex-1 p-6 overflow-y-auto">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Farm Location</label>
                    <div id="report-map" class="w-full h-48 bg-gray-200 rounded-md shadow-inner"></div>

                    <label class="block text-sm font-medium text-gray-700 mb-2">Upload Image of Affected Plant</label>
                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                        <div class="space-y-1 text-center">
                            <i id="image-placeholder-icon" data-lucide="image" class="mx-auto h-12 w-12 text-gray-400"></i>
                            <img id="submission-image-preview" src="" class="hidden mx-auto max-h-48 rounded-md">
                            <div class="flex text-sm text-gray-600">
                                <label for="image-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-green-600 hover:text-green-500 focus-within:outline-none">
                                    <span>Upload a file</span>
                                    <input id="image-upload" name="image-upload" type="file" class="sr-only" accept="image/*">
                                </label>
                                <p class="pl-1">or drag and drop</p>
                            </div>
                            <p class="text-xs text-gray-500">PNG, JPG, GIF up to 10MB</p>
                             <div class="mt-4">
                                <button id="open-camera-btn" type="button" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                    <i data-lucide="camera" class="mr-2 h-5 w-5"></i>
                                    Capture with Camera
                                </button>
                            </div>
                        </div>
                    </div>

                    <fieldset id="symptoms-checklist" class="mt-6">
                        <legend class="text-base font-medium text-gray-900">Observed Symptoms</legend>
                        <div class="mt-4 grid grid-cols-2 gap-4">
                            <div class="flex items-start"><div class="flex items-center h-5"><input id="symptom-spots" value="spots" type="checkbox" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="symptom-spots" class="font-medium text-gray-700">Leaf Spots</label></div></div>
                            <div class="flex items-start"><div class="flex items-center h-5"><input id="symptom-wilting" value="wilting" type="checkbox" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="symptom-wilting" class="font-medium text-gray-700">Wilting</label></div></div>
                            <div class="flex items-start"><div class="flex items-center h-5"><input id="symptom-yellowing" value="yellowing" type="checkbox" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="symptom-yellowing" class="font-medium text-gray-700">Yellowing</label></div></div>
                        </div>
                    </fieldset>

                    <fieldset id="distribution-radios" class="mt-6">
                        <legend class="text-base font-medium text-gray-900">Pest/Disease Distribution</legend>
                        <div class="mt-4 space-y-4">
                            <div class="flex items-center"><input id="dist-isolated" name="distribution" value="isolated" type="radio" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300"><label for="dist-isolated" class="ml-3 block text-sm font-medium text-gray-700">Isolated Plants</label></div>
                            <div class="flex items-center"><input id="dist-patches" name="distribution" value="patches" type="radio" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300"><label for="dist-patches" class="ml-3 block text-sm font-medium text-gray-700">In Patches</label></div>
                        </div>
                    </fieldset>

                    <fieldset id="severity-radios" class="mt-6">
                        <legend class="text-base font-medium text-gray-900">Severity</legend>
                        <div class="mt-4 space-y-4">
                            <div class="flex items-center"><input id="sev-low" name="severity" value="low" type="radio" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300"><label for="sev-low" class="ml-3 block text-sm font-medium text-gray-700">Low</label></div>
                            <div class="flex items-center"><input id="sev-medium" name="severity" value="medium" type="radio" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300"><label for="sev-medium" class="ml-3 block text-sm font-medium text-gray-700">Medium</label></div>
                            <div class="flex items-center"><input id="sev-high" name="severity" value="high" type="radio" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300"><label for="sev-high" class="ml-3 block text-sm font-medium text-gray-700">High</label></div>
                        </div>
                    </fieldset>
                    
                    <button id="save-submission-btn" class="mt-8 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md">Save Submission</button>
                </main>
            </div>

            <!-- Camera Screen -->
            <div id="camera-screen" class="screen flex-col h-screen bg-black text-white">
                <header class="bg-gray-900 p-4 flex justify-between items-center z-20">
                    <button id="back-to-submission-btn" class="p-2 rounded-full hover:bg-gray-700">
                        <i data-lucide="arrow-left" class="w-6 h-6"></i>
                    </button>
                    <h2 class="text-xl font-bold">Capture Media</h2>
                    <div class="w-10"></div> <!-- Spacer -->
                </header>
                <main class="flex-1 relative flex justify-center items-center">
                    <video id="camera-feed" class="w-full h-full object-cover" autoplay playsinline></video>
                    <div id="camera-overlay" class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <div class="w-11/12 h-2/3 border-4 border-dashed border-white rounded-lg" style="border-color: rgba(255, 255, 255, 0.7);">
                            <p class="text-white text-center mt-4">Place affected leaf inside this box</p>
                        </div>
                    </div>
                    <canvas id="photo-canvas" class="hidden"></canvas>
                </main>
                <footer class="bg-gray-900 p-4 flex justify-around items-center z-20">
                    <button id="capture-photo-btn" class="p-4 bg-white rounded-full focus:outline-none">
                        <i data-lucide="camera" class="w-8 h-8 text-gray-900"></i>
                    </button>
                    <button id="record-video-btn" class="p-4 bg-red-600 rounded-full focus:outline-none">
                        <i data-lucide="video" class="w-8 h-8 text-white"></i>
                    </button>
                </footer>
            </div>

            <!-- Reports Screen -->
            <div id="reports-screen" class="screen flex-col h-full bg-green-50 text-gray-800">
                <header class="bg-white p-4 shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">All Pest & Disease Reports</h2>
                    </div>
                    <div id="report-filters" class="flex space-x-2">
                        <button data-filter="all" class="report-filter-btn bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">All</button>
                        <button data-filter="pending" class="report-filter-btn bg-gray-200 text-gray-800 px-4 py-2 rounded-lg text-sm font-semibold">Pending Diagnosis</button>
                        <button data-filter="diagnosed" class="report-filter-btn bg-gray-200 text-gray-800 px-4 py-2 rounded-lg text-sm font-semibold">Diagnosed</button>
                        <button data-filter="treated" class="report-filter-btn bg-gray-200 text-gray-800 px-4 py-2 rounded-lg text-sm font-semibold">Treatment Provided</button>
                    </div>
                </header>
                <main id="reports-container" class="flex-1 p-4 overflow-y-auto">
                    <!-- Report cards will be inserted here by JavaScript -->
                </main>
            </div>

            <!-- Diagnosis Screen -->
            <div id="diagnosis-screen" class="screen flex-col h-full bg-green-50 text-gray-800">
                <header class="bg-white p-4 shadow-md">
                    <h2 class="text-2xl font-bold">Reports for Diagnosis</h2>
                </header>
                <main id="diagnosis-reports-container" class="flex-1 p-4 overflow-y-auto">
                    <!-- Reports awaiting diagnosis will be loaded here by JavaScript -->
                    <div class="text-center text-gray-500 mt-20">
                        <i data-lucide="loader" class="w-12 h-12 mx-auto text-gray-400 animate-spin"></i>
                        <p class="mt-4">Loading reports...</p>
                    </div>
                </main>
            </div>

            <!-- Treatment Screen -->
            <div id="treatment-screen" class="screen flex-col h-full bg-green-50 text-gray-800">
                <header class="bg-white p-4 shadow-md">
                    <h2 class="text-2xl font-bold">Reports for Final Diagnosis & Treatment</h2>
                </header>
                <main id="treatment-reports-container" class="flex-1 p-4 overflow-y-auto">
                    <!-- Diagnosed reports will be loaded here by JavaScript -->
                    <div class="text-center text-gray-500 mt-20">
                        <i data-lucide="loader" class="w-12 h-12 mx-auto text-gray-400 animate-spin"></i>
                        <p class="mt-4">Loading reports...</p>
                    </div>
                </main>
            </div>

            <!-- Online Clinic Screen -->
            <div id="online-clinic-screen" class="screen flex-col h-full bg-green-50 text-gray-800">
                <header class="bg-white p-4 shadow-md">
                    <h2 class="text-2xl font-bold">Online Clinic</h2>
                </header>
                <main class="flex-1 p-4">
                    <p>Expert consultation features will be available here.</p>
                </main>
            </div>

            <!-- Farm Setup Screen -->
            <div id="farm-setup-screen" class="screen flex-col h-full bg-green-50 text-gray-800">
                <header class="bg-white p-4 shadow-md">
                    <h2 class="text-2xl font-bold">Map Your Farm Plot</h2>
                </header>
                <main class="flex-1 p-6">
                    <p class="mb-4 text-gray-700">Please use the drawing tool on the map to outline the boundary of your farm plot. You can pan and zoom to find your location.</p>
                    <div id="map" class="w-full h-96 bg-gray-200 rounded-md shadow-inner"></div>
                    <div class="mt-6 text-right">
                        <button id="cancel-farm-setup-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md mr-2">Cancel</button>
                        <button id="save-farm-map-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md" disabled>Save Farm Area</button>
                    </div>
                </main>
            </div>

        </div>
    </div>

    <!-- Modals -->
    <!-- Diagnosis Modal -->
    <div id="diagnosis-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg m-4">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Diagnose Report</h3>
                <button id="close-diagnosis-modal-btn" class="p-1"><i data-lucide="x"></i></button>
            </div>
            <div class="p-6 max-h-[80vh] overflow-y-auto">
                <div id="diagnosis-report-details" class="mb-4">
                    <!-- Report details will be loaded here -->
                </div>
                <h4 class="text-lg font-bold mt-4 mb-2">Add Diagnosis</h4>
                <label for="pest-disease-select" class="block text-sm font-medium text-gray-700">Identified Pest/Disease</label>
                <select id="pest-disease-select" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    <option value="">Select a pest or disease...</option>
                </select>
                <div id="pest-disease-info" class="mt-4 p-3 bg-gray-50 rounded-lg border border-gray-200 text-sm hidden">
                    <!-- Pest/disease info will be displayed here -->
                </div>
                <label for="diagnosis-notes" class="block text-sm font-medium text-gray-700 mt-4">Diagnosis Notes</label>
                <textarea id="diagnosis-notes" rows="4" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm"></textarea>
                <button id="save-diagnosis-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md mt-6">Save Diagnosis</button>
            </div>
        </div>
    </div>

    <!-- Treatment Modal -->
    <div id="treatment-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg m-4">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Final Diagnosis & Treatment Plan</h3>
                <button id="close-treatment-modal-btn" class="p-1"><i data-lucide="x"></i></button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[80vh]">
                <div id="treatment-report-details" class="mb-4">
                    <!-- Report and diagnosis details will be loaded here -->
                </div>

                <h4 class="text-lg font-bold mt-4 mb-2">Final Diagnosis</h4>
                <label for="final-pest-disease-select" class="block text-sm font-medium text-gray-700">Identified Pest/Disease</label>
                 <select id="final-pest-disease-select" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    <option value="">Select a pest or disease...</option>
                </select>
                <div id="final-pest-disease-info" class="mt-4 p-3 bg-gray-50 rounded-lg border border-gray-200 text-sm hidden">
                    <!-- Final pest/disease info will be displayed here -->
                </div>
                <label for="final-diagnosis-notes" class="block text-sm font-medium text-gray-700 mt-4">Final Diagnosis Notes</label>
                <textarea id="final-diagnosis-notes" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm"></textarea>

                <h4 class="text-lg font-bold mt-6 mb-2">Add Treatment Plan</h4>

                <div id="treatment-plan-container" class="mt-4 space-y-4">
                    <div>
                        <label class="text-base font-medium text-gray-900">Prevention</label>
                        <div id="treatment-prevention-list" class="mt-2 space-y-2 text-sm">
                            <!-- Prevention checkboxes will be inserted here -->
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="text-base font-medium text-gray-900">Monitoring</label>
                        <div id="treatment-monitoring-list" class="mt-2 space-y-2 text-sm">
                            <!-- Monitoring checkboxes will be inserted here -->
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="text-base font-medium text-gray-900">Direct Control</label>
                        <div id="treatment-control-list" class="mt-2 space-y-2 text-sm">
                            <!-- Control checkboxes will be inserted here -->
                        </div>
                    </div>
                </div>


                <label for="treatment-instructions" class="block text-sm font-medium text-gray-700 mt-4">Specific Instructions</label>
                <textarea id="treatment-instructions" rows="4" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm"></textarea>

                <label for="follow-up-date" class="block text-sm font-medium text-gray-700 mt-4">Follow-up Date</label>
                <input type="date" id="follow-up-date" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">

                <button id="save-treatment-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md mt-6">Save Treatment Plan</button>
            </div>
        </div>
    </div>

    <div id="farm-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-40">
         <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Add New Farm Plot</h3>
                <button id="close-farm-modal-btn" class="p-1"><i data-lucide="x"></i></button>
            </div>
            <div class="p-6">
                <label for="farmName" class="block text-sm font-medium text-gray-700">Plot Name</label>
                <input type="text" id="farmName" placeholder="e.g., North Field" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                <label for="tobaccoVariety" class="block text-sm font-medium text-gray-700 mt-4">Tobacco Variety</label>
                <input type="text" id="tobaccoVariety" placeholder="e.g., Virginia" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                <label for="plantingDate" class="block text-sm font-medium text-gray-700 mt-4">Date of Planting</label>
                <input type="date" id="plantingDate" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                <button id="next-farm-map-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md mt-6">Next: Set Location</button>
            </div>
        </div>
    </div>

    <!-- Address Data -->
    <script src="address-provider.js"></script>

    <!-- Leaflet JS for mapping -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the IDB library for offline storage
        import { openDB } from 'https://cdn.jsdelivr.net/npm/idb@8/+esm';

        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            FacebookAuthProvider,
            signInWithPopup,
            signInAnonymously,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            collection,
            addDoc,
            onSnapshot,
            serverTimestamp,
            getDocs,
            query,
            where,
            orderBy,
            limit
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- 1. FIREBASE CONFIGURATION ---
        // IMPORTANT: Replace with your project's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB3yPx1dWJQwqn-SglOjGzrQ6BAZFngMDc",
            authDomain: "pest-monitoring-app-ph.firebaseapp.com",
            projectId: "pest-monitoring-app-ph",
            storageBucket: "pest-monitoring-app-ph.appspot.com",
            messagingSenderId: "948653534237",
            appId: "1:948653534237:web:dc195109343b4d5a12eaf4",
            measurementId: "G-YRFNHDN5VV"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 2. PWA & OFFLINE SETUP ---
        let pestAndDiseaseData = {}; // Global variable to hold the data

        window.pestDiseaseDataPromise = (async function() {
            try {
                const response = await fetch('pestDiseases.json');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                pestAndDiseaseData = await response.json();
                console.log('Pest and disease data loaded successfully.');
                return true;
            } catch (error) {
                console.error('Failed to load pest and disease data:', error);
                pestAndDiseaseData = null;
                return false;
            }
        })();

        // Initialize IndexedDB
        const dbPromise = openDB('agri-guard-db', 2, {
            upgrade(db, oldVersion, newVersion, transaction) {
                if (oldVersion < 1) {
                    db.createObjectStore('outbox', { autoIncrement: true });
                }
                if (oldVersion < 2) {
                    db.createObjectStore('submission_outbox', { autoIncrement: true });
                }
            },
        });
        console.log('IndexedDB setup initiated.');

        // Register the service worker for offline capabilities
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('ServiceWorker registration successful with scope: ', registration.scope))
                    .catch(err => console.log('ServiceWorker registration failed: ', err));
            });
        }
        
        // --- 3. UI & STATE MANAGEMENT ---
        let activeListeners = [];
        function detachAllListeners() {
            console.log(`Detaching ${activeListeners.length} active listeners.`);
            activeListeners.forEach(unsubscribe => unsubscribe());
            activeListeners = [];
        }

        const screens = {
            loading: document.getElementById('loading-screen'),
            login: document.getElementById('login-screen'),
            profile: document.getElementById('profile-screen'),
            farmList: document.getElementById('farm-list-screen'),
            dashboard: document.getElementById('dashboard-screen'),
            newSubmission: document.getElementById('new-submission-screen'),
            camera: document.getElementById('camera-screen'),
            reports: document.getElementById('reports-screen'),
            diagnosis: document.getElementById('diagnosis-screen'),
            treatment: document.getElementById('treatment-screen'),
            onlineClinic: document.getElementById('online-clinic-screen'),
            privacyPolicy: document.getElementById('privacy-policy-screen'),
            farmSetup: document.getElementById('farm-setup-screen'),
            ewDashboard: document.getElementById('ew-dashboard-screen'),
            coordinatorDashboard: document.getElementById('coordinator-dashboard-screen')
        };

        // --- Privacy Policy Navigation ---
        document.getElementById('privacy-policy-link').addEventListener('click', (e) => {
            e.preventDefault();
            showScreen('privacyPolicy');
        });

        document.getElementById('close-privacy-policy-btn').addEventListener('click', () => {
            // This should ideally return to the previous screen.
            // For simplicity, we'll return to the login screen as the link is only there.
            showScreen('login');
        });

        // --- Camera Navigation ---
        document.getElementById('open-camera-btn').addEventListener('click', () => {
            showScreen('camera');
        });

        document.getElementById('back-to-submission-btn').addEventListener('click', () => {
            showScreen('newSubmission');
        });

        // --- Sidebar Navigation ---
        document.getElementById('nav-farm-list').addEventListener('click', () => {
            if (!userProfile) return;

            let screen;
            const context = {
                isFreshNavigation: true,
                userId: currentUser.uid,
                userName: userProfile.fullName,
                label: 'Dashboard'
            };

            if (userProfile.role === 'Extension Worker') {
                screen = 'ewDashboard';
            } else if (userProfile.role === 'Branch Coordinator') {
                screen = 'coordinatorDashboard';
            } else { // Default to Farmer
                screen = 'farmList';
            }
            showScreen(screen, context);
        });
        document.getElementById('nav-profile').addEventListener('click', () => showScreen('profile', { isFreshNavigation: true, label: 'My Profile' }));
        document.getElementById('nav-reports').addEventListener('click', () => showScreen('reports', { isFreshNavigation: true, label: 'All Reports' }));
        document.getElementById('nav-diagnosis').addEventListener('click', () => showScreen('diagnosis', { isFreshNavigation: true, label: 'For Diagnosis' }));
        document.getElementById('nav-treatment').addEventListener('click', () => showScreen('treatment', { isFreshNavigation: true, label: 'For Treatment' }));
        document.getElementById('nav-clinic').addEventListener('click', () => showScreen('onlineClinic', { isFreshNavigation: true, label: 'Online Clinic' }));
        document.getElementById('sidebar-logout-btn').addEventListener('click', () => signOut(auth));

        // --- Sidebar is now fixed, toggle logic removed ---

        let currentUser = null;
        let userProfile = null;
        let selectedRole = 'Farmer';
        let navigationHistory = [];

        function updateNavigationControls() {
            const activeScreen = document.querySelector('.screen.active');
            if (!activeScreen) return;

            const backButton = activeScreen.querySelector('.back-button');

            if (backButton) {
                if (navigationHistory.length > 1) {
                    backButton.classList.remove('hidden');
                } else {
                    backButton.classList.add('hidden');
                }
            }

            updateBreadcrumbs();
        }

        function updateBreadcrumbs() {
            const activeScreen = document.querySelector('.screen.active');
            if (!activeScreen) return;
            const breadcrumbsContainer = activeScreen.querySelector('.breadcrumbs');
            if (!breadcrumbsContainer) return;

            breadcrumbsContainer.innerHTML = ''; // Clear old breadcrumbs

            navigationHistory.forEach((state, index) => {
                const label = state.context.label || state.screenName;

                if (index < navigationHistory.length - 1) {
                    // It's a link
                    const link = document.createElement('a');
                    link.href = '#';
                    link.textContent = label;
                    link.dataset.historyIndex = index;
                    link.className = 'hover:underline';
                    breadcrumbsContainer.appendChild(link);

                    const separator = document.createElement('span');
                    separator.textContent = ' / ';
                    separator.className = 'mx-2';
                    breadcrumbsContainer.appendChild(separator);
                } else {
                    // It's the current page, just text
                    const current = document.createElement('span');
                    current.textContent = label;
                    current.className = 'font-semibold text-gray-700';
                    breadcrumbsContainer.appendChild(current);
                }
            });
        }

        document.getElementById('screen-container').addEventListener('click', (e) => {
            const backButton = e.target.closest('.back-button');
            const breadcrumbLink = e.target.closest('.breadcrumbs a');

            if (backButton) {
                if (navigationHistory.length > 1) {
                    navigationHistory.pop(); // Remove the current screen
                    const lastState = navigationHistory[navigationHistory.length - 1];
                    showScreen(lastState.screenName, lastState.context, true);
                }
            } else if (breadcrumbLink) {
                e.preventDefault();
                const historyIndex = parseInt(breadcrumbLink.dataset.historyIndex, 10);

                // Truncate the history to the point we are navigating back to
                navigationHistory = navigationHistory.slice(0, historyIndex + 1);

                const lastState = navigationHistory[navigationHistory.length - 1];
                showScreen(lastState.screenName, lastState.context, true);
            }
        });

        // Function to switch between screens
        async function showScreen(screenName, context = {}, isBack = false) {
            if (!isBack) {
                if (context.isFreshNavigation) {
                    navigationHistory = [{ screenName, context }];
                } else {
                    const lastState = navigationHistory[navigationHistory.length - 1];
                    if (!lastState || lastState.screenName !== screenName || JSON.stringify(lastState.context) !== JSON.stringify(context)) {
                        navigationHistory.push({ screenName, context });
                    }
                }
            }

            detachAllListeners(); // Clean up listeners from the previous screen

            // Stop camera if navigating away from it
            if (mediaStream && screenName !== 'camera') {
                stopCamera();
            }

            const sidebar = document.getElementById('sidebar');
            const screenContainer = document.getElementById('screen-container');
            const noSidebarScreens = ['loading', 'login', 'camera', 'privacyPolicy'];

            if (noSidebarScreens.includes(screenName)) {
                sidebar.classList.add('hidden');
                screenContainer.classList.remove('with-sidebar');
            } else {
                sidebar.classList.remove('hidden');
                screenContainer.classList.add('with-sidebar');
            }

            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            if (screens[screenName]) {
                screens[screenName].classList.add('active');
            }

            // The context for the current screen is from the last item in history.
            const currentContext = navigationHistory.length > 0 ? navigationHistory[navigationHistory.length - 1].context : {};

            // Attach listeners and load data for the new screen
            switch (screenName) {
                case 'farmList':
                    loadFarms(currentContext);
                    break;
                case 'dashboard':
                    currentFarmId = currentContext.farmId; // Still needed by some functions
                    loadSubmissions(currentContext.farmId);
                    document.getElementById('dashboard-farm-name').textContent = currentContext.farmName || 'Farm Health Log';
                    document.getElementById('dashboard-farm-variety').textContent = currentContext.tobaccoVariety || '';
                    break;
                case 'reports':
                    loadAllReports();
                    break;
                case 'camera':
                    startCamera();
                    break;
                case 'diagnosis':
                    loadReportsForDiagnosis();
                    break;
                case 'treatment':
                    loadReportsForTreatment();
                    break;
                case 'ewDashboard':
                    loadExtensionWorkerDashboard(currentContext);
                    break;
                case 'coordinatorDashboard':
                    loadCoordinatorDashboard(currentContext);
                    break;
                case 'newSubmission':
                    await initializeReportMap(currentContext);
                    break;
            }

            lucide.createIcons();
            updateNavigationControls();
        }

        function updateUIVisibilityBasedOnRole() {
            if (!userProfile) return;

            const isFarmer = userProfile.role === 'Farmer';
            const isWorker = userProfile.role === 'Extension Worker';

            const navDiagnosis = document.getElementById('nav-diagnosis');
            const navTreatment = document.getElementById('nav-treatment');

            if (isFarmer) {
                navDiagnosis.style.display = 'none';
                navTreatment.style.display = 'none';
            } else if (isWorker) {
                navDiagnosis.style.display = 'block';
                navTreatment.style.display = 'none'; // Workers only do initial diagnosis
            }
            else { // Covers Coordinator and any other non-farmer roles
                navDiagnosis.style.display = 'block';
                navTreatment.style.display = 'block';
            }
        }

        let toastTimeout;
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');

            toastMessage.textContent = message;

            // Reset classes
            toast.className = 'fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-md transition-opacity duration-300';

            if (type === 'success') {
                toast.classList.add('bg-green-600');
            } else if (type === 'error') {
                toast.classList.add('bg-red-600');
            } else {
                toast.classList.add('bg-gray-800');
            }

            toast.classList.remove('opacity-0');

            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                toast.classList.add('opacity-0');
            }, 3000);
        }

        function showSavingOverlay(message = 'Saving...') {
            document.getElementById('saving-message').textContent = message;
            const overlay = document.getElementById('saving-overlay');
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
        }

        function hideSavingOverlay() {
            const overlay = document.getElementById('saving-overlay');
            overlay.classList.add('hidden');
            overlay.classList.remove('flex');
        }

        // --- CAMERA LOGIC ---
        const cameraFeed = document.getElementById('camera-feed');
        const photoCanvas = document.getElementById('photo-canvas');
        const capturePhotoBtn = document.getElementById('capture-photo-btn');
        const recordVideoBtn = document.getElementById('record-video-btn');
        let mediaStream = null;
        let mediaRecorder = null;
        let recordedChunks = [];

        async function startCamera() {
            try {
                if (!('mediaDevices' in navigator) || !('getUserMedia' in navigator.mediaDevices)) {
                    throw new Error('Camera API is not available in this browser.');
                }

                const constraints = {
                    video: {
                        facingMode: 'environment', // Prioritize back camera
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };

                mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraFeed.srcObject = mediaStream;
                cameraFeed.play();
            } catch (error) {
                console.error('Error accessing camera:', error);
                showToast(`Could not access camera: ${error.message}`, 'error');
                // Fallback or show an error message
                showScreen('newSubmission');
            }
        }

        function stopCamera() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
        }

        capturePhotoBtn.addEventListener('click', () => {
            const context = photoCanvas.getContext('2d');
            photoCanvas.width = cameraFeed.videoWidth;
            photoCanvas.height = cameraFeed.videoHeight;
            context.drawImage(cameraFeed, 0, 0, photoCanvas.width, photoCanvas.height);

            const imageDataUrl = photoCanvas.toDataURL('image/jpeg', 0.9); // 90% quality

            // Set the captured image on the submission form
            const imagePreview = document.getElementById('submission-image-preview');
            const imagePlaceholder = document.getElementById('image-placeholder-icon');
            imagePreview.src = imageDataUrl;
            imagePreview.classList.remove('hidden');
            imagePlaceholder.classList.add('hidden');

            // Stop the camera and go back to the form
            stopCamera();
            showScreen('newSubmission');
        });

        recordVideoBtn.addEventListener('click', () => {
            // Placeholder for video recording functionality
            showToast('Video recording is not yet implemented.', 'info');
        });


        // --- MAP & FARM SETUP LOGIC ---
        let map;
        let reportMap;
        let drawnItems;
        let pendingFarmData = {};

        async function initializeMapForEdit(farmId) {
             if (!currentUser || !farmId) return;

            try {
                const farmDocRef = doc(db, 'users', currentUser.uid, 'farmLots', farmId);
                const farmDocSnap = await getDoc(farmDocRef);

                if (farmDocSnap.exists()) {
                    const farmData = farmDocSnap.data();
                    const coordinates = farmData.polygonCoordinates;

                    if (coordinates && coordinates.length > 0) {
                        const latLngs = coordinates.map(c => [c.lat, c.lng]);
                        const polygon = L.polygon(latLngs, {color: '#22c55e'});

                        drawnItems.clearLayers();
                        drawnItems.addLayer(polygon);
                        map.fitBounds(polygon.getBounds());
                        document.getElementById('save-farm-map-btn').disabled = false;
                    }
                }
            } catch (error) {
                console.error("Error loading farm data for editing:", error);
            }
        }

        async function initializeReportMap(context) {
            const farmId = context.farmId;
            const targetUserId = context.userId || currentUser.uid;

            if (!currentUser || !farmId) return;

            try {
                const farmDocRef = doc(db, 'users', targetUserId, 'farmLots', farmId);
                const farmDocSnap = await getDoc(farmDocRef);

                if (farmDocSnap.exists()) {
                    const farmData = farmDocSnap.data();
                    const coordinates = farmData.polygonCoordinates;

                    if (reportMap) {
                        reportMap.remove();
                    }

                    reportMap = L.map('report-map', {
                        scrollWheelZoom: false,
                        dragging: false,
                        zoomControl: false
                    });

                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Tiles &copy; Esri'
                    }).addTo(reportMap);

                    if (coordinates && coordinates.length > 0) {
                        const latLngs = coordinates.map(c => [c.lat, c.lng]);
                        const polygon = L.polygon(latLngs, {color: '#22c55e'}).addTo(reportMap);
                        reportMap.fitBounds(polygon.getBounds());
                    }
                }
            } catch (error) {
                console.error("Error loading farm data for report map:", error);
            }
        }

        function initializeMap() {
            // If map is already initialized, just reset its view
            if (map) {
                map.setView([12.8797, 121.7740], 5); // Reset to PH view
                if(drawnItems) {
                    drawnItems.clearLayers();
                }
                return;
            }

            // Initialize the map and set its view to the Philippines
            map = L.map('map').setView([12.8797, 121.7740], 5);

            // Add a satellite tile layer to the map
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            }).addTo(map);

            // Initialize the FeatureGroup to store editable layers
            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            // Initialize the draw control and pass it the FeatureGroup
            const drawControl = new L.Control.Draw({
                edit: {
                    featureGroup: drawnItems,
                    remove: true
                },
                draw: {
                    polygon: {
                        allowIntersection: false,
                        drawError: {
                            color: '#e1e100',
                            message: '<strong>Oh snap!</strong> you can\'t draw that!'
                        },
                        shapeOptions: {
                            color: '#22c55e'
                        }
                    },
                    polyline: false,
                    rectangle: false,
                    circle: false,
                    marker: false,
                    circlemarker: false
                }
            });
            map.addControl(drawControl);

            map.on(L.Draw.Event.CREATED, function (event) {
                const layer = event.layer;
                drawnItems.clearLayers(); // Clear previous drawings
                drawnItems.addLayer(layer);
                document.getElementById('save-farm-map-btn').disabled = false;
            });

            map.on(L.Draw.Event.DELETED, function() {
                if (drawnItems.getLayers().length === 0) {
                    document.getElementById('save-farm-map-btn').disabled = true;
                }
            });

             // Attempt to get user's location
            map.locate({setView: true, maxZoom: 16});
            map.on('locationfound', e => {
                L.marker(e.latlng).addTo(map)
                    .bindPopup("You are somewhere around here.").openPopup();
            });
            map.on('locationerror', e => {
                console.log(e.message);
                // Silently fails if location is not available. Map defaults to PH view.
            });
        }


        // --- 4. AUTHENTICATION LOGIC ---
        const profileTitle = document.getElementById('profile-title');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const profileFormElements = document.querySelectorAll('#profile-screen input, #profile-screen select, #profile-screen textarea, #profile-screen .role-btn');

        function setProfileMode(mode) { // 'edit', 'view', 'new'
            if (mode === 'view') {
                profileTitle.textContent = 'Your Profile';
                profileFormElements.forEach(el => el.disabled = true);
                editProfileBtn.classList.remove('hidden');
                saveProfileBtn.classList.add('hidden');
                cancelEditBtn.classList.add('hidden');
            } else if (mode === 'edit') {
                profileTitle.textContent = 'Edit Profile';
                profileFormElements.forEach(el => el.disabled = false);
                saveProfileBtn.textContent = 'Save Changes';
                editProfileBtn.classList.add('hidden');
                saveProfileBtn.classList.remove('hidden');
                cancelEditBtn.classList.remove('hidden');
            } else { // new
                profileTitle.textContent = 'Complete Your Profile';
                profileFormElements.forEach(el => el.disabled = false);
                saveProfileBtn.textContent = 'Save and Continue';
                editProfileBtn.classList.add('hidden');
                saveProfileBtn.classList.remove('hidden');
                cancelEditBtn.classList.add('hidden');
            }
        }

        // --- Address Dropdown Logic ---
        const provinceSelect = document.getElementById('province');
        const municipalitySelect = document.getElementById('municipality');
        const barangaySelect = document.getElementById('barangay');

        function populateProvinces() {
            provinceSelect.innerHTML = '<option value="">Select Province</option>';
            if (window.philippineAddresses && window.philippineAddresses.provinces) {
                window.philippineAddresses.provinces.forEach(province => {
                    const option = document.createElement('option');
                    option.value = province.name;
                    option.textContent = province.name;
                    provinceSelect.appendChild(option);
                });
            } else {
                provinceSelect.innerHTML = '<option value="">Failed to load addresses</option>';
            }
        }

        provinceSelect.addEventListener('change', () => {
            const selectedProvinceName = provinceSelect.value;
            const selectedProvince = window.philippineAddresses.provinces.find(p => p.name === selectedProvinceName);
            municipalitySelect.innerHTML = '<option value="">Select Municipality</option>';
            barangaySelect.innerHTML = '<option value="">Select Barangay</option>';
            barangaySelect.disabled = true;

            if (selectedProvince) {
                municipalitySelect.disabled = false;
                selectedProvince.municipalities.forEach(municipality => {
                    const option = document.createElement('option');
                    option.value = municipality.name;
                    option.textContent = municipality.name;
                    municipalitySelect.appendChild(option);
                });
            } else {
                municipalitySelect.disabled = true;
            }
        });

        municipalitySelect.addEventListener('change', () => {
            const selectedProvinceName = provinceSelect.value;
            const selectedMunicipalityName = municipalitySelect.value;
            const selectedProvince = window.philippineAddresses.provinces.find(p => p.name === selectedProvinceName);
            const selectedMunicipality = selectedProvince?.municipalities.find(m => m.name === selectedMunicipalityName);
            barangaySelect.innerHTML = '<option value="">Select Barangay</option>';

            if (selectedMunicipality && selectedMunicipality.barangays) {
                barangaySelect.disabled = false;
                selectedMunicipality.barangays.forEach(barangay => {
                    const option = document.createElement('option');
                    option.value = barangay;
                    option.textContent = barangay;
                    barangaySelect.appendChild(option);
                });
            } else {
                barangaySelect.disabled = true;
            }
        });

        // --- RSBSA Logic ---
        const isFarmerCheckbox = document.getElementById('isFarmer');
        const rsbsaContainer = document.getElementById('rsbsa-container');
        isFarmerCheckbox.addEventListener('change', () => {
            rsbsaContainer.classList.toggle('hidden', !isFarmerCheckbox.checked);
        });

        function populateProfileFields(profile) {
            document.getElementById('profile-pic').src = profile.photoURL || (currentUser && currentUser.photoURL) || 'https://placehold.co/96x96/e2e8f0/334155?text=User';
            document.getElementById('fullName').value = profile.fullName || '';

            // Populate address fields only if the data is ready
            if (window.philippineAddresses && window.philippineAddresses.provinces.length > 0) {
                if (profile.province) {
                    provinceSelect.value = profile.province;
                    provinceSelect.dispatchEvent(new Event('change'));

                    setTimeout(() => {
                        if (profile.municipality) {
                            municipalitySelect.value = profile.municipality;
                            municipalitySelect.dispatchEvent(new Event('change'));

                            setTimeout(() => {
                                 if (profile.barangay) {
                                    barangaySelect.value = profile.barangay;
                                }
                            }, 100);
                        }
                    }, 100);
                }
            }

            // RSBSA Number
            if (profile.rsbsaNumber) {
                isFarmerCheckbox.checked = true;
                rsbsaContainer.classList.remove('hidden');
                document.getElementById('rsbsaNumber').value = profile.rsbsaNumber;
            } else {
                isFarmerCheckbox.checked = false;
                rsbsaContainer.classList.add('hidden');
                document.getElementById('rsbsaNumber').value = '';
            }

            document.getElementById('birthdate').value = profile.birthdate || '';
            document.getElementById('civilStatus').value = profile.civilStatus || 'Single';
            document.getElementById('religion').value = profile.religion || '';
            document.getElementById('yearsFarming').value = profile.yearsFarming || '';
            document.getElementById('familyMembers').value = profile.familyMembers || '';
            document.getElementById('education').value = profile.education || 'No formal education';

            selectedRole = profile.role || 'Farmer';
            document.querySelectorAll('.role-btn').forEach(btn => {
                btn.classList.remove('bg-green-600', 'text-white');
                btn.classList.add('border-gray-300');
            });
            if (selectedRole === 'Farmer') {
                document.getElementById('role-farmer-btn').classList.add('bg-green-600', 'text-white');
            } else if (selectedRole === 'Extension Worker') {
                document.getElementById('role-worker-btn').classList.add('bg-green-600', 'text-white');
            } else if (selectedRole === 'Branch Coordinator') {
                document.getElementById('role-coordinator-btn').classList.add('bg-green-600', 'text-white');
            }
            updateUIVisibilityBasedOnRole();
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                updateOnlineStatus();

                // Wait for the address and pest/disease data to be ready
                await Promise.all([window.addressDataPromise, window.pestDiseaseDataPromise]);

                // Now that address data is loaded, populate the dropdowns
                populateProvinces();
                
                const userDocRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists()) {
                    userProfile = docSnap.data();

                    const requiredFields = ['fullName', 'province', 'municipality', 'barangay', 'birthdate', 'civilStatus', 'religion', 'yearsFarming', 'familyMembers', 'education', 'role'];
                    const isProfileComplete = requiredFields.every(field => userProfile[field] !== undefined && userProfile[field] !== null && userProfile[field] !== '');

                    // Populate all fields, including the now-ready address dropdowns
                    populateProfileFields(userProfile);

                    if (isProfileComplete) {
                        setProfileMode('view');

                        // Role-based routing
                        let screen;
                        const context = {
                            isFreshNavigation: true,
                            userId: currentUser.uid,
                            userName: userProfile.fullName,
                            label: 'Dashboard'
                        };

                        if (userProfile.role === 'Extension Worker') {
                            screen = 'ewDashboard';
                            document.getElementById('ew-welcome-message').textContent = `Welcome, ${userProfile.fullName}`;
                            document.getElementById('add-farm-btn').style.display = 'none';
                        } else if (userProfile.role === 'Branch Coordinator') {
                            screen = 'coordinatorDashboard';
                            document.getElementById('coordinator-welcome-message').textContent = `Welcome, ${userProfile.fullName}`;
                            document.getElementById('add-farm-btn').style.display = 'none';
                        } else { // Default to Farmer
                            screen = 'farmList';
                            document.getElementById('welcome-message').textContent = `Welcome, ${userProfile.fullName}`;
                            document.getElementById('add-farm-btn').style.display = 'flex';
                        }
                        showScreen(screen, context);
                    } else {
                        setProfileMode('new');
                        showToast('Please complete your profile to continue.', 'info');
                        showScreen('profile', { isFreshNavigation: true, label: 'Complete Profile' });
                        document.getElementById('add-farm-btn').style.display = 'none';
                    }
                } else {
                    userProfile = {};
                    populateProfileFields({
                        fullName: user.displayName,
                        photoURL: user.photoURL
                    });
                    setProfileMode('new');
                    showScreen('profile');
                    document.getElementById('add-farm-btn').style.display = 'none';
                }
            } else {
                currentUser = null;
                userProfile = null;
                showScreen('login');
            }
        });

        // Event Listeners for Sign-in buttons
        document.getElementById('google-signin-btn').addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(error => console.error("Google Sign-in Error", error));
        });

        document.getElementById('facebook-signin-btn').addEventListener('click', () => {
            const provider = new FacebookAuthProvider();
            signInWithPopup(auth, provider).catch(error => console.error("Facebook Sign-in Error", error));
        });
        
        document.getElementById('guest-signin-btn').addEventListener('click', () => {
            signInAnonymously(auth).catch(error => console.error("Anonymous Sign-in Error", error));
        });

        // --- 5. PROFILE MANAGEMENT ---
        editProfileBtn.addEventListener('click', () => {
            setProfileMode('edit');
        });

        cancelEditBtn.addEventListener('click', () => {
            populateProfileFields(userProfile); // Revert changes
            setProfileMode('view');
        });

        document.querySelectorAll('.role-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (btn.disabled) return;
                document.querySelectorAll('.role-btn').forEach(b => {
                    b.classList.remove('bg-green-600', 'text-white');
                    b.classList.add('border-gray-300');
                });
                btn.classList.add('bg-green-600', 'text-white');
                btn.classList.remove('border-gray-300');

                if (btn.id === 'role-farmer-btn') {
                    selectedRole = 'Farmer';
                } else if (btn.id === 'role-worker-btn') {
                    selectedRole = 'Extension Worker';
                } else if (btn.id === 'role-coordinator-btn') {
                    selectedRole = 'Branch Coordinator';
                }
            });
        });

        document.getElementById('save-profile-btn').addEventListener('click', async () => {
            const fullName = document.getElementById('fullName').value;
            const province = document.getElementById('province').value;
            const municipality = document.getElementById('municipality').value;
            const barangay = document.getElementById('barangay').value;
            const birthdate = document.getElementById('birthdate').value;
            const civilStatus = document.getElementById('civilStatus').value;
            const religion = document.getElementById('religion').value;
            const yearsFarming = document.getElementById('yearsFarming').value;
            const familyMembers = document.getElementById('familyMembers').value;
            const education = document.getElementById('education').value;
            const rsbsaNumber = document.getElementById('rsbsaNumber').value;

            if (!fullName.trim() || !province.trim() || !municipality.trim() || !barangay.trim() || !birthdate.trim() || !civilStatus.trim() || !religion.trim() || !yearsFarming.trim() || !familyMembers.trim() || !education.trim()) {
                showToast('Please fill out all fields.', 'error');
                return;
            }
            
            showSavingOverlay('Saving Profile...');

            const profileData = {
                fullName: fullName.trim(),
                province: province,
                municipality: municipality,
                barangay: barangay,
                birthdate: birthdate,
                civilStatus: civilStatus,
                religion: religion.trim(),
                yearsFarming: parseInt(yearsFarming),
                familyMembers: parseInt(familyMembers),
                education: education,
                role: selectedRole,
                email: currentUser.email || '',
                photoURL: currentUser.photoURL || '',
                rsbsaNumber: rsbsaNumber.trim()
            };

            try {
                const userDocRef = doc(db, "users", currentUser.uid);
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists()) {
                    // For existing profiles, set updatedAt
                    profileData.updatedAt = serverTimestamp();
                } else {
                    // For new profiles, set createdAt
                    profileData.createdAt = serverTimestamp();
                }

                await setDoc(userDocRef, profileData, { merge: true });

                showToast("Profile saved successfully!", "success");

                // Re-fetch the profile to ensure local data is consistent and clean
                const updatedDocSnap = await getDoc(userDocRef);
                if (updatedDocSnap.exists()) {
                    userProfile = updatedDocSnap.data();
                } else {
                    // This case should ideally not happen if setDoc was successful.
                    // We'll optimistically use the data we sent, but remove the server-only fields.
                    if(profileData.updatedAt) delete profileData.updatedAt;
                    if(profileData.createdAt) delete profileData.createdAt;
                    userProfile = profileData;
                }

                const requiredFields = ['fullName', 'homeAddress', 'birthdate', 'civilStatus', 'religion', 'yearsFarming', 'familyMembers', 'education', 'role'];
                const isProfileComplete = requiredFields.every(field => userProfile[field]);

                if (isProfileComplete) {
                    populateProfileFields(userProfile); // Repopulate with the latest saved data
                    setProfileMode('view');
                    document.getElementById('welcome-message').textContent = `Welcome, ${userProfile.fullName}`;
                    loadFarms();
                    showScreen('farmList');
                    document.getElementById('add-farm-btn').style.display = 'flex';
                } else {
                    setProfileMode('new');
                }

            } catch (error) {
                console.error("Error saving profile:", error);
                showToast("Could not save profile. Please check connection.", 'error');
            } finally {
                hideSavingOverlay();
            }
        });

        // --- 6. FARM MANAGEMENT & SETUP FLOW ---
        const farmModal = document.getElementById('farm-modal');
        document.getElementById('add-farm-btn').addEventListener('click', () => farmModal.style.display = 'flex');
        document.getElementById('close-farm-modal-btn').addEventListener('click', () => farmModal.style.display = 'none');

        // --- New Farm Flow ---
        let isEditMode = false; // To track if we are editing or creating a new farm

        document.getElementById('edit-farm-details-btn').addEventListener('click', async () => {
            if (!currentFarmId || !currentUser) {
                showToast('No farm selected.', 'error');
                return;
            }
            isEditMode = true;

            // Fetch current farm data
            const farmDocRef = doc(db, 'users', currentUser.uid, 'farmLots', currentFarmId);
            const farmDocSnap = await getDoc(farmDocRef);

            if (farmDocSnap.exists()) {
                const farmData = farmDocSnap.data();
                // Pre-fill the modal
                document.getElementById('farmName').value = farmData.farmName || '';
                document.getElementById('tobaccoVariety').value = farmData.tobaccoVariety || '';
                document.getElementById('plantingDate').value = farmData.plantingDate || '';

                // Change button text and show modal
                document.getElementById('next-farm-map-btn').textContent = 'Update Details & Set Location';
                farmModal.style.display = 'flex';
            } else {
                showToast('Could not find farm details to edit.', 'error');
            }
        });

        // Reset edit mode when adding a new farm
        document.getElementById('add-farm-btn').addEventListener('click', () => {
            isEditMode = false;
            // Clear fields and reset button text for new entry
            document.getElementById('farmName').value = '';
            document.getElementById('tobaccoVariety').value = '';
            document.getElementById('plantingDate').value = '';
            document.getElementById('next-farm-map-btn').textContent = 'Next: Set Location';
            farmModal.style.display = 'flex';
        });


        document.getElementById('next-farm-map-btn').addEventListener('click', () => {
            const farmName = document.getElementById('farmName').value.trim();
            const tobaccoVariety = document.getElementById('tobaccoVariety').value.trim();
            const plantingDate = document.getElementById('plantingDate').value;

            if (!farmName || !tobaccoVariety || !plantingDate) {
                showToast('Please fill out all farm details.', 'error');
                return;
            }

            pendingFarmData = {
                farmName,
                tobaccoVariety,
                plantingDate
            };

            farmModal.style.display = 'none';

            if (isEditMode) {
                document.getElementById('save-farm-map-btn').textContent = 'Update Farm Area';
            } else {
                document.getElementById('save-farm-map-btn').textContent = 'Save Farm Area';
            }

            showScreen('farmSetup');
            // Invalidate map size and re-center, needed when map is in a hidden div
            setTimeout(() => {
                initializeMap(); // General map init
                if (isEditMode) {
                    initializeMapForEdit(currentFarmId); // Load existing polygon if editing
                }
            }, 100);
        });

        document.getElementById('cancel-farm-setup-btn').addEventListener('click', () => {
            pendingFarmData = {};
            drawnItems.clearLayers();
            document.getElementById('save-farm-map-btn').disabled = true;
            showScreen('farmList'); // Go back to the farm list
        });

        document.getElementById('delete-farm-btn').addEventListener('click', async () => {
            if (!currentFarmId || !currentUser) {
                showToast('No farm selected.', 'error');
                return;
            }

            if (confirm('Are you sure you want to delete this farm plot? This action cannot be undone.')) {
                try {
                    const farmDocRef = doc(db, 'users', currentUser.uid, 'farmLots', currentFarmId);
                    await deleteDoc(farmDocRef);
                    showToast('Deletion Successful: The farm plot has been removed.', 'success');
                    currentFarmId = null;
                    showScreen('farmList');
                } catch (error) {
                    console.error("Error deleting farm plot:", error);
                    showToast('Failed to delete farm plot. Please try again.', 'error');
                }
            }
        });

        document.getElementById('save-farm-map-btn').addEventListener('click', async () => {
            if (drawnItems.getLayers().length === 0) {
                showToast('Please draw or select a farm area on the map first.', 'error');
                return;
            }

            showSavingOverlay('Saving Farm Plot...');

            // Extract polygon data
            const geojson = drawnItems.getLayers()[0].toGeoJSON();
            const coordinates = geojson.geometry.coordinates[0].map(p => ({ lat: p[1], lng: p[0] }));

            const farmData = {
                ...pendingFarmData,
                polygonCoordinates: coordinates,
            };

            if (!currentUser) {
                showToast('Error: No user logged in.', 'error');
                hideSavingOverlay();
                return;
            }

            try {
                if (isEditMode) {
                    // Update existing document
                    farmData.updatedAt = serverTimestamp();
                    const farmDocRef = doc(db, 'users', currentUser.uid, 'farmLots', currentFarmId);
                    await updateDoc(farmDocRef, farmData);
                    showToast('Update Successful: The farm plot details have been saved.', 'success');
                } else {
                    // Create new document
                    farmData.createdAt = serverTimestamp();
                    const farmLotsCollection = collection(db, 'users', currentUser.uid, 'farmLots');
                    await addDoc(farmLotsCollection, farmData);
                    showToast('Creation Successful: A new farm plot has been added.', 'success');
                }

                // Reset state
                isEditMode = false;
                pendingFarmData = {};
                drawnItems.clearLayers();
                document.getElementById('save-farm-map-btn').disabled = true;
                document.getElementById('farmName').value = '';
                document.getElementById('tobaccoVariety').value = '';
                document.getElementById('plantingDate').value = '';

                showScreen('farmList'); // Go back to the farm list
            } catch (error) {
                console.error("Error saving farm plot:", error);
                showToast('Could not save farm plot. Please try again.', 'error');
            } finally {
                hideSavingOverlay();
            }
        });
        
        // --- 8. NEW SUBMISSION LOGIC ---
        const imageUploadInput = document.getElementById('image-upload');
        const imagePreview = document.getElementById('submission-image-preview');
        const imagePlaceholder = document.getElementById('image-placeholder-icon');

        imageUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                    imagePlaceholder.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('save-submission-btn').addEventListener('click', async () => {
            const imageSrc = document.getElementById('submission-image-preview').src;
            const symptoms = Array.from(document.querySelectorAll('#symptoms-checklist input:checked')).map(cb => cb.value);
            const distribution = document.querySelector('#distribution-radios input:checked')?.value;
            const severity = document.querySelector('#severity-radios input:checked')?.value;

            if (!imageSrc.startsWith('data:image') || symptoms.length === 0 || !distribution || !severity) {
                showToast('Please fill out all fields and select an image.', 'error');
                return;
            }

            if (!currentFarmId || !currentUser) {
                showToast('Could not identify the current farm or user. Please go back to the farm list.', 'error');
                return;
            }

            showSavingOverlay('Saving Report...');

            const submissionData = {
                imageDataUrl: imageSrc,
                symptoms,
                distribution,
                severity,
            };

            try {
                if (isEditSubmissionMode) {
                    // Update existing submission
                    submissionData.updatedAt = serverTimestamp();
                    const submissionDocRef = doc(db, 'users', currentUser.uid, 'farmLots', currentFarmId, 'submissions', currentSubmissionId);
                    await updateDoc(submissionDocRef, submissionData);
                    showToast('Report Updated: Your report has been successfully updated.', 'success');
                } else {
                    // Create new submission
                    submissionData.timestamp = serverTimestamp();
                     // Simulate GPS data
                    submissionData.gps_coordinates = { latitude: 17.5734, longitude: 120.3856 };
                    const submissionsCollection = collection(db, 'users', currentUser.uid, 'farmLots', currentFarmId, 'submissions');
                    await addDoc(submissionsCollection, submissionData);
                    showToast('Report Submitted: Your new report has been saved.', 'success');
                }

                // Reset state and form
                isEditSubmissionMode = false;
                currentSubmissionId = null;
                document.getElementById('new-submission-btn').click(); // Programmatically click to reset the form

                showScreen('dashboard');
            } catch (error) {
                console.error('Failed to save submission:', error);
                showToast('Could not save report. Please try again.', 'error');
            } finally {
                hideSavingOverlay();
            }
        });

        let currentFarmId = null;
        let isEditSubmissionMode = false;
        let currentSubmissionId = null;

        // --- Submission Edit Flow ---
        document.getElementById('dashboard-main').addEventListener('click', async (e) => {
            if (e.target && e.target.classList.contains('edit-submission-btn')) {
                currentSubmissionId = e.target.getAttribute('data-id');
                if (!currentSubmissionId || !currentUser || !currentFarmId) {
                    showToast('Error: Cannot find submission to edit.', 'error');
                    return;
                }
                isEditSubmissionMode = true;

                try {
                    const submissionDocRef = doc(db, 'users', currentUser.uid, 'farmLots', currentFarmId, 'submissions', currentSubmissionId);
                    const submissionDocSnap = await getDoc(submissionDocRef);

                    if (submissionDocSnap.exists()) {
                        const sub = submissionDocSnap.data();

                        // Pre-fill the form
                        document.getElementById('submission-image-preview').src = sub.imageDataUrl || '';
                        document.getElementById('submission-image-preview').classList.remove('hidden');
                        document.getElementById('image-placeholder-icon').classList.add('hidden');

                        // Reset checkboxes before setting new state
                        document.querySelectorAll('#symptoms-checklist input[type="checkbox"]').forEach(cb => cb.checked = false);
                        sub.symptoms.forEach(symptomValue => {
                            const checkbox = document.getElementById(`symptom-${symptomValue}`);
                            if (checkbox) checkbox.checked = true;
                        });

                        // Reset radios before setting new state
                        document.querySelectorAll('#distribution-radios input[type="radio"]').forEach(rb => rb.checked = false);
                        const distRadio = document.getElementById(`dist-${sub.distribution}`);
                        if (distRadio) distRadio.checked = true;

                        document.querySelectorAll('#severity-radios input[type="radio"]').forEach(rb => rb.checked = false);
                        const sevRadio = document.getElementById(`sev-${sub.severity}`);
                        if (sevRadio) sevRadio.checked = true;

                        // Update button and show screen
                        document.getElementById('save-submission-btn').textContent = 'Update Report';
                        showScreen('newSubmission');
                        initializeReportMap(currentFarmId);

                    } else {
                        showToast('Submission data not found.', 'error');
                    }
                } catch (error) {
                    console.error("Error fetching submission for edit:", error);
                    showToast('Could not load submission data.', 'error');
                }
            }
        });

        document.getElementById('new-submission-btn').addEventListener('click', () => {
            isEditSubmissionMode = false;
            currentSubmissionId = null;

            // Reset the form for a new entry
            document.getElementById('submission-image-preview').src = '';
            document.getElementById('submission-image-preview').classList.add('hidden');
            document.getElementById('image-placeholder-icon').classList.remove('hidden');
            document.getElementById('image-upload').value = '';
            document.querySelectorAll('#symptoms-checklist input:checked').forEach(cb => cb.checked = false);
            document.querySelectorAll('#distribution-radios input:checked').forEach(rb => rb.checked = false);
            document.querySelectorAll('#severity-radios input:checked').forEach(rb => rb.checked = false);

            document.getElementById('save-submission-btn').textContent = 'Save Submission';

            const lastContext = navigationHistory[navigationHistory.length - 1]?.context || {};
            const newContext = { ...lastContext, label: 'New Report' };
            showScreen('newSubmission', newContext);
        });

        function loadSubmissions(farmId) {
            if (!currentUser || !farmId) return;

            const submissionsCollection = collection(db, 'users', currentUser.uid, 'farmLots', farmId, 'submissions');
            const dashboardMain = document.getElementById('dashboard-main');

            const unsubscribe = onSnapshot(submissionsCollection, (querySnapshot) => {
                dashboardMain.innerHTML = ''; // Clear existing content

                if (querySnapshot.empty) {
                    dashboardMain.innerHTML = `
                    <div class="text-center text-gray-500 mt-20">
                        <i data-lucide="clipboard-list" class="w-12 h-12 mx-auto text-gray-400"></i>
                        <p class="mt-4">No scouting reports found for this farm.</p>
                        <p>Click 'New Report' to add one.</p>
                    </div>`;
                } else {
                    querySnapshot.forEach(doc => {
                        const submission = doc.data();
                        const submissionId = doc.id;
                        const card = document.createElement('div');
                        card.className = 'bg-white p-4 rounded-xl mb-4 shadow-sm border border-gray-200';

                        // Fallback for older data that might not have a proper timestamp
                        const submissionDate = submission.timestamp?.toDate ? submission.timestamp.toDate() : new Date();
                        const dateString = submissionDate.toLocaleDateString();
                        const timeString = submissionDate.toLocaleTimeString();

                        card.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div class="flex">
                                    <img src="${submission.imageDataUrl || 'https://placehold.co/96x96/e2e8f0/334155?text=No+Image'}" class="w-24 h-24 rounded-md mr-4 object-cover">
                                    <div>
                                        <p class="font-bold">Report from ${dateString} at ${timeString}</p>
                                        <p class="text-sm"><strong>Symptoms:</strong> ${submission.symptoms.join(', ')}</p>
                                        <p class="text-sm"><strong>Distribution:</strong> ${submission.distribution}</p>
                                        <p class="text-sm"><strong>Severity:</strong> ${submission.severity}</p>
                                    </div>
                                </div>
                                <div>
                                    <button class="edit-submission-btn bg-blue-500 text-white text-xs font-bold py-1 px-2 rounded" data-id="${submissionId}">Edit</button>
                                </div>
                            </div>
                        `;
                        dashboardMain.appendChild(card);
                    });
                }
                lucide.createIcons();
            });
            activeListeners.push(unsubscribe);
        }

        let currentReportFilter = 'all';

        document.getElementById('report-filters').addEventListener('click', (e) => {
            if (e.target.classList.contains('report-filter-btn')) {
                const filter = e.target.getAttribute('data-filter');
                currentReportFilter = filter;

                document.querySelectorAll('.report-filter-btn').forEach(b => {
                    b.classList.remove('bg-green-600', 'text-white');
                    b.classList.add('bg-gray-200', 'text-gray-800');
                });
                e.target.classList.add('bg-green-600', 'text-white');
                e.target.classList.remove('bg-gray-200', 'text-gray-800');

                loadAllReports();
            }
        });

        async function loadAllReports() {
            if (!currentUser) return;

            const reportsContainer = document.getElementById('reports-container');
            reportsContainer.innerHTML = `<div class="text-center text-gray-500 mt-20"><i data-lucide="loader" class="w-12 h-12 mx-auto text-gray-400 animate-spin"></i><p class="mt-4">Loading reports...</p></div>`;
            lucide.createIcons();

            try {
                // For coordinators, fetch all reports. For farmers, fetch only their own.
                let allSubmissions = [];
                if (userProfile.role === 'Farmer') {
                    const farmLotsCollection = collection(db, 'users', currentUser.uid, 'farmLots');
                    const farmLotsSnapshot = await getDocs(farmLotsCollection);
                    for (const farmDoc of farmLotsSnapshot.docs) {
                        const farmData = farmDoc.data();
                        const submissionsCollection = collection(db, 'users', currentUser.uid, 'farmLots', farmDoc.id, 'submissions');
                        const submissionsSnapshot = await getDocs(submissionsCollection);
                        submissionsSnapshot.forEach(submissionDoc => {
                            allSubmissions.push({
                                ...submissionDoc.data(),
                                id: submissionDoc.id,
                                farmName: farmData.farmName,
                                userId: currentUser.uid,
                                farmId: farmDoc.id
                            });
                        });
                    }
                } else { // For Extension Worker or Branch Coordinator
                    const usersSnapshot = await getDocs(collection(db, 'users'));
                    for (const userDoc of usersSnapshot.docs) {
                         const farmLotsCollection = collection(db, 'users', userDoc.id, 'farmLots');
                        const farmLotsSnapshot = await getDocs(farmLotsCollection);
                        for (const farmDoc of farmLotsSnapshot.docs) {
                            const farmData = farmDoc.data();
                            const submissionsCollection = collection(db, 'users', userDoc.id, 'farmLots', farmDoc.id, 'submissions');
                            const submissionsSnapshot = await getDocs(submissionsCollection);
                            submissionsSnapshot.forEach(submissionDoc => {
                                allSubmissions.push({
                                    ...submissionDoc.data(),
                                    id: submissionDoc.id,
                                    farmName: farmData.farmName,
                                    userName: userDoc.data().fullName,
                                    userId: userDoc.id,
                                    farmId: farmDoc.id
                                });
                            });
                        }
                    }
                }

                // Client-side filtering
                let filteredSubmissions = allSubmissions;
                if (currentReportFilter === 'pending') {
                    filteredSubmissions = allSubmissions.filter(s => !s.initialDiagnosis);
                } else if (currentReportFilter === 'diagnosed') {
                    filteredSubmissions = allSubmissions.filter(s => s.initialDiagnosis && !s.finalDiagnosis);
                } else if (currentReportFilter === 'treated') {
                    filteredSubmissions = allSubmissions.filter(s => s.finalDiagnosis && s.treatment);
                }

                filteredSubmissions.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
                renderAllReports(filteredSubmissions);

            } catch (error) {
                console.error("Error loading all reports:", error);
                showToast("Could not load reports. Please try again.", "error");
                reportsContainer.innerHTML = `<div class="text-center text-red-500 mt-20"><p>Could not load reports.</p></div>`;
            }
        }

        let currentDiagnosisTarget = null; // Holds { userId, farmId, submissionId }

        async function loadReportsForDiagnosis() {
            if (!currentUser) return;

            // This is a placeholder for role checking. In a real app, you'd secure this.
            // For now, we assume if you can see the button, you have access.

            const diagnosisContainer = document.getElementById('diagnosis-reports-container');
            diagnosisContainer.innerHTML = `<div class="text-center text-gray-500 mt-20"><i data-lucide="loader" class="w-12 h-12 mx-auto text-gray-400 animate-spin"></i><p class="mt-4">Loading reports...</p></div>`;
            lucide.createIcons();

            try {
                // Inefficient Query: This iterates through all users and their farms.
                // A better DB structure would be a single top-level 'submissions' collection
                // that could be queried directly.
                const usersSnapshot = await getDocs(collection(db, 'users'));
                let submissionsForDiagnosis = [];

                for (const userDoc of usersSnapshot.docs) {
                    const farmLotsCollection = collection(db, 'users', userDoc.id, 'farmLots');
                    const farmLotsSnapshot = await getDocs(farmLotsCollection);

                    for (const farmDoc of farmLotsSnapshot.docs) {
                        const submissionsCollection = collection(db, 'users', userDoc.id, 'farmLots', farmDoc.id, 'submissions');
                        const submissionsSnapshot = await getDocs(submissionsCollection);

                        submissionsSnapshot.forEach(submissionDoc => {
                            const submissionData = submissionDoc.data();
                            // Show reports that don't have an initial diagnosis yet.
                            if (!submissionData.initialDiagnosis) {
                                submissionsForDiagnosis.push({
                                    ...submissionData,
                                    userId: userDoc.id,
                                    farmId: farmDoc.id,
                                    submissionId: submissionDoc.id,
                                    farmName: farmDoc.data().farmName // Include farm name for context
                                });
                            }
                        });
                    }
                }

                renderReportsForDiagnosis(submissionsForDiagnosis);

            } catch (error) {
                console.error("Error loading reports for diagnosis:", error);
                diagnosisContainer.innerHTML = `<div class="text-center text-red-500 mt-20"><p>Error loading reports. You may not have the required permissions.</p></div>`;
                showToast("Could not load reports for diagnosis.", "error");
            }
        }

        function renderReportsForDiagnosis(submissions) {
            const diagnosisContainer = document.getElementById('diagnosis-reports-container');
            diagnosisContainer.innerHTML = '';

            if (submissions.length === 0) {
                diagnosisContainer.innerHTML = `
                    <div class="text-center text-gray-500 mt-20">
                        <i data-lucide="check-circle-2" class="w-12 h-12 mx-auto text-green-500"></i>
                        <p class="mt-4">No reports are currently awaiting diagnosis.</p>
                        <p>Good job!</p>
                    </div>`;
                lucide.createIcons();
                return;
            }

            submissions.forEach(submission => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-xl mb-4 shadow-sm border border-gray-200 cursor-pointer hover:shadow-md transition-shadow';
                card.setAttribute('data-user-id', submission.userId);
                card.setAttribute('data-farm-id', submission.farmId);
                card.setAttribute('data-submission-id', submission.submissionId);

                const submissionDate = submission.timestamp?.toDate ? submission.timestamp.toDate() : new Date();
                const dateString = submissionDate.toLocaleDateString();

                card.innerHTML = `
                    <div class="flex items-start">
                        <img src="${submission.imageDataUrl || 'https://placehold.co/96x96/e2e8f0/334155?text=No+Image'}" class="w-24 h-24 rounded-md mr-4 object-cover">
                        <div class="flex-grow">
                            <p class="font-bold text-lg">${submission.farmName}</p>
                            <p class="text-sm text-gray-500 mb-2">Reported on ${dateString}</p>
                            <p class="text-sm"><strong>Symptoms:</strong> <span class="capitalize">${submission.symptoms.join(', ')}</span></p>
                            <p class="text-sm"><strong>Severity:</strong> <span class="capitalize">${submission.severity}</span></p>
                        </div>
                    </div>
                `;

                card.addEventListener('click', () => {
                    currentDiagnosisTarget = {
                        userId: submission.userId,
                        farmId: submission.farmId,
                        submissionId: submission.submissionId
                    };

                    // Populate and show the modal
                    const detailsContainer = document.getElementById('diagnosis-report-details');
                    detailsContainer.innerHTML = `
                        <p><strong>Farm:</strong> ${submission.farmName}</p>
                        <img src="${submission.imageDataUrl}" class="rounded-lg my-2 max-h-64 w-auto mx-auto">
                        <p><strong>Symptoms:</strong> ${submission.symptoms.join(', ')}</p>
                        <p><strong>Distribution:</strong> ${submission.distribution}</p>
                        <p><strong>Severity:</strong> ${submission.severity}</p>
                    `;

                    // Populate dropdown and reset fields
                    const pestDiseaseSelect = document.getElementById('pest-disease-select');
                    populatePestDiseaseDropdown(pestDiseaseSelect);
                    document.getElementById('pest-disease-info').innerHTML = '';
                    document.getElementById('pest-disease-info').classList.add('hidden');
                    document.getElementById('diagnosis-notes').value = '';

                    document.getElementById('diagnosis-modal').classList.remove('hidden');
                    document.getElementById('diagnosis-modal').classList.add('flex');
                    lucide.createIcons();
                });

                diagnosisContainer.appendChild(card);
            });
            lucide.createIcons();
        }

        let currentTreatmentTarget = null; // Holds { userId, farmId, submissionId }

        async function loadReportsForTreatment() {
            if (!currentUser) return;

            const treatmentContainer = document.getElementById('treatment-reports-container');
            treatmentContainer.innerHTML = `<div class="text-center text-gray-500 mt-20"><i data-lucide="loader" class="w-12 h-12 mx-auto text-gray-400 animate-spin"></i><p class="mt-4">Loading reports...</p></div>`;
            lucide.createIcons();

            try {
                const usersSnapshot = await getDocs(collection(db, 'users'));
                let submissionsForTreatment = [];

                for (const userDoc of usersSnapshot.docs) {
                    const farmLotsCollection = collection(db, 'users', userDoc.id, 'farmLots');
                    const farmLotsSnapshot = await getDocs(farmLotsCollection);

                    for (const farmDoc of farmLotsSnapshot.docs) {
                        const submissionsCollection = collection(db, 'users', userDoc.id, 'farmLots', farmDoc.id, 'submissions');
                        const submissionsSnapshot = await getDocs(submissionsCollection);

                        submissionsSnapshot.forEach(submissionDoc => {
                            const submissionData = submissionDoc.data();
                            // We want reports that HAVE an initial diagnosis but do NOT have a final diagnosis.
                            if (submissionData.initialDiagnosis && !submissionData.finalDiagnosis) {
                                submissionsForTreatment.push({
                                    ...submissionData,
                                    userId: userDoc.id,
                                    farmId: farmDoc.id,
                                    submissionId: submissionDoc.id,
                                    farmName: farmDoc.data().farmName
                                });
                            }
                        });
                    }
                }

                renderReportsForTreatment(submissionsForTreatment);

            } catch (error) {
                console.error("Error loading reports for treatment:", error);
                treatmentContainer.innerHTML = `<div class="text-center text-red-500 mt-20"><p>Error loading reports.</p></div>`;
                showToast("Could not load reports for treatment.", "error");
            }
        }

        function renderReportsForTreatment(submissions) {
            const treatmentContainer = document.getElementById('treatment-reports-container');
            treatmentContainer.innerHTML = '';

            if (submissions.length === 0) {
                treatmentContainer.innerHTML = `
                    <div class="text-center text-gray-500 mt-20">
                        <i data-lucide="check-circle-2" class="w-12 h-12 mx-auto text-green-500"></i>
                        <p class="mt-4">No reports are currently awaiting a treatment plan.</p>
                    </div>`;
                lucide.createIcons();
                return;
            }

            submissions.forEach(submission => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-xl mb-4 shadow-sm border border-gray-200 cursor-pointer hover:shadow-md transition-shadow';

                card.addEventListener('click', () => {
                    currentTreatmentTarget = {
                        userId: submission.userId,
                        farmId: submission.farmId,
                        submissionId: submission.submissionId
                    };

                    const detailsContainer = document.getElementById('treatment-report-details');
                    detailsContainer.innerHTML = `
                        <p class="font-bold text-lg">${submission.farmName}</p>
                        <p class="font-semibold text-gray-800 mt-2">Initial Diagnosis:</p>
                        <div class="pl-2 border-l-2 border-gray-200">
                            <p><strong>Pest/Disease:</strong> ${submission.initialDiagnosis.pestDisease}</p>
                            <p class="text-sm text-gray-600"><strong>Notes:</strong> ${submission.initialDiagnosis.notes || 'N/A'}</p>
                            <p class="text-sm text-gray-600"><strong>Diagnosed by:</strong> ${submission.initialDiagnosis.diagnosedByName || 'N/A'}</p>
                        </div>
                    `;

                    // Reset and populate form fields
                    const finalPestDiseaseSelect = document.getElementById('final-pest-disease-select');
                    populatePestDiseaseDropdown(finalPestDiseaseSelect);

                    // Pre-fill with data from initial diagnosis
                    finalPestDiseaseSelect.value = submission.initialDiagnosis.pestDisease;
                    document.getElementById('final-diagnosis-notes').value = submission.initialDiagnosis.notes || '';

                    // Manually trigger change to populate info and treatment options
                    finalPestDiseaseSelect.dispatchEvent(new Event('change'));

                    document.getElementById('treatment-instructions').value = '';
                    document.getElementById('follow-up-date').value = '';

                    document.getElementById('treatment-modal').classList.remove('hidden');
                    document.getElementById('treatment-modal').classList.add('flex');
                    lucide.createIcons();
                });

                card.innerHTML = `
                    <p class="font-bold text-lg">${submission.farmName}</p>
                    <p><strong>Initial Diagnosis:</strong> ${submission.initialDiagnosis.pestDisease}</p>
                    <p class="text-sm text-gray-600">Diagnosed by ${submission.initialDiagnosis.diagnosedByName || 'an expert'}</p>
                `;
                treatmentContainer.appendChild(card);
            });
            lucide.createIcons();
        }

        // --- Treatment Modal Logic ---
        function populateCheckboxes(container, items, category) {
            container.innerHTML = '';
            if (!items || items.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No recommendations available.</p>';
                return;
            }
            items.forEach((item, index) => {
                const checkboxId = `${category}-${index}`;
                const div = document.createElement('div');
                div.className = 'flex items-start';
                div.innerHTML = `
                    <div class="flex items-center h-5">
                        <input id="${checkboxId}" name="${category}" value="${item}" type="checkbox" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300 rounded">
                    </div>
                    <div class="ml-3 text-sm">
                        <label for="${checkboxId}" class="font-medium text-gray-700">${item}</label>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        document.getElementById('final-pest-disease-select').addEventListener('change', (e) => {
            const selectedName = e.target.value;
            const infoContainer = document.getElementById('final-pest-disease-info');
            const preventionContainer = document.getElementById('treatment-prevention-list');
            const monitoringContainer = document.getElementById('treatment-monitoring-list');
            const controlContainer = document.getElementById('treatment-control-list');

            // Clear everything first
            infoContainer.innerHTML = '';
            infoContainer.classList.add('hidden');
            preventionContainer.innerHTML = '';
            monitoringContainer.innerHTML = '';
            controlContainer.innerHTML = '';

            if (!selectedName) return;

            const allItems = [
                ...(pestAndDiseaseData.fungal_and_bacterial_diseases || []),
                ...(pestAndDiseaseData.major_insect_pests || [])
            ];
            const selectedItem = allItems.find(item => (item['Disease Name'] || item['Pest Common Name']) === selectedName);

            if (selectedItem) {
                // Populate info section
                let infoHTML = '';
                if (selectedItem['Causal Agents']) { // It's a disease
                    infoHTML += `<p><strong>Causal Agent:</strong> ${selectedItem['Causal Agents']}</p>`;
                    infoHTML += `<p class="mt-2"><strong>Symptoms:</strong> ${selectedItem['Primary Visual Symptoms']}</p>`;
                } else { // It's a pest
                    infoHTML += `<p><strong>Scientific Name:</strong> ${selectedItem['Scientific Name']}</p>`;
                    infoHTML += `<p><strong>Feeding Guild:</strong> ${selectedItem['Feeding Guild']}</p>`;
                    infoHTML += `<p class="mt-2"><strong>Damage:</strong> ${selectedItem['Characteristic Visual Damage']}</p>`;
                }
                if (selectedItem['Key Plant Parts Affected']) {
                    infoHTML += `<p class="mt-2"><strong>Key Parts Affected:</strong> ${selectedItem['Key Plant Parts Affected'].join(', ')}</p>`;
                }
                infoContainer.innerHTML = infoHTML;
                infoContainer.classList.remove('hidden');

                // Populate treatment plan checkboxes
                const management = selectedItem.management;
                if (management) {
                    populateCheckboxes(preventionContainer, management.prevention, 'prevention');
                    populateCheckboxes(monitoringContainer, management.monitoring, 'monitoring');
                    populateCheckboxes(controlContainer, management.direct_control, 'control');
                }
            }
        });

        document.getElementById('close-treatment-modal-btn').addEventListener('click', () => {
            document.getElementById('treatment-modal').classList.add('hidden');
            document.getElementById('treatment-modal').classList.remove('flex');
            currentTreatmentTarget = null;
        });

        document.getElementById('save-treatment-btn').addEventListener('click', async () => {
            if (!currentTreatmentTarget) {
                showToast('No report selected for treatment.', 'error');
                return;
            }

            const finalPestDisease = document.getElementById('final-pest-disease-select').value;
            const finalDiagnosisNotes = document.getElementById('final-diagnosis-notes').value.trim();

            const prevention = Array.from(document.querySelectorAll('#treatment-prevention-list input:checked')).map(cb => cb.value);
            const monitoring = Array.from(document.querySelectorAll('#treatment-monitoring-list input:checked')).map(cb => cb.value);
            const control = Array.from(document.querySelectorAll('#treatment-control-list input:checked')).map(cb => cb.value);

            const instructions = document.getElementById('treatment-instructions').value.trim();
            const followUpDate = document.getElementById('follow-up-date').value;

            if (!finalPestDisease) {
                showToast('Please provide a final diagnosis.', 'error');
                return;
            }
             if (prevention.length === 0 && monitoring.length === 0 && control.length === 0) {
                showToast('Please select at least one treatment action.', 'error');
                return;
            }
             if (!instructions) {
                showToast('Please provide specific instructions.', 'error');
                return;
            }


            showSavingOverlay('Saving Final Diagnosis & Treatment...');

            const finalDiagnosisData = {
                pestDisease: finalPestDisease,
                notes: finalDiagnosisNotes,
                diagnosedBy: currentUser.uid,
                diagnosedByName: userProfile.fullName,
                diagnosedAt: serverTimestamp()
            };

            const treatmentData = {
                prevention,
                monitoring,
                control,
                instructions,
                followUpDate,
                createdBy: currentUser.uid,
                createdByName: userProfile.fullName,
                createdAt: serverTimestamp()
            };

            try {
                const { userId, farmId, submissionId } = currentTreatmentTarget;
                const submissionDocRef = doc(db, 'users', userId, 'farmLots', farmId, 'submissions', submissionId);

                await updateDoc(submissionDocRef, {
                    finalDiagnosis: finalDiagnosisData,
                    treatment: treatmentData,
                    status: 'Treatment Provided'
                });

                showToast('Final diagnosis and treatment plan saved!', 'success');
                document.getElementById('close-treatment-modal-btn').click();
                loadReportsForTreatment();

            } catch (error)
            {
                console.error('Error saving treatment plan:', error);
                showToast('Could not save treatment plan.', 'error');
            } finally {
                hideSavingOverlay();
            }
        });

        // --- Diagnosis Modal Logic ---

        function populatePestDiseaseDropdown(selectElement) {
            if (!pestAndDiseaseData) {
                console.error("Pest and disease data not loaded.");
                selectElement.innerHTML = '<option value="">Failed to load data</option>';
                return;
            }

            selectElement.innerHTML = '<option value="">Select a pest or disease...</option>';

            const diseases = pestAndDiseaseData.fungal_and_bacterial_diseases || [];
            const pests = pestAndDiseaseData.major_insect_pests || [];

            // Add diseases
            const diseaseGroup = document.createElement('optgroup');
            diseaseGroup.label = 'Fungal & Bacterial Diseases';
            diseases.forEach(disease => {
                const option = document.createElement('option');
                option.value = disease['Disease Name'];
                option.textContent = disease['Disease Name'];
                diseaseGroup.appendChild(option);
            });
            selectElement.appendChild(diseaseGroup);

            // Add pests
            const pestGroup = document.createElement('optgroup');
            pestGroup.label = 'Major Insect Pests';
            pests.forEach(pest => {
                const option = document.createElement('option');
                option.value = pest['Pest Common Name'];
                option.textContent = pest['Pest Common Name'];
                pestGroup.appendChild(option);
            });
            selectElement.appendChild(pestGroup);
        }

        document.getElementById('pest-disease-select').addEventListener('change', (e) => {
            const selectedName = e.target.value;
            const infoContainer = document.getElementById('pest-disease-info');

            if (!selectedName) {
                infoContainer.innerHTML = '';
                infoContainer.classList.add('hidden');
                return;
            }

            const allItems = [
                ...(pestAndDiseaseData.fungal_and_bacterial_diseases || []),
                ...(pestAndDiseaseData.major_insect_pests || [])
            ];

            const selectedItem = allItems.find(item => (item['Disease Name'] || item['Pest Common Name']) === selectedName);

            if (selectedItem) {
                let infoHTML = '';
                if (selectedItem['Causal Agents']) { // It's a disease
                    infoHTML += `<p><strong>Causal Agent:</strong> ${selectedItem['Causal Agents']}</p>`;
                    infoHTML += `<p class="mt-2"><strong>Symptoms:</strong> ${selectedItem['Primary Visual Symptoms']}</p>`;
                } else { // It's a pest
                    infoHTML += `<p><strong>Scientific Name:</strong> ${selectedItem['Scientific Name']}</p>`;
                    infoHTML += `<p><strong>Feeding Guild:</strong> ${selectedItem['Feeding Guild']}</p>`;
                    infoHTML += `<p class="mt-2"><strong>Damage:</strong> ${selectedItem['Characteristic Visual Damage']}</p>`;
                }
                if (selectedItem['Key Plant Parts Affected']) {
                    infoHTML += `<p class="mt-2"><strong>Key Parts Affected:</strong> ${selectedItem['Key Plant Parts Affected'].join(', ')}</p>`;
                }
                infoContainer.innerHTML = infoHTML;
                infoContainer.classList.remove('hidden');
            } else {
                infoContainer.innerHTML = '';
                infoContainer.classList.add('hidden');
            }
        });

        document.getElementById('close-diagnosis-modal-btn').addEventListener('click', () => {
            document.getElementById('diagnosis-modal').classList.add('hidden');
            document.getElementById('diagnosis-modal').classList.remove('flex');
            currentDiagnosisTarget = null;
        });

        document.getElementById('save-diagnosis-btn').addEventListener('click', async () => {
            if (!currentDiagnosisTarget) {
                showToast('No report selected for diagnosis.', 'error');
                return;
            }

            const pestDisease = document.getElementById('pest-disease-select').value;
            const notes = document.getElementById('diagnosis-notes').value.trim();

            if (!pestDisease) {
                showToast('Please identify a pest or disease from the dropdown.', 'error');
                return;
            }

            showSavingOverlay('Saving Diagnosis...');

            const initialDiagnosisData = {
                pestDisease,
                notes,
                diagnosedBy: currentUser.uid,
                diagnosedByName: userProfile.fullName,
                diagnosedAt: serverTimestamp()
            };

            try {
                const { userId, farmId, submissionId } = currentDiagnosisTarget;
                const submissionDocRef = doc(db, 'users', userId, 'farmLots', farmId, 'submissions', submissionId);

                await updateDoc(submissionDocRef, {
                    initialDiagnosis: initialDiagnosisData,
                    status: 'Pending Final Diagnosis'
                });

                showToast('Initial diagnosis submitted successfully!', 'success');
                document.getElementById('close-diagnosis-modal-btn').click(); // Close modal
                loadReportsForDiagnosis(); // Refresh the list

            } catch (error) {
                console.error('Error saving diagnosis:', error);
                showToast('Could not save diagnosis. Please try again.', 'error');
            } finally {
                hideSavingOverlay();
            }
        });

        function renderAllReports(submissions) {
            const reportsContainer = document.getElementById('reports-container');
            reportsContainer.innerHTML = '';

            if (submissions.length === 0) {
                reportsContainer.innerHTML = `
                    <div class="text-center text-gray-500 mt-20">
                        <i data-lucide="folder-search" class="w-12 h-12 mx-auto text-gray-400"></i>
                        <p class="mt-4">No reports found for the selected filter.</p>
                    </div>`;
                lucide.createIcons();
                return;
            }

            submissions.forEach(submission => {
                const reportWrapper = document.createElement('div');
                reportWrapper.className = 'bg-white rounded-xl mb-4 shadow-sm border border-gray-200 overflow-hidden';

                const summaryCard = document.createElement('div');
                summaryCard.className = 'p-4 cursor-pointer hover:bg-gray-50';

                const detailsCard = document.createElement('div');
                detailsCard.className = 'p-4 border-t border-gray-200 hidden';
                detailsCard.innerHTML = `<div class="text-center text-gray-500"><i data-lucide="loader" class="animate-spin inline-block"></i> Loading details...</div>`;

                const submissionDate = submission.timestamp?.toDate ? submission.timestamp.toDate() : new Date();
                const dateString = submissionDate.toLocaleDateString();
                const timeString = submissionDate.toLocaleTimeString();

                let statusHTML = '';
                if (submission.status === 'Treatment Provided') {
                    statusHTML = `<span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-white bg-blue-500">Treated</span>`;
                } else if (submission.status === 'Pending Final Diagnosis') {
                    statusHTML = `<span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-yellow-800 bg-yellow-200">Diagnosed</span>`;
                } else {
                    statusHTML = `<span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-red-800 bg-red-200">Pending</span>`;
                }

                let farmerNameHTML = '';
                if (submission.userName && userProfile.role !== 'Farmer') {
                    farmerNameHTML = `<p class="text-sm text-gray-500">Farmer: ${submission.userName}</p>`;
                }

                summaryCard.innerHTML = `
                    <div class="flex items-start">
                        <img src="${submission.imageDataUrl || 'https://placehold.co/96x96/e2e8f0/334155?text=No+Image'}" class="w-24 h-24 rounded-md mr-4 object-cover">
                        <div class="flex-grow">
                            <div class="flex justify-between items-center mb-1">
                                <p class="font-bold text-lg">${submission.farmName}</p>
                                ${statusHTML}
                            </div>
                            <p class="text-sm text-gray-500 mb-2">Reported on ${dateString} at ${timeString}</p>
                            ${farmerNameHTML}
                            <p class="text-sm"><strong>Symptoms:</strong> <span class="capitalize">${submission.symptoms.join(', ')}</span></p>
                            <p class="text-sm text-blue-600 mt-2">Click to expand for more details</p>
                        </div>
                    </div>`;

                summaryCard.addEventListener('click', async () => {
                    const isHidden = detailsCard.classList.toggle('hidden');
                    if (!isHidden && !detailsCard.dataset.loaded) {
                        detailsCard.dataset.loaded = 'true'; // Prevent reloading

                        const mapId = `report-map-${submission.id}`;

                        let initialDiagnosisHTML = '';
                        if (submission.initialDiagnosis) {
                            initialDiagnosisHTML = `
                                <div class="mt-4 pt-4 border-t">
                                    <h4 class="font-bold">Initial Diagnosis</h4>
                                    <p><strong>Pest/Disease:</strong> ${submission.initialDiagnosis.pestDisease}</p>
                                    <p><strong>Notes:</strong> ${submission.initialDiagnosis.notes || 'N/A'}</p>
                                    <p class="text-sm text-gray-500">by ${submission.initialDiagnosis.diagnosedByName}</p>
                                </div>`;
                        }

                        let finalDiagnosisHTML = '';
                        if (submission.finalDiagnosis) {
                            finalDiagnosisHTML = `
                                <div class="mt-4 pt-4 border-t">
                                    <h4 class="font-bold">Final Diagnosis</h4>
                                    <p><strong>Pest/Disease:</strong> ${submission.finalDiagnosis.pestDisease}</p>
                                    <p><strong>Notes:</strong> ${submission.finalDiagnosis.notes || 'N/A'}</p>
                                    <p class="text-sm text-gray-500">by ${submission.finalDiagnosis.diagnosedByName}</p>
                                </div>`;
                        }

                        let treatmentHTML = '';
                        if (submission.treatment) {
                            const allActions = [
                                ...(submission.treatment.prevention || []),
                                ...(submission.treatment.monitoring || []),
                                ...(submission.treatment.control || [])
                            ];

                            treatmentHTML = `
                                <div class="mt-4 pt-4 border-t">
                                    <h4 class="font-bold">Treatment Plan</h4>
                                    ${allActions.length > 0 ? `<p><strong>Actions:</strong> ${allActions.join(', ')}</p>` : ''}
                                    <p><strong>Instructions:</strong> ${submission.treatment.instructions || 'N/A'}</p>
                                    ${submission.treatment.followUpDate ? `<p><strong>Follow-up Date:</strong> ${submission.treatment.followUpDate}</p>` : ''}
                                </div>`;
                        }

                        detailsCard.innerHTML = `
                            <h3 class="text-lg font-bold mb-2">Full Report Details</h3>
                            <div id="${mapId}" class="w-full h-48 bg-gray-200 rounded-md shadow-inner mb-4"></div>
                            <img src="${submission.imageDataUrl}" class="rounded-lg my-2 max-h-96 w-auto">
                            ${initialDiagnosisHTML}
                            ${finalDiagnosisHTML}
                            ${treatmentHTML}
                        `;

                        try {
                            const farmDocRef = doc(db, 'users', submission.userId, 'farmLots', submission.farmId);
                            const farmDocSnap = await getDoc(farmDocRef);
                            if (farmDocSnap.exists()) {
                                const farmData = farmDocSnap.data();
                                const coordinates = farmData.polygonCoordinates;

                                const detailMap = L.map(mapId, { scrollWheelZoom: false, dragging: false, zoomControl: false });
                                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                                    attribution: 'Tiles &copy; Esri'
                                }).addTo(detailMap);

                                if (coordinates && coordinates.length > 0) {
                                    const latLngs = coordinates.map(c => [c.lat, c.lng]);
                                    const polygon = L.polygon(latLngs, {color: '#22c55e'}).addTo(detailMap);
                                    detailMap.fitBounds(polygon.getBounds());
                                }
                                setTimeout(() => detailMap.invalidateSize(), 0);
                            }
                        } catch (e) {
                            console.error("Could not load map for report", e);
                            document.getElementById(mapId).innerHTML = '<p class="text-red-500">Could not load map.</p>';
                        }
                    }
                });

                reportWrapper.appendChild(summaryCard);
                reportWrapper.appendChild(detailsCard);
                reportsContainer.appendChild(reportWrapper);
            });
            lucide.createIcons();
        }

        function loadFarms(context) {
            const targetUserId = context.userId || (currentUser ? currentUser.uid : null);
            if (!targetUserId) return;

            const welcomeMessage = document.getElementById('welcome-message');
            const farmListTitle = document.querySelector('#farm-list-screen h2');
            const addFarmBtn = document.getElementById('add-farm-btn');

            if (context.userId && context.userId !== currentUser.uid) {
                // Viewing someone else's farms (drill-down)
                welcomeMessage.textContent = `Viewing farms for ${context.userName}`;
                farmListTitle.textContent = `${context.userName}'s Farm Plots`;
                addFarmBtn.style.display = 'none';
            } else {
                // Viewing own farms
                welcomeMessage.textContent = `Welcome, ${userProfile.fullName}`;
                farmListTitle.textContent = 'My Farm Plots';
                if (userProfile.role === 'Farmer') {
                    addFarmBtn.style.display = 'flex';
                } else {
                    addFarmBtn.style.display = 'none';
                }
            }

            const farmLotsCollection = collection(db, 'users', targetUserId, 'farmLots');
            const unsubscribe = onSnapshot(farmLotsCollection, (querySnapshot) => {
                const farmListContainer = document.getElementById('farm-list-container');
                farmListContainer.innerHTML = ''; // Clear existing list
                
                if (querySnapshot.empty) {
                    farmListContainer.innerHTML = `
                        <div class="text-center text-gray-500 mt-20">
                            <i data-lucide="map-pin" class="w-12 h-12 mx-auto text-gray-400"></i>
                            <p class="mt-4">No farm plots found for this user.</p>
                        </div>`;
                } else {
                    querySnapshot.forEach((doc) => {
                        const farm = doc.data();
                        const farmId = doc.id;
                        const farmCard = document.createElement('div');
                        farmCard.className = 'bg-white p-4 rounded-xl mb-4 shadow-sm border border-gray-200 cursor-pointer hover:shadow-md';
                        farmCard.setAttribute('data-id', farmId);

                        const plantingDate = farm.plantingDate ? new Date(farm.plantingDate).toLocaleDateString() : 'N/A';

                        farmCard.innerHTML = `
                            <p class="text-xl font-bold text-gray-800">${farm.farmName}</p>
                            <p class="text-md text-gray-600">Variety: ${farm.tobaccoVariety || 'N/A'}</p>
                            <p class="text-sm text-gray-500">Planted on: ${plantingDate}</p>
                        `;

                        farmCard.addEventListener('click', () => {
                            const newContext = { ...context, farmId: farmId, farmName: farm.farmName, tobaccoVariety: farm.tobaccoVariety, label: farm.farmName };
                            showScreen('dashboard', newContext);
                        });

                        farmListContainer.appendChild(farmCard);
                    });
                }
                lucide.createIcons();
            });
            activeListeners.push(unsubscribe);
        }

        async function loadExtensionWorkerDashboard(context) {
            const ewDashboardContainer = document.getElementById('ew-dashboard-container');
            const welcomeMessage = document.getElementById('ew-welcome-message');
            const dashboardTitle = document.querySelector('#ew-dashboard-screen h2');

            if (context.userId && context.userId !== currentUser.uid) {
                // Coordinator viewing a specific EW's list
                welcomeMessage.textContent = `Viewing farmers for ${context.userName}`;
                dashboardTitle.textContent = `${context.userName}'s Farmer List`;
            } else {
                // EW viewing their own dashboard
                welcomeMessage.textContent = `Welcome, ${userProfile.fullName}`;
                dashboardTitle.textContent = 'Extension Worker Dashboard';
            }

            if (!currentUser) return;
            ewDashboardContainer.innerHTML = `
                <div class="text-center text-gray-500 mt-20">
                    <i data-lucide="loader" class="w-12 h-12 mx-auto text-gray-400 animate-spin"></i>
                    <p class="mt-4">Loading assigned farmers...</p>
                </div>`;
            lucide.createIcons();

            try {
                const usersCollection = collection(db, 'users');
                const q = query(usersCollection, where("role", "==", "Farmer"));
                const querySnapshot = await getDocs(q);

                let farmers = [];
                querySnapshot.forEach(doc => {
                    farmers.push({ id: doc.id, ...doc.data() });
                });

                let farmersWithData = [];
                for (const farmer of farmers) {
                    let latestReportTimestamp = null;
                    const farmLotsCollection = collection(db, 'users', farmer.id, 'farmLots');
                    const farmLotsSnapshot = await getDocs(farmLotsCollection);

                    for (const farmDoc of farmLotsSnapshot.docs) {
                        const submissionsCollection = collection(db, 'users', farmer.id, 'farmLots', farmDoc.id, 'submissions');
                        const subQuery = query(submissionsCollection, orderBy("timestamp", "desc"), limit(1));
                        const submissionsSnapshot = await getDocs(subQuery);

                        if (!submissionsSnapshot.empty) {
                            const latestSubmission = submissionsSnapshot.docs[0].data();
                            const currentTimestamp = latestSubmission.timestamp.toDate();
                            if (!latestReportTimestamp || currentTimestamp > latestReportTimestamp) {
                                latestReportTimestamp = currentTimestamp;
                            }
                        }
                    }
                    farmersWithData.push({ ...farmer, lastReportDate: latestReportTimestamp });
                }

                farmersWithData.sort((a, b) => (b.lastReportDate || 0) - (a.lastReportDate || 0));
                renderFarmerTable(farmersWithData, context);

            } catch (error) {
                console.error("Error loading Extension Worker dashboard:", error);
                ewDashboardContainer.innerHTML = `<div class="text-center text-red-500 mt-20"><p>Could not load farmer data. Check console for details.</p></div>`;
            }
        }

        function renderFarmerTable(farmers, context) {
            const container = document.getElementById('ew-dashboard-container');
            if (!farmers || farmers.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 mt-20">
                        <i data-lucide="users" class="w-12 h-12 mx-auto text-gray-400"></i>
                        <p class="mt-4">No farmers found or assigned.</p>
                    </div>`;
                lucide.createIcons();
                return;
            }

            const tableHtml = `
                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Farmer Name</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Report Date</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="farmer-table-body">
                            ${farmers.map(farmer => `
                                <tr class="hover:bg-gray-50 cursor-pointer" data-farmer-id="${farmer.id}" data-farmer-name="${farmer.fullName}">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900">${farmer.fullName}</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        ${farmer.barangay}, ${farmer.municipality}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        ${farmer.lastReportDate ? farmer.lastReportDate.toLocaleDateString() : 'No reports yet'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = tableHtml;
        }

        async function loadCoordinatorDashboard(context) {
            if (!currentUser) return;

            const container = document.getElementById('coordinator-dashboard-container');
            container.innerHTML = `<div class="text-center text-gray-500 mt-20"><i data-lucide="loader" class="w-12 h-12 mx-auto text-gray-400 animate-spin"></i><p class="mt-4">Loading extension workers...</p></div>`;
            lucide.createIcons();

            try {
                const usersCollection = collection(db, 'users');
                const q = query(usersCollection, where("role", "==", "Extension Worker"));
                const querySnapshot = await getDocs(q);

                let extensionWorkers = [];
                querySnapshot.forEach(doc => {
                    extensionWorkers.push({ id: doc.id, ...doc.data() });
                });

                extensionWorkers.sort((a, b) => a.fullName.localeCompare(b.fullName));

                const workersWithData = extensionWorkers.map(worker => ({
                    ...worker,
                    lastReportDate: null // Placeholder
                }));

                renderExtensionWorkerTable(workersWithData, context);

            } catch (error) {
                console.error("Error loading Coordinator dashboard:", error);
                container.innerHTML = `<div class="text-center text-red-500 mt-20"><p>Could not load worker data. Check console for details.</p></div>`;
            }
        }

        function renderExtensionWorkerTable(workers, context) {
            const container = document.getElementById('coordinator-dashboard-container');
            if (!workers || workers.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 mt-20"><i data-lucide="briefcase" class="w-12 h-12 mx-auto text-gray-400"></i><p class="mt-4">No Extension Workers found.</p></div>`;
                lucide.createIcons();
                return;
            }

            const tableHtml = `
                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Worker Name</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Report Received</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="ew-table-body">
                            ${workers.map(worker => `
                                <tr class="hover:bg-gray-50 cursor-pointer" data-worker-id="${worker.id}" data-worker-name="${worker.fullName}">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900">${worker.fullName}</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        ${worker.lastReportDate ? worker.lastReportDate.toLocaleDateString() : 'Data unavailable'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = tableHtml;
        }
        
        // Removed old syncOutbox function as it's now obsolete with the new online-only farm setup flow.

        async function syncSubmissionOutbox() {
            if (!navigator.onLine || !currentUser) return;

            const idb = await dbPromise;
            const allSubmissions = await idb.getAll('submission_outbox');
            if (allSubmissions.length === 0) return;

            const connectionStatusEl = document.getElementById('connection-status');
            connectionStatusEl.textContent = `Syncing ${allSubmissions.length} submission(s)...`;
            connectionStatusEl.className = 'text-center py-1 text-sm font-semibold bg-yellow-100 text-yellow-800';

            try {
                for (const submission of allSubmissions) {
                    const { id, farmId, ...dataToSync } = submission;
                    if (!farmId) continue;

                    const submissionsCollection = collection(db, 'users', currentUser.uid, 'farmLots', farmId, 'submissions');
                    await addDoc(submissionsCollection, dataToSync);
                }

                await idb.clear('submission_outbox');
            } catch (error) {
                console.error('Error syncing submission outbox:', error);
                connectionStatusEl.textContent = 'Sync Failed';
                connectionStatusEl.className = 'text-center py-1 text-sm font-semibold bg-red-100 text-red-800';
            }
        }

        // --- 7. DRILL-DOWN NAVIGATION ---
        let currentViewContext = {}; // Used to pass data between screens. DEPRECATED but kept for safety.

        document.getElementById('ew-dashboard-container').addEventListener('click', (e) => {
            const row = e.target.closest('tr[data-farmer-id]');
            if (row) {
                const farmerId = row.dataset.farmerId;
                const farmerName = row.dataset.farmerName;
                const lastContext = navigationHistory[navigationHistory.length - 1]?.context || {};
                const newContext = { ...lastContext, userId: farmerId, userName: farmerName, label: farmerName };
                showScreen('farmList', newContext);
            }
        });

        document.getElementById('coordinator-dashboard-container').addEventListener('click', (e) => {
            const row = e.target.closest('tr[data-worker-id]');
            if (row) {
                const workerId = row.dataset.workerId;
                const workerName = row.dataset.workerName;
                const lastContext = navigationHistory[navigationHistory.length - 1]?.context || {};
                const newContext = { ...lastContext, userId: workerId, userName: workerName, label: workerName };
                showScreen('ewDashboard', newContext);
            }
        });

        // --- 8. CONNECTION STATUS UI ---
        const connectionStatusEl = document.getElementById('connection-status');
        async function updateOnlineStatus() {
            const db = await dbPromise;
            const farmOutboxCount = await db.count('outbox');
            const submissionOutboxCount = await db.count('submission_outbox');

            if (navigator.onLine) {
                if (farmOutboxCount > 0) {
                    syncOutbox();
                }
                if (submissionOutboxCount > 0) {
                    syncSubmissionOutbox();
                }

                if (farmOutboxCount === 0 && submissionOutboxCount === 0) {
                    connectionStatusEl.textContent = 'Online';
                    connectionStatusEl.className = 'text-center py-1 text-sm font-semibold bg-blue-100 text-blue-800';
                }
            } else {
                let message = 'Offline Mode';
                const totalOutboxCount = farmOutboxCount + submissionOutboxCount;
                if (totalOutboxCount > 0) {
                    message += ` (${totalOutboxCount} item(s) waiting to sync)`;
                }
                connectionStatusEl.textContent = message;
                connectionStatusEl.className = 'text-center py-1 text-sm font-semibold bg-gray-200 text-gray-800';
            }
        }
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus();

    </script>
</body>
</html>
