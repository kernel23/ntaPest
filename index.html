<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agri-Guard</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Theme Color for PWA -->
    <meta name="theme-color" content="#22c55e">
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Simple transition for showing/hiding screens */
        .screen { display: none; }
        .screen.active { display: flex; }
        body { font-family: 'Inter', sans-serif; } /* Using a common sans-serif font */

        /* Sidebar Transitions */
        #sidebar {
            transition: width 0.5s ease-in-out;
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            z-index: 10;
        }

        #screen-container {
            transition: margin-left 0.5s ease-in-out;
        }

        .ml-16 {
            margin-left: 4rem !important; /* Use !important to ensure it overrides Tailwind's ml-64 */
        }

        #sidebar-title, .sidebar-text {
            transition: opacity 0.2s ease-out, width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            overflow: hidden;
        }

        .sidebar-collapsed {
            width: 4rem; /* w-16 */
        }

        .sidebar-collapsed #sidebar-title {
            opacity: 0;
            width: 0;
        }

        .sidebar-collapsed .sidebar-text {
            opacity: 0;
            width: 0;
        }

        .sidebar-collapsed .nav-item {
            justify-content: center;
        }

        .sidebar-collapsed .nav-item .sidebar-text {
            margin-left: 0;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-5 right-5 bg-green-600 text-white py-2 px-4 rounded-lg shadow-md opacity-0 transition-opacity duration-300 z-50">
        <p id="toast-message"></p>
    </div>

    <div id="app-container" class="h-screen w-screen relative">
        <!-- Sidebar (hidden by default, shown after login) -->
        <aside id="sidebar" class="w-64 bg-green-800 text-white p-4 hidden flex-col">
            <div class="flex justify-between items-center mb-10">
                <h1 id="sidebar-title" class="text-2xl font-bold text-white transition-opacity duration-300">Agri-Guard</h1>
                <button id="sidebar-toggle" class="p-2 rounded-lg hover:bg-green-700">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <nav class="flex-1">
                <a href="#" id="nav-farm-list" class="nav-item flex items-center p-2 rounded-lg hover:bg-green-700">
                    <i data-lucide="layout-dashboard" class="w-6 h-6"></i>
                    <span class="ml-3 sidebar-text">My Farms</span>
                </a>
                <a href="#" id="nav-profile" class="nav-item flex items-center p-2 rounded-lg hover:bg-green-700 mt-2">
                    <i data-lucide="user" class="w-6 h-6"></i>
                    <span class="ml-3 sidebar-text">Profile</span>
                </a>
                <a href="#" id="nav-reports" class="nav-item flex items-center p-2 rounded-lg hover:bg-green-700 mt-2">
                    <i data-lucide="file-text" class="w-6 h-6"></i>
                    <span class="ml-3 sidebar-text">Reports</span>
                </a>
                <a href="#" id="nav-diagnosis" class="nav-item flex items-center p-2 rounded-lg hover:bg-green-700 mt-2">
                    <i data-lucide="stethoscope" class="w-6 h-6"></i>
                    <span class="ml-3 sidebar-text">Diagnosis</span>
                </a>
                <a href="#" id="nav-treatment" class="nav-item flex items-center p-2 rounded-lg hover:bg-green-700 mt-2">
                    <i data-lucide="syringe" class="w-6 h-6"></i>
                    <span class="ml-3 sidebar-text">Treatment</span>
                </a>
                <a href="#" id="nav-clinic" class="nav-item flex items-center p-2 rounded-lg hover:bg-green-700 mt-2">
                    <i data-lucide="message-square" class="w-6 h-6"></i>
                    <span class="ml-3 sidebar-text">Online Clinic</span>
                </a>
            </nav>
            <div class="mt-auto">
                <button id="sidebar-logout-btn" class="nav-item w-full flex items-center p-2 rounded-lg hover:bg-red-700">
                    <i data-lucide="log-out" class="w-6 h-6"></i>
                    <span class="ml-3 sidebar-text">Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main content area that holds all screens -->
        <div id="screen-container" class="h-screen overflow-y-auto">
            <!-- Loading Screen -->
            <div id="loading-screen" class="screen active flex-col justify-center items-center h-full bg-green-50 text-gray-800">
                <svg class="animate-spin h-10 w-10 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-lg text-green-700">Loading Agri-Guard...</p>
            </div>

            <!-- Login Screen -->
            <div id="login-screen" class="screen flex-col justify-center items-center h-full p-6 bg-green-50 text-gray-800">
                <div class="text-center mb-10">
                    <i data-lucide="leaf" class="w-16 h-16 text-green-600 mx-auto"></i>
                    <h1 class="text-4xl font-bold text-green-900 mt-4">Agri-Guard</h1>
                    <p class="text-lg text-green-700">Tobacco Pest Monitoring</p>
                    <p class="text-sm text-gray-500 mt-1">Ilocos Region, Philippines</p>
                </div>
                <div class="w-full max-w-sm">
                    <button id="google-signin-btn" class="w-full bg-white text-gray-700 font-semibold py-3 px-4 border border-gray-300 rounded-lg shadow-sm flex items-center justify-center mb-3">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" alt="Google" class="mr-3"> <!-- Placeholder for Google Icon -->
                        Sign in with Google
                    </button>
                    <button id="facebook-signin-btn" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg shadow-sm flex items-center justify-center mb-4">
                         <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z" clip-rule="evenodd" /></svg>
                        Sign in with Facebook
                    </button>
                    <button id="guest-signin-btn" class="w-full text-gray-600 py-2">Continue as Guest</button>
                </div>
                <div class="mt-4 text-center text-xs text-gray-500">
                    By signing in, you agree to our <a href="#" id="privacy-policy-link" class="underline hover:text-green-700">Privacy Policy</a>. All personal data is encrypted in transit.
                </div>
            </div>

            <!-- Privacy Policy Screen -->
            <div id="privacy-policy-screen" class="screen flex-col h-full bg-green-50 text-gray-800">
                <header class="bg-white p-4 shadow-md flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Privacy Policy</h2>
                    <button id="close-privacy-policy-btn" class="p-2 rounded-full hover:bg-gray-100">
                        <i data-lucide="x" class="w-6 h-6 text-gray-600"></i>
                    </button>
                </header>
                <main class="flex-1 p-6 overflow-y-auto">
                    <p class="mb-4"><strong>Last updated: August 11, 2025</strong></p>
                    <p class="mb-4">This Privacy Policy describes Our policies and procedures on the collection, use and disclosure of Your information when You use the Service and tells You about Your privacy rights and how the law protects You.</p>
                    <h3 class="text-lg font-bold mt-6 mb-2">Interpretation and Definitions</h3>
                    <p class="mb-4">The words of which the initial letter is capitalized have meanings defined under the following conditions. The following definitions shall have the same meaning regardless of whether they appear in singular or in plural.</p>
                    <h3 class="text-lg font-bold mt-6 mb-2">Collecting and Using Your Personal Data</h3>
                    <p class="mb-4">While using Our Service, We may ask You to provide Us with certain personally identifiable information that can be used to contact or identify You. Personally identifiable information may include, but is not limited to: Email address, First name and last name, Phone number, Address, State, Province, ZIP/Postal code, City, Usage Data.</p>
                    <h3 class="text-lg font-bold mt-6 mb-2">Data Encryption</h3>
                    <p class="mb-4">We are committed to ensuring that your information is secure. To prevent unauthorized access or disclosure, we have put in place suitable physical, electronic and managerial procedures to safeguard and secure the information we collect online. All personal data is encrypted in transit between your device and our servers using Secure Socket Layer (SSL) technology.</p>
                    <h3 class="text-lg font-bold mt-6 mb-2">Contact Us</h3>
                    <p>If you have any questions about this Privacy Policy, You can contact us by email: privacy@agri-guard.com</p>
                </main>
            </div>

            <!-- Create Profile Screen -->
            <div id="profile-screen" class="screen flex-col h-full bg-green-50 text-gray-800">
                <header class="bg-white p-4 shadow-md">
                    <h2 id="profile-title" class="text-2xl font-bold">Your Profile</h2>
                </header>
                <main class="flex-1 p-6 overflow-y-auto">
                    <div class="text-center mb-6">
                        <img id="profile-pic" src="https://placehold.co/96x96/e2e8f0/334155?text=User" class="w-24 h-24 rounded-full mx-auto mb-4">
                    </div>
                    <label for="fullName" class="block text-sm font-medium text-gray-700">Full Name</label>
                    <input type="text" id="fullName" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">

                    <label for="province" class="block text-sm font-medium text-gray-700 mt-4">Province</label>
                    <select id="province" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        <option>Loading provinces...</option>
                    </select>

                    <label for="municipality" class="block text-sm font-medium text-gray-700 mt-4">Municipality</label>
                    <select id="municipality" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" disabled></select>

                    <label for="barangay" class="block text-sm font-medium text-gray-700 mt-4">Barangay</label>
                    <select id="barangay" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" disabled></select>

                    <label for="birthdate" class="block text-sm font-medium text-gray-700 mt-4">Birthdate</label>
                    <input type="date" id="birthdate" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    <label for="civilStatus" class="block text-sm font-medium text-gray-700 mt-4">Civil Status</label>
                    <select id="civilStatus" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        <option>Single</option>
                        <option>Married</option>
                        <option>Widowed</option>
                        <option>Divorced</option>
                    </select>
                    <label for="religion" class="block text-sm font-medium text-gray-700 mt-4">Religion</label>
                    <input type="text" id="religion" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    <label for="yearsFarming" class="block text-sm font-medium text-gray-700 mt-4">Years in Tobacco Farming</label>
                    <input type="number" id="yearsFarming" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    <label for="familyMembers" class="block text-sm font-medium text-gray-700 mt-4">Number of Family Members</label>
                    <input type="number" id="familyMembers" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    <label for="education" class="block text-sm font-medium text-gray-700 mt-4">Highest Educational Attainment</label>
                    <select id="education" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        <option>No formal education</option>
                        <option>Elementary</option>
                        <option>High School</option>
                        <option>Vocational</option>
                        <option>College</option>
                        <option>Post-graduate</option>
                    </select>
                    <div class="mt-4">
                        <label for="isFarmer" class="flex items-center">
                            <input type="checkbox" id="isFarmer" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                            <span class="ml-2 text-sm font-medium text-gray-700">I am a farmer</span>
                        </label>
                    </div>
                    <div id="rsbsa-container" class="hidden mt-4">
                        <label for="rsbsaNumber" class="block text-sm font-medium text-gray-700">RSBSA Number (Optional)</label>
                        <input type="text" id="rsbsaNumber" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    </div>
                    <p class="mt-6 mb-2 font-medium text-gray-700">Select Your Role:</p>
                    <div class="flex gap-4">
                        <button id="role-farmer-btn" class="role-btn flex-1 p-4 rounded-lg border-2 border-green-600 bg-green-600 text-white">Farmer</button>
                        <button id="role-worker-btn" class="role-btn flex-1 p-4 rounded-lg border-2 border-gray-300">Extension Worker</button>
                    </div>
                    <div class="mt-8 space-y-4">
                        <button id="edit-profile-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hidden">Edit Profile</button>
                        <button id="save-profile-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md">Save and Continue</button>
                        <button id="cancel-edit-btn" class="w-full bg-gray-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hidden">Cancel</button>
                    </div>
                </main>
            </div>

            <!-- Farm List Screen (Home) -->
            <div id="farm-list-screen" class="screen flex-col h-full bg-green-50 text-gray-800">
                <header class="bg-white p-4 shadow-md flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold">My Farm Plots</h2>
                        <p id="welcome-message" class="text-sm text-gray-600"></p>
                    </div>
                    <div id="connection-status" class="text-center py-1 px-3 rounded-full text-sm font-semibold"></div>
                </header>
                <main id="farm-list-container" class="flex-1 p-4 overflow-y-auto">
                    <!-- Farm cards will be inserted here by JavaScript -->
                    <div id="no-farms-message" class="text-center text-gray-500 mt-20">
                        <i data-lucide="map-pin" class="w-12 h-12 mx-auto text-gray-400"></i>
                        <p class="mt-4">No farm plots found.</p>
                        <p>Add your first plot to start monitoring.</p>
                    </div>
                </main>
                <button id="add-farm-btn" class="absolute bottom-6 right-6 bg-green-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center">
                    <i data-lucide="plus" class="w-8 h-8"></i>
                </button>
            </div>

            <!-- Dashboard Screen -->
            <div id="dashboard-screen" class="screen flex-col h-full bg-green-50 text-gray-800">
                <header class="bg-white p-4 shadow-md flex justify-between items-center">
                    <div class="flex items-center">
                        <h2 id="dashboard-farm-name" class="text-2xl font-bold">Farm Health Log</h2>
                        <p id="dashboard-farm-variety" class="text-sm text-gray-600 ml-4"></p>
                    </div>
                    <button id="new-submission-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">New Report</button>
                </header>
                <main id="dashboard-main" class="flex-1 p-4 overflow-y-auto">
                    <div class="text-center text-gray-500 mt-20">
                        <i data-lucide="clipboard-list" class="w-12 h-12 mx-auto text-gray-400"></i>
                        <p class="mt-4">Submission history will appear here.</p>
                    </div>
                </main>
            </div>

            <!-- New Submission Screen -->
            <div id="new-submission-screen" class="screen flex-col h-full bg-green-50 text-gray-800">
                <header class="bg-white p-4 shadow-md flex items-center">
                    <button id="back-to-dashboard-btn" class="p-2 rounded-full hover:bg-gray-100 mr-2">
                        <i data-lucide="arrow-left" class="w-6 h-6 text-gray-600"></i>
                    </button>
                    <h2 class="text-2xl font-bold">New Scouting Report</h2>
                </header>
                <main class="flex-1 p-6 overflow-y-auto">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Upload Image of Affected Plant</label>
                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                        <div class="space-y-1 text-center">
                            <i id="image-placeholder-icon" data-lucide="image" class="mx-auto h-12 w-12 text-gray-400"></i>
                            <img id="submission-image-preview" src="" class="hidden mx-auto max-h-48 rounded-md">
                            <div class="flex text-sm text-gray-600">
                                <label for="image-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-green-600 hover:text-green-500 focus-within:outline-none">
                                    <span>Upload a file</span>
                                    <input id="image-upload" name="image-upload" type="file" class="sr-only" accept="image/*">
                                </label>
                                <p class="pl-1">or drag and drop</p>
                            </div>
                            <p class="text-xs text-gray-500">PNG, JPG, GIF up to 10MB</p>
                        </div>
                    </div>

                    <fieldset id="symptoms-checklist" class="mt-6">
                        <legend class="text-base font-medium text-gray-900">Observed Symptoms</legend>
                        <div class="mt-4 grid grid-cols-2 gap-4">
                            <div class="flex items-start"><div class="flex items-center h-5"><input id="symptom-spots" value="spots" type="checkbox" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="symptom-spots" class="font-medium text-gray-700">Leaf Spots</label></div></div>
                            <div class="flex items-start"><div class="flex items-center h-5"><input id="symptom-wilting" value="wilting" type="checkbox" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="symptom-wilting" class="font-medium text-gray-700">Wilting</label></div></div>
                            <div class="flex items-start"><div class="flex items-center h-5"><input id="symptom-yellowing" value="yellowing" type="checkbox" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="symptom-yellowing" class="font-medium text-gray-700">Yellowing</label></div></div>
                        </div>
                    </fieldset>

                    <fieldset id="distribution-radios" class="mt-6">
                        <legend class="text-base font-medium text-gray-900">Pest/Disease Distribution</legend>
                        <div class="mt-4 space-y-4">
                            <div class="flex items-center"><input id="dist-isolated" name="distribution" value="isolated" type="radio" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300"><label for="dist-isolated" class="ml-3 block text-sm font-medium text-gray-700">Isolated Plants</label></div>
                            <div class="flex items-center"><input id="dist-patches" name="distribution" value="patches" type="radio" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300"><label for="dist-patches" class="ml-3 block text-sm font-medium text-gray-700">In Patches</label></div>
                        </div>
                    </fieldset>

                    <fieldset id="severity-radios" class="mt-6">
                        <legend class="text-base font-medium text-gray-900">Severity</legend>
                        <div class="mt-4 space-y-4">
                            <div class="flex items-center"><input id="sev-low" name="severity" value="low" type="radio" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300"><label for="sev-low" class="ml-3 block text-sm font-medium text-gray-700">Low</label></div>
                            <div class="flex items-center"><input id="sev-medium" name="severity" value="medium" type="radio" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300"><label for="sev-medium" class="ml-3 block text-sm font-medium text-gray-700">Medium</label></div>
                            <div class="flex items-center"><input id="sev-high" name="severity" value="high" type="radio" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300"><label for="sev-high" class="ml-3 block text-sm font-medium text-gray-700">High</label></div>
                        </div>
                    </fieldset>
                    
                    <button id="save-submission-btn" class="mt-8 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md">Save Submission</button>
                </main>
            </div>

            <!-- Reports Screen -->
            <div id="reports-screen" class="screen flex-col h-full bg-green-50 text-gray-800">
                <header class="bg-white p-4 shadow-md">
                    <h2 class="text-2xl font-bold">Reports</h2>
                </header>
                <main class="flex-1 p-4">
                    <p>Reports will be displayed here.</p>
                </main>
            </div>

            <!-- Diagnosis Screen -->
            <div id="diagnosis-screen" class="screen flex-col h-full bg-green-50 text-gray-800">
                <header class="bg-white p-4 shadow-md">
                    <h2 class="text-2xl font-bold">Diagnosis</h2>
                </header>
                <main class="flex-1 p-4">
                    <p>Diagnosis tools and information will be available here.</p>
                </main>
            </div>

            <!-- Treatment Screen -->
            <div id="treatment-screen" class="screen flex-col h-full bg-green-50 text-gray-800">
                <header class="bg-white p-4 shadow-md">
                    <h2 class="text-2xl font-bold">Treatment</h2>
                </header>
                <main class="flex-1 p-4">
                    <p>Treatment recommendations will be available here.</p>
                </main>
            </div>

            <!-- Online Clinic Screen -->
            <div id="online-clinic-screen" class="screen flex-col h-full bg-green-50 text-gray-800">
                <header class="bg-white p-4 shadow-md">
                    <h2 class="text-2xl font-bold">Online Clinic</h2>
                </header>
                <main class="flex-1 p-4">
                    <p>Expert consultation features will be available here.</p>
                </main>
            </div>

        </div>
    </div>

    <!-- Modals -->
    <div id="farm-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-40">
         <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Add New Farm Plot</h3>
                <button id="close-farm-modal-btn" class="p-1"><i data-lucide="x"></i></button>
            </div>
            <div class="p-6">
                <label for="farmName" class="block text-sm font-medium text-gray-700">Plot Name</label>
                <input type="text" id="farmName" placeholder="e.g., North Field" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                <label for="tobaccoVariety" class="block text-sm font-medium text-gray-700 mt-4">Tobacco Variety</label>
                <input type="text" id="tobaccoVariety" placeholder="e.g., Virginia" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                <button id="save-farm-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md mt-6">Save Plot</button>
            </div>
        </div>
    </div>

    <!-- Address Data -->
    <script src="address-provider.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the IDB library for offline storage
        import { openDB } from 'https://cdn.jsdelivr.net/npm/idb@8/+esm';

        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            FacebookAuthProvider,
            signInWithPopup,
            signInAnonymously,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore,
            doc,
            getDoc,
            setDoc,
            collection,
            addDoc,
            onSnapshot,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- 1. FIREBASE CONFIGURATION ---
        // IMPORTANT: Replace with your project's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB3yPx1dWJQwqn-SglOjGzrQ6BAZFngMDc",
            authDomain: "pest-monitoring-app-ph.firebaseapp.com",
            projectId: "pest-monitoring-app-ph",
            storageBucket: "pest-monitoring-app-ph.appspot.com",
            messagingSenderId: "948653534237",
            appId: "1:948653534237:web:dc195109343b4d5a12eaf4",
            measurementId: "G-YRFNHDN5VV"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 2. PWA & OFFLINE SETUP ---
        // Initialize IndexedDB
        const dbPromise = openDB('agri-guard-db', 2, {
            upgrade(db, oldVersion, newVersion, transaction) {
                if (oldVersion < 1) {
                    db.createObjectStore('outbox', { autoIncrement: true });
                }
                if (oldVersion < 2) {
                    db.createObjectStore('submission_outbox', { autoIncrement: true });
                }
            },
        });
        console.log('IndexedDB setup initiated.');

        // Register the service worker for offline capabilities
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('ServiceWorker registration successful with scope: ', registration.scope))
                    .catch(err => console.log('ServiceWorker registration failed: ', err));
            });
        }
        
        // --- 3. UI & STATE MANAGEMENT ---
        const screens = {
            loading: document.getElementById('loading-screen'),
            login: document.getElementById('login-screen'),
            profile: document.getElementById('profile-screen'),
            farmList: document.getElementById('farm-list-screen'),
            dashboard: document.getElementById('dashboard-screen'),
            newSubmission: document.getElementById('new-submission-screen'),
            reports: document.getElementById('reports-screen'),
            diagnosis: document.getElementById('diagnosis-screen'),
            treatment: document.getElementById('treatment-screen'),
            onlineClinic: document.getElementById('online-clinic-screen'),
            privacyPolicy: document.getElementById('privacy-policy-screen')
        };

        // --- Privacy Policy Navigation ---
        document.getElementById('privacy-policy-link').addEventListener('click', (e) => {
            e.preventDefault();
            showScreen('privacyPolicy');
        });

        document.getElementById('close-privacy-policy-btn').addEventListener('click', () => {
            // This should ideally return to the previous screen.
            // For simplicity, we'll return to the login screen as the link is only there.
            showScreen('login');
        });

        // --- Sidebar Navigation ---
        document.getElementById('nav-farm-list').addEventListener('click', () => showScreen('farmList'));
        document.getElementById('nav-profile').addEventListener('click', () => showScreen('profile'));
        document.getElementById('nav-reports').addEventListener('click', () => showScreen('reports'));
        document.getElementById('nav-diagnosis').addEventListener('click', () => showScreen('diagnosis'));
        document.getElementById('nav-treatment').addEventListener('click', () => showScreen('treatment'));
        document.getElementById('nav-clinic').addEventListener('click', () => showScreen('onlineClinic'));
        document.getElementById('sidebar-logout-btn').addEventListener('click', () => signOut(auth));

        // --- Sidebar Toggle Logic ---
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebarToggleIcon = sidebarToggle.querySelector('i'); // Get the icon element
        const screenContainer = document.getElementById('screen-container');

        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('sidebar-collapsed');

            // Change the icon and margin based on the sidebar's state
            if (sidebar.classList.contains('sidebar-collapsed')) {
                sidebarToggleIcon.setAttribute('data-lucide', 'menu');
                screenContainer.classList.remove('ml-64');
                screenContainer.classList.add('ml-16');
            } else {
                sidebarToggleIcon.setAttribute('data-lucide', 'x');
                screenContainer.classList.remove('ml-16');
                screenContainer.classList.add('ml-64');
            }

            // Re-render icons
            lucide.createIcons();
        });

        let currentUser = null;
        let userProfile = null;
        let selectedRole = 'Farmer';

        // Function to switch between screens
        function showScreen(screenName) {
            const sidebar = document.getElementById('sidebar');
            const screenContainer = document.getElementById('screen-container');
            const noSidebarScreens = ['loading', 'login'];

            if (noSidebarScreens.includes(screenName)) {
                sidebar.classList.add('hidden');
                screenContainer.classList.remove('ml-64', 'ml-16'); // Remove margins
            } else {
                sidebar.classList.remove('hidden');
                // When showing a screen with a sidebar, we need to apply the correct margin
                // based on whether the sidebar is currently collapsed or not.
                if (sidebar.classList.contains('sidebar-collapsed')) {
                    screenContainer.classList.add('ml-16');
                    screenContainer.classList.remove('ml-64');
                } else {
                    screenContainer.classList.add('ml-64');
                    screenContainer.classList.remove('ml-16');
                }
            }

            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            if (screens[screenName]) {
                screens[screenName].classList.add('active');
            }
            lucide.createIcons();
        }

        let toastTimeout;
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');

            toastMessage.textContent = message;

            // Reset classes
            toast.className = 'fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-md transition-opacity duration-300';

            if (type === 'success') {
                toast.classList.add('bg-green-600');
            } else if (type === 'error') {
                toast.classList.add('bg-red-600');
            } else {
                toast.classList.add('bg-gray-800');
            }

            toast.classList.remove('opacity-0');

            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                toast.classList.add('opacity-0');
            }, 3000);
        }

        // --- 4. AUTHENTICATION LOGIC ---
        const profileTitle = document.getElementById('profile-title');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const profileFormElements = document.querySelectorAll('#profile-screen input, #profile-screen select, #profile-screen textarea, #profile-screen .role-btn');

        function setProfileMode(mode) { // 'edit', 'view', 'new'
            if (mode === 'view') {
                profileTitle.textContent = 'Your Profile';
                profileFormElements.forEach(el => el.disabled = true);
                editProfileBtn.classList.remove('hidden');
                saveProfileBtn.classList.add('hidden');
                cancelEditBtn.classList.add('hidden');
            } else if (mode === 'edit') {
                profileTitle.textContent = 'Edit Profile';
                profileFormElements.forEach(el => el.disabled = false);
                saveProfileBtn.textContent = 'Save Changes';
                editProfileBtn.classList.add('hidden');
                saveProfileBtn.classList.remove('hidden');
                cancelEditBtn.classList.remove('hidden');
            } else { // new
                profileTitle.textContent = 'Complete Your Profile';
                profileFormElements.forEach(el => el.disabled = false);
                saveProfileBtn.textContent = 'Save and Continue';
                editProfileBtn.classList.add('hidden');
                saveProfileBtn.classList.remove('hidden');
                cancelEditBtn.classList.add('hidden');
            }
        }

        // --- Address Dropdown Logic ---
        const provinceSelect = document.getElementById('province');
        const municipalitySelect = document.getElementById('municipality');
        const barangaySelect = document.getElementById('barangay');

        document.addEventListener('addressDataReady', () => {
            populateProvinces();
        });

        function populateProvinces() {
            provinceSelect.innerHTML = '<option value="">Select Province</option>';
            if (window.philippineAddresses && window.philippineAddresses.provinces) {
                window.philippineAddresses.provinces.forEach(province => {
                    const option = document.createElement('option');
                    option.value = province.name;
                    option.textContent = province.name;
                    provinceSelect.appendChild(option);
                });
            } else {
                provinceSelect.innerHTML = '<option value="">Failed to load addresses</option>';
            }
        }

        provinceSelect.addEventListener('change', () => {
            const selectedProvinceName = provinceSelect.value;
            const selectedProvince = window.philippineAddresses.provinces.find(p => p.name === selectedProvinceName);
            municipalitySelect.innerHTML = '<option value="">Select Municipality</option>';
            barangaySelect.innerHTML = '<option value="">Select Barangay</option>';
            barangaySelect.disabled = true;

            if (selectedProvince) {
                municipalitySelect.disabled = false;
                selectedProvince.municipalities.forEach(municipality => {
                    const option = document.createElement('option');
                    option.value = municipality.name;
                    option.textContent = municipality.name;
                    municipalitySelect.appendChild(option);
                });
            } else {
                municipalitySelect.disabled = true;
            }
        });

        municipalitySelect.addEventListener('change', () => {
            const selectedProvinceName = provinceSelect.value;
            const selectedMunicipalityName = municipalitySelect.value;
            const selectedProvince = window.philippineAddresses.provinces.find(p => p.name === selectedProvinceName);
            const selectedMunicipality = selectedProvince?.municipalities.find(m => m.name === selectedMunicipalityName);
            barangaySelect.innerHTML = '<option value="">Select Barangay</option>';

            if (selectedMunicipality && selectedMunicipality.barangays) {
                barangaySelect.disabled = false;
                selectedMunicipality.barangays.forEach(barangay => {
                    const option = document.createElement('option');
                    option.value = barangay;
                    option.textContent = barangay;
                    barangaySelect.appendChild(option);
                });
            } else {
                barangaySelect.disabled = true;
            }
        });

        // --- RSBSA Logic ---
        const isFarmerCheckbox = document.getElementById('isFarmer');
        const rsbsaContainer = document.getElementById('rsbsa-container');
        isFarmerCheckbox.addEventListener('change', () => {
            rsbsaContainer.classList.toggle('hidden', !isFarmerCheckbox.checked);
        });

        function populateProfileFields(profile) {
            document.getElementById('profile-pic').src = profile.photoURL || (currentUser && currentUser.photoURL) || 'https://placehold.co/96x96/e2e8f0/334155?text=User';
            document.getElementById('fullName').value = profile.fullName || '';

            // Populate address fields
            if (profile.province) {
                provinceSelect.value = profile.province;
                provinceSelect.dispatchEvent(new Event('change'));

                // Use a small timeout to allow municipalities to populate before setting the value
                setTimeout(() => {
                    if (profile.municipality) {
                        municipalitySelect.value = profile.municipality;
                        municipalitySelect.dispatchEvent(new Event('change'));

                        setTimeout(() => {
                             if (profile.barangay) {
                                barangaySelect.value = profile.barangay;
                            }
                        }, 100);
                    }
                }, 100);
            }

            // RSBSA Number
            if (profile.rsbsaNumber) {
                isFarmerCheckbox.checked = true;
                rsbsaContainer.classList.remove('hidden');
                document.getElementById('rsbsaNumber').value = profile.rsbsaNumber;
            } else {
                isFarmerCheckbox.checked = false;
                rsbsaContainer.classList.add('hidden');
                document.getElementById('rsbsaNumber').value = '';
            }

            document.getElementById('birthdate').value = profile.birthdate || '';
            document.getElementById('civilStatus').value = profile.civilStatus || 'Single';
            document.getElementById('religion').value = profile.religion || '';
            document.getElementById('yearsFarming').value = profile.yearsFarming || '';
            document.getElementById('familyMembers').value = profile.familyMembers || '';
            document.getElementById('education').value = profile.education || 'No formal education';

            selectedRole = profile.role || 'Farmer';
            document.querySelectorAll('.role-btn').forEach(btn => {
                btn.classList.remove('bg-green-600', 'text-white');
                btn.classList.add('border-gray-300');
            });
            if (selectedRole === 'Farmer') {
                document.getElementById('role-farmer-btn').classList.add('bg-green-600', 'text-white');
            } else {
                document.getElementById('role-worker-btn').classList.add('bg-green-600', 'text-white');
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                updateOnlineStatus();
                
                const userDocRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists()) {
                    userProfile = docSnap.data();

                    const requiredFields = ['fullName', 'province', 'municipality', 'barangay', 'birthdate', 'civilStatus', 'religion', 'yearsFarming', 'familyMembers', 'education', 'role'];
                    const isProfileComplete = requiredFields.every(field => userProfile[field] !== undefined && userProfile[field] !== null && userProfile[field] !== '');

                    populateProfileFields(userProfile);

                    if (isProfileComplete) {
                        setProfileMode('view');
                        document.getElementById('welcome-message').textContent = `Welcome, ${userProfile.fullName}`;
                        loadFarms();
                        showScreen('farmList');
                        document.getElementById('add-farm-btn').style.display = 'flex';
                    } else {
                        setProfileMode('new');
                        showToast('Please complete your profile to continue.', 'info');
                        showScreen('profile');
                        document.getElementById('add-farm-btn').style.display = 'none';
                    }
                } else {
                    userProfile = {};
                    populateProfileFields({
                        fullName: user.displayName,
                        photoURL: user.photoURL
                    });
                    setProfileMode('new');
                    showScreen('profile');
                    document.getElementById('add-farm-btn').style.display = 'none';
                }
            } else {
                currentUser = null;
                userProfile = null;
                showScreen('login');
            }
        });

        // Event Listeners for Sign-in buttons
        document.getElementById('google-signin-btn').addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(error => console.error("Google Sign-in Error", error));
        });

        document.getElementById('facebook-signin-btn').addEventListener('click', () => {
            const provider = new FacebookAuthProvider();
            signInWithPopup(auth, provider).catch(error => console.error("Facebook Sign-in Error", error));
        });
        
        document.getElementById('guest-signin-btn').addEventListener('click', () => {
            signInAnonymously(auth).catch(error => console.error("Anonymous Sign-in Error", error));
        });

        // --- 5. PROFILE MANAGEMENT ---
        editProfileBtn.addEventListener('click', () => {
            setProfileMode('edit');
        });

        cancelEditBtn.addEventListener('click', () => {
            populateProfileFields(userProfile); // Revert changes
            setProfileMode('view');
        });

        document.querySelectorAll('.role-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (btn.disabled) return;
                document.querySelectorAll('.role-btn').forEach(b => {
                    b.classList.remove('bg-green-600', 'text-white');
                    b.classList.add('border-gray-300');
                });
                btn.classList.add('bg-green-600', 'text-white');
                btn.classList.remove('border-gray-300');
                selectedRole = btn.id === 'role-farmer-btn' ? 'Farmer' : 'Extension Worker';
            });
        });

        document.getElementById('save-profile-btn').addEventListener('click', async () => {
            const fullName = document.getElementById('fullName').value;
            const province = document.getElementById('province').value;
            const municipality = document.getElementById('municipality').value;
            const barangay = document.getElementById('barangay').value;
            const birthdate = document.getElementById('birthdate').value;
            const civilStatus = document.getElementById('civilStatus').value;
            const religion = document.getElementById('religion').value;
            const yearsFarming = document.getElementById('yearsFarming').value;
            const familyMembers = document.getElementById('familyMembers').value;
            const education = document.getElementById('education').value;
            const rsbsaNumber = document.getElementById('rsbsaNumber').value;

            if (!fullName.trim() || !province.trim() || !municipality.trim() || !barangay.trim() || !birthdate.trim() || !civilStatus.trim() || !religion.trim() || !yearsFarming.trim() || !familyMembers.trim() || !education.trim()) {
                showToast('Please fill out all fields.', 'error');
                return;
            }
            
            const profileData = {
                fullName: fullName.trim(),
                province: province,
                municipality: municipality,
                barangay: barangay,
                birthdate: birthdate,
                civilStatus: civilStatus,
                religion: religion.trim(),
                yearsFarming: parseInt(yearsFarming),
                familyMembers: parseInt(familyMembers),
                education: education,
                role: selectedRole,
                email: currentUser.email || '',
                photoURL: currentUser.photoURL || '',
                rsbsaNumber: rsbsaNumber.trim()
            };

            try {
                const userDocRef = doc(db, "users", currentUser.uid);
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists()) {
                    // For existing profiles, set updatedAt
                    profileData.updatedAt = serverTimestamp();
                } else {
                    // For new profiles, set createdAt
                    profileData.createdAt = serverTimestamp();
                }

                await setDoc(userDocRef, profileData, { merge: true });

                showToast("Profile saved successfully!", "success");

                // Re-fetch the profile to ensure local data is consistent and clean
                const updatedDocSnap = await getDoc(userDocRef);
                if (updatedDocSnap.exists()) {
                    userProfile = updatedDocSnap.data();
                } else {
                    // This case should ideally not happen if setDoc was successful.
                    // We'll optimistically use the data we sent, but remove the server-only fields.
                    if(profileData.updatedAt) delete profileData.updatedAt;
                    if(profileData.createdAt) delete profileData.createdAt;
                    userProfile = profileData;
                }

                const requiredFields = ['fullName', 'homeAddress', 'birthdate', 'civilStatus', 'religion', 'yearsFarming', 'familyMembers', 'education', 'role'];
                const isProfileComplete = requiredFields.every(field => userProfile[field]);

                if (isProfileComplete) {
                    populateProfileFields(userProfile); // Repopulate with the latest saved data
                    setProfileMode('view');
                    document.getElementById('welcome-message').textContent = `Welcome, ${userProfile.fullName}`;
                    loadFarms();
                    showScreen('farmList');
                    document.getElementById('add-farm-btn').style.display = 'flex';
                } else {
                    setProfileMode('new');
                }

            } catch (error) {
                console.error("Error saving profile:", error);
                showToast("Could not save profile. Please check connection.", 'error');
            }
        });

        // --- 6. FARM MANAGEMENT ---
        const farmModal = document.getElementById('farm-modal');
        document.getElementById('add-farm-btn').addEventListener('click', () => farmModal.style.display = 'flex');
        document.getElementById('close-farm-modal-btn').addEventListener('click', () => farmModal.style.display = 'none');
        //--document.getElementById('back-to-farm-list-btn').addEventListener('click', () => showScreen('farmList'));--
        document.getElementById('back-to-dashboard-btn').addEventListener('click', () => showScreen('dashboard'));
        
        // --- 8. NEW SUBMISSION LOGIC ---
        const imageUploadInput = document.getElementById('image-upload');
        const imagePreview = document.getElementById('submission-image-preview');
        const imagePlaceholder = document.getElementById('image-placeholder-icon');

        imageUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                    imagePlaceholder.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('save-submission-btn').addEventListener('click', async () => {
            const imageSrc = document.getElementById('submission-image-preview').src;

            const symptoms = Array.from(document.querySelectorAll('#symptoms-checklist input:checked')).map(cb => cb.value);
            const distribution = document.querySelector('#distribution-radios input:checked')?.value;
            const severity = document.querySelector('#severity-radios input:checked')?.value;

            if (!imageSrc || symptoms.length === 0 || !distribution || !severity) {
                showToast('Please fill out all fields and select an image.', 'error');
                return;
            }

            // Simulate GPS data
            const gps_coordinates = {
                latitude: 17.5734,
                longitude: 120.3856
            };

            if (!currentFarmId) {
                showToast('Could not identify the current farm. Please go back to the farm list.', 'error');
                return;
            }

            const submissionData = {
                farmId: currentFarmId,
                imageDataUrl: imageSrc,
                symptoms,
                distribution,
                severity,
                gps_coordinates,
                timestamp: new Date()
            };

            try {
                const db = await dbPromise;
                await db.add('submission_outbox', submissionData);
                showToast('Submission saved locally. It will be synced when online.', 'success');

                // Reset form
                document.getElementById('submission-image-preview').src = '';
                document.getElementById('submission-image-preview').classList.add('hidden');
                document.getElementById('image-placeholder-icon').classList.remove('hidden');
                document.querySelectorAll('#symptoms-checklist input:checked').forEach(cb => cb.checked = false);
                document.querySelectorAll('#distribution-radios input:checked').forEach(rb => rb.checked = false);
                document.querySelectorAll('#severity-radios input:checked').forEach(rb => rb.checked = false);

                showScreen('dashboard');
            } catch (error) {
                console.error('Failed to save submission locally:', error);
                showToast('Could not save submission.', 'error');
            }
        });

        let currentFarmId = null;

        document.getElementById('new-submission-btn').addEventListener('click', () => {
            showScreen('newSubmission');
        });

        async function loadSubmissions(farmId) {
            const dashboardMain = document.getElementById('dashboard-main');
            dashboardMain.innerHTML = ''; // Clear existing content

            const db = await dbPromise;
            const submissions = await db.getAll('submission_outbox');

            if (submissions.length === 0) {
                dashboardMain.innerHTML = `
                <div class="text-center text-gray-500 mt-20">
                    <i data-lucide="clipboard-list" class="w-12 h-12 mx-auto text-gray-400"></i>
                    <p class="mt-4">No submissions yet for this farm.</p>
                </div>`;
            } else {
                submissions.forEach(submission => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-xl mb-4 shadow-sm border border-gray-200';

                    const date = new Date(submission.timestamp);
                    const dateString = date.toLocaleDateString();
                    const timeString = date.toLocaleTimeString();

                    card.innerHTML = `
                        <div class="flex">
                            <img src="${submission.imageDataUrl}" class="w-24 h-24 rounded-md mr-4">
                            <div>
                                <p class="font-bold">Submission from ${dateString} at ${timeString}</p>
                                <p><strong>Symptoms:</strong> ${submission.symptoms.join(', ')}</p>
                                <p><strong>Distribution:</strong> ${submission.distribution}</p>
                                <p><strong>Severity:</strong> ${submission.severity}</p>
                            </div>
                        </div>
                    `;
                    dashboardMain.appendChild(card);
                });
            }
            lucide.createIcons();
        }

        document.getElementById('save-farm-btn').addEventListener('click', async () => {
            const farmNameInput = document.getElementById('farmName');
            const tobaccoVarietyInput = document.getElementById('tobaccoVariety');
            const farmName = farmNameInput.value.trim();
            const tobaccoVariety = tobaccoVarietyInput.value.trim();

            if (!farmName || !tobaccoVariety) {
                showToast('Please fill out all fields.', 'error');
                return;
            }

            farmModal.style.display = 'none';
            farmNameInput.value = '';
            tobaccoVarietyInput.value = '';
            
            const farmData = {
                farmName: farmName,
                tobaccoVariety: tobaccoVariety,
            };

            if (navigator.onLine) {
                farmData.createdAt = serverTimestamp();
                try {
                    const farmsCollection = collection(db, 'users', currentUser.uid, 'farms');
                    await addDoc(farmsCollection, farmData);
                } catch (error) {
                    console.error("Firestore save failed, saving to outbox:", error);
                    farmData.createdAt = new Date();
                    const idb = await dbPromise;
                    await idb.add('outbox', farmData);
                }
            } else {
                farmData.createdAt = new Date();
                try {
                    const idb = await dbPromise;
                    await idb.add('outbox', farmData);
                } catch (error) {
                    console.error("Outbox save failed:", error);
                    showToast('Could not save farm locally.', 'error');
                }
            }
            updateOnlineStatus();
        });

        function loadFarms() {
            const farmsCollection = collection(db, 'users', currentUser.uid, 'farms');
            onSnapshot(farmsCollection, (querySnapshot) => {
                const farmListContainer = document.getElementById('farm-list-container');
                farmListContainer.innerHTML = ''; // Clear existing list
                
                if (querySnapshot.empty) {
                    farmListContainer.innerHTML = `
                        <div class="text-center text-gray-500 mt-20">
                            <i data-lucide="map-pin" class="w-12 h-12 mx-auto text-gray-400"></i>
                            <p class="mt-4">No farm plots found.</p>
                            <p>Add your first plot to start monitoring.</p>
                        </div>`;
                } else {
                    querySnapshot.forEach((doc) => {
                        const farm = doc.data();
                        const farmId = doc.id;
                        const farmCard = document.createElement('div');
                        farmCard.className = 'bg-white p-4 rounded-xl mb-4 shadow-sm border border-gray-200 cursor-pointer hover:shadow-md';
                        farmCard.setAttribute('data-id', farmId);
                        farmCard.innerHTML = `
                            <p class="text-xl font-bold text-gray-800">${farm.farmName}</p>
                            <p class="text-md text-gray-600">${farm.tobaccoVariety || 'N/A'}</p>
                        `;

                        farmCard.addEventListener('click', () => {
                            currentFarmId = farmId;
                            document.getElementById('dashboard-farm-name').textContent = farm.farmName;
                            document.getElementById('dashboard-farm-variety').textContent = farm.tobaccoVariety || 'N/A';
                            loadSubmissions(currentFarmId);
                            showScreen('dashboard');
                        });

                        farmListContainer.appendChild(farmCard);
                    });
                }
                lucide.createIcons();
            });
        }
        
        async function syncOutbox() {
            if (!navigator.onLine || !currentUser) return;

            const db = await dbPromise;
            const allItems = await db.getAll('outbox');
            if (allItems.length === 0) return;

            const connectionStatusEl = document.getElementById('connection-status');
            connectionStatusEl.textContent = `Syncing ${allItems.length} item(s)...`;
            connectionStatusEl.className = 'text-center py-1 text-sm font-semibold bg-yellow-100 text-yellow-800';

            const farmsCollection = collection(db, 'users', currentUser.uid, 'farms');
            
            try {
                await Promise.all(allItems.map(item => addDoc(farmsCollection, item)));
                await db.clear('outbox');
                connectionStatusEl.textContent = 'Sync Complete';
                connectionStatusEl.className = 'text-center py-1 text-sm font-semibold bg-green-100 text-green-800';
            } catch (error) {
                console.error('Error syncing outbox:', error);
                connectionStatusEl.textContent = 'Sync Failed';
                connectionStatusEl.className = 'text-center py-1 text-sm font-semibold bg-red-100 text-red-800';
            } finally {
                setTimeout(updateOnlineStatus, 2000);
            }
        }

        async function syncSubmissionOutbox() {
            if (!navigator.onLine || !currentUser) return;

            const db = await dbPromise;
            const allSubmissions = await db.getAll('submission_outbox');
            if (allSubmissions.length === 0) return;

            const connectionStatusEl = document.getElementById('connection-status');
            connectionStatusEl.textContent = `Syncing ${allSubmissions.length} submission(s)...`;
            connectionStatusEl.className = 'text-center py-1 text-sm font-semibold bg-yellow-100 text-yellow-800';

            try {
                for (const submission of allSubmissions) {
                    const { id, farmId, ...dataToSync } = submission;
                    if (!farmId) continue;

                    const submissionsCollection = collection(db, 'users', currentUser.uid, 'farms', farmId, 'submissions');
                    await addDoc(submissionsCollection, dataToSync);
                }

                await db.clear('submission_outbox');
            } catch (error) {
                console.error('Error syncing submission outbox:', error);
                connectionStatusEl.textContent = 'Sync Failed';
                connectionStatusEl.className = 'text-center py-1 text-sm font-semibold bg-red-100 text-red-800';
            }
        }

        // --- 7. CONNECTION STATUS UI ---
        const connectionStatusEl = document.getElementById('connection-status');
        async function updateOnlineStatus() {
            const db = await dbPromise;
            const farmOutboxCount = await db.count('outbox');
            const submissionOutboxCount = await db.count('submission_outbox');

            if (navigator.onLine) {
                if (farmOutboxCount > 0) {
                    syncOutbox();
                }
                if (submissionOutboxCount > 0) {
                    syncSubmissionOutbox();
                }

                if (farmOutboxCount === 0 && submissionOutboxCount === 0) {
                    connectionStatusEl.textContent = 'Online';
                    connectionStatusEl.className = 'text-center py-1 text-sm font-semibold bg-blue-100 text-blue-800';
                }
            } else {
                let message = 'Offline Mode';
                const totalOutboxCount = farmOutboxCount + submissionOutboxCount;
                if (totalOutboxCount > 0) {
                    message += ` (${totalOutboxCount} item(s) waiting to sync)`;
                }
                connectionStatusEl.textContent = message;
                connectionStatusEl.className = 'text-center py-1 text-sm font-semibold bg-gray-200 text-gray-800';
            }
        }
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus();

    </script>
</body>
</html>
